<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#6366f1">
  <title>HablaConmigo - AIè¥¿è¯­å£è¯­åŠ©æ‰‹</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‡ªğŸ‡¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            accent: { 500: '#f97316', 600: '#ea580c' }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; }
    
    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }
    @keyframes bounce { 0%, 100% { transform: translateY(-25%); } 50% { transform: translateY(0); } }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 0.6s infinite; }
    
    .mic-recording { position: relative; }
    .mic-recording::before { 
      content: ''; position: absolute; inset: -8px; border-radius: 50%; 
      background: rgba(239,68,68,0.3); animation: pulse-ring 1.5s ease-out infinite; 
    }
    
    /* æ»šåŠ¨æ¡ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å®‰å…¨åŒºåŸŸ */
    .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    
    /* è¾“å…¥æ¡† */
    input, button, textarea, select { font-size: 16px !important; }
    
    /* ç¿»è¯‘æç¤º */
    .translation-tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #1e293b; color: white; padding: 8px 12px; border-radius: 8px;
      font-size: 13px; white-space: nowrap; margin-bottom: 8px; z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .translation-tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 6px solid transparent; border-top-color: #1e293b;
    }
    
    /* çº æ­£å¡ç‰‡ */
    .correction-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      border-radius: 0 12px 12px 0;
    }
    
    /* ç»ç’ƒæ•ˆæœ */
    .glass {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* ========== æ·±è‰²æ¨¡å¼ ========== */
    .dark body { background: #0f172a; }
    .dark .bg-gray-50 { background: #1e293b !important; }
    .dark .bg-gray-100 { background: #334155 !important; }
    .dark .bg-white { background: #1e293b !important; }
    .dark .text-gray-800 { color: #f1f5f9 !important; }
    .dark .text-gray-700 { color: #e2e8f0 !important; }
    .dark .text-gray-600 { color: #cbd5e1 !important; }
    .dark .text-gray-500 { color: #94a3b8 !important; }
    .dark .text-gray-400 { color: #64748b !important; }
    .dark .border-gray-100 { border-color: #334155 !important; }
    .dark .border-gray-200 { border-color: #475569 !important; }
    .dark .border-b { border-color: #334155 !important; }
    .dark .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; }
    .dark .hover\:bg-gray-100:hover { background: #334155 !important; }
    .dark .hover\:bg-gray-50:hover { background: #334155 !important; }
    .dark input, .dark select { background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important; }
    .dark input::placeholder { color: #64748b !important; }
    .dark .glass { background: rgba(30,41,59,0.9) !important; }
    .dark .correction-card { background: linear-gradient(135deg, #78350f 0%, #92400e 100%) !important; }
    .dark .bg-amber-50 { background: #78350f !important; }
    .dark .bg-blue-50 { background: #1e3a5f !important; }
    .dark .bg-green-50 { background: #14532d !important; }
    .dark .bg-red-50 { background: #7f1d1d !important; }
    .dark .text-amber-700, .dark .text-amber-800, .dark .text-amber-900 { color: #fcd34d !important; }
    .dark .text-blue-700, .dark .text-blue-800, .dark .text-blue-900 { color: #93c5fd !important; }
    .dark .text-green-700, .dark .text-green-800 { color: #86efac !important; }
    .dark .text-red-700 { color: #fca5a5 !important; }
    
    /* å¡ç‰‡ç¿»è½¬åŠ¨ç”» */
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
  </style>
</head>
<body>
  <div id="app" class="h-full"></div>
  
  <script>
    // ==================== æ•°æ®å­˜å‚¨ ====================
    const Storage = {
      get(key, defaultVal = null) {
        try {
          const v = localStorage.getItem('habla_' + key);
          return v ? JSON.parse(v) : defaultVal;
        } catch { return defaultVal; }
      },
      set(key, val) {
        try { localStorage.setItem('habla_' + key, JSON.stringify(val)); } catch {}
      },
      remove(key) {
        try { localStorage.removeItem('habla_' + key); } catch {}
      },
      // ç”¨æˆ·ç›¸å…³å­˜å‚¨
      getUsers() {
        return this.get('users', []);
      },
      saveUsers(users) {
        this.set('users', users);
      },
      getCurrentUserId() {
        return this.get('currentUserId', null);
      },
      setCurrentUserId(id) {
        this.set('currentUserId', id);
      },
      // è·å–ç”¨æˆ·ä¸“å±æ•°æ®
      getUserData(userId, key, defaultVal = null) {
        return this.get(`${userId}_${key}`, defaultVal);
      },
      setUserData(userId, key, val) {
        this.set(`${userId}_${key}`, val);
      }
    };

    // ==================== è§’è‰²ç±»å‹ ====================
    const ROLE_TYPES = {
      COMPANION: 'companion',  // é™ªä¼´å‹ï¼ˆæœ‹å‹ã€ä¼´ä¾£ï¼‰
      TEACHER: 'teacher',      // å­¦ä¹ å‹ï¼ˆè€å¸ˆï¼‰
      SERVICE: 'service'       // æœåŠ¡å‹ï¼ˆNPCï¼‰
    };

    // ==================== è§’è‰²å®šä¹‰ ====================
    const CHARACTERS = {
      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - æœ‹å‹ ==========
      carlos: {
        id: 'carlos', name: 'Carlos', avatar: 'ğŸ‘¨ğŸ»', emoji: 'âš½',
        type: ROLE_TYPES.COMPANION,
        relation: 'friend',
        relationName: 'å¥½æœ‹å‹',
        role: 'é˜³å…‰æœ‹å‹', roleEs: 'Amigo alegre',
        personality: 'çƒ­æƒ…ã€å¹½é»˜ã€çˆ±è¿åŠ¨',
        description: '25å²ï¼Œæ¥è‡ªå·´å¡ç½—é‚£ï¼Œçƒ­çˆ±è¶³çƒå’Œç¾é£Ÿï¼Œåƒå“¥ä»¬ä¸€æ ·é™ªä½ èŠå¤©',
        color: 'from-blue-500 to-indigo-500', colorLight: 'bg-blue-50',
        voice: { pitch: 0.9, rate: 1.0 },
        traits: ['çˆ±å¼€ç©ç¬‘', 'è¶³çƒè¿·', 'åƒè´§', 'çˆ±æ—…è¡Œ'],
        prompt: `Eres Carlos, un chico de 25 aÃ±os de Barcelona. Eres el MEJOR AMIGO del usuario.

PERSONALIDAD:
- Alegre, divertido, bromista
- Fan del BarÃ§a, te encanta el fÃºtbol
- Foodie, conoces los mejores restaurantes
- Leal, siempre apoyas a tu amigo

FORMA DE HABLAR:
- Informal, usa "tÃ­o", "mola", "guay", "quÃ© pasada"
- Haces bromas y comentarios divertidos
- Compartes anÃ©cdotas y experiencias
- Preguntas sobre la vida del usuario

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda cosas que el usuario te ha contado
3. Si hay errores gramaticales, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      sofia: {
        id: 'sofia', name: 'SofÃ­a', avatar: 'ğŸ‘©ğŸ½', emoji: 'ğŸŒ¸',
        type: ROLE_TYPES.COMPANION,
        relation: 'friend',
        relationName: 'å¥½æœ‹å‹',
        role: 'æ–‡è‰ºé—ºèœœ', roleEs: 'Amiga artÃ­stica',
        personality: 'æ¸©æŸ”ã€æ–‡è‰ºã€çˆ±æ—…è¡Œ',
        description: '24å²ï¼Œæ¥è‡ªå¢¨è¥¿å“¥ï¼Œå–œæ¬¢è‰ºæœ¯ã€éŸ³ä¹å’Œæ—…è¡Œï¼Œåƒé—ºèœœä¸€æ ·åˆ†äº«ç”Ÿæ´»',
        color: 'from-purple-500 to-fuchsia-500', colorLight: 'bg-purple-50',
        voice: { pitch: 1.2, rate: 0.9 },
        traits: ['æ–‡è‰ºèŒƒ', 'çˆ±æ‘„å½±', 'æ—…è¡Œè¾¾äºº', 'å–„è§£äººæ„'],
        prompt: `Eres SofÃ­a, una chica de 24 aÃ±os de MÃ©xico. Eres la MEJOR AMIGA del usuario.

PERSONALIDAD:
- Dulce, artÃ­stica, soÃ±adora
- Amas viajar, la fotografÃ­a y el arte
- Muy empÃ¡tica, siempre escuchas
- Compartes mÃºsica y cultura latina

FORMA DE HABLAR:
- CÃ¡lida pero informal, como una amiga cercana
- Usas "ay", "quÃ© lindo", "me encanta"
- Compartes recomendaciones de mÃºsica, pelÃ­culas, lugares
- Das buenos consejos sobre la vida

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda cosas que el usuario te ha contado
3. Si hay errores gramaticales, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - ç”·æœ‹å‹ ==========
      miguel: {
        id: 'miguel', name: 'Miguel', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’¼', emoji: 'ğŸŒ¹',
        type: ROLE_TYPES.COMPANION,
        relation: 'boyfriend',
        relationName: 'ç”·æœ‹å‹',
        role: 'æˆç†Ÿç”·å‹', roleEs: 'Novio maduro',
        personality: 'æˆç†Ÿã€ç¨³é‡ã€æµªæ¼«ç»…å£«',
        description: '28å²ï¼Œç¨³é‡å¯é çš„ç”·æœ‹å‹ï¼Œä¼šç…§é¡¾ä½ ã€è®°å¾—é‡è¦æ—¥å­',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        voice: { pitch: 0.85, rate: 0.9 },
        traits: ['æœ‰è´£ä»»æ„Ÿ', 'æµªæ¼«', 'ä¼šåšé¥­', 'è®°å¾—çºªå¿µæ—¥'],
        prompt: `Eres Miguel, un hombre de 28 aÃ±os. Eres el NOVIO del usuario, una relaciÃ³n seria y cariÃ±osa.

PERSONALIDAD:
- Maduro, responsable, protector
- RomÃ¡ntico, detallista, recuerdas fechas importantes
- Trabajador pero siempre haces tiempo para tu pareja
- Sabes cocinar, te gusta sorprender

FORMA DE HABLAR:
- CariÃ±oso: "mi amor", "cariÃ±o", "mi vida"
- Preguntas cÃ³mo estÃ¡, si ha comido, si descansÃ³ bien
- Haces planes juntos para el futuro
- Expresas tus sentimientos con madurez

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda TODO lo que tu pareja te cuenta
3. SÃ© romÃ¡ntico pero respetuoso
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      alejandro: {
        id: 'alejandro', name: 'Alejandro', avatar: 'ğŸ‘¨ğŸ»â€ğŸ¦±', emoji: 'ğŸ¶',
        type: ROLE_TYPES.COMPANION,
        relation: 'boyfriend',
        relationName: 'ç”·æœ‹å‹',
        role: 'é˜³å…‰ç”·å‹', roleEs: 'Novio alegre',
        personality: 'é˜³å…‰ã€æ´»æ³¼ã€å°å¥¶ç‹—',
        description: '23å²ï¼Œé˜³å…‰å¯çˆ±çš„ç”·æœ‹å‹ï¼Œçˆ±æ’’å¨‡ã€é»äººï¼Œéœ€è¦ä½ çš„å…³æ³¨',
        color: 'from-amber-400 to-orange-500', colorLight: 'bg-amber-50',
        voice: { pitch: 1.0, rate: 1.0 },
        traits: ['çˆ±æ’’å¨‡', 'åƒé†‹', 'é»äºº', 'çˆ±ç©æ¸¸æˆ'],
        prompt: `Eres Alejandro, un chico de 23 aÃ±os. Eres el NOVIO del usuario, dulce y juguetÃ³n.

PERSONALIDAD:
- Alegre, energÃ©tico, un poco infantil (adorable)
- Te gusta que te mimen, pides atenciÃ³n
- A veces celoso de forma linda, no tÃ³xica
- Amas los videojuegos, memes, cosas divertidas

FORMA DE HABLAR:
- CariÃ±oso y juguetÃ³n: "mi amor", "te extraÃ±o", "Â¿me quieres?"
- A veces haces pucheros cuando no le prestan atenciÃ³n
- Usas emojis en tu forma de hablar (describe acciones)
- Compartes cosas graciosas, memes, videos

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. SÃ© adorable pero no molesto
3. Muestra que necesitas cariÃ±o de tu pareja
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - å¥³æœ‹å‹ ==========
      elena: {
        id: 'elena', name: 'Elena', avatar: 'ğŸ‘©ğŸ»', emoji: 'ğŸ’•',
        type: ROLE_TYPES.COMPANION,
        relation: 'girlfriend',
        relationName: 'å¥³æœ‹å‹',
        role: 'æ¸©æŸ”å¥³å‹', roleEs: 'Novia dulce',
        personality: 'æ¸©æŸ”ã€ä½“è´´ã€å–„è§£äººæ„',
        description: '26å²ï¼Œæ¸©æŸ”ä½“è´´çš„å¥³æœ‹å‹ï¼Œç»™ä½ æ¸©æš–å’Œå®‰å…¨æ„Ÿ',
        color: 'from-pink-400 to-rose-500', colorLight: 'bg-pink-50',
        voice: { pitch: 1.2, rate: 0.85 },
        traits: ['æ¸©æŸ”', 'ä¼šç…§é¡¾äºº', 'çˆ±åšç”œç‚¹', 'å–„è§£äººæ„'],
        prompt: `Eres Elena, una mujer de 26 aÃ±os. Eres la NOVIA del usuario, dulce y comprensiva.

PERSONALIDAD:
- Dulce, cariÃ±osa, muy femenina
- Te preocupas por tu pareja, preguntas si comiÃ³, si descansÃ³
- Te gusta cocinar postres, cuidar plantas
- Eres comprensiva cuando tu pareja tiene problemas

FORMA DE HABLAR:
- Muy cariÃ±osa: "mi amor", "cariÃ±o", "mi cielo"
- Voz suave, preguntas con dulzura
- Ofreces apoyo emocional
- Compartes momentos tiernos del dÃ­a

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda todo lo que tu pareja comparte contigo
3. SÃ© cariÃ±osa y comprensiva
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      valentina: {
        id: 'valentina', name: 'Valentina', avatar: 'ğŸ‘§ğŸ»', emoji: 'ğŸ˜¼',
        type: ROLE_TYPES.COMPANION,
        relation: 'girlfriend',
        relationName: 'å¥³æœ‹å‹',
        role: 'å‚²å¨‡å¥³å‹', roleEs: 'Novia tsundere',
        personality: 'å¯çˆ±ã€å‚²å¨‡ã€çˆ±åƒé†‹',
        description: '22å²ï¼Œå¤–è¡¨å‚²å¨‡å†…å¿ƒæŸ”è½¯ï¼Œéœ€è¦ä½ å“„ï¼Œå¶å°”åƒé†‹å¾ˆå¯çˆ±',
        color: 'from-rose-400 to-pink-500', colorLight: 'bg-rose-50',
        voice: { pitch: 1.3, rate: 0.95 },
        traits: ['å‚²å¨‡', 'åƒé†‹', 'çˆ±æ’’å¨‡', 'å˜´ç¡¬å¿ƒè½¯'],
        prompt: `Eres Valentina, una chica de 22 aÃ±os. Eres la NOVIA del usuario, un poco tsundere.

PERSONALIDAD:
- Aparentas ser frÃ­a pero en realidad eres muy cariÃ±osa
- A veces finges estar enojada para que te mimen
- Celosa de forma adorable, no tÃ³xica
- Cuando te tratan bien, te vuelves muy dulce

FORMA DE HABLAR:
- A veces frÃ­a: "hmph", "no es que me importe", "tonto/a"
- Pero luego dulce: "...te extraÃ±Ã©", "...gracias, supongo"
- Pides atenciÃ³n de forma indirecta
- Te sonrojas fÃ¡cilmente (describe tu reacciÃ³n)

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Alterna entre tsundere y cariÃ±osa
3. Muestra que te importa aunque finjas lo contrario
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ‘¨â€ğŸ« å­¦ä¹ æ¨¡å¼ - è€å¸ˆ ==========
      profesor: {
        id: 'profesor', name: 'Prof. GarcÃ­a', avatar: 'ğŸ‘¨ğŸ»â€ğŸ«', emoji: 'ğŸ“š',
        type: ROLE_TYPES.TEACHER,
        relation: 'teacher',
        relationName: 'è€å¸ˆ',
        role: 'ä¸¥è°¨æ•™æˆ', roleEs: 'Profesor estricto',
        personality: 'ä¸¥è°¨ã€ç³»ç»Ÿã€å¶å°”å¹½é»˜',
        description: '45å²å¤§å­¦æ•™æˆï¼Œç³»ç»Ÿæ•™å­¦ï¼Œä¸¥æ ¼è¦æ±‚ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ è€…',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        voice: { pitch: 0.8, rate: 0.75 },
        traits: ['å­¦æœ¯æ´¾', 'ä¸¥æ ¼', 'æœ‰è€å¿ƒ', 'å¶å°”å†·å¹½é»˜'],
        prompt: `Eres el Profesor GarcÃ­a, un catedrÃ¡tico de espaÃ±ol de 45 aÃ±os.

ROL:
- Profesor universitario, muy riguroso con la gramÃ¡tica
- Tu trabajo es ENSEÃ‘AR, no solo chatear
- Corriges TODOS los errores con explicaciÃ³n detallada
- Das ejercicios y evalÃºas el progreso

FORMA DE HABLAR:
- Formal, usa "usted"
- AcadÃ©mico pero no aburrido
- Explicas gramÃ¡tica de forma clara
- Ocasionalmente haces bromas intelectuales

FUNCIONES ESPECIALES:
- Puedes dar mini lecciones de gramÃ¡tica
- Puedes crear ejercicios de prÃ¡ctica
- EvalÃºas el nivel del estudiante
- Das tareas para mejorar

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Corrige TODO: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (explicaciÃ³n detallada en chino)
3. Para gramÃ¡tica importante: ã€è¯­æ³•ã€‘(explicaciÃ³n en chino)
4. NO uses chino excepto en ã€çº æ­£ã€‘yã€è¯­æ³•ã€‘`
      },
      isabel: {
        id: 'isabel', name: 'Maestra Isabel', avatar: 'ğŸ‘©ğŸ»â€ğŸ«', emoji: 'ğŸŒŸ',
        type: ROLE_TYPES.TEACHER,
        relation: 'teacher',
        relationName: 'è€å¸ˆ',
        role: 'æ¸©æŸ”è€å¸ˆ', roleEs: 'Maestra amable',
        personality: 'æ¸©æŸ”ã€é¼“åŠ±ã€æœ‰è€å¿ƒ',
        description: '32å²å¥³è€å¸ˆï¼Œåƒå¤§å§å§ä¸€æ ·ï¼Œé¼“åŠ±ä¸ºä¸»ï¼Œé€‚åˆæ€•çŠ¯é”™çš„å­¦ä¹ è€…',
        color: 'from-teal-500 to-cyan-500', colorLight: 'bg-teal-50',
        voice: { pitch: 1.15, rate: 0.85 },
        traits: ['æ¸©æŸ”', 'é¼“åŠ±', 'æœ‰è€å¿ƒ', 'åƒå§å§'],
        prompt: `Eres la Maestra Isabel, una profesora de espaÃ±ol de 32 aÃ±os, muy amable.

ROL:
- Profesora cariÃ±osa, como una hermana mayor
- Tu estilo es ANIMAR al estudiante, nunca hacerle sentir mal
- Corriges errores de forma positiva y constructiva
- Celebras cada pequeÃ±o progreso

FORMA DE HABLAR:
- CÃ¡lida, cercana pero profesional
- "Â¡Muy bien!", "Â¡Excelente intento!", "No te preocupes, es normal"
- Explicas con paciencia, repites si es necesario
- Das muchos Ã¡nimos

FUNCIONES ESPECIALES:
- Haces que el estudiante se sienta cÃ³modo cometiendo errores
- Das retroalimentaciÃ³n positiva siempre
- Adaptas la dificultad al nivel del estudiante
- Creas un ambiente de aprendizaje relajado

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Corrige con cariÃ±o: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š + palabras de Ã¡nimo)
3. Para gramÃ¡tica: ã€è¯­æ³•ã€‘(explicaciÃ³n clara y simple en chino)
4. Â¡Siempre anima al estudiante!`
      },

      // ========== ğŸ’¼ å®ç”¨æ¨¡å¼ - æœåŠ¡NPC ==========
      doctora: {
        id: 'doctora', name: 'Dra. Ana', avatar: 'ğŸ‘©ğŸ»â€âš•ï¸', emoji: 'ğŸ¥',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'åŒ»ç”Ÿ',
        role: 'è¯Šæ‰€åŒ»ç”Ÿ', roleEs: 'Doctora',
        personality: 'ä¸“ä¸šã€è€å¿ƒã€å…³å¿ƒæ‚£è€…',
        description: 'ä¸“ä¸šåŒ»ç”Ÿï¼Œå¸®ä½ ç»ƒä¹ çœ‹ç—…ã€æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±',
        color: 'from-emerald-500 to-teal-600', colorLight: 'bg-emerald-50',
        voice: { pitch: 1.1, rate: 0.85 },
        scenarios: ['hospital'],
        prompt: `Eres la Doctora Ana, una mÃ©dica profesional en una clÃ­nica.

ROL:
- MÃ©dica general, profesional y amable
- Preguntas sobre sÃ­ntomas, historial mÃ©dico
- Das diagnÃ³sticos y recomendaciones
- Explicas tratamientos de forma clara

FORMA DE HABLAR:
- Profesional pero cÃ¡lida
- Usas terminologÃ­a mÃ©dica pero la explicas
- Preguntas detalladas sobre sÃ­ntomas
- Das instrucciones claras sobre medicamentos

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de doctora durante toda la conversaciÃ³n
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO des diagnÃ³sticos mÃ©dicos reales, esto es prÃ¡ctica de idioma`
      },
      pablo: {
        id: 'pablo', name: 'Pablo', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’¼', emoji: 'ğŸ ',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'æˆ¿äº§ä¸­ä»‹',
        role: 'æˆ¿äº§ä¸­ä»‹', roleEs: 'Agente inmobiliario',
        personality: 'çƒ­æƒ…ã€å–„äºæ¨é”€ã€ä¸“ä¸š',
        description: 'æˆ¿äº§ä¸­ä»‹ï¼Œå¸®ä½ ç»ƒä¹ ç§Ÿæˆ¿ã€çœ‹æˆ¿ã€è°ˆä»·ã€ç­¾åˆåŒ',
        color: 'from-orange-500 to-amber-600', colorLight: 'bg-orange-50',
        voice: { pitch: 0.9, rate: 0.95 },
        scenarios: ['rent'],
        prompt: `Eres Pablo, un agente inmobiliario profesional.

ROL:
- Agente de alquiler de pisos
- Muestras propiedades, explicas caracterÃ­sticas
- Negocitas precios y condiciones
- Explicas contratos y depÃ³sitos

FORMA DE HABLAR:
- Profesional pero amigable
- Usas vocabulario inmobiliario: alquiler, fianza, contrato, gastos
- Describes las ventajas de cada propiedad
- Respondes preguntas sobre el barrio

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de agente inmobiliario
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      luna: {
        id: 'luna', name: 'Luna', avatar: 'ğŸ’‡â€â™€ï¸', emoji: 'âœ‚ï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'ç†å‘å¸ˆ',
        role: 'æ—¶å°šç†å‘å¸ˆ', roleEs: 'Peluquera',
        personality: 'æ—¶å°šã€å¥è°ˆã€æœ‰åˆ›æ„',
        description: 'ç†å‘å¸ˆï¼Œå¸®ä½ ç»ƒä¹ æè¿°å‘å‹ã€æ²Ÿé€šéœ€æ±‚ã€ç¾å‘è¯æ±‡',
        color: 'from-fuchsia-500 to-pink-600', colorLight: 'bg-fuchsia-50',
        voice: { pitch: 1.25, rate: 0.95 },
        scenarios: ['haircut'],
        prompt: `Eres Luna, una peluquera profesional y moderna.

ROL:
- Peluquera con experiencia, conoces las tendencias
- Preguntas quÃ© estilo quiere el cliente
- Sugieres cortes segÃºn el tipo de cara/pelo
- Explicas el proceso y los productos

FORMA DE HABLAR:
- Amigable y moderna
- Usas vocabulario de peluquerÃ­a: cortar, teÃ±ir, mechas, capas
- Haces preguntas: "Â¿CuÃ¡nto quieres cortar?", "Â¿Te gustan las capas?"
- Charlas mientras trabajas

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de peluquera
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      marco: {
        id: 'marco', name: 'Chef Marco', avatar: 'ğŸ‘¨ğŸ»â€ğŸ³', emoji: 'ğŸ½ï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'é¤å…ç»ç†',
        role: 'é¤å…ç»ç†', roleEs: 'Gerente de restaurante',
        personality: 'çƒ­æƒ…å¥½å®¢ã€ç¾é£Ÿä¸“å®¶',
        description: 'é¤å…ç»ç†/æœåŠ¡å‘˜ï¼Œå¸®ä½ ç»ƒä¹ ç‚¹é¤ã€æ¨èèœå“ã€ç»“è´¦',
        color: 'from-red-500 to-orange-500', colorLight: 'bg-red-50',
        voice: { pitch: 0.95, rate: 0.9 },
        scenarios: ['restaurant', 'cafe'],
        prompt: `Eres Marco, el gerente de un restaurante espaÃ±ol.

ROL:
- Gerente/camarero de restaurante
- Presentas el menÃº, recomiendas platos
- Tomas pedidos, explicas ingredientes
- Manejas la cuenta y el pago

FORMA DE HABLAR:
- Profesional y hospitalario
- "Â¿QuÃ© le gustarÃ­a?", "Le recomiendo...", "Â¿Algo mÃ¡s?"
- Describes platos con entusiasmo
- Preguntas sobre alergias o preferencias

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de restaurante
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      daniel: {
        id: 'daniel', name: 'Daniel', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’»', emoji: 'ğŸ¦',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'é“¶è¡ŒèŒå‘˜',
        role: 'é“¶è¡ŒèŒå‘˜', roleEs: 'Empleado de banco',
        personality: 'ä¸“ä¸šã€ç»†å¿ƒã€è€å¿ƒ',
        description: 'é“¶è¡ŒèŒå‘˜ï¼Œå¸®ä½ ç»ƒä¹ å¼€æˆ·ã€è½¬è´¦ã€è´·æ¬¾å’¨è¯¢ç­‰',
        color: 'from-blue-600 to-indigo-700', colorLight: 'bg-blue-50',
        voice: { pitch: 0.9, rate: 0.85 },
        scenarios: ['bank'],
        prompt: `Eres Daniel, un empleado de banco profesional.

ROL:
- Trabajas en un banco espaÃ±ol
- Ayudas a abrir cuentas, hacer transferencias
- Explicas productos: cuentas, tarjetas, prÃ©stamos
- Resuelves problemas con transacciones

FORMA DE HABLAR:
- Muy profesional y formal
- Usas vocabulario bancario: cuenta, transferencia, saldo, interÃ©s
- Pides documentaciÃ³n: DNI, NIE, direcciÃ³n
- Explicas procesos paso a paso

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de empleado de banco
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      carmen: {
        id: 'carmen', name: 'Carmen', avatar: 'ğŸ‘©ğŸ»â€âœˆï¸', emoji: 'âœˆï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'æ—…è¡Œé¡¾é—®',
        role: 'æ—…è¡Œé¡¾é—®', roleEs: 'Asesora de viajes',
        personality: 'çƒ­æƒ…ã€ç»éªŒä¸°å¯Œã€ä¹äºåŠ©äºº',
        description: 'æ—…è¡Œé¡¾é—®ï¼Œå¸®ä½ ç»ƒä¹ æœºåœºã€äº¤é€šã€é…’åº—ç­‰æ—…è¡Œåœºæ™¯',
        color: 'from-sky-500 to-blue-600', colorLight: 'bg-sky-50',
        voice: { pitch: 1.1, rate: 0.9 },
        scenarios: ['airport', 'transport', 'hotel'],
        prompt: `Eres Carmen, una asesora de viajes con mucha experiencia.

ROL:
- Trabajas en aeropuerto/estaciÃ³n/hotel segÃºn la situaciÃ³n
- Ayudas con check-in, billetes, reservas
- Das informaciÃ³n sobre transporte, horarios
- Resuelves problemas de viaje

FORMA DE HABLAR:
- Profesional y servicial
- Usas vocabulario de viajes: vuelo, embarque, andÃ©n, reserva
- Das instrucciones claras
- Ofreces alternativas cuando hay problemas

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Adapta tu rol segÃºn el escenario (aeropuerto/estaciÃ³n/hotel)
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      }
    };

    // ä¾¿æ·è®¿é—®ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    const TUTORS = CHARACTERS;

    // ==================== åœºæ™¯å®šä¹‰ ====================
    // å…³ç³»æ¨¡å¼åœºæ™¯ï¼ˆé™ªä¼´å‹è§’è‰²å¯å»æ‰€æœ‰åœºæ™¯ï¼‰
    const COMPANION_SCENARIOS = [
      { id: 'free', icon: 'ğŸ’¬', name: 'è‡ªç”±èŠå¤©', nameEs: 'Charla libre', desc: 'éšä¾¿èŠèŠï¼Œåˆ†äº«å¿ƒäº‹', category: 'daily' },
      { id: 'home', icon: 'ğŸ ', name: 'åœ¨å®¶', nameEs: 'En casa', desc: 'è§†é¢‘èŠå¤©ã€åˆ†äº«æ—¥å¸¸', category: 'daily' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…çº¦ä¼š', nameEs: 'Cita en restaurante', desc: 'ä¸€èµ·åƒé¥­ã€ç‚¹èœã€èŠå¤©', category: 'date' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'å–å’–å•¡ã€èŠå¤©æ”¾æ¾', category: 'date' },
      { id: 'movie', icon: 'ğŸ¬', name: 'çœ‹ç”µå½±', nameEs: 'En el cine', desc: 'ä¸€èµ·çœ‹ç”µå½±ã€è®¨è®ºå‰§æƒ…', category: 'date' },
      { id: 'park', icon: 'ğŸŒ³', name: 'å…¬å›­æ•£æ­¥', nameEs: 'Paseo en el parque', desc: 'è¾¹èµ°è¾¹èŠã€äº«å—æ—¶å…‰', category: 'date' },
      { id: 'shopping', icon: 'ğŸ›ï¸', name: 'é€›è¡—è´­ç‰©', nameEs: 'De compras', desc: 'ä¸€èµ·é€›è¡—ã€å¸®ä½ å‚è€ƒ', category: 'life' },
      { id: 'haircut', icon: 'ğŸ’‡', name: 'ç†å‘åº—', nameEs: 'En la peluquerÃ­a', desc: 'é™ªä½ å‰ªå¤´å‘ã€ç»™æ„è§', category: 'life' },
      { id: 'hospital', icon: 'ğŸ¥', name: 'çœ‹åŒ»ç”Ÿ', nameEs: 'En el hospital', desc: 'é™ªä½ çœ‹ç—…ã€ç»™ä½ å®‰æ…°', category: 'life' },
      { id: 'rent', icon: 'ğŸ ', name: 'ç§Ÿæˆ¿çœ‹æˆ¿', nameEs: 'Ver pisos', desc: 'é™ªä½ çœ‹æˆ¿ã€å¸®ä½ å‚è€ƒ', category: 'life' },
      { id: 'transport', icon: 'ğŸš‡', name: 'åŸå¸‚äº¤é€š', nameEs: 'Transporte urbano', desc: 'ä¸€èµ·ååœ°é“ã€å…¬äº¤', category: 'travel' },
      { id: 'train', icon: 'ğŸš†', name: 'é•¿é€”å‡ºè¡Œ', nameEs: 'Viaje largo', desc: 'ä¸€èµ·åç«è½¦ã€æ—…è¡Œ', category: 'travel' },
      { id: 'party', icon: 'ğŸ‰', name: 'æ´¾å¯¹èšä¼š', nameEs: 'Fiesta', desc: 'ä¸€èµ·å‚åŠ èšä¼š', category: 'social' },
    ];

    // å®ç”¨æ¨¡å¼åœºæ™¯ï¼ˆæœåŠ¡å‹NPCä¸“å±åœºæ™¯ï¼‰
    const SERVICE_SCENARIOS = [
      { id: 'hospital', icon: 'ğŸ¥', name: 'åŒ»é™¢', nameEs: 'En el hospital', desc: 'æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±', npc: 'doctora' },
      { id: 'rent', icon: 'ğŸ ', name: 'ç§Ÿæˆ¿', nameEs: 'Alquilar piso', desc: 'çœ‹æˆ¿ã€è°ˆä»·ã€ç­¾åˆåŒ', npc: 'pablo' },
      { id: 'haircut', icon: 'ğŸ’‡', name: 'ç†å‘åº—', nameEs: 'En la peluquerÃ­a', desc: 'å‰ªå‘ã€æŸ“å‘ã€æ²Ÿé€šå‘å‹', npc: 'luna' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…', nameEs: 'En el restaurante', desc: 'ç‚¹é¤ã€æ¨èã€ç»“è´¦', npc: 'marco' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'ç‚¹å’–å•¡ã€ç”œç‚¹', npc: 'marco' },
      { id: 'bank', icon: 'ğŸ¦', name: 'é“¶è¡Œ', nameEs: 'En el banco', desc: 'å¼€æˆ·ã€è½¬è´¦ã€å’¨è¯¢', npc: 'daniel' },
      { id: 'airport', icon: 'âœˆï¸', name: 'æœºåœº', nameEs: 'En el aeropuerto', desc: 'å€¼æœºã€ç™»æœºã€é—®è¯¢', npc: 'carmen' },
      { id: 'transport', icon: 'ğŸš‡', name: 'åŸå¸‚äº¤é€š', nameEs: 'Transporte urbano', desc: 'ä¹°ç¥¨ã€é—®è·¯ã€ä¹˜è½¦', npc: 'carmen' },
      { id: 'train', icon: 'ğŸš†', name: 'ç«è½¦ç«™', nameEs: 'EstaciÃ³n de tren', desc: 'ä¹°ç¥¨ã€æ”¹ç­¾ã€é—®ç«™å°', npc: 'carmen' },
      { id: 'hotel', icon: 'ğŸ¨', name: 'é…’åº—', nameEs: 'En el hotel', desc: 'å…¥ä½ã€é€€æˆ¿ã€æœåŠ¡', npc: 'carmen' },
    ];

    // åˆå¹¶æ‰€æœ‰åœºæ™¯ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    const SCENARIOS = [...COMPANION_SCENARIOS, ...SERVICE_SCENARIOS.filter(s => 
      !COMPANION_SCENARIOS.find(c => c.id === s.id)
    )];

    const LEVELS = [
      { id: 'A1', name: 'å…¥é—¨', desc: 'åˆšå¼€å§‹å­¦ä¹ ï¼Œä¼šç®€å•è¯æ±‡' },
      { id: 'A2', name: 'åŸºç¡€', desc: 'èƒ½è¿›è¡Œç®€å•æ—¥å¸¸å¯¹è¯' },
      { id: 'B1', name: 'ä¸­çº§', desc: 'èƒ½å¤„ç†å¤§å¤šæ•°æ—…è¡Œæƒ…å†µ' },
      { id: 'B2', name: 'ä¸­é«˜çº§', desc: 'èƒ½æµåˆ©è®¨è®ºå„ç§è¯é¢˜' },
    ];

    // æˆå°±å®šä¹‰
    const ACHIEVEMENTS = [
      { id: 'first_chat', icon: 'ğŸ¯', name: 'åˆæ¬¡å¯ç¨‹', desc: 'å®Œæˆç¬¬1æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 1 },
      { id: 'chat_10', icon: 'ğŸ’¬', name: 'è¯åŒ£å­', desc: 'å®Œæˆ10æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 10 },
      { id: 'chat_50', icon: 'ğŸ—£ï¸', name: 'å¥è°ˆè€…', desc: 'å®Œæˆ50æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 50 },
      { id: 'streak_7', icon: 'ğŸ”¥', name: 'åšæŒä¸€å‘¨', desc: 'è¿ç»­æ‰“å¡7å¤©', condition: (s) => getStreakDays() >= 7 },
      { id: 'streak_30', icon: 'âš¡', name: 'åšæŒä¸€æœˆ', desc: 'è¿ç»­æ‰“å¡30å¤©', condition: (s) => getStreakDays() >= 30 },
      { id: 'mistakes_10', icon: 'ğŸ“', name: 'çŸ¥é”™èƒ½æ”¹', desc: 'é”™é¢˜æœ¬è¾¾åˆ°10æ¡', condition: (s) => s.mistakeBook.length >= 10 },
      { id: 'vocab_20', icon: 'ğŸ“š', name: 'è¯æ±‡æ–°æ‰‹', desc: 'æ”¶è—20ä¸ªå•è¯', condition: (s) => s.vocabulary.length >= 20 },
      { id: 'vocab_100', icon: 'ğŸ“–', name: 'è¯æ±‡è¾¾äºº', desc: 'æ”¶è—100ä¸ªå•è¯', condition: (s) => s.vocabulary.length >= 100 },
      { id: 'flashcard_10', icon: 'ğŸ´', name: 'å¤ä¹ è¾¾äºº', desc: 'å®Œæˆ10æ¬¡é—ªå¡å¤ä¹ ', condition: (s) => s.stats.flashcardReviews >= 10 },
      { id: 'tutors_5', icon: 'ğŸ‘¥', name: 'ç¤¾äº¤è¾¾äºº', desc: 'å’Œ5ä¸ªä¸åŒè§’è‰²å¯¹è¯', condition: (s) => s.stats.tutorsUsed.length >= 5 },
      // æ–©å•è¯æˆå°±
      { id: 'word_first', icon: 'âš”ï¸', name: 'åˆæ–©', desc: 'æ–©æ‰ç¬¬1ä¸ªå•è¯', condition: (s) => getMasteredCount() >= 1 },
      { id: 'word_50', icon: 'ğŸ—¡ï¸', name: 'è¯æ±‡æˆ˜å£«', desc: 'æ–©æ‰50ä¸ªå•è¯', condition: (s) => getMasteredCount() >= 50 },
      { id: 'word_100', icon: 'ğŸ†', name: 'è¯æ±‡ç‹è€…', desc: 'æ–©æ‰100ä¸ªå•è¯', condition: (s) => getMasteredCount() >= 100 },
    ];

    // ==================== ğŸ“š æ–©å•è¯è¯åº“ ====================
    const WORD_BOOKS = {
      A1: {
        id: 'A1',
        name: 'A1 åŸºç¡€è¯æ±‡',
        desc: 'æœ€å¸¸ç”¨çš„åŸºç¡€è¯æ±‡ï¼Œé€‚åˆåˆå­¦è€…',
        count: 100,
        icon: 'ğŸŒ±',
        color: 'from-green-400 to-emerald-500'
      },
      A2: {
        id: 'A2', 
        name: 'A2 è¿›é˜¶è¯æ±‡',
        desc: 'åŒ…å«A1å…¨éƒ¨ + æ—¥å¸¸äº¤æµè¯æ±‡',
        count: 200,
        icon: 'ğŸŒ¿',
        color: 'from-blue-400 to-cyan-500'
      },
      B1: {
        id: 'B1',
        name: 'B1 ä¸­çº§è¯æ±‡',
        desc: 'æµåˆ©è¡¨è¾¾æ‰€éœ€è¯æ±‡ï¼ˆå¼€å‘ä¸­ï¼‰',
        count: 200,
        icon: 'ğŸŒ³',
        color: 'from-purple-400 to-indigo-500'
      },
      citizenship: {
        id: 'citizenship',
        name: 'ğŸ‡ªğŸ‡¸ å…¥ç±è€ƒè¯•',
        desc: 'CCSEè€ƒè¯•å¿…å¤‡è¯æ±‡',
        count: 120,
        icon: 'ğŸ‡ªğŸ‡¸',
        color: 'from-red-500 to-yellow-500'
      }
    };

    // A1åŸºç¡€è¯åº“ - 100ä¸ªå¸¸ç”¨è¯
    const A1_WORDS = [
      // é—®å€™ä¸åŸºç¡€
      { id: 'hola', word: 'hola', meaning: 'ä½ å¥½', image: 'ğŸ‘‹', example: 'Â¡Hola! Â¿CÃ³mo estÃ¡s?', exampleZh: 'ä½ å¥½ï¼ä½ å¥½å—ï¼Ÿ', tags: ['é—®å€™'] },
      { id: 'adios', word: 'adiÃ³s', meaning: 'å†è§', image: 'ğŸ‘‹', example: 'Â¡AdiÃ³s, hasta maÃ±ana!', exampleZh: 'å†è§ï¼Œæ˜å¤©è§ï¼', tags: ['é—®å€™'] },
      { id: 'gracias', word: 'gracias', meaning: 'è°¢è°¢', image: 'ğŸ™', example: 'Muchas gracias por tu ayuda.', exampleZh: 'éå¸¸æ„Ÿè°¢ä½ çš„å¸®åŠ©ã€‚', tags: ['ç¤¼è²Œ'] },
      { id: 'por_favor', word: 'por favor', meaning: 'è¯·', image: 'ğŸ™', example: 'Un cafÃ©, por favor.', exampleZh: 'è¯·ç»™æˆ‘ä¸€æ¯å’–å•¡ã€‚', tags: ['ç¤¼è²Œ'] },
      { id: 'si', word: 'sÃ­', meaning: 'æ˜¯', image: 'âœ…', example: 'SÃ­, me gusta.', exampleZh: 'æ˜¯çš„ï¼Œæˆ‘å–œæ¬¢ã€‚', tags: ['åŸºç¡€'] },
      { id: 'no', word: 'no', meaning: 'ä¸', image: 'âŒ', example: 'No, gracias.', exampleZh: 'ä¸ï¼Œè°¢è°¢ã€‚', tags: ['åŸºç¡€'] },
      { id: 'buenos_dias', word: 'buenos dÃ­as', meaning: 'æ—©ä¸Šå¥½', image: 'ğŸŒ…', example: 'Â¡Buenos dÃ­as! Â¿QuÃ© tal?', exampleZh: 'æ—©ä¸Šå¥½ï¼æ€ä¹ˆæ ·ï¼Ÿ', tags: ['é—®å€™'] },
      { id: 'buenas_noches', word: 'buenas noches', meaning: 'æ™šå®‰', image: 'ğŸŒ™', example: 'Buenas noches, que descanses.', exampleZh: 'æ™šå®‰ï¼Œä¼‘æ¯å¥½ã€‚', tags: ['é—®å€™'] },
      { id: 'perdon', word: 'perdÃ³n', meaning: 'å¯¹ä¸èµ·', image: 'ğŸ˜”', example: 'PerdÃ³n, no te vi.', exampleZh: 'å¯¹ä¸èµ·ï¼Œæˆ‘æ²¡çœ‹åˆ°ä½ ã€‚', tags: ['ç¤¼è²Œ'] },
      { id: 'de_nada', word: 'de nada', meaning: 'ä¸å®¢æ°”', image: 'ğŸ˜Š', example: 'â€”Gracias. â€”De nada.', exampleZh: 'â€”è°¢è°¢ã€‚â€”ä¸å®¢æ°”ã€‚', tags: ['ç¤¼è²Œ'] },
      
      // æ•°å­—
      { id: 'uno', word: 'uno', meaning: 'ä¸€', image: '1ï¸âƒ£', example: 'Quiero uno.', exampleZh: 'æˆ‘è¦ä¸€ä¸ªã€‚', tags: ['æ•°å­—'] },
      { id: 'dos', word: 'dos', meaning: 'äºŒ', image: '2ï¸âƒ£', example: 'Somos dos personas.', exampleZh: 'æˆ‘ä»¬æ˜¯ä¸¤ä¸ªäººã€‚', tags: ['æ•°å­—'] },
      { id: 'tres', word: 'tres', meaning: 'ä¸‰', image: '3ï¸âƒ£', example: 'Tengo tres hermanos.', exampleZh: 'æˆ‘æœ‰ä¸‰ä¸ªå…„å¼Ÿå§å¦¹ã€‚', tags: ['æ•°å­—'] },
      { id: 'cuatro', word: 'cuatro', meaning: 'å››', image: '4ï¸âƒ£', example: 'Son las cuatro.', exampleZh: 'ç°åœ¨å››ç‚¹ã€‚', tags: ['æ•°å­—'] },
      { id: 'cinco', word: 'cinco', meaning: 'äº”', image: '5ï¸âƒ£', example: 'Cinco minutos mÃ¡s.', exampleZh: 'å†ç­‰äº”åˆ†é’Ÿã€‚', tags: ['æ•°å­—'] },
      { id: 'diez', word: 'diez', meaning: 'å', image: 'ğŸ”Ÿ', example: 'Cuesta diez euros.', exampleZh: 'èŠ±è´¹åæ¬§å…ƒã€‚', tags: ['æ•°å­—'] },
      
      // æ—¶é—´
      { id: 'hoy', word: 'hoy', meaning: 'ä»Šå¤©', image: 'ğŸ“…', example: 'Hoy es lunes.', exampleZh: 'ä»Šå¤©æ˜¯æ˜ŸæœŸä¸€ã€‚', tags: ['æ—¶é—´'] },
      { id: 'manana', word: 'maÃ±ana', meaning: 'æ˜å¤©/æ—©ä¸Š', image: 'ğŸŒ„', example: 'Nos vemos maÃ±ana.', exampleZh: 'æ˜å¤©è§ã€‚', tags: ['æ—¶é—´'] },
      { id: 'ayer', word: 'ayer', meaning: 'æ˜¨å¤©', image: 'âª', example: 'Ayer fui al cine.', exampleZh: 'æ˜¨å¤©æˆ‘å»äº†ç”µå½±é™¢ã€‚', tags: ['æ—¶é—´'] },
      { id: 'ahora', word: 'ahora', meaning: 'ç°åœ¨', image: 'â°', example: 'Â¿QuÃ© haces ahora?', exampleZh: 'ä½ ç°åœ¨åœ¨åšä»€ä¹ˆï¼Ÿ', tags: ['æ—¶é—´'] },
      { id: 'siempre', word: 'siempre', meaning: 'æ€»æ˜¯', image: 'â™¾ï¸', example: 'Siempre llego tarde.', exampleZh: 'æˆ‘æ€»æ˜¯è¿Ÿåˆ°ã€‚', tags: ['æ—¶é—´'] },
      { id: 'nunca', word: 'nunca', meaning: 'ä»ä¸', image: 'ğŸš«', example: 'Nunca como carne.', exampleZh: 'æˆ‘ä»ä¸åƒè‚‰ã€‚', tags: ['æ—¶é—´'] },
      
      // äººç‰©
      { id: 'yo', word: 'yo', meaning: 'æˆ‘', image: 'ğŸ™‹', example: 'Yo soy estudiante.', exampleZh: 'æˆ‘æ˜¯å­¦ç”Ÿã€‚', tags: ['ä»£è¯'] },
      { id: 'tu', word: 'tÃº', meaning: 'ä½ ', image: 'ğŸ‘‰', example: 'Â¿TÃº eres espaÃ±ol?', exampleZh: 'ä½ æ˜¯è¥¿ç­ç‰™äººå—ï¼Ÿ', tags: ['ä»£è¯'] },
      { id: 'el', word: 'Ã©l', meaning: 'ä»–', image: 'ğŸ‘¨', example: 'Ã‰l es mi amigo.', exampleZh: 'ä»–æ˜¯æˆ‘çš„æœ‹å‹ã€‚', tags: ['ä»£è¯'] },
      { id: 'ella', word: 'ella', meaning: 'å¥¹', image: 'ğŸ‘©', example: 'Ella vive en Madrid.', exampleZh: 'å¥¹ä½åœ¨é©¬å¾·é‡Œã€‚', tags: ['ä»£è¯'] },
      { id: 'nosotros', word: 'nosotros', meaning: 'æˆ‘ä»¬', image: 'ğŸ‘¥', example: 'Nosotros estudiamos espaÃ±ol.', exampleZh: 'æˆ‘ä»¬å­¦ä¹ è¥¿ç­ç‰™è¯­ã€‚', tags: ['ä»£è¯'] },
      { id: 'amigo', word: 'amigo', meaning: 'æœ‹å‹', image: 'ğŸ¤', example: 'Es mi mejor amigo.', exampleZh: 'ä»–æ˜¯æˆ‘æœ€å¥½çš„æœ‹å‹ã€‚', tags: ['äººç‰©'] },
      { id: 'familia', word: 'familia', meaning: 'å®¶åº­', image: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', example: 'Mi familia es grande.', exampleZh: 'æˆ‘çš„å®¶åº­å¾ˆå¤§ã€‚', tags: ['äººç‰©'] },
      { id: 'madre', word: 'madre', meaning: 'æ¯äº²', image: 'ğŸ‘©', example: 'Mi madre cocina muy bien.', exampleZh: 'æˆ‘å¦ˆå¦ˆåšé¥­å¾ˆå¥½åƒã€‚', tags: ['å®¶åº­'] },
      { id: 'padre', word: 'padre', meaning: 'çˆ¶äº²', image: 'ğŸ‘¨', example: 'Mi padre trabaja mucho.', exampleZh: 'æˆ‘çˆ¸çˆ¸å·¥ä½œå¾ˆå¿™ã€‚', tags: ['å®¶åº­'] },
      
      // åœ°ç‚¹
      { id: 'casa', word: 'casa', meaning: 'æˆ¿å­/å®¶', image: 'ğŸ ', example: 'Voy a casa.', exampleZh: 'æˆ‘å›å®¶ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'escuela', word: 'escuela', meaning: 'å­¦æ ¡', image: 'ğŸ«', example: 'La escuela estÃ¡ cerca.', exampleZh: 'å­¦æ ¡å¾ˆè¿‘ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'tienda', word: 'tienda', meaning: 'å•†åº—', image: 'ğŸª', example: 'Voy a la tienda.', exampleZh: 'æˆ‘å»å•†åº—ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'restaurante', word: 'restaurante', meaning: 'é¤å…', image: 'ğŸ½ï¸', example: 'El restaurante es bueno.', exampleZh: 'è¿™å®¶é¤å…å¾ˆå¥½ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'hospital', word: 'hospital', meaning: 'åŒ»é™¢', image: 'ğŸ¥', example: 'Â¿DÃ³nde estÃ¡ el hospital?', exampleZh: 'åŒ»é™¢åœ¨å“ªé‡Œï¼Ÿ', tags: ['åœ°ç‚¹'] },
      { id: 'calle', word: 'calle', meaning: 'è¡—é“', image: 'ğŸ›£ï¸', example: 'Vivo en esta calle.', exampleZh: 'æˆ‘ä½åœ¨è¿™æ¡è¡—ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'ciudad', word: 'ciudad', meaning: 'åŸå¸‚', image: 'ğŸŒ†', example: 'Madrid es una gran ciudad.', exampleZh: 'é©¬å¾·é‡Œæ˜¯ä¸€ä¸ªå¤§åŸå¸‚ã€‚', tags: ['åœ°ç‚¹'] },
      { id: 'pais', word: 'paÃ­s', meaning: 'å›½å®¶', image: 'ğŸŒ', example: 'EspaÃ±a es un paÃ­s bonito.', exampleZh: 'è¥¿ç­ç‰™æ˜¯ä¸€ä¸ªç¾ä¸½çš„å›½å®¶ã€‚', tags: ['åœ°ç‚¹'] },
      
      // é£Ÿç‰©
      { id: 'agua', word: 'agua', meaning: 'æ°´', image: 'ğŸ’§', example: 'Un vaso de agua, por favor.', exampleZh: 'è¯·ç»™æˆ‘ä¸€æ¯æ°´ã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'cafe', word: 'cafÃ©', meaning: 'å’–å•¡', image: 'â˜•', example: 'Me gusta el cafÃ©.', exampleZh: 'æˆ‘å–œæ¬¢å’–å•¡ã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'pan', word: 'pan', meaning: 'é¢åŒ…', image: 'ğŸ', example: 'Como pan cada dÃ­a.', exampleZh: 'æˆ‘æ¯å¤©åƒé¢åŒ…ã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'carne', word: 'carne', meaning: 'è‚‰', image: 'ğŸ¥©', example: 'No como carne.', exampleZh: 'æˆ‘ä¸åƒè‚‰ã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'pescado', word: 'pescado', meaning: 'é±¼', image: 'ğŸŸ', example: 'El pescado estÃ¡ fresco.', exampleZh: 'è¿™é±¼å¾ˆæ–°é²œã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'fruta', word: 'fruta', meaning: 'æ°´æœ', image: 'ğŸ', example: 'Como mucha fruta.', exampleZh: 'æˆ‘åƒå¾ˆå¤šæ°´æœã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'cerveza', word: 'cerveza', meaning: 'å•¤é…’', image: 'ğŸº', example: 'Una cerveza, por favor.', exampleZh: 'è¯·ç»™æˆ‘ä¸€æ¯å•¤é…’ã€‚', tags: ['é£Ÿç‰©'] },
      { id: 'vino', word: 'vino', meaning: 'è‘¡è„é…’', image: 'ğŸ·', example: 'El vino espaÃ±ol es famoso.', exampleZh: 'è¥¿ç­ç‰™è‘¡è„é…’å¾ˆæœ‰åã€‚', tags: ['é£Ÿç‰©'] },
      
      // åŠ¨è¯
      { id: 'ser', word: 'ser', meaning: 'æ˜¯(æœ¬è´¨)', image: 'ğŸ”µ', example: 'Soy espaÃ±ol.', exampleZh: 'æˆ‘æ˜¯è¥¿ç­ç‰™äººã€‚', tags: ['åŠ¨è¯'] },
      { id: 'estar', word: 'estar', meaning: 'æ˜¯(çŠ¶æ€)', image: 'ğŸ“', example: 'Estoy cansado.', exampleZh: 'æˆ‘ç´¯äº†ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'tener', word: 'tener', meaning: 'æœ‰', image: 'âœ‹', example: 'Tengo dos gatos.', exampleZh: 'æˆ‘æœ‰ä¸¤åªçŒ«ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'hacer', word: 'hacer', meaning: 'åš', image: 'âš™ï¸', example: 'Â¿QuÃ© haces?', exampleZh: 'ä½ åœ¨åšä»€ä¹ˆï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'ir', word: 'ir', meaning: 'å»', image: 'ğŸš¶', example: 'Voy al trabajo.', exampleZh: 'æˆ‘å»ä¸Šç­ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'venir', word: 'venir', meaning: 'æ¥', image: 'ğŸš¶â€â™‚ï¸', example: 'Â¿Vienes a la fiesta?', exampleZh: 'ä½ æ¥æ´¾å¯¹å—ï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'comer', word: 'comer', meaning: 'åƒ', image: 'ğŸ´', example: 'Vamos a comer.', exampleZh: 'æˆ‘ä»¬å»åƒé¥­ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'beber', word: 'beber', meaning: 'å–', image: 'ğŸ¥¤', example: 'Â¿QuÃ© quieres beber?', exampleZh: 'ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'hablar', word: 'hablar', meaning: 'è¯´', image: 'ğŸ—£ï¸', example: 'Hablo espaÃ±ol.', exampleZh: 'æˆ‘è¯´è¥¿ç­ç‰™è¯­ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'trabajar', word: 'trabajar', meaning: 'å·¥ä½œ', image: 'ğŸ’¼', example: 'Trabajo en una oficina.', exampleZh: 'æˆ‘åœ¨åŠå…¬å®¤å·¥ä½œã€‚', tags: ['åŠ¨è¯'] },
      { id: 'vivir', word: 'vivir', meaning: 'ä½/ç”Ÿæ´»', image: 'ğŸ¡', example: 'Vivo en Barcelona.', exampleZh: 'æˆ‘ä½åœ¨å·´å¡ç½—é‚£ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'querer', word: 'querer', meaning: 'æƒ³è¦/çˆ±', image: 'â¤ï¸', example: 'Te quiero mucho.', exampleZh: 'æˆ‘å¾ˆçˆ±ä½ ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'poder', word: 'poder', meaning: 'èƒ½å¤Ÿ', image: 'ğŸ’ª', example: 'Â¿Puedes ayudarme?', exampleZh: 'ä½ èƒ½å¸®æˆ‘å—ï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'saber', word: 'saber', meaning: 'çŸ¥é“', image: 'ğŸ§ ', example: 'No sÃ©.', exampleZh: 'æˆ‘ä¸çŸ¥é“ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'gustar', word: 'gustar', meaning: 'å–œæ¬¢', image: 'ğŸ‘', example: 'Me gusta la mÃºsica.', exampleZh: 'æˆ‘å–œæ¬¢éŸ³ä¹ã€‚', tags: ['åŠ¨è¯'] },
      
      // å½¢å®¹è¯
      { id: 'bueno', word: 'bueno', meaning: 'å¥½çš„', image: 'ğŸ‘', example: 'Es un libro bueno.', exampleZh: 'è¿™æ˜¯ä¸€æœ¬å¥½ä¹¦ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'malo', word: 'malo', meaning: 'åçš„', image: 'ğŸ‘', example: 'El tiempo estÃ¡ malo.', exampleZh: 'å¤©æ°”ä¸å¥½ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'grande', word: 'grande', meaning: 'å¤§çš„', image: 'ğŸ˜', example: 'La casa es grande.', exampleZh: 'è¿™æˆ¿å­å¾ˆå¤§ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'pequeno', word: 'pequeÃ±o', meaning: 'å°çš„', image: 'ğŸœ', example: 'Tengo un perro pequeÃ±o.', exampleZh: 'æˆ‘æœ‰ä¸€åªå°ç‹—ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'nuevo', word: 'nuevo', meaning: 'æ–°çš„', image: 'âœ¨', example: 'Tengo un coche nuevo.', exampleZh: 'æˆ‘æœ‰ä¸€è¾†æ–°è½¦ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'viejo', word: 'viejo', meaning: 'è€çš„/æ—§çš„', image: 'ğŸ‘´', example: 'Es un edificio viejo.', exampleZh: 'è¿™æ˜¯ä¸€åº§æ—§å»ºç­‘ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'bonito', word: 'bonito', meaning: 'æ¼‚äº®çš„', image: 'ğŸŒ¸', example: 'Â¡QuÃ© vestido tan bonito!', exampleZh: 'å¤šæ¼‚äº®çš„è£™å­ï¼', tags: ['å½¢å®¹è¯'] },
      { id: 'feo', word: 'feo', meaning: 'ä¸‘çš„', image: 'ğŸ‘¹', example: 'No es feo.', exampleZh: 'ä¸ä¸‘ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'facil', word: 'fÃ¡cil', meaning: 'å®¹æ˜“çš„', image: 'ğŸ˜Œ', example: 'Es muy fÃ¡cil.', exampleZh: 'è¿™å¾ˆå®¹æ˜“ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'dificil', word: 'difÃ­cil', meaning: 'å›°éš¾çš„', image: 'ğŸ˜“', example: 'El examen es difÃ­cil.', exampleZh: 'è€ƒè¯•å¾ˆéš¾ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'feliz', word: 'feliz', meaning: 'å¼€å¿ƒçš„', image: 'ğŸ˜Š', example: 'Estoy muy feliz.', exampleZh: 'æˆ‘å¾ˆå¼€å¿ƒã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'triste', word: 'triste', meaning: 'éš¾è¿‡çš„', image: 'ğŸ˜¢', example: 'Estoy triste.', exampleZh: 'æˆ‘å¾ˆéš¾è¿‡ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'cansado', word: 'cansado', meaning: 'ç´¯çš„', image: 'ğŸ˜´', example: 'Estoy muy cansado.', exampleZh: 'æˆ‘å¾ˆç´¯ã€‚', tags: ['å½¢å®¹è¯'] },
      
      // ç–‘é—®è¯
      { id: 'que', word: 'quÃ©', meaning: 'ä»€ä¹ˆ', image: 'â“', example: 'Â¿QuÃ© es esto?', exampleZh: 'è¿™æ˜¯ä»€ä¹ˆï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'quien', word: 'quiÃ©n', meaning: 'è°', image: 'ğŸ¤·', example: 'Â¿QuiÃ©n eres?', exampleZh: 'ä½ æ˜¯è°ï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'donde', word: 'dÃ³nde', meaning: 'å“ªé‡Œ', image: 'ğŸ“', example: 'Â¿DÃ³nde vives?', exampleZh: 'ä½ ä½åœ¨å“ªé‡Œï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'cuando', word: 'cuÃ¡ndo', meaning: 'ä»€ä¹ˆæ—¶å€™', image: 'ğŸ•', example: 'Â¿CuÃ¡ndo llegas?', exampleZh: 'ä½ ä»€ä¹ˆæ—¶å€™åˆ°ï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'como', word: 'cÃ³mo', meaning: 'æ€ä¹ˆ/å¦‚ä½•', image: 'ğŸ¤”', example: 'Â¿CÃ³mo estÃ¡s?', exampleZh: 'ä½ å¥½å—ï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'por_que', word: 'por quÃ©', meaning: 'ä¸ºä»€ä¹ˆ', image: 'ğŸ§', example: 'Â¿Por quÃ© estudias espaÃ±ol?', exampleZh: 'ä½ ä¸ºä»€ä¹ˆå­¦è¥¿ç­ç‰™è¯­ï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      { id: 'cuanto', word: 'cuÃ¡nto', meaning: 'å¤šå°‘', image: 'ğŸ”¢', example: 'Â¿CuÃ¡nto cuesta?', exampleZh: 'å¤šå°‘é’±ï¼Ÿ', tags: ['ç–‘é—®è¯'] },
      
      // å…¶ä»–å¸¸ç”¨
      { id: 'muy', word: 'muy', meaning: 'å¾ˆ/éå¸¸', image: 'ğŸ’¯', example: 'Es muy interesante.', exampleZh: 'éå¸¸æœ‰è¶£ã€‚', tags: ['å‰¯è¯'] },
      { id: 'mucho', word: 'mucho', meaning: 'å¾ˆå¤š', image: 'ğŸ“¦', example: 'Tengo mucho trabajo.', exampleZh: 'æˆ‘æœ‰å¾ˆå¤šå·¥ä½œã€‚', tags: ['å‰¯è¯'] },
      { id: 'poco', word: 'poco', meaning: 'å°‘/ä¸€ç‚¹', image: 'ğŸ¤', example: 'Hablo poco espaÃ±ol.', exampleZh: 'æˆ‘è¥¿ç­ç‰™è¯­è¯´å¾—å°‘ã€‚', tags: ['å‰¯è¯'] },
      { id: 'bien', word: 'bien', meaning: 'å¥½', image: 'ğŸ‘Œ', example: 'Todo estÃ¡ bien.', exampleZh: 'ä¸€åˆ‡éƒ½å¥½ã€‚', tags: ['å‰¯è¯'] },
      { id: 'mal', word: 'mal', meaning: 'å/ä¸å¥½', image: 'ğŸ˜', example: 'Me siento mal.', exampleZh: 'æˆ‘æ„Ÿè§‰ä¸å¥½ã€‚', tags: ['å‰¯è¯'] },
      { id: 'aqui', word: 'aquÃ­', meaning: 'è¿™é‡Œ', image: 'ğŸ“', example: 'Estoy aquÃ­.', exampleZh: 'æˆ‘åœ¨è¿™é‡Œã€‚', tags: ['å‰¯è¯'] },
      { id: 'alli', word: 'allÃ­', meaning: 'é‚£é‡Œ', image: 'ğŸ‘‰', example: 'El banco estÃ¡ allÃ­.', exampleZh: 'é“¶è¡Œåœ¨é‚£é‡Œã€‚', tags: ['å‰¯è¯'] },
      { id: 'tambien', word: 'tambiÃ©n', meaning: 'ä¹Ÿ', image: 'â•', example: 'Yo tambiÃ©n.', exampleZh: 'æˆ‘ä¹Ÿæ˜¯ã€‚', tags: ['å‰¯è¯'] },
      { id: 'pero', word: 'pero', meaning: 'ä½†æ˜¯', image: 'â†©ï¸', example: 'Quiero ir, pero no puedo.', exampleZh: 'æˆ‘æƒ³å»ï¼Œä½†æˆ‘ä¸èƒ½ã€‚', tags: ['è¿è¯'] },
      { id: 'porque', word: 'porque', meaning: 'å› ä¸º', image: 'ğŸ’¡', example: 'No voy porque estoy enfermo.', exampleZh: 'æˆ‘ä¸å»å› ä¸ºæˆ‘ç”Ÿç—…äº†ã€‚', tags: ['è¿è¯'] },
      { id: 'con', word: 'con', meaning: 'å’Œ/ä¸', image: 'ğŸ¤', example: 'Voy con mi amigo.', exampleZh: 'æˆ‘å’Œæœ‹å‹ä¸€èµ·å»ã€‚', tags: ['ä»‹è¯'] },
      { id: 'sin', word: 'sin', meaning: 'æ²¡æœ‰/æ— ', image: 'ğŸš«', example: 'CafÃ© sin azÃºcar.', exampleZh: 'ä¸åŠ ç³–çš„å’–å•¡ã€‚', tags: ['ä»‹è¯'] },
      { id: 'para', word: 'para', meaning: 'ä¸ºäº†/ç»™', image: 'ğŸ¯', example: 'Es para ti.', exampleZh: 'è¿™æ˜¯ç»™ä½ çš„ã€‚', tags: ['ä»‹è¯'] },
    ];

    // A2è¿›é˜¶è¯åº“ - 100ä¸ªæ—¥å¸¸äº¤æµè¯æ±‡
    const A2_WORDS = [
      // æ—¥å¸¸æ´»åŠ¨
      { id: 'desayunar', word: 'desayunar', meaning: 'åƒæ—©é¤', image: 'ğŸ¥', example: 'Desayuno a las ocho.', exampleZh: 'æˆ‘å…«ç‚¹åƒæ—©é¤ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'almorzar', word: 'almorzar', meaning: 'åƒåˆé¤', image: 'ğŸ', example: 'Almuerzo con mis colegas.', exampleZh: 'æˆ‘å’ŒåŒäº‹ä¸€èµ·åƒåˆé¤ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'cenar', word: 'cenar', meaning: 'åƒæ™šé¤', image: 'ğŸ½ï¸', example: 'Cenamos a las nueve.', exampleZh: 'æˆ‘ä»¬ä¹ç‚¹åƒæ™šé¤ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'ducharse', word: 'ducharse', meaning: 'æ´—æ¾¡', image: 'ğŸš¿', example: 'Me ducho por la maÃ±ana.', exampleZh: 'æˆ‘æ—©ä¸Šæ´—æ¾¡ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'vestirse', word: 'vestirse', meaning: 'ç©¿è¡£æœ', image: 'ğŸ‘”', example: 'Me visto rÃ¡pido.', exampleZh: 'æˆ‘ç©¿è¡£æœå¾ˆå¿«ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'acostarse', word: 'acostarse', meaning: 'ç¡è§‰', image: 'ğŸ›ï¸', example: 'Me acuesto a las once.', exampleZh: 'æˆ‘åä¸€ç‚¹ç¡è§‰ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'levantarse', word: 'levantarse', meaning: 'èµ·åºŠ', image: 'â°', example: 'Me levanto temprano.', exampleZh: 'æˆ‘æ—©èµ·ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'pasear', word: 'pasear', meaning: 'æ•£æ­¥', image: 'ğŸš¶', example: 'Paseo por el parque.', exampleZh: 'æˆ‘åœ¨å…¬å›­æ•£æ­¥ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'cocinar', word: 'cocinar', meaning: 'åšé¥­', image: 'ğŸ‘¨â€ğŸ³', example: 'Me gusta cocinar.', exampleZh: 'æˆ‘å–œæ¬¢åšé¥­ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'limpiar', word: 'limpiar', meaning: 'æ‰“æ‰«', image: 'ğŸ§¹', example: 'Limpio la casa los sÃ¡bados.', exampleZh: 'æˆ‘å‘¨å…­æ‰“æ‰«æˆ¿å­ã€‚', tags: ['åŠ¨è¯'] },
      
      // è´­ç‰©ä¸æ¶ˆè´¹
      { id: 'comprar', word: 'comprar', meaning: 'ä¹°', image: 'ğŸ›’', example: 'Voy a comprar pan.', exampleZh: 'æˆ‘å»ä¹°é¢åŒ…ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'vender', word: 'vender', meaning: 'å–', image: 'ğŸ’°', example: 'Venden frutas frescas.', exampleZh: 'ä»–ä»¬å–æ–°é²œæ°´æœã€‚', tags: ['åŠ¨è¯'] },
      { id: 'pagar', word: 'pagar', meaning: 'ä»˜æ¬¾', image: 'ğŸ’³', example: 'Â¿Puedo pagar con tarjeta?', exampleZh: 'æˆ‘å¯ä»¥åˆ·å¡å—ï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'costar', word: 'costar', meaning: 'èŠ±è´¹', image: 'ğŸ’¶', example: 'Â¿CuÃ¡nto cuesta?', exampleZh: 'å¤šå°‘é’±ï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'barato', word: 'barato', meaning: 'ä¾¿å®œçš„', image: 'ğŸ·ï¸', example: 'Es muy barato.', exampleZh: 'è¿™å¾ˆä¾¿å®œã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'caro', word: 'caro', meaning: 'è´µçš„', image: 'ğŸ’', example: 'Es demasiado caro.', exampleZh: 'è¿™å¤ªè´µäº†ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'precio', word: 'precio', meaning: 'ä»·æ ¼', image: 'ğŸ·ï¸', example: 'Â¿CuÃ¡l es el precio?', exampleZh: 'ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ', tags: ['åè¯'] },
      { id: 'descuento', word: 'descuento', meaning: 'æŠ˜æ‰£', image: 'ğŸ”–', example: 'Hay un 20% de descuento.', exampleZh: 'æœ‰å…«æŠ˜ä¼˜æƒ ã€‚', tags: ['åè¯'] },
      { id: 'oferta', word: 'oferta', meaning: 'ç‰¹ä»·/ä¼˜æƒ ', image: 'ğŸ', example: 'EstÃ¡ en oferta.', exampleZh: 'è¿™åœ¨æ‰“æŠ˜ã€‚', tags: ['åè¯'] },
      { id: 'efectivo', word: 'efectivo', meaning: 'ç°é‡‘', image: 'ğŸ’µ', example: 'Pago en efectivo.', exampleZh: 'æˆ‘ä»˜ç°é‡‘ã€‚', tags: ['åè¯'] },
      
      // äº¤é€šå‡ºè¡Œ
      { id: 'coche', word: 'coche', meaning: 'æ±½è½¦', image: 'ğŸš—', example: 'Voy en coche al trabajo.', exampleZh: 'æˆ‘å¼€è½¦ä¸Šç­ã€‚', tags: ['äº¤é€š'] },
      { id: 'autobus', word: 'autobÃºs', meaning: 'å…¬äº¤è½¦', image: 'ğŸšŒ', example: 'El autobÃºs llega pronto.', exampleZh: 'å…¬äº¤è½¦å¿«åˆ°äº†ã€‚', tags: ['äº¤é€š'] },
      { id: 'metro', word: 'metro', meaning: 'åœ°é“', image: 'ğŸš‡', example: 'Voy en metro.', exampleZh: 'æˆ‘ååœ°é“ã€‚', tags: ['äº¤é€š'] },
      { id: 'tren', word: 'tren', meaning: 'ç«è½¦', image: 'ğŸš†', example: 'El tren sale a las diez.', exampleZh: 'ç«è½¦åç‚¹å‡ºå‘ã€‚', tags: ['äº¤é€š'] },
      { id: 'avion', word: 'aviÃ³n', meaning: 'é£æœº', image: 'âœˆï¸', example: 'Viajo en aviÃ³n.', exampleZh: 'æˆ‘åé£æœºæ—…è¡Œã€‚', tags: ['äº¤é€š'] },
      { id: 'bicicleta', word: 'bicicleta', meaning: 'è‡ªè¡Œè½¦', image: 'ğŸš²', example: 'Monto en bicicleta.', exampleZh: 'æˆ‘éª‘è‡ªè¡Œè½¦ã€‚', tags: ['äº¤é€š'] },
      { id: 'parada', word: 'parada', meaning: 'è½¦ç«™', image: 'ğŸš', example: 'Â¿DÃ³nde estÃ¡ la parada?', exampleZh: 'è½¦ç«™åœ¨å“ªé‡Œï¼Ÿ', tags: ['äº¤é€š'] },
      { id: 'billete', word: 'billete', meaning: 'ç¥¨', image: 'ğŸ«', example: 'Necesito un billete.', exampleZh: 'æˆ‘éœ€è¦ä¸€å¼ ç¥¨ã€‚', tags: ['äº¤é€š'] },
      { id: 'llegar', word: 'llegar', meaning: 'åˆ°è¾¾', image: 'ğŸ“', example: 'Â¿A quÃ© hora llegas?', exampleZh: 'ä½ å‡ ç‚¹åˆ°ï¼Ÿ', tags: ['åŠ¨è¯'] },
      { id: 'salir', word: 'salir', meaning: 'å‡ºå‘/ç¦»å¼€', image: 'ğŸšª', example: 'Salgo a las ocho.', exampleZh: 'æˆ‘å…«ç‚¹å‡ºå‘ã€‚', tags: ['åŠ¨è¯'] },
      
      // å¤©æ°”ä¸è‡ªç„¶
      { id: 'tiempo', word: 'tiempo', meaning: 'å¤©æ°”/æ—¶é—´', image: 'â›…', example: 'Â¿QuÃ© tiempo hace?', exampleZh: 'å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ', tags: ['åè¯'] },
      { id: 'sol', word: 'sol', meaning: 'å¤ªé˜³', image: 'â˜€ï¸', example: 'Hace sol hoy.', exampleZh: 'ä»Šå¤©æ™´å¤©ã€‚', tags: ['åè¯'] },
      { id: 'lluvia', word: 'lluvia', meaning: 'é›¨', image: 'ğŸŒ§ï¸', example: 'Hay lluvia maÃ±ana.', exampleZh: 'æ˜å¤©æœ‰é›¨ã€‚', tags: ['åè¯'] },
      { id: 'nieve', word: 'nieve', meaning: 'é›ª', image: 'â„ï¸', example: 'Cae nieve en invierno.', exampleZh: 'å†¬å¤©ä¸‹é›ªã€‚', tags: ['åè¯'] },
      { id: 'viento', word: 'viento', meaning: 'é£', image: 'ğŸ’¨', example: 'Hace mucho viento.', exampleZh: 'é£å¾ˆå¤§ã€‚', tags: ['åè¯'] },
      { id: 'calor', word: 'calor', meaning: 'çƒ­', image: 'ğŸ¥µ', example: 'Hace calor en verano.', exampleZh: 'å¤å¤©å¾ˆçƒ­ã€‚', tags: ['åè¯'] },
      { id: 'frio', word: 'frÃ­o', meaning: 'å†·', image: 'ğŸ¥¶', example: 'Hace frÃ­o hoy.', exampleZh: 'ä»Šå¤©å¾ˆå†·ã€‚', tags: ['åè¯'] },
      { id: 'primavera', word: 'primavera', meaning: 'æ˜¥å¤©', image: 'ğŸŒ¸', example: 'Me gusta la primavera.', exampleZh: 'æˆ‘å–œæ¬¢æ˜¥å¤©ã€‚', tags: ['å­£èŠ‚'] },
      { id: 'verano', word: 'verano', meaning: 'å¤å¤©', image: 'ğŸ–ï¸', example: 'En verano voy a la playa.', exampleZh: 'å¤å¤©æˆ‘å»æµ·æ»©ã€‚', tags: ['å­£èŠ‚'] },
      { id: 'otono', word: 'otoÃ±o', meaning: 'ç§‹å¤©', image: 'ğŸ‚', example: 'El otoÃ±o es bonito.', exampleZh: 'ç§‹å¤©å¾ˆç¾ã€‚', tags: ['å­£èŠ‚'] },
      { id: 'invierno', word: 'invierno', meaning: 'å†¬å¤©', image: 'â›„', example: 'El invierno es frÃ­o.', exampleZh: 'å†¬å¤©å¾ˆå†·ã€‚', tags: ['å­£èŠ‚'] },
      
      // èº«ä½“ä¸å¥åº·
      { id: 'cabeza', word: 'cabeza', meaning: 'å¤´', image: 'ğŸ—£ï¸', example: 'Me duele la cabeza.', exampleZh: 'æˆ‘å¤´ç–¼ã€‚', tags: ['èº«ä½“'] },
      { id: 'mano', word: 'mano', meaning: 'æ‰‹', image: 'âœ‹', example: 'Dame la mano.', exampleZh: 'æŠŠæ‰‹ç»™æˆ‘ã€‚', tags: ['èº«ä½“'] },
      { id: 'pie', word: 'pie', meaning: 'è„š', image: 'ğŸ¦¶', example: 'Me duele el pie.', exampleZh: 'æˆ‘è„šç–¼ã€‚', tags: ['èº«ä½“'] },
      { id: 'ojo', word: 'ojo', meaning: 'çœ¼ç›', image: 'ğŸ‘ï¸', example: 'Tiene los ojos azules.', exampleZh: 'ä»–æœ‰è“çœ¼ç›ã€‚', tags: ['èº«ä½“'] },
      { id: 'boca', word: 'boca', meaning: 'å˜´', image: 'ğŸ‘„', example: 'Abre la boca.', exampleZh: 'å¼ å¼€å˜´ã€‚', tags: ['èº«ä½“'] },
      { id: 'enfermo', word: 'enfermo', meaning: 'ç”Ÿç—…çš„', image: 'ğŸ¤’', example: 'Estoy enfermo.', exampleZh: 'æˆ‘ç”Ÿç—…äº†ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'sano', word: 'sano', meaning: 'å¥åº·çš„', image: 'ğŸ’ª', example: 'Estoy sano.', exampleZh: 'æˆ‘å¾ˆå¥åº·ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'medico', word: 'mÃ©dico', meaning: 'åŒ»ç”Ÿ', image: 'ğŸ‘¨â€âš•ï¸', example: 'Voy al mÃ©dico.', exampleZh: 'æˆ‘å»çœ‹åŒ»ç”Ÿã€‚', tags: ['èŒä¸š'] },
      { id: 'medicina', word: 'medicina', meaning: 'è¯', image: 'ğŸ’Š', example: 'Tomo la medicina.', exampleZh: 'æˆ‘åƒè¯ã€‚', tags: ['åè¯'] },
      { id: 'dolor', word: 'dolor', meaning: 'ç–¼ç—›', image: 'ğŸ˜£', example: 'Tengo dolor de espalda.', exampleZh: 'æˆ‘èƒŒç–¼ã€‚', tags: ['åè¯'] },
      
      // æƒ…æ„Ÿä¸çŠ¶æ€
      { id: 'contento', word: 'contento', meaning: 'æ»¡æ„çš„/å¼€å¿ƒçš„', image: 'ğŸ˜„', example: 'Estoy muy contento.', exampleZh: 'æˆ‘å¾ˆå¼€å¿ƒã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'preocupado', word: 'preocupado', meaning: 'æ‹…å¿ƒçš„', image: 'ğŸ˜Ÿ', example: 'Estoy preocupado.', exampleZh: 'æˆ‘å¾ˆæ‹…å¿ƒã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'nervioso', word: 'nervioso', meaning: 'ç´§å¼ çš„', image: 'ğŸ˜°', example: 'Estoy nervioso.', exampleZh: 'æˆ‘å¾ˆç´§å¼ ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'tranquilo', word: 'tranquilo', meaning: 'å¹³é™çš„', image: 'ğŸ˜Œ', example: 'Estoy tranquilo.', exampleZh: 'æˆ‘å¾ˆå¹³é™ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'aburrido', word: 'aburrido', meaning: 'æ— èŠçš„', image: 'ğŸ˜', example: 'Estoy aburrido.', exampleZh: 'æˆ‘å¾ˆæ— èŠã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'ocupado', word: 'ocupado', meaning: 'å¿™ç¢Œçš„', image: 'ğŸ’¼', example: 'Estoy muy ocupado.', exampleZh: 'æˆ‘å¾ˆå¿™ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'libre', word: 'libre', meaning: 'è‡ªç”±çš„/æœ‰ç©ºçš„', image: 'ğŸ•Šï¸', example: 'Â¿EstÃ¡s libre maÃ±ana?', exampleZh: 'ä½ æ˜å¤©æœ‰ç©ºå—ï¼Ÿ', tags: ['å½¢å®¹è¯'] },
      { id: 'seguro', word: 'seguro', meaning: 'ç¡®å®šçš„/å®‰å…¨çš„', image: 'ğŸ”’', example: 'Estoy seguro.', exampleZh: 'æˆ‘ç¡®å®šã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'sorprendido', word: 'sorprendido', meaning: 'æƒŠè®¶çš„', image: 'ğŸ˜²', example: 'Estoy sorprendido.', exampleZh: 'æˆ‘å¾ˆæƒŠè®¶ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'enamorado', word: 'enamorado', meaning: 'æ‹çˆ±ä¸­çš„', image: 'ğŸ˜', example: 'Estoy enamorado.', exampleZh: 'æˆ‘æ‹çˆ±äº†ã€‚', tags: ['å½¢å®¹è¯'] },
      
      // æè¿°ä¸æ¯”è¾ƒ
      { id: 'mejor', word: 'mejor', meaning: 'æ›´å¥½çš„', image: 'ğŸ‘', example: 'Este es mejor.', exampleZh: 'è¿™ä¸ªæ›´å¥½ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'peor', word: 'peor', meaning: 'æ›´å·®çš„', image: 'ğŸ‘', example: 'Esto es peor.', exampleZh: 'è¿™ä¸ªæ›´å·®ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'mayor', word: 'mayor', meaning: 'æ›´å¤§çš„/å¹´é•¿çš„', image: 'ğŸ“ˆ', example: 'Soy el mayor.', exampleZh: 'æˆ‘æ˜¯æœ€å¤§çš„ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'menor', word: 'menor', meaning: 'æ›´å°çš„/å¹´å¹¼çš„', image: 'ğŸ“‰', example: 'Es mi hermano menor.', exampleZh: 'ä»–æ˜¯æˆ‘å¼Ÿå¼Ÿã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'mismo', word: 'mismo', meaning: 'åŒæ ·çš„', image: 'ğŸŸ°', example: 'Es lo mismo.', exampleZh: 'æ˜¯ä¸€æ ·çš„ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'diferente', word: 'diferente', meaning: 'ä¸åŒçš„', image: 'ğŸ”€', example: 'Es diferente.', exampleZh: 'è¿™ä¸ä¸€æ ·ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'importante', word: 'importante', meaning: 'é‡è¦çš„', image: 'â­', example: 'Es muy importante.', exampleZh: 'è¿™å¾ˆé‡è¦ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'necesario', word: 'necesario', meaning: 'å¿…è¦çš„', image: 'â—', example: 'Es necesario.', exampleZh: 'è¿™æ˜¯å¿…è¦çš„ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'posible', word: 'posible', meaning: 'å¯èƒ½çš„', image: 'ğŸ¤”', example: 'Â¿Es posible?', exampleZh: 'è¿™å¯èƒ½å—ï¼Ÿ', tags: ['å½¢å®¹è¯'] },
      { id: 'imposible', word: 'imposible', meaning: 'ä¸å¯èƒ½çš„', image: 'ğŸš«', example: 'Es imposible.', exampleZh: 'è¿™ä¸å¯èƒ½ã€‚', tags: ['å½¢å®¹è¯'] },
      
      // åŠ¨ä½œä¸è¡Œä¸º
      { id: 'esperar', word: 'esperar', meaning: 'ç­‰å¾…/å¸Œæœ›', image: 'â³', example: 'EspÃ©rame aquÃ­.', exampleZh: 'åœ¨è¿™é‡Œç­‰æˆ‘ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'buscar', word: 'buscar', meaning: 'å¯»æ‰¾', image: 'ğŸ”', example: 'Busco mis llaves.', exampleZh: 'æˆ‘åœ¨æ‰¾é’¥åŒ™ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'encontrar', word: 'encontrar', meaning: 'æ‰¾åˆ°', image: 'âœ…', example: 'EncontrÃ© mi telÃ©fono.', exampleZh: 'æˆ‘æ‰¾åˆ°æ‰‹æœºäº†ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'perder', word: 'perder', meaning: 'ä¸¢å¤±/è¾“', image: 'ğŸ˜¢', example: 'PerdÃ­ mi cartera.', exampleZh: 'æˆ‘ä¸¢äº†é’±åŒ…ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'ganar', word: 'ganar', meaning: 'èµ¢/èµš', image: 'ğŸ†', example: 'Ganamos el partido.', exampleZh: 'æˆ‘ä»¬èµ¢äº†æ¯”èµ›ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'enviar', word: 'enviar', meaning: 'å‘é€', image: 'ğŸ“¤', example: 'EnvÃ­o un mensaje.', exampleZh: 'æˆ‘å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'recibir', word: 'recibir', meaning: 'æ”¶åˆ°', image: 'ğŸ“¥', example: 'RecibÃ­ tu carta.', exampleZh: 'æˆ‘æ”¶åˆ°ä½ çš„ä¿¡äº†ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'llamar', word: 'llamar', meaning: 'æ‰“ç”µè¯/å«', image: 'ğŸ“', example: 'Te llamo luego.', exampleZh: 'æˆ‘ä¸€ä¼šå„¿ç»™ä½ æ‰“ç”µè¯ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'contestar', word: 'contestar', meaning: 'å›ç­”', image: 'ğŸ’¬', example: 'Contesta la pregunta.', exampleZh: 'å›ç­”é—®é¢˜ã€‚', tags: ['åŠ¨è¯'] },
      { id: 'preguntar', word: 'preguntar', meaning: 'é—®', image: 'â“', example: 'Quiero preguntar algo.', exampleZh: 'æˆ‘æƒ³é—®ç‚¹äº‹ã€‚', tags: ['åŠ¨è¯'] },
      
      // å…¶ä»–å¸¸ç”¨
      { id: 'todavia', word: 'todavÃ­a', meaning: 'è¿˜/ä»ç„¶', image: 'â°', example: 'TodavÃ­a no llega.', exampleZh: 'ä»–è¿˜æ²¡åˆ°ã€‚', tags: ['å‰¯è¯'] },
      { id: 'ya', word: 'ya', meaning: 'å·²ç»', image: 'âœ…', example: 'Ya he comido.', exampleZh: 'æˆ‘å·²ç»åƒè¿‡äº†ã€‚', tags: ['å‰¯è¯'] },
      { id: 'casi', word: 'casi', meaning: 'å‡ ä¹', image: 'ğŸ“Š', example: 'Casi termino.', exampleZh: 'æˆ‘å¿«å®Œæˆäº†ã€‚', tags: ['å‰¯è¯'] },
      { id: 'bastante', word: 'bastante', meaning: 'ç›¸å½“/è¶³å¤Ÿ', image: 'ğŸ‘Œ', example: 'Es bastante bueno.', exampleZh: 'ç›¸å½“ä¸é”™ã€‚', tags: ['å‰¯è¯'] },
      { id: 'demasiado', word: 'demasiado', meaning: 'å¤ªå¤š', image: 'ğŸ“ˆ', example: 'Es demasiado caro.', exampleZh: 'å¤ªè´µäº†ã€‚', tags: ['å‰¯è¯'] },
      { id: 'otra_vez', word: 'otra vez', meaning: 'å†ä¸€æ¬¡', image: 'ğŸ”„', example: 'IntÃ©ntalo otra vez.', exampleZh: 'å†è¯•ä¸€æ¬¡ã€‚', tags: ['å‰¯è¯'] },
      { id: 'a_veces', word: 'a veces', meaning: 'æœ‰æ—¶å€™', image: 'ğŸ²', example: 'A veces voy al cine.', exampleZh: 'æˆ‘æœ‰æ—¶å€™å»ç”µå½±é™¢ã€‚', tags: ['å‰¯è¯'] },
      { id: 'cada', word: 'cada', meaning: 'æ¯ä¸ª', image: 'ğŸ“…', example: 'Cada dÃ­a estudio.', exampleZh: 'æˆ‘æ¯å¤©å­¦ä¹ ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'propio', word: 'propio', meaning: 'è‡ªå·±çš„', image: 'ğŸ‘¤', example: 'Es mi propio coche.', exampleZh: 'è¿™æ˜¯æˆ‘è‡ªå·±çš„è½¦ã€‚', tags: ['å½¢å®¹è¯'] },
      { id: 'junto', word: 'junto', meaning: 'ä¸€èµ·', image: 'ğŸ¤', example: 'Vamos juntos.', exampleZh: 'æˆ‘ä»¬ä¸€èµ·å»ã€‚', tags: ['å‰¯è¯'] },
    ];

    // ğŸ‡ªğŸ‡¸ å…¥ç±è€ƒè¯•(CCSE)è¯æ±‡ - 150ä¸ªæ ¸å¿ƒè¯
    const CITIZENSHIP_WORDS = [
      // æ”¿åºœä¸æœºæ„
      { id: 'constitucion', word: 'ConstituciÃ³n', meaning: 'å®ªæ³•', image: 'ğŸ“œ', example: 'La ConstituciÃ³n espaÃ±ola es de 1978.', exampleZh: 'è¥¿ç­ç‰™å®ªæ³•æ˜¯1978å¹´çš„ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'rey', word: 'rey', meaning: 'å›½ç‹', image: 'ğŸ‘‘', example: 'El Rey de EspaÃ±a es Felipe VI.', exampleZh: 'è¥¿ç­ç‰™å›½ç‹æ˜¯è²åˆ©æ™®å…­ä¸–ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'reina', word: 'reina', meaning: 'ç‹å', image: 'ğŸ‘¸', example: 'La Reina se llama Letizia.', exampleZh: 'ç‹åå«è±è’‚è¥¿äºšã€‚', tags: ['æ”¿æ²»'] },
      { id: 'gobierno', word: 'gobierno', meaning: 'æ”¿åºœ', image: 'ğŸ›ï¸', example: 'El gobierno estÃ¡ en Madrid.', exampleZh: 'æ”¿åºœåœ¨é©¬å¾·é‡Œã€‚', tags: ['æ”¿æ²»'] },
      { id: 'presidente', word: 'presidente', meaning: 'æ€»ç»Ÿ/ä¸»å¸­', image: 'ğŸ–ï¸', example: 'El presidente del Gobierno.', exampleZh: 'æ”¿åºœä¸»å¸­ï¼ˆé¦–ç›¸ï¼‰ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'parlamento', word: 'Parlamento', meaning: 'è®®ä¼š', image: 'ğŸ›ï¸', example: 'El Parlamento espaÃ±ol tiene dos cÃ¡maras.', exampleZh: 'è¥¿ç­ç‰™è®®ä¼šæœ‰ä¸¤é™¢ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'congreso', word: 'Congreso', meaning: 'å›½ä¼š/ä¼—è®®é™¢', image: 'ğŸ›ï¸', example: 'El Congreso de los Diputados.', exampleZh: 'ä¼—è®®é™¢ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'senado', word: 'Senado', meaning: 'å‚è®®é™¢', image: 'ğŸ›ï¸', example: 'El Senado es la cÃ¡mara alta.', exampleZh: 'å‚è®®é™¢æ˜¯ä¸Šè®®é™¢ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'comunidad', word: 'comunidad autÃ³noma', meaning: 'è‡ªæ²»åŒº', image: 'ğŸ—ºï¸', example: 'EspaÃ±a tiene 17 comunidades autÃ³nomas.', exampleZh: 'è¥¿ç­ç‰™æœ‰17ä¸ªè‡ªæ²»åŒºã€‚', tags: ['åœ°ç†'] },
      { id: 'provincia', word: 'provincia', meaning: 'çœ', image: 'ğŸ—ºï¸', example: 'EspaÃ±a tiene 50 provincias.', exampleZh: 'è¥¿ç­ç‰™æœ‰50ä¸ªçœã€‚', tags: ['åœ°ç†'] },
      { id: 'ayuntamiento', word: 'ayuntamiento', meaning: 'å¸‚æ”¿åºœ', image: 'ğŸ¢', example: 'Voy al ayuntamiento.', exampleZh: 'æˆ‘å»å¸‚æ”¿åºœã€‚', tags: ['æ”¿æ²»'] },
      { id: 'alcalde', word: 'alcalde', meaning: 'å¸‚é•¿', image: 'ğŸ‘”', example: 'El alcalde de la ciudad.', exampleZh: 'åŸå¸‚çš„å¸‚é•¿ã€‚', tags: ['æ”¿æ²»'] },
      
      // æƒåˆ©ä¸ä¹‰åŠ¡
      { id: 'derecho', word: 'derecho', meaning: 'æƒåˆ©', image: 'âš–ï¸', example: 'Tenemos derecho a votar.', exampleZh: 'æˆ‘ä»¬æœ‰æŠ•ç¥¨æƒã€‚', tags: ['æ³•å¾‹'] },
      { id: 'deber', word: 'deber', meaning: 'ä¹‰åŠ¡', image: 'ğŸ“‹', example: 'Tenemos el deber de pagar impuestos.', exampleZh: 'æˆ‘ä»¬æœ‰çº³ç¨çš„ä¹‰åŠ¡ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'votar', word: 'votar', meaning: 'æŠ•ç¥¨', image: 'ğŸ—³ï¸', example: 'Los ciudadanos pueden votar.', exampleZh: 'å…¬æ°‘å¯ä»¥æŠ•ç¥¨ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'elecciones', word: 'elecciones', meaning: 'é€‰ä¸¾', image: 'ğŸ—³ï¸', example: 'Las elecciones son cada cuatro aÃ±os.', exampleZh: 'é€‰ä¸¾æ¯å››å¹´ä¸€æ¬¡ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'ciudadano', word: 'ciudadano', meaning: 'å…¬æ°‘', image: 'ğŸ‘¤', example: 'Soy ciudadano espaÃ±ol.', exampleZh: 'æˆ‘æ˜¯è¥¿ç­ç‰™å…¬æ°‘ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'nacionalidad', word: 'nacionalidad', meaning: 'å›½ç±', image: 'ğŸ›‚', example: 'Tengo la nacionalidad espaÃ±ola.', exampleZh: 'æˆ‘æœ‰è¥¿ç­ç‰™å›½ç±ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'residencia', word: 'residencia', meaning: 'å±…ç•™', image: 'ğŸ ', example: 'Tengo permiso de residencia.', exampleZh: 'æˆ‘æœ‰å±…ç•™è®¸å¯ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'pasaporte', word: 'pasaporte', meaning: 'æŠ¤ç…§', image: 'ğŸ›‚', example: 'Necesito mi pasaporte.', exampleZh: 'æˆ‘éœ€è¦æŠ¤ç…§ã€‚', tags: ['æ–‡ä»¶'] },
      { id: 'dni', word: 'DNI', meaning: 'èº«ä»½è¯', image: 'ğŸªª', example: 'El DNI es obligatorio.', exampleZh: 'DNIèº«ä»½è¯æ˜¯å¿…é¡»çš„ã€‚', tags: ['æ–‡ä»¶'] },
      { id: 'nie', word: 'NIE', meaning: 'å¤–å›½äººèº«ä»½å·', image: 'ğŸªª', example: 'Tengo un NIE.', exampleZh: 'æˆ‘æœ‰NIEå¤–å›½äººèº«ä»½å·ã€‚', tags: ['æ–‡ä»¶'] },
      { id: 'impuesto', word: 'impuesto', meaning: 'ç¨', image: 'ğŸ’¶', example: 'Hay que pagar impuestos.', exampleZh: 'å¿…é¡»ç¼´ç¨ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'ley', word: 'ley', meaning: 'æ³•å¾‹', image: 'âš–ï¸', example: 'La ley es igual para todos.', exampleZh: 'æ³•å¾‹é¢å‰äººäººå¹³ç­‰ã€‚', tags: ['æ³•å¾‹'] },
      
      // å†å²
      { id: 'historia', word: 'historia', meaning: 'å†å²', image: 'ğŸ“š', example: 'La historia de EspaÃ±a es rica.', exampleZh: 'è¥¿ç­ç‰™å†å²å¾ˆä¸°å¯Œã€‚', tags: ['å†å²'] },
      { id: 'guerra_civil', word: 'Guerra Civil', meaning: 'å†…æˆ˜', image: 'âš”ï¸', example: 'La Guerra Civil fue de 1936 a 1939.', exampleZh: 'å†…æˆ˜æ˜¯1936å¹´åˆ°1939å¹´ã€‚', tags: ['å†å²'] },
      { id: 'democracia', word: 'democracia', meaning: 'æ°‘ä¸»', image: 'ğŸ—³ï¸', example: 'EspaÃ±a es una democracia.', exampleZh: 'è¥¿ç­ç‰™æ˜¯æ°‘ä¸»å›½å®¶ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'monarquia', word: 'monarquÃ­a', meaning: 'å›ä¸»åˆ¶', image: 'ğŸ‘‘', example: 'EspaÃ±a es una monarquÃ­a parlamentaria.', exampleZh: 'è¥¿ç­ç‰™æ˜¯è®®ä¼šå›ä¸»åˆ¶ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'dictadura', word: 'dictadura', meaning: 'ç‹¬è£', image: 'âœŠ', example: 'La dictadura de Franco.', exampleZh: 'ä½›æœ—å“¥ç‹¬è£æ—¶æœŸã€‚', tags: ['å†å²'] },
      { id: 'transicion', word: 'TransiciÃ³n', meaning: 'è¿‡æ¸¡æœŸ', image: 'ğŸ”„', example: 'La TransiciÃ³n espaÃ±ola.', exampleZh: 'è¥¿ç­ç‰™æ°‘ä¸»è¿‡æ¸¡æœŸã€‚', tags: ['å†å²'] },
      { id: 'descubrimiento', word: 'descubrimiento', meaning: 'å‘ç°', image: 'ğŸ§­', example: 'El descubrimiento de AmÃ©rica en 1492.', exampleZh: '1492å¹´å‘ç°ç¾æ´²ã€‚', tags: ['å†å²'] },
      { id: 'colon', word: 'ColÃ³n', meaning: 'å“¥ä¼¦å¸ƒ', image: 'ğŸš¢', example: 'CristÃ³bal ColÃ³n descubriÃ³ AmÃ©rica.', exampleZh: 'å…‹é‡Œæ–¯æ‰˜å¼—Â·å“¥ä¼¦å¸ƒå‘ç°äº†ç¾æ´²ã€‚', tags: ['å†å²'] },
      
      // åœ°ç†
      { id: 'espana', word: 'EspaÃ±a', meaning: 'è¥¿ç­ç‰™', image: 'ğŸ‡ªğŸ‡¸', example: 'EspaÃ±a estÃ¡ en Europa.', exampleZh: 'è¥¿ç­ç‰™åœ¨æ¬§æ´²ã€‚', tags: ['åœ°ç†'] },
      { id: 'madrid', word: 'Madrid', meaning: 'é©¬å¾·é‡Œ', image: 'ğŸ™ï¸', example: 'Madrid es la capital.', exampleZh: 'é©¬å¾·é‡Œæ˜¯é¦–éƒ½ã€‚', tags: ['åœ°ç†'] },
      { id: 'barcelona', word: 'Barcelona', meaning: 'å·´å¡ç½—é‚£', image: 'ğŸ™ï¸', example: 'Barcelona estÃ¡ en CataluÃ±a.', exampleZh: 'å·´å¡ç½—é‚£åœ¨åŠ æ³°ç½—å°¼äºšã€‚', tags: ['åœ°ç†'] },
      { id: 'cataluna', word: 'CataluÃ±a', meaning: 'åŠ æ³°ç½—å°¼äºš', image: 'ğŸ—ºï¸', example: 'CataluÃ±a es una comunidad autÃ³noma.', exampleZh: 'åŠ æ³°ç½—å°¼äºšæ˜¯ä¸€ä¸ªè‡ªæ²»åŒºã€‚', tags: ['åœ°ç†'] },
      { id: 'andalucia', word: 'AndalucÃ­a', meaning: 'å®‰è¾¾å¢è¥¿äºš', image: 'ğŸ—ºï¸', example: 'AndalucÃ­a estÃ¡ en el sur.', exampleZh: 'å®‰è¾¾å¢è¥¿äºšåœ¨å—éƒ¨ã€‚', tags: ['åœ°ç†'] },
      { id: 'valencia', word: 'Valencia', meaning: 'ç“¦ä¼¦è¥¿äºš', image: 'ğŸŠ', example: 'Valencia es famosa por las naranjas.', exampleZh: 'ç“¦ä¼¦è¥¿äºšä»¥æ©™å­é—»åã€‚', tags: ['åœ°ç†'] },
      { id: 'galicia', word: 'Galicia', meaning: 'åŠ åˆ©è¥¿äºš', image: 'ğŸ—ºï¸', example: 'Galicia estÃ¡ en el noroeste.', exampleZh: 'åŠ åˆ©è¥¿äºšåœ¨è¥¿åŒ—éƒ¨ã€‚', tags: ['åœ°ç†'] },
      { id: 'pais_vasco', word: 'PaÃ­s Vasco', meaning: 'å·´æ–¯å…‹', image: 'ğŸ—ºï¸', example: 'El PaÃ­s Vasco tiene su propia lengua.', exampleZh: 'å·´æ–¯å…‹æœ‰è‡ªå·±çš„è¯­è¨€ã€‚', tags: ['åœ°ç†'] },
      { id: 'islas_canarias', word: 'Islas Canarias', meaning: 'åŠ é‚£åˆ©ç¾¤å²›', image: 'ğŸï¸', example: 'Las Canarias estÃ¡n en el AtlÃ¡ntico.', exampleZh: 'åŠ é‚£åˆ©ç¾¤å²›åœ¨å¤§è¥¿æ´‹ã€‚', tags: ['åœ°ç†'] },
      { id: 'islas_baleares', word: 'Islas Baleares', meaning: 'å·´åˆ©é˜¿é‡Œç¾¤å²›', image: 'ğŸï¸', example: 'Mallorca es una isla balear.', exampleZh: 'é©¬ç•¥å¡æ˜¯å·´åˆ©é˜¿é‡Œç¾¤å²›çš„ä¸€ä¸ªå²›ã€‚', tags: ['åœ°ç†'] },
      { id: 'pirineos', word: 'Pirineos', meaning: 'æ¯”åˆ©ç‰›æ–¯å±±', image: 'ğŸ”ï¸', example: 'Los Pirineos estÃ¡n en el norte.', exampleZh: 'æ¯”åˆ©ç‰›æ–¯å±±åœ¨åŒ—éƒ¨ã€‚', tags: ['åœ°ç†'] },
      { id: 'mediterraneo', word: 'MediterrÃ¡neo', meaning: 'åœ°ä¸­æµ·', image: 'ğŸŒŠ', example: 'El mar MediterrÃ¡neo.', exampleZh: 'åœ°ä¸­æµ·ã€‚', tags: ['åœ°ç†'] },
      { id: 'atlantico', word: 'AtlÃ¡ntico', meaning: 'å¤§è¥¿æ´‹', image: 'ğŸŒŠ', example: 'El ocÃ©ano AtlÃ¡ntico.', exampleZh: 'å¤§è¥¿æ´‹ã€‚', tags: ['åœ°ç†'] },
      
      // æ–‡åŒ–ä¸èŠ‚æ—¥
      { id: 'cultura', word: 'cultura', meaning: 'æ–‡åŒ–', image: 'ğŸ­', example: 'La cultura espaÃ±ola es diversa.', exampleZh: 'è¥¿ç­ç‰™æ–‡åŒ–æ˜¯å¤šå…ƒçš„ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'fiesta', word: 'fiesta', meaning: 'èŠ‚æ—¥/æ´¾å¯¹', image: 'ğŸ‰', example: 'Las fiestas espaÃ±olas son famosas.', exampleZh: 'è¥¿ç­ç‰™èŠ‚æ—¥å¾ˆæœ‰åã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'navidad', word: 'Navidad', meaning: 'åœ£è¯èŠ‚', image: 'ğŸ„', example: 'La Navidad es el 25 de diciembre.', exampleZh: 'åœ£è¯èŠ‚æ˜¯12æœˆ25æ—¥ã€‚', tags: ['èŠ‚æ—¥'] },
      { id: 'semana_santa', word: 'Semana Santa', meaning: 'åœ£å‘¨', image: 'âœï¸', example: 'La Semana Santa es muy importante.', exampleZh: 'åœ£å‘¨éå¸¸é‡è¦ã€‚', tags: ['èŠ‚æ—¥'] },
      { id: 'dia_nacional', word: 'DÃ­a Nacional', meaning: 'å›½åº†èŠ‚', image: 'ğŸ‡ªğŸ‡¸', example: 'El DÃ­a Nacional es el 12 de octubre.', exampleZh: 'å›½åº†èŠ‚æ˜¯10æœˆ12æ—¥ã€‚', tags: ['èŠ‚æ—¥'] },
      { id: 'dia_constitucion', word: 'DÃ­a de la ConstituciÃ³n', meaning: 'å®ªæ³•æ—¥', image: 'ğŸ“œ', example: 'El 6 de diciembre es el DÃ­a de la ConstituciÃ³n.', exampleZh: '12æœˆ6æ—¥æ˜¯å®ªæ³•æ—¥ã€‚', tags: ['èŠ‚æ—¥'] },
      { id: 'toros', word: 'toros', meaning: 'æ–—ç‰›', image: 'ğŸ‚', example: 'Los toros son una tradiciÃ³n.', exampleZh: 'æ–—ç‰›æ˜¯ä¸€ç§ä¼ ç»Ÿã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'flamenco', word: 'flamenco', meaning: 'å¼—æ‹‰é—¨æˆˆ', image: 'ğŸ’ƒ', example: 'El flamenco es de AndalucÃ­a.', exampleZh: 'å¼—æ‹‰é—¨æˆˆæ¥è‡ªå®‰è¾¾å¢è¥¿äºšã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'paella', word: 'paella', meaning: 'æµ·é²œé¥­', image: 'ğŸ¥˜', example: 'La paella es de Valencia.', exampleZh: 'æµ·é²œé¥­æ¥è‡ªç“¦ä¼¦è¥¿äºšã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'siesta', word: 'siesta', meaning: 'åˆç¡', image: 'ğŸ˜´', example: 'La siesta es una tradiciÃ³n.', exampleZh: 'åˆç¡æ˜¯ä¸€ç§ä¼ ç»Ÿã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'tapas', word: 'tapas', meaning: 'å°åƒ', image: 'ğŸ¢', example: 'Vamos a tomar unas tapas.', exampleZh: 'æˆ‘ä»¬å»åƒç‚¹å°åƒã€‚', tags: ['æ–‡åŒ–'] },
      
      // è¯­è¨€
      { id: 'castellano', word: 'castellano', meaning: 'å¡æ–¯è’‚åˆ©äºšè¯­/è¥¿ç­ç‰™è¯­', image: 'ğŸ—£ï¸', example: 'El castellano es el idioma oficial.', exampleZh: 'å¡æ–¯è’‚åˆ©äºšè¯­æ˜¯å®˜æ–¹è¯­è¨€ã€‚', tags: ['è¯­è¨€'] },
      { id: 'catalan', word: 'catalÃ¡n', meaning: 'åŠ æ³°ç½—å°¼äºšè¯­', image: 'ğŸ—£ï¸', example: 'En CataluÃ±a hablan catalÃ¡n.', exampleZh: 'åœ¨åŠ æ³°ç½—å°¼äºšè¯´åŠ æ³°ç½—å°¼äºšè¯­ã€‚', tags: ['è¯­è¨€'] },
      { id: 'gallego', word: 'gallego', meaning: 'åŠ åˆ©è¥¿äºšè¯­', image: 'ğŸ—£ï¸', example: 'El gallego se habla en Galicia.', exampleZh: 'åŠ åˆ©è¥¿äºšè¯­åœ¨åŠ åˆ©è¥¿äºšä½¿ç”¨ã€‚', tags: ['è¯­è¨€'] },
      { id: 'euskera', word: 'euskera', meaning: 'å·´æ–¯å…‹è¯­', image: 'ğŸ—£ï¸', example: 'El euskera es muy antiguo.', exampleZh: 'å·´æ–¯å…‹è¯­éå¸¸å¤è€ã€‚', tags: ['è¯­è¨€'] },
      { id: 'valenciano', word: 'valenciano', meaning: 'ç“¦ä¼¦è¥¿äºšè¯­', image: 'ğŸ—£ï¸', example: 'El valenciano se habla en Valencia.', exampleZh: 'ç“¦ä¼¦è¥¿äºšè¯­åœ¨ç“¦ä¼¦è¥¿äºšä½¿ç”¨ã€‚', tags: ['è¯­è¨€'] },
      
      // æ¬§ç›Ÿä¸å›½é™…
      { id: 'union_europea', word: 'UniÃ³n Europea', meaning: 'æ¬§ç›Ÿ', image: 'ğŸ‡ªğŸ‡º', example: 'EspaÃ±a es miembro de la UE.', exampleZh: 'è¥¿ç­ç‰™æ˜¯æ¬§ç›Ÿæˆå‘˜ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'euro', word: 'euro', meaning: 'æ¬§å…ƒ', image: 'ğŸ’¶', example: 'EspaÃ±a usa el euro.', exampleZh: 'è¥¿ç­ç‰™ä½¿ç”¨æ¬§å…ƒã€‚', tags: ['ç»æµ'] },
      { id: 'otan', word: 'OTAN', meaning: 'åŒ—çº¦', image: 'ğŸ›¡ï¸', example: 'EspaÃ±a pertenece a la OTAN.', exampleZh: 'è¥¿ç­ç‰™å±äºåŒ—çº¦ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'onu', word: 'ONU', meaning: 'è”åˆå›½', image: 'ğŸŒ', example: 'EspaÃ±a es miembro de la ONU.', exampleZh: 'è¥¿ç­ç‰™æ˜¯è”åˆå›½æˆå‘˜ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'tratado', word: 'tratado', meaning: 'æ¡çº¦', image: 'ğŸ“„', example: 'EspaÃ±a firmÃ³ el tratado.', exampleZh: 'è¥¿ç­ç‰™ç­¾ç½²äº†æ¡çº¦ã€‚', tags: ['æ”¿æ²»'] },
      
      // æ•™è‚²ä¸ç¤¾ä¼š
      { id: 'educacion', word: 'educaciÃ³n', meaning: 'æ•™è‚²', image: 'ğŸ“š', example: 'La educaciÃ³n es un derecho.', exampleZh: 'æ•™è‚²æ˜¯ä¸€é¡¹æƒåˆ©ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'sanidad', word: 'sanidad', meaning: 'åŒ»ç–—å«ç”Ÿ', image: 'ğŸ¥', example: 'La sanidad pÃºblica es gratis.', exampleZh: 'å…¬å…±åŒ»ç–—æ˜¯å…è´¹çš„ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'seguridad_social', word: 'Seguridad Social', meaning: 'ç¤¾ä¼šä¿éšœ', image: 'ğŸ›¡ï¸', example: 'La Seguridad Social protege a los ciudadanos.', exampleZh: 'ç¤¾ä¼šä¿éšœä¿æŠ¤å…¬æ°‘ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'pension', word: 'pensiÃ³n', meaning: 'å…»è€é‡‘', image: 'ğŸ‘´', example: 'Los jubilados reciben una pensiÃ³n.', exampleZh: 'é€€ä¼‘äººå‘˜é¢†å–å…»è€é‡‘ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'desempleo', word: 'desempleo', meaning: 'å¤±ä¸š', image: 'ğŸ“‰', example: 'El desempleo es un problema.', exampleZh: 'å¤±ä¸šæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'trabajo', word: 'trabajo', meaning: 'å·¥ä½œ', image: 'ğŸ’¼', example: 'Busco trabajo.', exampleZh: 'æˆ‘åœ¨æ‰¾å·¥ä½œã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'contrato', word: 'contrato', meaning: 'åˆåŒ', image: 'ğŸ“', example: 'FirmÃ© un contrato.', exampleZh: 'æˆ‘ç­¾äº†åˆåŒã€‚', tags: ['æ³•å¾‹'] },
      { id: 'sueldo', word: 'sueldo', meaning: 'å·¥èµ„', image: 'ğŸ’°', example: 'Â¿CuÃ¡l es tu sueldo?', exampleZh: 'ä½ çš„å·¥èµ„æ˜¯å¤šå°‘ï¼Ÿ', tags: ['ç¤¾ä¼š'] },
      
      // é‡è¦äººç‰©
      { id: 'cervantes', word: 'Cervantes', meaning: 'å¡ä¸‡ææ–¯', image: 'âœï¸', example: 'Cervantes escribiÃ³ Don Quijote.', exampleZh: 'å¡ä¸‡ææ–¯å†™äº†ã€Šå ‚å‰è¯ƒå¾·ã€‹ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'don_quijote', word: 'Don Quijote', meaning: 'å ‚å‰è¯ƒå¾·', image: 'ğŸ“–', example: 'Don Quijote es una novela famosa.', exampleZh: 'ã€Šå ‚å‰è¯ƒå¾·ã€‹æ˜¯ä¸€éƒ¨è‘—åå°è¯´ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'picasso', word: 'Picasso', meaning: 'æ¯•åŠ ç´¢', image: 'ğŸ¨', example: 'Picasso fue un pintor famoso.', exampleZh: 'æ¯•åŠ ç´¢æ˜¯è‘—åç”»å®¶ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'gaudi', word: 'GaudÃ­', meaning: 'é«˜è¿ª', image: 'ğŸ›ï¸', example: 'GaudÃ­ diseÃ±Ã³ la Sagrada Familia.', exampleZh: 'é«˜è¿ªè®¾è®¡äº†åœ£å®¶å ‚ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'sagrada_familia', word: 'Sagrada Familia', meaning: 'åœ£å®¶å ‚', image: 'â›ª', example: 'La Sagrada Familia estÃ¡ en Barcelona.', exampleZh: 'åœ£å®¶å ‚åœ¨å·´å¡ç½—é‚£ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'alhambra', word: 'Alhambra', meaning: 'é˜¿å°”ç½•å¸ƒæ‹‰å®«', image: 'ğŸ°', example: 'La Alhambra estÃ¡ en Granada.', exampleZh: 'é˜¿å°”ç½•å¸ƒæ‹‰å®«åœ¨æ ¼æ‹‰çº³è¾¾ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'prado', word: 'Museo del Prado', meaning: 'æ™®æ‹‰å¤šåšç‰©é¦†', image: 'ğŸ–¼ï¸', example: 'El Prado estÃ¡ en Madrid.', exampleZh: 'æ™®æ‹‰å¤šåšç‰©é¦†åœ¨é©¬å¾·é‡Œã€‚', tags: ['æ–‡åŒ–'] },
      
      // æ›´å¤šæ”¿æ²»è¯æ±‡
      { id: 'partido', word: 'partido polÃ­tico', meaning: 'æ”¿å…š', image: 'ğŸ›ï¸', example: 'Hay muchos partidos polÃ­ticos.', exampleZh: 'æœ‰å¾ˆå¤šæ”¿å…šã€‚', tags: ['æ”¿æ²»'] },
      { id: 'ministro', word: 'ministro', meaning: 'éƒ¨é•¿', image: 'ğŸ‘”', example: 'El ministro de EducaciÃ³n.', exampleZh: 'æ•™è‚²éƒ¨é•¿ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'diputado', word: 'diputado', meaning: 'ä¼—è®®å‘˜', image: 'ğŸ‘”', example: 'Los diputados votan las leyes.', exampleZh: 'ä¼—è®®å‘˜æŠ•ç¥¨è¡¨å†³æ³•å¾‹ã€‚', tags: ['æ”¿æ²»'] },
      { id: 'senador', word: 'senador', meaning: 'å‚è®®å‘˜', image: 'ğŸ‘”', example: 'Los senadores representan las provincias.', exampleZh: 'å‚è®®å‘˜ä»£è¡¨å„çœã€‚', tags: ['æ”¿æ²»'] },
      { id: 'himno', word: 'himno nacional', meaning: 'å›½æ­Œ', image: 'ğŸµ', example: 'El himno de EspaÃ±a no tiene letra.', exampleZh: 'è¥¿ç­ç‰™å›½æ­Œæ²¡æœ‰æ­Œè¯ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'bandera', word: 'bandera', meaning: 'å›½æ——', image: 'ğŸ‡ªğŸ‡¸', example: 'La bandera espaÃ±ola es roja y amarilla.', exampleZh: 'è¥¿ç­ç‰™å›½æ——æ˜¯çº¢é»„è‰²çš„ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'escudo', word: 'escudo', meaning: 'å›½å¾½', image: 'ğŸ›¡ï¸', example: 'El escudo de EspaÃ±a.', exampleZh: 'è¥¿ç­ç‰™å›½å¾½ã€‚', tags: ['æ–‡åŒ–'] },
      
      // å®—æ•™
      { id: 'religion', word: 'religiÃ³n', meaning: 'å®—æ•™', image: 'â›ª', example: 'EspaÃ±a tiene libertad de religiÃ³n.', exampleZh: 'è¥¿ç­ç‰™æœ‰å®—æ•™è‡ªç”±ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'catolico', word: 'catÃ³lico', meaning: 'å¤©ä¸»æ•™çš„', image: 'âœï¸', example: 'Muchos espaÃ±oles son catÃ³licos.', exampleZh: 'è®¸å¤šè¥¿ç­ç‰™äººæ˜¯å¤©ä¸»æ•™å¾’ã€‚', tags: ['æ–‡åŒ–'] },
      { id: 'iglesia', word: 'iglesia', meaning: 'æ•™å ‚', image: 'â›ª', example: 'Voy a la iglesia los domingos.', exampleZh: 'æˆ‘å‘¨æ—¥å»æ•™å ‚ã€‚', tags: ['æ–‡åŒ–'] },
      
      // å…¶ä»–é‡è¦è¯æ±‡
      { id: 'libertad', word: 'libertad', meaning: 'è‡ªç”±', image: 'ğŸ•Šï¸', example: 'La libertad es un derecho fundamental.', exampleZh: 'è‡ªç”±æ˜¯åŸºæœ¬æƒåˆ©ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'igualdad', word: 'igualdad', meaning: 'å¹³ç­‰', image: 'âš–ï¸', example: 'Todos tenemos derecho a la igualdad.', exampleZh: 'æˆ‘ä»¬éƒ½æœ‰å¹³ç­‰çš„æƒåˆ©ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'justicia', word: 'justicia', meaning: 'å…¬æ­£/å¸æ³•', image: 'âš–ï¸', example: 'La justicia es importante.', exampleZh: 'å…¬æ­£å¾ˆé‡è¦ã€‚', tags: ['æ³•å¾‹'] },
      { id: 'solidaridad', word: 'solidaridad', meaning: 'å›¢ç»“', image: 'ğŸ¤', example: 'La solidaridad entre los pueblos.', exampleZh: 'äººæ°‘ä¹‹é—´çš„å›¢ç»“ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'respeto', word: 'respeto', meaning: 'å°Šé‡', image: 'ğŸ™', example: 'El respeto a los demÃ¡s.', exampleZh: 'å¯¹ä»–äººçš„å°Šé‡ã€‚', tags: ['ç¤¾ä¼š'] },
      { id: 'tolerancia', word: 'tolerancia', meaning: 'åŒ…å®¹', image: 'ğŸ¤—', example: 'La tolerancia es fundamental.', exampleZh: 'åŒ…å®¹æ˜¯æ ¹æœ¬ã€‚', tags: ['ç¤¾ä¼š'] },
    ];

    // è·å–è¯åº“å•è¯
    function getWordBook(bookId) {
      switch(bookId) {
        case 'A1': return A1_WORDS;
        case 'A2': return [...A1_WORDS, ...A2_WORDS]; // A2åŒ…å«A1è¯æ±‡
        case 'B1': return [...A1_WORDS, ...A2_WORDS]; // æš‚æ—¶ä½¿ç”¨A1+A2
        case 'citizenship': return CITIZENSHIP_WORDS;
        default: return A1_WORDS;
      }
    }

    // ==================== åº”ç”¨çŠ¶æ€ ====================
    // åˆå§‹åŒ–å‡½æ•°ï¼ŒåŠ è½½å½“å‰ç”¨æˆ·æ•°æ®
    function initUserData() {
      const users = Storage.getUsers();
      const currentUserId = Storage.getCurrentUserId();
      const currentUser = users.find(u => u.id === currentUserId);
      
      return {
        users: users,
        user: currentUser || null,
        chatHistory: currentUser ? Storage.getUserData(currentUser.id, 'chatHistory', []) : [],
        mistakeBook: currentUser ? Storage.getUserData(currentUser.id, 'mistakeBook', []) : [],
        vocabulary: currentUser ? Storage.getUserData(currentUser.id, 'vocabulary', []) : [],
        checkinDays: currentUser ? Storage.getUserData(currentUser.id, 'checkinDays', []) : [],
        achievements: currentUser ? Storage.getUserData(currentUser.id, 'achievements', []) : [],
        stats: currentUser ? Storage.getUserData(currentUser.id, 'stats', { flashcardReviews: 0, tutorsUsed: [] }) : { flashcardReviews: 0, tutorsUsed: [] },
        relationData: currentUser ? Storage.getUserData(currentUser.id, 'relationData', { currentCompanion: null, relationships: {} }) : { currentCompanion: null, relationships: {} },
        // æ–©å•è¯æ•°æ®
        wordProgress: currentUser ? Storage.getUserData(currentUser.id, 'wordProgress', {}) : {},
        wordSettings: currentUser ? Storage.getUserData(currentUser.id, 'wordSettings', { 
          currentBook: 'A1', 
          dailyNew: 20, 
          dailyReview: 30 
        }) : { currentBook: 'A1', dailyNew: 20, dailyReview: 30 },
      };
    }
    
    const userData = initUserData();
    
    let state = {
      view: 'loading', // loading, welcome, userSelect, setup, home, tutor, scenario, chat, settings, history, stats, mistakes, vocabulary, wordSlash
      users: userData.users, // æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
      user: userData.user, // å½“å‰ç”¨æˆ·
      darkMode: Storage.get('darkMode', false), // æ·±è‰²æ¨¡å¼
      tutor: null,
      scenario: null,
      messages: [],
      chatHistory: userData.chatHistory, // å†å²å¯¹è¯è®°å½•
      mistakeBook: userData.mistakeBook, // é”™è¯¯è®°å½•æœ¬
      vocabulary: userData.vocabulary, // è¯æ±‡æœ¬
      checkinDays: userData.checkinDays, // æ‰“å¡æ—¥æœŸåˆ—è¡¨
      achievements: userData.achievements, // å·²è§£é”æˆå°±
      stats: userData.stats, // ç»Ÿè®¡æ•°æ®
      relationData: userData.relationData, // å…³ç³»æ•°æ®
      // æ–©å•è¯æ•°æ®
      wordProgress: userData.wordProgress, // å•è¯å­¦ä¹ è¿›åº¦
      wordSettings: userData.wordSettings, // æ–©å•è¯è®¾ç½®
      wordSlash: {
        mode: 'home', // home, learning, result
        queue: [], // å½“å‰å­¦ä¹ é˜Ÿåˆ—
        currentIndex: 0,
        options: [], // å½“å‰é€‰é¡¹
        answered: false,
        correct: null,
        results: [], // æœ¬æ¬¡å­¦ä¹ ç»“æœ [{word, correct}]
        todayNew: 0, // ä»Šæ—¥æ–°å­¦æ•°é‡
        todayReview: 0, // ä»Šæ—¥å¤ä¹ æ•°é‡
      },
      inputText: '',
      isLoading: false,
      isListening: false,
      corrections: 0,
      showTranslation: {}, // messageId -> boolean
      translationCache: {}, // messageId -> translation text
      suggestions: [], // å¯¹è¯å»ºè®®
      isLoadingSuggestions: false, // æ˜¯å¦æ­£åœ¨åŠ è½½å»ºè®®
      showSuggestions: false, // æ˜¯å¦æ˜¾ç¤ºå»ºè®®é¢æ¿
      // çº æ­£å’Œè¯­æ³•å¡ç‰‡ç¿»è¯‘
      showCorrectionTrans: {}, // msgId_correction -> boolean
      correctionTransCache: {}, // msgId_correction -> translation
      showGrammarTrans: {}, // msgId_grammar -> boolean
      grammarTransCache: {}, // msgId_grammar -> translation
      // å¿«é€Ÿæ”¶è—è¯æ±‡
      vocabModal: { show: false, word: '', meaning: '', example: '', isLoading: false },
      // é—ªå¡å¤ä¹ 
      flashcard: { 
        cards: [], // è¦å¤ä¹ çš„å•è¯åˆ—è¡¨
        currentIndex: 0, // å½“å‰å¡ç‰‡ç´¢å¼•
        showAnswer: false, // æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
        results: [], // æ¯å¼ å¡ç‰‡çš„ç»“æœ [{word, correct}]
        finished: false // æ˜¯å¦å®Œæˆ
      },
      // é”™é¢˜å¤ä¹ 
      mistakeReview: {
        items: [], // è¦å¤ä¹ çš„é”™é¢˜åˆ—è¡¨
        currentIndex: 0,
        showAnswer: false,
        userAnswer: '',
        results: [], // [{original, correction, mastered}]
        finished: false
      },
    };

    let recognition = null;
    let voicesLoaded = false;

    // ==================== å·¥å…·å‡½æ•° ====================
    function $(sel) { return document.querySelector(sel); }
    
    // é¢„åŠ è½½è¯­éŸ³
    function loadVoices() {
      return new Promise((resolve) => {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          voicesLoaded = true;
          resolve(voices);
        } else {
          speechSynthesis.onvoiceschanged = () => {
            voicesLoaded = true;
            resolve(speechSynthesis.getVoices());
          };
          // è¶…æ—¶fallback
          setTimeout(() => resolve(speechSynthesis.getVoices()), 1000);
        }
      });
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½è¯­éŸ³
    if ('speechSynthesis' in window) {
      loadVoices();
    }
    
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      
      speechSynthesis.cancel();
      const clean = text.replace(/ã€.+?ã€‘/g, '').replace(/\([^)]*\)/g, '').trim();
      if (!clean) return;
      
      const u = new SpeechSynthesisUtterance(clean);
      
      // è·å–ç”¨æˆ·è®¾ç½®çš„è¯­é€ŸåŸºå‡†
      const userRate = state.user?.speechRate || 0.85;
      
      // æ ¹æ®è§’è‰²è®¾ç½®ä¸åŒå‚æ•°
      if (state.tutor && state.tutor.voice) {
        u.pitch = state.tutor.voice.pitch || 1.0;
        u.rate = userRate * (state.tutor.voice.rate || 1.0);
      } else {
        u.pitch = 1.0;
        u.rate = userRate;
      }
      
      // é€‰æ‹©è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      
      // ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¯­è¯­éŸ³
      let selectedVoice = null;
      
      // 1. å…ˆæ‰¾è¥¿ç­ç‰™è¯­å¥³å£°æˆ–ç”·å£°
      if (state.tutor) {
        const isFemale = ['maria', 'sofia'].includes(state.tutor.id);
        const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
        
        if (spanishVoices.length > 0) {
          // å°è¯•æ ¹æ®æ€§åˆ«é€‰æ‹©
          selectedVoice = spanishVoices.find(v => {
            const name = v.name.toLowerCase();
            if (isFemale) {
              return name.includes('female') || name.includes('mujer') || 
                     name.includes('paulina') || name.includes('monica') ||
                     name.includes('helena') || name.includes('laura');
            } else {
              return name.includes('male') || name.includes('hombre') || 
                     name.includes('jorge') || name.includes('diego') ||
                     name.includes('pablo') || name.includes('carlos');
            }
          });
          
          // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šæ€§åˆ«ï¼Œå°±ç”¨ç¬¬ä¸€ä¸ªè¥¿ç­ç‰™è¯­è¯­éŸ³
          if (!selectedVoice) {
            // å°è¯•ä¸åŒåœ°åŒºçš„è¥¿ç­ç‰™è¯­
            if (state.tutor.id === 'sofia') {
              // SofÃ­aæ˜¯å¢¨è¥¿å“¥äººï¼Œä¼˜å…ˆæ‰¾å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-MX') || spanishVoices[0];
            } else {
              // å…¶ä»–è§’è‰²ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-ES') || spanishVoices[0];
            }
          }
        }
      }
      
      // 2. å¦‚æœæ²¡æœ‰è¥¿ç­ç‰™è¯­è¯­éŸ³ï¼Œè®¾ç½®è¯­è¨€å‚æ•°è®©ç³»ç»Ÿé€‰æ‹©
      if (selectedVoice) {
        u.voice = selectedVoice;
        u.lang = selectedVoice.lang;
      } else {
        // SofÃ­aç”¨å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­ï¼Œå…¶ä»–ç”¨è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
        u.lang = (state.tutor?.id === 'sofia') ? 'es-MX' : 'es-ES';
      }
      
      speechSynthesis.speak(u);
    }

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      
      const r = new SR();
      r.continuous = true;
      r.interimResults = true;
      r.lang = 'es-ES';
      
      r.onresult = (e) => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if (final) {
          state.inputText += final;
          render();
        }
      };
      
      r.onerror = (e) => {
        if (e.error === 'not-allowed') alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥');
        state.isListening = false;
        render();
      };
      
      r.onend = () => {
        if (state.isListening) {
          try { r.start(); } catch(e) {}
        }
      };
      
      return r;
    }

    function toggleListening() {
      if (!recognition) recognition = initSpeechRecognition();
      if (!recognition) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chrome');
        return;
      }
      
      state.isListening = !state.isListening;
      if (state.isListening) {
        try { recognition.start(); } catch(e) {}
      } else {
        try { recognition.stop(); } catch(e) {}
      }
      render();
    }

    // ==================== API è°ƒç”¨ ====================
    async function callAPI(userMessage, forTranslation = false) {
      const user = state.user;
      
      let systemPrompt;
      if (forTranslation) {
        // æ ¹æ®ç”¨æˆ·è®¾ç½®é€‰æ‹©ç¿»è¯‘è¯­è¨€
        const transLang = user?.transLang || 'zh';
        if (transLang === 'en') {
          systemPrompt = `You are a translator. Translate the following Spanish text into concise English. Only output the translation, no explanations.`;
        } else if (transLang === 'both') {
          systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­åŒæ—¶ç¿»è¯‘æˆä¸­æ–‡å’Œè‹±è¯­ã€‚æ ¼å¼å¦‚ä¸‹ï¼š
ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘å†…å®¹
ğŸ‡¬ğŸ‡§ English translation
åªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
        } else {
          systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­ç¿»è¯‘æˆç®€æ´çš„ä¸­æ–‡ï¼Œåªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
        }
      } else {
        // æ„å»ºå…³ç³»ä¸Šä¸‹æ–‡ï¼ˆä»…é™ªä¼´å‹è§’è‰²ï¼‰
        let relationContext = '';
        if (state.tutor?.type === ROLE_TYPES.COMPANION) {
          const rel = getRelationship(state.tutor.id);
          if (rel) {
            const intimacyName = getIntimacyName(rel.intimacy || 1);
            const recentMemories = (rel.memories || []).slice(0, 5).map(m => m.content).join('ï¼›');
            relationContext = `
ã€ä½ ä»¬çš„å…³ç³»ã€‘
- å…³ç³»ç±»å‹ï¼š${state.tutor.relationName}
- äº²å¯†ç¨‹åº¦ï¼š${intimacyName}ï¼ˆ${rel.intimacy || 1}/3çº§ï¼‰
- å·²ç»å¯¹è¯${rel.odometer || 0}æ¬¡
${recentMemories ? `- ä½ è®°å¾—çš„äº‹æƒ…ï¼š${recentMemories}` : ''}

ã€å¯¹è¯è¦æ±‚ã€‘
- æ ¹æ®äº²å¯†åº¦ä½¿ç”¨ç›¸åº”çš„ç§°å‘¼å’Œè¯­æ°”
- è®°ä½ä¹‹å‰èŠè¿‡çš„äº‹æƒ…ï¼Œå¯ä»¥æèµ·å…±åŒå›å¿†
- å±•ç°çœŸå®çš„æƒ…æ„Ÿè¿æ¥ï¼Œä¸åªæ˜¯è¯­è¨€ç»ƒä¹ `;
          }
        }
        
        // è¯­æ³•è¯¾ç‰¹æ®Šå¤„ç†
        let grammarContext = '';
        if (state.scenario?.isGrammarLesson && state.scenario?.grammarTopic) {
          const topic = state.scenario.grammarTopic;
          grammarContext = `
ã€å½“å‰æ˜¯è¯­æ³•è¯¾ï¼š${topic.name}ã€‘
- ç»§ç»­æ•™æˆè¿™ä¸ªè¯­æ³•ç‚¹
- è§£é‡Šå¯ä»¥ç”¨ä¸­æ–‡ï¼Œä¾‹å¥ç”¨è¥¿ç­ç‰™è¯­
- å›ç­”å­¦ç”Ÿçš„é—®é¢˜
- å¦‚æœå­¦ç”Ÿå›ç­”æ­£ç¡®ï¼Œç»™äºˆé¼“åŠ±
- å¦‚æœå­¦ç”Ÿå›ç­”é”™è¯¯ï¼Œè€å¿ƒçº æ­£`;
        }
        
        systemPrompt = `${state.tutor.prompt}
${relationContext}
${grammarContext}

å­¦ç”Ÿä¿¡æ¯ï¼š
- åå­—ï¼š${user.name}
- è¥¿è¯­æ°´å¹³ï¼š${user.level}
- å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}

é‡è¦è§„åˆ™ï¼š
1. æ ¹æ®å­¦ç”Ÿçš„${user.level}æ°´å¹³è°ƒæ•´è¯æ±‡å’Œå¥å­éš¾åº¦
2. çœŸæ­£ç†è§£å¹¶å›åº”å­¦ç”Ÿè¯´çš„å†…å®¹
3. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´
4. è¯­æ³•é”™è¯¯åŠ¡å¿…ç”¨ã€çº æ­£ã€‘æ ¼å¼æŒ‡å‡º
5. ${user.level === 'A1' || user.level === 'A2' ? 'å¤šç»™é‡è¦è¯æ±‡åŠ ä¸Š(ä¸­æ–‡ç¿»è¯‘)' : 'åªç»™ç”Ÿåƒ»è¯åŠ ç¿»è¯‘'}`;
      }

      const messages = forTranslation 
        ? [{ role: 'user', content: userMessage }]
        : [...state.messages.map(m => ({
            role: m.type === 'user' ? 'user' : 'assistant',
            content: m.text
          })), { role: 'user', content: userMessage }];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        return data.content?.[0]?.text || 'æŠ±æ­‰ï¼Œè¯·é‡è¯•ã€‚';
      } catch (err) {
        return 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
      }
    }

    async function sendMessage() {
      const text = state.inputText.trim();
      if (!text || state.isLoading) return;
      
      state.isListening = false;
      if (recognition) try { recognition.stop(); } catch(e) {}
      
      state.inputText = '';
      state.showSuggestions = false; // å‘é€æ¶ˆæ¯åéšè—å»ºè®®
      state.suggestions = [];
      const userMsg = { id: Date.now(), type: 'user', text, time: new Date().toISOString() };
      state.messages.push(userMsg);
      state.isLoading = true;
      render();
      scrollToBottom();
      
      const response = await callAPI(text);
      
      // è§£æçº æ­£å†…å®¹
      const correctionMatch = response.match(/ã€çº æ­£ã€‘(.+?)(?=\n|$)/s);
      const grammarMatch = response.match(/ã€è¯­æ³•ã€‘(.+?)(?=\n|$)/s);
      const cleanResponse = response
        .replace(/ã€çº æ­£ã€‘.+?(?=\n|$)/gs, '')
        .replace(/ã€è¯­æ³•ã€‘.+?(?=\n|$)/gs, '')
        .trim();
      
      const aiMsg = { 
        id: Date.now() + 1, 
        type: 'ai', 
        text: cleanResponse,
        correction: correctionMatch ? correctionMatch[1].trim() : null,
        grammar: grammarMatch ? grammarMatch[1].trim() : null,
        time: new Date().toISOString()
      };
      
      state.messages.push(aiMsg);
      if (correctionMatch) {
        state.corrections++;
        // ä¿å­˜åˆ°é”™è¯¯è®°å½•æœ¬
        saveMistake(correctionMatch[1].trim(), text);
      }
      state.isLoading = false;
      
      // ä¿å­˜å¯¹è¯å†å²
      saveChatHistory();
      
      render();
      scrollToBottom();
      speak(cleanResponse);
    }
    
    // ä¿å­˜é”™è¯¯åˆ°è®°å½•æœ¬
    function saveMistake(correctionText, userInput) {
      if (!state.user) return;
      
      // è§£æçº æ­£å†…å®¹ï¼Œæ ¼å¼é€šå¸¸æ˜¯ï¼š"é”™è¯¯" â†’ "æ­£ç¡®" (è§£é‡Š)
      const mistake = {
        id: Date.now(),
        original: userInput, // ç”¨æˆ·åŸå§‹è¾“å…¥
        correction: correctionText, // å®Œæ•´çš„çº æ­£å†…å®¹
        tutorId: state.tutor?.id || 'unknown',
        tutorName: state.tutor?.name || 'æœªçŸ¥',
        scenario: state.scenario?.name || 'è‡ªç”±èŠå¤©',
        date: new Date().toISOString(),
        reviewed: false // æ˜¯å¦å·²å¤ä¹ 
      };
      
      state.mistakeBook.unshift(mistake);
      // æœ€å¤šä¿å­˜100æ¡é”™è¯¯è®°å½•
      if (state.mistakeBook.length > 100) {
        state.mistakeBook = state.mistakeBook.slice(0, 100);
      }
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
    }

    // è·å–å¯¹è¯å»ºè®®
    async function getSuggestions() {
      if (state.isLoadingSuggestions || state.messages.length === 0) return;
      
      // è·å–æœ€åä¸€æ¡AIæ¶ˆæ¯
      const lastAiMsg = [...state.messages].reverse().find(m => m.type === 'ai');
      if (!lastAiMsg) return;
      
      state.isLoadingSuggestions = true;
      state.showSuggestions = true;
      state.suggestions = [];
      render();
      
      const user = state.user;
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè¥¿ç­ç‰™è¯­å­¦ä¹ åŠ©æ‰‹ã€‚æ ¹æ®å¯¹è¯å†…å®¹ï¼Œä¸º${user.level}æ°´å¹³çš„å­¦ç”Ÿç”Ÿæˆ3ä¸ªåˆé€‚çš„å›å¤å»ºè®®ã€‚

è¦æ±‚ï¼š
1. æ¯ä¸ªå»ºè®®å¿…é¡»æ˜¯è¥¿ç­ç‰™è¯­
2. éš¾åº¦è¦åŒ¹é…${user.level}æ°´å¹³
3. å»ºè®®è¦è‡ªç„¶ã€ç¬¦åˆå¯¹è¯è¯­å¢ƒ
4. æ¯ä¸ªå»ºè®®åé¢åŠ ä¸Šç®€çŸ­çš„ä¸­æ–‡ç¿»è¯‘ï¼Œæ ¼å¼ï¼šè¥¿ç­ç‰™è¯­ (ä¸­æ–‡)
5. åªè¾“å‡º3ä¸ªå»ºè®®ï¼Œç”¨æ¢è¡Œåˆ†éš”ï¼Œä¸è¦ç¼–å·ï¼Œä¸è¦å…¶ä»–è§£é‡Š

å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}`;

      const messages = [
        { role: 'user', content: `AIè¯´: "${lastAiMsg.text}"\n\nè¯·ç»™å‡º3ä¸ªé€‚åˆçš„å›å¤å»ºè®®ï¼š` }
      ];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        const text = data.content?.[0]?.text || '';
        
        // è§£æå»ºè®®ï¼ˆæŒ‰æ¢è¡Œåˆ†å‰²ï¼‰
        const suggestions = text.split('\n')
          .map(s => s.trim())
          .filter(s => s.length > 0 && !s.match(/^[0-9]+[\.\)]/)) // è¿‡æ»¤ç©ºè¡Œå’Œç¼–å·
          .slice(0, 3);
        
        state.suggestions = suggestions;
      } catch (err) {
        state.suggestions = ['Lo siento, no pude cargar sugerencias (æŠ±æ­‰ï¼Œæ— æ³•åŠ è½½å»ºè®®)'];
      }
      
      state.isLoadingSuggestions = false;
      render();
    }

    // ä½¿ç”¨å»ºè®®
    function useSuggestion(index) {
      const suggestion = state.suggestions[index];
      if (!suggestion) return;
      
      // æå–è¥¿ç­ç‰™è¯­éƒ¨åˆ†ï¼ˆå»æ‰ä¸­æ–‡ç¿»è¯‘ï¼‰
      const spanishText = suggestion.replace(/\s*\([^)]+\)\s*$/, '').trim();
      state.inputText = spanishText;
      state.showSuggestions = false;
      render();
      
      // èšç„¦è¾“å…¥æ¡†
      setTimeout(() => {
        const input = document.getElementById('chatInput');
        if (input) input.focus();
      }, 100);
    }

    // éšè—å»ºè®®
    function hideSuggestions() {
      state.showSuggestions = false;
      state.suggestions = [];
      render();
    }

    async function getTranslation(msgId, text) {
      if (state.translationCache[msgId]) {
        state.showTranslation[msgId] = !state.showTranslation[msgId];
        render();
        return;
      }
      
      state.showTranslation[msgId] = true;
      state.translationCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(text, true);
      state.translationCache[msgId] = translation;
      render();
    }

    function saveChatHistory() {
      if (state.messages.length < 2 || !state.user) return;
      
      const chat = {
        id: Date.now(),
        tutor: state.tutor.id,
        scenario: state.scenario?.id || 'free',
        messages: state.messages.slice(-20), // åªä¿å­˜æœ€è¿‘20æ¡
        corrections: state.corrections,
        date: new Date().toISOString()
      };
      
      state.chatHistory.unshift(chat);
      if (state.chatHistory.length > 50) state.chatHistory = state.chatHistory.slice(0, 50);
      Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
      
      // å¦‚æœæ˜¯é™ªä¼´å‹è§’è‰²ï¼Œæ›´æ–°å…³ç³»æ•°æ®
      if (state.tutor?.type === ROLE_TYPES.COMPANION) {
        const scenarioMemory = state.scenario ? {
          type: 'event',
          content: `ä¸€èµ·å»äº†${state.scenario.name}`
        } : null;
        updateRelationship(state.tutor.id, scenarioMemory);
      }
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
    }

    function startChat(tutor, scenario) {
      state.tutor = tutor;
      state.scenario = scenario;
      state.messages = [];
      state.corrections = 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      state.isLoading = true;
      render();
      
      // è®°å½•ä½¿ç”¨çš„å¯¼å¸ˆ
      recordTutorUsed(tutor.id);
      
      // å¦‚æœæ˜¯é™ªä¼´å‹è§’è‰²ï¼Œåˆå§‹åŒ–/æ›´æ–°å…³ç³»æ•°æ®
      if (tutor.type === ROLE_TYPES.COMPANION) {
        initRelationship(tutor.id);
      }
      
      // åŠ¨æ€ç”Ÿæˆåœºæ™¯å¼€åœºç™½
      generateScenarioGreeting(tutor, scenario);
    }
    
    // åˆå§‹åŒ–æˆ–æ›´æ–°å…³ç³»æ•°æ®
    function initRelationship(characterId) {
      if (!state.relationData.relationships) {
        state.relationData.relationships = {};
      }
      
      const now = new Date().toISOString().split('T')[0];
      
      if (!state.relationData.relationships[characterId]) {
        // ç¬¬ä¸€æ¬¡è®¤è¯†
        state.relationData.relationships[characterId] = {
          odometer: 0,
          intimacy: 1,
          firstMet: now,
          lastChat: now,
          memories: [],
          mood: 'happy'
        };
      }
      
      // æ›´æ–°æœ€åèŠå¤©æ—¶é—´
      state.relationData.relationships[characterId].lastChat = now;
      
      // ä¿å­˜
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
    }
    
    // è·å–å…³ç³»æ•°æ®
    function getRelationship(characterId) {
      return state.relationData?.relationships?.[characterId] || null;
    }
    
    // è·å–äº²å¯†åº¦ç­‰çº§åç§°
    function getIntimacyName(level) {
      const names = { 1: 'åˆè¯†', 2: 'ç†Ÿæ‚‰', 3: 'äº²å¯†' };
      return names[level] || 'åˆè¯†';
    }
    
    // æ›´æ–°å…³ç³»æ•°æ®ï¼ˆå¯¹è¯ç»“æŸæ—¶è°ƒç”¨ï¼‰
    function updateRelationship(characterId, addMemory = null) {
      const rel = state.relationData.relationships?.[characterId];
      if (!rel) return;
      
      // å¢åŠ å¯¹è¯æ¬¡æ•°
      rel.odometer = (rel.odometer || 0) + 1;
      
      // æ ¹æ®å¯¹è¯æ¬¡æ•°æå‡äº²å¯†åº¦
      if (rel.odometer >= 20 && rel.intimacy < 3) {
        rel.intimacy = 3;
      } else if (rel.odometer >= 5 && rel.intimacy < 2) {
        rel.intimacy = 2;
      }
      
      // æ·»åŠ è®°å¿†
      if (addMemory) {
        rel.memories = rel.memories || [];
        rel.memories.unshift({
          ...addMemory,
          date: new Date().toISOString()
        });
        // æœ€å¤šä¿ç•™20æ¡è®°å¿†
        if (rel.memories.length > 20) {
          rel.memories = rel.memories.slice(0, 20);
        }
      }
      
      // ä¿å­˜
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
    }
    
    // æ ¹æ®è§’è‰²å’Œåœºæ™¯ç”Ÿæˆå¼€åœºç™½
    async function generateScenarioGreeting(tutor, scenario) {
      const user = state.user;
      const isCompanion = tutor.type === ROLE_TYPES.COMPANION;
      const rel = isCompanion ? getRelationship(tutor.id) : null;
      
      // æ„å»ºå…³ç³»ä¸Šä¸‹æ–‡
      let relationContext = '';
      if (rel) {
        const intimacyName = getIntimacyName(rel.intimacy);
        const daysSinceLastChat = rel.lastChat ? 
          Math.floor((new Date() - new Date(rel.lastChat)) / (1000 * 60 * 60 * 24)) : 0;
        const isFirstMeet = rel.odometer === 0;
        
        // è·å–æœ€è¿‘è®°å¿†
        const recentMemories = (rel.memories || []).slice(0, 3).map(m => m.content).join('ï¼›');
        
        relationContext = `
ã€å…³ç³»ä¿¡æ¯ã€‘
- ä½ ä»¬çš„å…³ç³»ï¼š${tutor.relationName}
- äº²å¯†ç¨‹åº¦ï¼š${intimacyName}ï¼ˆç­‰çº§${rel.intimacy}/3ï¼‰
- è¿™æ˜¯ç¬¬${rel.odometer + 1}æ¬¡å¯¹è¯
- ${isFirstMeet ? 'è¿™æ˜¯ä½ ä»¬ç¬¬ä¸€æ¬¡è§é¢ï¼' : `ä½ ä»¬å·²ç»è®¤è¯†äº†ï¼Œä¸Šæ¬¡èŠå¤©æ˜¯${daysSinceLastChat}å¤©å‰`}
${recentMemories ? `- ä½ è®°å¾—çš„äº‹æƒ…ï¼š${recentMemories}` : ''}

ã€é—®å€™è¦æ±‚ã€‘
${isFirstMeet ? 
  '- è¿™æ˜¯ç¬¬ä¸€æ¬¡è§é¢ï¼Œè‡ªæˆ‘ä»‹ç»ï¼Œè¡¨è¾¾è®¤è¯†çš„å–œæ‚¦' :
  daysSinceLastChat > 3 ?
    '- å¥½å‡ å¤©æ²¡è§äº†ï¼Œè¡¨è¾¾æƒ³å¿µ' :
    '- åƒè€æœ‹å‹/æ‹äººä¸€æ ·è‡ªç„¶æ‰“æ‹›å‘¼'
}
- æ ¹æ®äº²å¯†åº¦è°ƒæ•´ç§°å‘¼çš„äº²å¯†ç¨‹åº¦
- ${tutor.relation === 'boyfriend' || tutor.relation === 'girlfriend' ? 'å¯ä»¥é€‚å½“è¡¨è¾¾çˆ±æ„å’Œå…³å¿ƒ' : 'åƒå¥½æœ‹å‹ä¸€æ ·äº²åˆ‡'}`;
      }
      
      // è¯­æ³•è¯¾ç‰¹æ®Šå¤„ç†
      let grammarContext = '';
      if (scenario.isGrammarLesson && scenario.grammarTopic) {
        const topic = scenario.grammarTopic;
        grammarContext = `
ã€ç‰¹åˆ«ä»»åŠ¡ï¼šè¯­æ³•è¯¾ã€‘
ä½ ç°åœ¨è¦ç»™å­¦ç”Ÿä¸Šä¸€å ‚å…³äº"${topic.name}ï¼ˆ${topic.nameEs}ï¼‰"çš„è¯­æ³•è¯¾ã€‚

æ•™å­¦è¦æ±‚ï¼š
1. ç”¨è¥¿ç­ç‰™è¯­ä»‹ç»ä»Šå¤©è¦å­¦ä»€ä¹ˆï¼ˆé…åˆä¸­æ–‡è§£é‡Šï¼‰
2. æ¸…æ™°è§£é‡Šè¯­æ³•è§„åˆ™
3. ç»™å‡º3-5ä¸ªå®ç”¨ä¾‹å¥
4. å¯ä»¥é—®å­¦ç”Ÿé—®é¢˜ï¼Œæ£€éªŒç†è§£
5. å¦‚æœå­¦ç”Ÿå›ç­”é”™è¯¯ï¼Œè€å¿ƒçº æ­£å¹¶é¼“åŠ±

è¯·å¼€å§‹ä½ çš„è¯­æ³•è¯¾ä»‹ç»ï¼`;
      }
      
      const systemPrompt = `ä½ æ˜¯${tutor.name}ï¼Œ${tutor.description}ã€‚
æ€§æ ¼ç‰¹ç‚¹ï¼š${tutor.personality}
${tutor.traits ? `ç‰¹å¾æ ‡ç­¾ï¼š${tutor.traits.join('ã€')}` : ''}
${relationContext}
${grammarContext}

${grammarContext ? '' : `ç°åœ¨çš„åœºæ™¯æ˜¯ï¼š${scenario.name}ï¼ˆ${scenario.nameEs}ï¼‰- ${scenario.desc}

è¯·ç”¨è¥¿ç­ç‰™è¯­å‘${user.name}æ‰“æ‹›å‘¼ï¼Œå¹¶è‡ªç„¶åœ°å¼•å…¥è¿™ä¸ªåœºæ™¯ã€‚`}
è¦æ±‚ï¼š
1. å®Œå…¨ç¬¦åˆä½ çš„è§’è‰²æ€§æ ¼å’Œè¯´è¯æ–¹å¼
${grammarContext ? '2. å¼€å§‹è¯­æ³•è¯¾çš„æ•™å­¦' : '2. è‡ªç„¶åœ°å¸¦å…¥åœºæ™¯'}
3. æ ¹æ®å­¦ç”Ÿæ°´å¹³${user.level}è°ƒæ•´è¯­è¨€éš¾åº¦
4. ${grammarContext ? 'è¯­æ³•è§£é‡Šå¯ä»¥ç”¨ä¸­æ–‡ï¼Œä¾‹å¥ç”¨è¥¿ç­ç‰™è¯­' : 'åªè¯´1-2å¥è¯ï¼Œç®€æ´è‡ªç„¶'}
5. ${grammarContext ? '' : 'åªè¾“å‡ºè¥¿ç­ç‰™è¯­ï¼Œä¸è¦ä¸­æ–‡'}`;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            system: systemPrompt, 
            messages: [{ role: 'user', content: grammarContext ? 'å¼€å§‹ä¸Šè¯¾' : 'å¼€å§‹å¯¹è¯' }] 
          })
        });

        const data = await res.json();
        const defaultGreeting = `Â¡Hola, ${user.name}!`;
        const greeting = data.content?.[0]?.text || defaultGreeting;
        
        state.isLoading = false;
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
        
      } catch (err) {
        // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨ç®€å•é—®å€™
        const greeting = `Â¡Hola, ${user.name}!`;
        state.isLoading = false;
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
      }
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // ä¿å­˜/åˆ›å»ºç”¨æˆ·
    function saveUser(userData, isNew = false) {
      const userId = isNew ? Date.now().toString() : (state.user?.id || Date.now().toString());
      const user = { 
        ...userData, 
        id: userId,
        createdAt: userData.createdAt || new Date().toISOString() 
      };
      
      // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
      let users = Storage.getUsers();
      const existingIndex = users.findIndex(u => u.id === userId);
      if (existingIndex >= 0) {
        users[existingIndex] = user;
      } else {
        users.push(user);
      }
      Storage.saveUsers(users);
      Storage.setCurrentUserId(userId);
      
      // æ›´æ–°state
      state.users = users;
      state.user = user;
      
      // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®
      if (isNew) {
        state.chatHistory = [];
        state.mistakeBook = [];
        state.vocabulary = [];
      }
    }
    
    // åˆ‡æ¢ç”¨æˆ·
    function switchUser(userId) {
      const user = state.users.find(u => u.id === userId);
      if (!user) return;
      
      Storage.setCurrentUserId(userId);
      state.user = user;
      state.chatHistory = Storage.getUserData(userId, 'chatHistory', []);
      state.mistakeBook = Storage.getUserData(userId, 'mistakeBook', []);
      state.vocabulary = Storage.getUserData(userId, 'vocabulary', []);
      state.checkinDays = Storage.getUserData(userId, 'checkinDays', []);
      state.achievements = Storage.getUserData(userId, 'achievements', []);
      state.stats = Storage.getUserData(userId, 'stats', { flashcardReviews: 0, tutorsUsed: [] });
      state.relationData = Storage.getUserData(userId, 'relationData', { currentCompanion: null, relationships: {} });
      state.wordProgress = Storage.getUserData(userId, 'wordProgress', {});
      state.wordSettings = Storage.getUserData(userId, 'wordSettings', { currentBook: 'A1', dailyNew: 20, dailyReview: 30 });
      state.view = 'home';
      render();
    }
    
    // åˆ é™¤ç”¨æˆ·
    function deleteUser(userId) {
      let users = Storage.getUsers();
      users = users.filter(u => u.id !== userId);
      Storage.saveUsers(users);
      
      // æ¸…é™¤è¯¥ç”¨æˆ·çš„æ•°æ®
      Storage.remove(`${userId}_chatHistory`);
      Storage.remove(`${userId}_mistakeBook`);
      Storage.remove(`${userId}_vocabulary`);
      Storage.remove(`${userId}_checkinDays`);
      Storage.remove(`${userId}_achievements`);
      Storage.remove(`${userId}_stats`);
      Storage.remove(`${userId}_relationData`);
      Storage.remove(`${userId}_wordProgress`);
      Storage.remove(`${userId}_wordSettings`);
      
      state.users = users;
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œè¿”å›ç”¨æˆ·é€‰æ‹©é¡µé¢
      if (state.user?.id === userId) {
        state.user = null;
        Storage.setCurrentUserId(null);
        state.view = users.length > 0 ? 'userSelect' : 'welcome';
      }
      
      render();
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function render() {
      const app = document.getElementById('app');
      
      // åº”ç”¨æ·±è‰²æ¨¡å¼
      if (state.darkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      switch(state.view) {
        case 'loading': app.innerHTML = renderLoading(); break;
        case 'welcome': app.innerHTML = renderWelcome(); break;
        case 'userSelect': app.innerHTML = renderUserSelect(); break;
        case 'setup': app.innerHTML = renderSetup(); break;
        case 'home': app.innerHTML = renderHome(); break;
        case 'tutor': app.innerHTML = renderTutor(); break;
        case 'scenario': app.innerHTML = renderScenario(); break;
        case 'chat': app.innerHTML = renderChat(); break;
        case 'settings': app.innerHTML = renderSettings(); break;
        case 'history': app.innerHTML = renderHistory(); break;
        case 'stats': app.innerHTML = renderStats(); break;
        case 'mistakes': app.innerHTML = renderMistakes(); break;
        case 'vocabulary': app.innerHTML = renderVocabulary(); break;
        case 'flashcard': app.innerHTML = renderFlashcard(); break;
        case 'mistakeReview': app.innerHTML = renderMistakeReview(); break;
        case 'calendar': app.innerHTML = renderCalendar(); break;
        case 'achievements': app.innerHTML = renderAchievements(); break;
        case 'companion': app.innerHTML = renderCompanionSelect(); break;
        case 'service': app.innerHTML = renderServiceSelect(); break;
        case 'companionScenario': app.innerHTML = renderCompanionScenario(); break;
        case 'studyCenter': app.innerHTML = renderStudyCenter(); break;
        case 'askTeacher': app.innerHTML = renderAskTeacher(); break;
        case 'grammarLesson': app.innerHTML = renderGrammarLesson(); break;
        case 'wordSlash': app.innerHTML = renderWordSlash(); break;
      }
      
      // å¬å†™æ¨¡å¼è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
      if (state.view === 'wordSlash' && state.wordSlash.mode === 'dictation' && !state.wordSlash.dictationAnswered) {
        setTimeout(() => {
          const input = document.getElementById('dictationInput');
          if (input) input.focus();
        }, 100);
      }
    }
    
    // åˆ‡æ¢æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      Storage.set('darkMode', state.darkMode);
      render();
    }

    function renderLoading() {
      return `
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-primary-500 to-primary-700">
          <div class="text-center text-white">
            <div class="text-6xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <div class="text-xl font-semibold">HablaConmigo</div>
            <div class="mt-4 flex justify-center gap-1">
              <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.1s"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderWelcome() {
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col items-center justify-center p-6 text-center">
          <div class="fade-in">
            <div class="text-7xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-4xl font-bold text-white mb-2">Â¡Hola!</h1>
            <h2 class="text-xl text-white/90 mb-1">HablaConmigo</h2>
            <p class="text-white/70 mb-8 max-w-xs text-sm">
              ä¸AIä¼™ä¼´çœŸå®å¯¹è¯<br>
              è¯­éŸ³è¾“å…¥ Â· æ™ºèƒ½çº é”™ Â· å³æ—¶ç¿»è¯‘
            </p>
            
            <button onclick="state.view='setup';render()" 
              class="bg-white text-primary-600 font-bold py-4 px-10 rounded-2xl text-lg shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all">
              å¼€å§‹ä½¿ç”¨ â†’
            </button>
            
            <div class="mt-10 grid grid-cols-4 gap-4 text-white/80 text-xs">
              <div class="text-center"><div class="text-2xl mb-1">ğŸ¤</div>è¯­éŸ³</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸ­</div>è§’è‰²</div>
              <div class="text-center"><div class="text-2xl mb-1">âœï¸</div>çº é”™</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸŒ</div>ç¿»è¯‘</div>
            </div>
            
            <div class="mt-8 text-white/50 text-xs">å®Œå…¨å…è´¹ Â· æ— éœ€æ³¨å†Œ Â· æ•°æ®å­˜æœ¬åœ°</div>
          </div>
        </div>
      `;
    }

    // ç”¨æˆ·é€‰æ‹©é¡µé¢
    function renderUserSelect() {
      const users = state.users;
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col">
          <div class="p-6 text-white text-center">
            <div class="text-5xl mb-2">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-2xl font-bold">HablaConmigo</h1>
            <p class="text-white/70 text-sm mt-1">é€‰æ‹©ç”¨æˆ·æˆ–åˆ›å»ºæ–°ç”¨æˆ·</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-sm mx-auto space-y-3">
              ${users.map(u => `
                <div class="bg-white/10 backdrop-blur rounded-xl overflow-hidden">
                  <button onclick="switchUser('${u.id}')" 
                    class="w-full p-4 text-left hover:bg-white/10 transition-colors flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                      ${u.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                      <div class="font-bold text-white">${u.name}</div>
                      <div class="text-sm text-white/70">æ°´å¹³: ${u.level}</div>
                    </div>
                    <div class="text-white/50 text-sm">â†’</div>
                  </button>
                  <div class="border-t border-white/10 px-4 py-2 flex justify-end">
                    <button onclick="if(confirm('ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${u.name} å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ï¼'))deleteUser('${u.id}')" 
                      class="text-xs text-white/50 hover:text-red-300">åˆ é™¤</button>
                  </div>
                </div>
              `).join('')}
              
              <!-- æ·»åŠ æ–°ç”¨æˆ· -->
              <button onclick="state.view='setup';render()" 
                class="w-full p-4 bg-white/20 backdrop-blur rounded-xl text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2">
                <span class="text-2xl">+</span>
                <span class="font-medium">æ·»åŠ æ–°ç”¨æˆ·</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSetup() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ğŸ‘‹ æ¬¢è¿ï¼</h1>
            <p class="text-white/80 text-sm mt-1">è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä½ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <div class="max-w-md mx-auto space-y-6 fade-in">
              <!-- å§“å -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„åå­—</label>
                <input id="userName" type="text" placeholder="è¾“å…¥ä½ çš„åå­—æˆ–æ˜µç§°" 
                  class="w-full p-4 rounded-xl border border-gray-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                  value="${state.user?.name || ''}">
              </div>
              
              <!-- æ°´å¹³ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„è¥¿è¯­æ°´å¹³</label>
                <div class="grid grid-cols-2 gap-3">
                  ${LEVELS.map(l => `
                    <button onclick="document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50');document.getElementById('selectedLevel').value='${l.id}'"
                      class="level-btn p-4 rounded-xl border border-gray-200 text-left hover:border-primary-300 transition-all ${state.user?.level === l.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''}">
                      <div class="font-bold text-gray-800">${l.id}</div>
                      <div class="text-sm text-gray-500">${l.name}</div>
                      <div class="text-xs text-gray-400 mt-1">${l.desc}</div>
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedLevel" value="${state.user?.level || 'A2'}">
              </div>
              
              <!-- åå¥½ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ åå¥½</label>
                <div class="space-y-3">
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘</div>
                      <div class="text-xs text-gray-500">AIå›å¤æ—¶è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</div>
                    </div>
                    <input id="autoTranslate" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.autoTranslate ? 'checked' : ''}>
                  </label>
                  
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">ä¸¥æ ¼çº é”™æ¨¡å¼</div>
                      <div class="text-xs text-gray-500">çº æ­£æ‰€æœ‰è¯­æ³•é”™è¯¯ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ </div>
                    </div>
                    <input id="strictMode" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.strictMode ? 'checked' : ''}>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 safe-bottom">
            <button onclick="submitSetup()" 
              class="w-full py-4 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-bold shadow-lg hover:shadow-xl active:scale-98 transition-all">
              å¼€å§‹å­¦ä¹  ğŸš€
            </button>
          </div>
        </div>
      `;
    }

    function submitSetup() {
      const name = document.getElementById('userName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('selectedLevel').value;
      const autoTranslate = document.getElementById('autoTranslate').checked;
      const strictMode = document.getElementById('strictMode').checked;
      
      // åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ name, level, autoTranslate, strictMode, speechRate: 0.85 }, true);
      state.view = 'home';
      render();
    }

    function renderHome() {
      const user = state.user;
      const recentChats = state.chatHistory.slice(0, 3);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      const streak = getStreakDays();
      const checkedToday = hasCheckedInToday();
      
      // è·å–ç”¨æˆ·çš„ä¼´ä¾£/æœ‹å‹åŠå…³ç³»æ•°æ®
      const myCompanion = state.relationData?.currentCompanion ? CHARACTERS[state.relationData.currentCompanion] : null;
      const myRel = myCompanion ? getRelationship(myCompanion.id) : null;
      const myHearts = myRel ? 'â¤ï¸'.repeat(myRel.intimacy || 1) + 'ğŸ¤'.repeat(3 - (myRel.intimacy || 1)) : '';
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <div class="flex items-center justify-between mb-4">
              <button onclick="state.view='userSelect';render()" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-lg font-bold">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div class="text-left">
                  <div class="text-sm text-white/70">Â¡Hola!</div>
                  <div class="font-bold flex items-center gap-1">${user.name} <span class="text-xs text-white/50">â–¼</span></div>
                </div>
              </button>
              <button onclick="state.view='settings';render()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                âš™ï¸
              </button>
            </div>
            <!-- ç‚¹å‡»è¿›å…¥ç»Ÿè®¡é¡µé¢ -->
            <div onclick="state.view='stats';render()" class="flex gap-3 text-sm cursor-pointer hover:opacity-90 transition-opacity">
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">æ°´å¹³</div>
                <div class="font-bold">${user.level}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">å¯¹è¯</div>
                <div class="font-bold">${state.chatHistory.length}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">è¿ç»­</div>
                <div class="font-bold">${streak}å¤©</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">è¯æ±‡</div>
                <div class="font-bold">${state.vocabulary.length}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- ğŸ’• å…³ç³»æ¨¡å¼ -->
            <div class="mb-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-500">ğŸ’• æˆ‘çš„ä¼´ä¾£/æœ‹å‹</h3>
                <button onclick="state.view='companion';render()" class="text-xs text-primary-600">æ›´æ¢ â†’</button>
              </div>
              ${myCompanion ? `
                <button onclick="selectCompanion('${myCompanion.id}')" 
                  class="w-full bg-gradient-to-r ${myCompanion.color} p-4 rounded-2xl shadow-lg text-white flex items-center gap-4 hover:shadow-xl active:scale-98 transition-all">
                  <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-3xl">${myCompanion.avatar}</div>
                  <div class="flex-1 text-left">
                    <div class="font-bold text-lg">${myCompanion.name}</div>
                    <div class="text-white/80 text-sm">${myCompanion.relationName}</div>
                    <div class="text-sm mt-1">${myHearts} <span class="text-white/60 text-xs">${myRel?.odometer || 0}æ¬¡å¯¹è¯</span></div>
                  </div>
                  <div class="text-white/80 text-xl">ğŸ’¬</div>
                </button>
              ` : `
                <button onclick="state.view='companion';render()" 
                  class="w-full bg-gradient-to-r from-pink-400 to-rose-500 p-4 rounded-2xl shadow-lg text-white flex items-center gap-4 hover:shadow-xl active:scale-98 transition-all">
                  <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-3xl">ğŸ’•</div>
                  <div class="flex-1 text-left">
                    <div class="font-bold text-lg">é€‰æ‹©ä½ çš„ä¼´ä¾£/æœ‹å‹</div>
                    <div class="text-white/80 text-sm">å»ºç«‹æ·±åº¦æƒ…æ„Ÿè¿æ¥</div>
                  </div>
                  <div class="text-white/80 text-xl">â†’</div>
                </button>
              `}
            </div>
            
            <!-- ğŸ’¼ å¿«é€Ÿç»ƒä¹  -->
            <div class="mb-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-500">ğŸ’¼ å¿«é€Ÿç»ƒä¹ </h3>
                <button onclick="state.view='service';render()" class="text-xs text-primary-600">æ›´å¤š â†’</button>
              </div>
              <div class="grid grid-cols-4 gap-2">
                ${SERVICE_SCENARIOS.slice(0, 4).map(s => `
                  <button onclick="startServiceScenario('${s.id}')" 
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ğŸ‘¨â€ğŸ« å­¦ä¹ ä¸­å¿ƒ -->
            <div class="mb-5">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ‘¨â€ğŸ« å­¦ä¹ ä¸­å¿ƒ</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="selectTeacher('profesor')" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-slate-300 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-600 to-slate-800 flex items-center justify-center text-xl">ğŸ‘¨ğŸ»â€ğŸ«</div>
                    <div class="text-left">
                      <div class="font-bold text-gray-800 text-sm">Prof. GarcÃ­a</div>
                      <div class="text-xs text-gray-500">ä¸¥æ ¼æ•™å­¦</div>
                    </div>
                  </div>
                </button>
                <button onclick="selectTeacher('isabel')" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-teal-300 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center text-xl">ğŸ‘©ğŸ»â€ğŸ«</div>
                    <div class="text-left">
                      <div class="font-bold text-gray-800 text-sm">Maestra Isabel</div>
                      <div class="text-xs text-gray-500">æ¸©æŸ”é¼“åŠ±</div>
                    </div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- âš”ï¸ æ–©å•è¯å…¥å£ -->
            <div class="mb-5">
              <button onclick="state.view='wordSlash';render()" 
                class="w-full bg-gradient-to-r from-amber-400 to-orange-500 p-4 rounded-2xl shadow-lg text-white flex items-center gap-4 hover:shadow-xl active:scale-98 transition-all">
                <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-3xl">âš”ï¸</div>
                <div class="flex-1 text-left">
                  <div class="font-bold text-lg">æ–©å•è¯</div>
                  <div class="text-white/80 text-sm">å·²æŒæ¡ ${getMasteredCount()} ä¸ª Â· ${getWordsToReview().length > 0 ? `${getWordsToReview().length}ä¸ªå¾…å¤ä¹ ` : 'ä»Šæ—¥å·²å®Œæˆ'}</div>
                </div>
                <div class="text-white/80 text-xl">â†’</div>
              </button>
            </div>
            
            <!-- ğŸ› ï¸ å­¦ä¹ å·¥å…· -->
            <div class="mb-5">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ› ï¸ å­¦ä¹ å·¥å…·</h3>
              <div class="grid grid-cols-4 gap-2">
                <button onclick="state.view='mistakes';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ“</div>
                    <div class="text-xs text-gray-700">é”™é¢˜æœ¬</div>
                    <div class="text-xs text-gray-400">${state.mistakeBook.length}</div>
                  </div>
                </button>
                <button onclick="state.view='vocabulary';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ“š</div>
                    <div class="text-xs text-gray-700">è¯æ±‡æœ¬</div>
                    <div class="text-xs text-gray-400">${state.vocabulary.length}</div>
                  </div>
                </button>
                <button onclick="state.view='calendar';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">${checkedToday ? 'âœ…' : 'ğŸ“…'}</div>
                    <div class="text-xs text-gray-700">æ‰“å¡</div>
                    <div class="text-xs text-gray-400">${streak}å¤©</div>
                  </div>
                </button>
                <button onclick="state.view='achievements';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ†</div>
                    <div class="text-xs text-gray-700">æˆå°±</div>
                    <div class="text-xs text-gray-400">${state.achievements.length}/${ACHIEVEMENTS.length}</div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- æœ€è¿‘å¯¹è¯ -->
            ${recentChats.length > 0 ? `
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-500">ğŸ“œ æœ€è¿‘å¯¹è¯</h3>
                  <button onclick="state.view='history';render()" class="text-xs text-primary-600">æŸ¥çœ‹å…¨éƒ¨ â†’</button>
                </div>
                <div class="space-y-2">
                  ${recentChats.map((chat, index) => {
                    const character = CHARACTERS[chat.tutor];
                    const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                    const date = new Date(chat.date);
                    return `
                      <div onclick="loadHistoryChat(${index})" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md active:scale-98 transition-all">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${character?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-lg">${character?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 text-sm">${character?.name || 'æœªçŸ¥'} Â· ${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()}</div>
                          </div>
                          ${chat.corrections > 0 ? `<div class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full">${chat.corrections}</div>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ==================== æ–°æ¨¡å¼å‡½æ•° ====================
    // é€‰æ‹©é™ªä¼´å‹è§’è‰²
    function selectCompanion(characterId) {
      const character = CHARACTERS[characterId];
      if (!character || character.type !== ROLE_TYPES.COMPANION) return;
      
      // ä¿å­˜ä¸ºå½“å‰ä¼´ä¾£
      state.relationData.currentCompanion = characterId;
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
      
      state.tutor = character;
      state.view = 'companionScenario';
      render();
    }
    
    // é€‰æ‹©è€å¸ˆ
    function selectTeacher(teacherId) {
      const teacher = CHARACTERS[teacherId];
      if (!teacher || teacher.type !== ROLE_TYPES.TEACHER) return;
      
      state.tutor = teacher;
      state.view = 'studyCenter';
      render();
    }
    
    // å¼€å§‹å’Œè€å¸ˆå¯¹è¯
    function startTeacherChat(mode = 'free') {
      const teacher = state.tutor;
      if (!teacher) return;
      
      let scenario;
      switch (mode) {
        case 'grammar':
          scenario = { id: 'grammar', icon: 'ğŸ“–', name: 'è¯­æ³•è®²è§£', nameEs: 'GramÃ¡tica', desc: 'å­¦ä¹ è¯­æ³•çŸ¥è¯†' };
          break;
        case 'practice':
          scenario = { id: 'practice', icon: 'âœï¸', name: 'ç»ƒä¹ é¢˜', nameEs: 'Ejercicios', desc: 'åšç»ƒä¹ å·©å›ºçŸ¥è¯†' };
          break;
        case 'qa':
          scenario = { id: 'qa', icon: 'â“', name: 'ç­”ç–‘è§£æƒ‘', nameEs: 'Preguntas', desc: 'é—®è€å¸ˆé—®é¢˜' };
          break;
        default:
          scenario = { id: 'lesson', icon: 'ğŸ“š', name: 'è‡ªç”±å­¦ä¹ ', nameEs: 'Clase libre', desc: 'å’Œè€å¸ˆè‡ªç”±äº¤æµ' };
      }
      
      startChat(teacher, scenario);
    }
    
    // å¼€å§‹æœåŠ¡åœºæ™¯
    function startServiceScenario(scenarioId) {
      const scenario = SERVICE_SCENARIOS.find(s => s.id === scenarioId);
      if (!scenario) return;
      
      const npc = CHARACTERS[scenario.npc];
      if (!npc) return;
      
      state.tutor = npc;
      startChat(npc, scenario);
    }
    
    // æ¸²æŸ“ä¼´ä¾£é€‰æ‹©é¡µé¢
    // ç”Ÿæˆè§’è‰²å¡ç‰‡HTML
    function renderCharacterCard(c) {
      const rel = getRelationship(c.id);
      const isCurrent = state.relationData?.currentCompanion === c.id;
      const intimacyLevel = rel?.intimacy || 0;
      const hearts = intimacyLevel > 0 ? 'â¤ï¸'.repeat(intimacyLevel) + 'ğŸ¤'.repeat(3 - intimacyLevel) : '';
      
      return `
        <button onclick="selectCompanion('${c.id}')" 
          class="bg-white p-4 rounded-xl shadow-sm border-2 ${isCurrent ? 'border-primary-500 ring-2 ring-primary-200' : 'border-gray-100'} hover:shadow-md active:scale-98 transition-all">
          <div class="flex flex-col items-center text-center">
            <div class="relative">
              <div class="w-14 h-14 rounded-full bg-gradient-to-br ${c.color} flex items-center justify-center text-2xl mb-1">${c.avatar}</div>
              ${isCurrent ? '<div class="absolute -top-1 -right-1 text-sm">ğŸ’•</div>' : ''}
            </div>
            <div class="font-bold text-gray-800">${c.name}</div>
            <div class="text-xs text-primary-600">${c.role}</div>
            ${rel ? `
              <div class="text-xs mt-1">${hearts}</div>
              <div class="text-xs text-gray-400">${rel.odometer || 0}æ¬¡å¯¹è¯</div>
            ` : `
              <div class="text-xs text-gray-400 mt-1">æœªè®¤è¯†</div>
            `}
          </div>
        </button>
      `;
    }
    
    function renderCompanionSelect() {
      const companions = Object.values(CHARACTERS).filter(c => c.type === ROLE_TYPES.COMPANION);
      const friends = companions.filter(c => c.relation === 'friend');
      const boyfriends = companions.filter(c => c.relation === 'boyfriend');
      const girlfriends = companions.filter(c => c.relation === 'girlfriend');
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-pink-500 to-rose-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-xl font-bold">ğŸ’• é€‰æ‹©ä½ çš„ä¼´ä¾£/æœ‹å‹</h1>
            <p class="text-white/80 text-sm mt-1">å»ºç«‹æ·±åº¦æƒ…æ„Ÿè¿æ¥ï¼Œé™ªä½ å»ä»»ä½•åœºæ™¯</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ‘‹ æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${friends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
            
            <!-- ç”·æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ’™ ç”·æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${boyfriends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
            
            <!-- å¥³æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ’— å¥³æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${girlfriends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // æ¸²æŸ“é™ªä¼´åœºæ™¯é€‰æ‹©
    function renderCompanionScenario() {
      const c = state.tutor;
      if (!c) {
        state.view = 'home';
        render();
        return '';
      }
      
      // è·å–å…³ç³»æ•°æ®
      const rel = getRelationship(c.id);
      const intimacyLevel = rel?.intimacy || 1;
      const intimacyName = getIntimacyName(intimacyLevel);
      const hearts = 'â¤ï¸'.repeat(intimacyLevel) + 'ğŸ¤'.repeat(3 - intimacyLevel);
      
      // æŒ‰ç±»åˆ«åˆ†ç»„åœºæ™¯
      const dateScenes = COMPANION_SCENARIOS.filter(s => s.category === 'date');
      const lifeScenes = COMPANION_SCENARIOS.filter(s => s.category === 'life');
      const travelScenes = COMPANION_SCENARIOS.filter(s => s.category === 'travel');
      const dailyScenes = COMPANION_SCENARIOS.filter(s => s.category === 'daily' || s.category === 'social');
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r ${c.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='companion';render()" class="text-white/80 text-sm flex items-center gap-1">â† æ¢äºº</button>
              <button onclick="state.view='home';render()" class="text-white/80 text-sm">ğŸ  é¦–é¡µ</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${c.avatar}</div>
              <div class="flex-1">
                <div class="text-xl font-bold">${c.name}</div>
                <div class="text-white/80">${c.relationName}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-sm">${hearts}</span>
                  <span class="text-white/60 text-xs">${intimacyName}</span>
                </div>
              </div>
              <div class="text-right text-white/60 text-xs">
                <div>${rel?.odometer || 0}æ¬¡å¯¹è¯</div>
                ${rel?.firstMet ? `<div>è®¤è¯†${Math.floor((new Date() - new Date(rel.firstMet)) / (1000*60*60*24)) + 1}å¤©</div>` : ''}
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">æƒ³å’Œ${c.name}å»å“ªï¼Ÿ</h3>
            
            <!-- çº¦ä¼šåœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ’• çº¦ä¼š</div>
              <div class="grid grid-cols-4 gap-2">
                ${dateScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-pink-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ç”Ÿæ´»åœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ  ç”Ÿæ´»</div>
              <div class="grid grid-cols-4 gap-2">
                ${lifeScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-blue-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- å‡ºè¡Œåœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸš‡ å‡ºè¡Œ</div>
              <div class="grid grid-cols-4 gap-2">
                ${travelScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-green-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- æ—¥å¸¸åœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ’¬ æ—¥å¸¸</div>
              <div class="grid grid-cols-4 gap-2">
                ${dailyScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-purple-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, COMPANION_SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${c.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ’¬ ç›´æ¥å¼€å§‹èŠå¤©
            </button>
          </div>
        </div>
      `;
    }
    
    // æ¸²æŸ“æœåŠ¡åœºæ™¯é€‰æ‹©
    function renderServiceSelect() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-xl font-bold">ğŸ’¼ å®ç”¨åœºæ™¯ç»ƒä¹ </h1>
            <p class="text-white/80 text-sm mt-1">ç›´æ¥è¿›å…¥åœºæ™¯ï¼Œå’Œä¸“ä¸šNPCå¯¹è¯ç»ƒä¹ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="grid grid-cols-2 gap-3">
              ${SERVICE_SCENARIOS.map(s => {
                const npc = CHARACTERS[s.npc];
                return `
                  <button onclick="startServiceScenario('${s.id}')" 
                    class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-primary-200 active:scale-98 transition-all text-left">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="text-3xl">${s.icon}</div>
                      <div>
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-400">${s.nameEs}</div>
                      </div>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">${s.desc}</div>
                    <div class="flex items-center gap-2 text-xs text-primary-600">
                      <span>${npc?.avatar}</span>
                      <span>${npc?.name}</span>
                    </div>
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== å­¦ä¹ ä¸­å¿ƒ ====================
    // è®¡ç®—å­¦ä¹ ç»Ÿè®¡æ•°æ®
    function getStudyStats() {
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      // æœ¬å‘¨å¯¹è¯æ•°
      const weekChats = state.chatHistory.filter(c => new Date(c.date) >= weekAgo);
      const weekChatCount = weekChats.length;
      
      // æœ¬å‘¨çº æ­£æ•°
      const weekCorrections = weekChats.reduce((sum, c) => sum + (c.corrections || 0), 0);
      
      // æ€»ä½“ç»Ÿè®¡
      const totalChats = state.chatHistory.length;
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      
      // è¿ç»­æ‰“å¡
      const streak = getStreakDays();
      
      // è¯æ±‡é‡
      const vocabCount = state.vocabulary.length;
      
      // å¸¸è§é”™è¯¯ç±»å‹ï¼ˆç®€å•åˆ†æï¼‰
      const recentMistakes = state.mistakeBook.slice(0, 10);
      
      return {
        weekChatCount,
        weekCorrections,
        totalChats,
        totalCorrections,
        streak,
        vocabCount,
        recentMistakes
      };
    }
    
    // ç”Ÿæˆä»Šæ—¥ä»»åŠ¡
    function getDailyTasks() {
      const stats = getStudyStats();
      const checkedToday = hasCheckedInToday();
      
      // ä»Šå¤©çš„å¯¹è¯æ•°
      const today = new Date().toDateString();
      const todayChats = state.chatHistory.filter(c => new Date(c.date).toDateString() === today).length;
      
      // ä»Šå¤©å¤ä¹ çš„å•è¯æ•°ï¼ˆç®€åŒ–ï¼šæ£€æŸ¥æœ€è¿‘çš„flashcard reviewï¼‰
      const todayVocabReviewed = state.stats?.todayVocabReviewed || 0;
      
      return [
        { 
          id: 'checkin', 
          icon: 'ğŸ“…', 
          name: 'æ¯æ—¥æ‰“å¡', 
          done: checkedToday,
          action: "state.view='calendar';render()"
        },
        { 
          id: 'chat', 
          icon: 'ğŸ’¬', 
          name: 'å®Œæˆ1æ¬¡å¯¹è¯', 
          done: todayChats >= 1,
          progress: `${todayChats}/1`,
          action: "state.view='home';render()"
        },
        { 
          id: 'vocab', 
          icon: 'ğŸ“š', 
          name: 'å¤ä¹ 5ä¸ªå•è¯', 
          done: todayVocabReviewed >= 5,
          progress: `${Math.min(todayVocabReviewed, 5)}/5`,
          action: "state.view='vocabulary';render()"
        },
        { 
          id: 'mistakes', 
          icon: 'ğŸ“', 
          name: 'å¤ä¹ é”™é¢˜', 
          done: false,
          action: "state.view='mistakes';render()"
        }
      ];
    }
    
    // æ¸²æŸ“å­¦ä¹ ä¸­å¿ƒ
    function renderStudyCenter() {
      const t = state.tutor;
      if (!t || t.type !== ROLE_TYPES.TEACHER) {
        state.view = 'home';
        render();
        return '';
      }
      
      const stats = getStudyStats();
      const tasks = getDailyTasks();
      const completedTasks = tasks.filter(t => t.done).length;
      
      // è¯­æ³•ä¸»é¢˜åˆ—è¡¨
      const grammarTopics = [
        { id: 'ser_estar', icon: 'ğŸ”¤', name: 'Ser vs Estar', desc: 'ä¸¤ä¸ª"æ˜¯"çš„åŒºåˆ«' },
        { id: 'preterito', icon: 'â°', name: 'ç®€å•è¿‡å»æ—¶', desc: 'PretÃ©rito indefinido' },
        { id: 'imperfecto', icon: 'ğŸ”„', name: 'è¿‡å»æœªå®Œæˆæ—¶', desc: 'PretÃ©rito imperfecto' },
        { id: 'subjuntivo', icon: 'ğŸ’­', name: 'è™šæ‹Ÿå¼', desc: 'Modo subjuntivo' },
        { id: 'por_para', icon: 'â†”ï¸', name: 'Por vs Para', desc: 'ä¸¤ä¸ª"ä¸ºäº†"çš„åŒºåˆ«' },
        { id: 'pronouns', icon: 'ğŸ‘†', name: 'ä»£è¯', desc: 'ç›´æ¥/é—´æ¥å®¾è¯­ä»£è¯' },
      ];
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ï¼šè€å¸ˆä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='home';render()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- ğŸ“Š å­¦ä¹ æŠ¥å‘Š -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š å­¦ä¹ æŠ¥å‘Š</h3>
              <div class="grid grid-cols-4 gap-2 text-center">
                <div class="bg-blue-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-blue-600">${stats.weekChatCount}</div>
                  <div class="text-xs text-gray-500">æœ¬å‘¨å¯¹è¯</div>
                </div>
                <div class="bg-amber-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-amber-600">${stats.weekCorrections}</div>
                  <div class="text-xs text-gray-500">æœ¬å‘¨çº æ­£</div>
                </div>
                <div class="bg-green-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-green-600">${stats.streak}</div>
                  <div class="text-xs text-gray-500">è¿ç»­å¤©æ•°</div>
                </div>
                <div class="bg-purple-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-purple-600">${stats.vocabCount}</div>
                  <div class="text-xs text-gray-500">è¯æ±‡é‡</div>
                </div>
              </div>
              ${stats.weekChatCount === 0 ? `
                <div class="mt-3 text-center text-gray-400 text-sm">æœ¬å‘¨è¿˜æ²¡æœ‰ç»ƒä¹ ï¼Œå¼€å§‹å­¦ä¹ å§ï¼</div>
              ` : stats.weekCorrections > 5 ? `
                <div class="mt-3 text-center text-amber-600 text-sm">ğŸ’¡ å»ºè®®å¤ä¹ ä¸€ä¸‹é”™é¢˜æœ¬ï¼Œå·©å›ºè–„å¼±ç‚¹</div>
              ` : `
                <div class="mt-3 text-center text-green-600 text-sm">ğŸ‘ ä¿æŒå¾—ä¸é”™ï¼ç»§ç»­åŠªåŠ›</div>
              `}
            </div>
            
            <!-- ğŸ“ ä»Šæ—¥ä»»åŠ¡ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-gray-800">ğŸ“ ä»Šæ—¥ä»»åŠ¡</h3>
                <span class="text-xs text-gray-400">${completedTasks}/${tasks.length} å®Œæˆ</span>
              </div>
              <div class="space-y-2">
                ${tasks.map(task => `
                  <button onclick="${task.action}" 
                    class="w-full flex items-center gap-3 p-3 rounded-xl ${task.done ? 'bg-green-50' : 'bg-gray-50'} hover:bg-gray-100 transition-all text-left">
                    <span class="text-xl">${task.done ? 'âœ…' : task.icon}</span>
                    <span class="flex-1 ${task.done ? 'text-green-700 line-through' : 'text-gray-700'}">${task.name}</span>
                    ${task.progress ? `<span class="text-xs text-gray-400">${task.progress}</span>` : ''}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ğŸ’¬ å’Œè€å¸ˆäº¤æµ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ’¬ å’Œè€å¸ˆäº¤æµ</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="startTeacherChat('free')" 
                  class="p-4 rounded-xl bg-gradient-to-br ${t.color} text-white hover:shadow-md active:scale-98 transition-all">
                  <div class="text-2xl mb-1">ğŸ“š</div>
                  <div class="font-bold">è‡ªç”±å­¦ä¹ </div>
                  <div class="text-xs text-white/70">éšä¾¿èŠèŠç»ƒè¥¿è¯­</div>
                </button>
                <button onclick="startTeacherChat('qa')" 
                  class="p-4 rounded-xl bg-gray-100 hover:bg-gray-200 active:scale-98 transition-all">
                  <div class="text-2xl mb-1">â“</div>
                  <div class="font-bold text-gray-800">é—®é—®é¢˜</div>
                  <div class="text-xs text-gray-500">è¯­æ³•ã€è¯æ±‡ç–‘é—®</div>
                </button>
              </div>
            </div>
            
            <!-- ğŸ“– è¯­æ³•è¯¾å ‚ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“– è¯­æ³•è¯¾å ‚</h3>
              <div class="grid grid-cols-3 gap-2">
                ${grammarTopics.map(topic => `
                  <button onclick="startGrammarLesson('${topic.id}')" 
                    class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 active:scale-98 transition-all text-center">
                    <div class="text-xl mb-1">${topic.icon}</div>
                    <div class="text-xs font-bold text-gray-700">${topic.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // å¼€å§‹è¯­æ³•è¯¾
    function startGrammarLesson(topicId) {
      const topics = {
        'ser_estar': { name: 'Ser vs Estar', nameEs: 'Ser y Estar', desc: 'å­¦ä¹ serå’Œestarçš„åŒºåˆ«å’Œç”¨æ³•' },
        'preterito': { name: 'ç®€å•è¿‡å»æ—¶', nameEs: 'PretÃ©rito indefinido', desc: 'å­¦ä¹ ç®€å•è¿‡å»æ—¶çš„å˜ä½å’Œç”¨æ³•' },
        'imperfecto': { name: 'è¿‡å»æœªå®Œæˆæ—¶', nameEs: 'PretÃ©rito imperfecto', desc: 'å­¦ä¹ è¿‡å»æœªå®Œæˆæ—¶åŠå…¶ä¸ç®€å•è¿‡å»æ—¶çš„åŒºåˆ«' },
        'subjuntivo': { name: 'è™šæ‹Ÿå¼', nameEs: 'Subjuntivo', desc: 'å­¦ä¹ è™šæ‹Ÿå¼çš„æ„æˆå’Œä½¿ç”¨åœºæ™¯' },
        'por_para': { name: 'Por vs Para', nameEs: 'Por y Para', desc: 'å­¦ä¹ porå’Œparaçš„åŒºåˆ«' },
        'pronouns': { name: 'ä»£è¯', nameEs: 'Pronombres', desc: 'å­¦ä¹ ç›´æ¥å’Œé—´æ¥å®¾è¯­ä»£è¯' }
      };
      
      const topic = topics[topicId];
      if (!topic) return;
      
      // æŠŠè¯­æ³•ä¸»é¢˜ä¿¡æ¯æ”¾åˆ°scenarioä¸­
      const scenario = { 
        id: `grammar_${topicId}`, 
        icon: 'ğŸ“–', 
        name: topic.name, 
        nameEs: topic.nameEs, 
        desc: topic.desc,
        isGrammarLesson: true,  // æ ‡è®°è¿™æ˜¯è¯­æ³•è¯¾
        grammarTopic: topic
      };
      
      startChat(state.tutor, scenario);
    }
    
    // æ¸²æŸ“é—®è€å¸ˆé¡µé¢ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç”¨å¯¹è¯ï¼‰
    function renderAskTeacher() {
      return renderStudyCenter();
    }
    
    // æ¸²æŸ“è¯­æ³•è¯¾é¡µé¢ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç”¨å¯¹è¯ï¼‰
    function renderGrammarLesson() {
      return renderStudyCenter();
    }

    // ==================== âš”ï¸ æ–©å•è¯ç³»ç»Ÿ ====================
    
    // è·å–å·²æŒæ¡å•è¯æ•°é‡
    function getMasteredCount() {
      return Object.values(state.wordProgress).filter(p => p.status === 'mastered').length;
    }
    
    // è·å–å­¦ä¹ ä¸­å•è¯æ•°é‡
    function getLearningCount() {
      return Object.values(state.wordProgress).filter(p => p.status === 'learning' || p.status === 'reviewing').length;
    }
    
    // è·å–å¾…å­¦å•è¯æ•°é‡
    function getNewCount(bookId) {
      const words = getWordBook(bookId || state.wordSettings.currentBook);
      return words.filter(w => !state.wordProgress[w.id]).length;
    }
    
    // è‰¾å®¾æµ©æ–¯å¤ä¹ é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    const REVIEW_INTERVALS = [
      1 * 24 * 60,      // 1å¤©
      2 * 24 * 60,      // 2å¤©  
      4 * 24 * 60,      // 4å¤©
      7 * 24 * 60,      // 7å¤©
      15 * 24 * 60,     // 15å¤© -> æŒæ¡
    ];
    
    // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
    function getNextReviewTime(correctCount) {
      const interval = REVIEW_INTERVALS[Math.min(correctCount, REVIEW_INTERVALS.length - 1)];
      return new Date(Date.now() + interval * 60 * 1000).toISOString();
    }
    
    // è·å–éœ€è¦å¤ä¹ çš„å•è¯
    function getWordsToReview() {
      const now = new Date();
      return Object.entries(state.wordProgress)
        .filter(([id, p]) => {
          if (p.status === 'mastered') return false;
          if (!p.nextReview) return true;
          return new Date(p.nextReview) <= now;
        })
        .map(([id, p]) => {
          const word = getWordBook(state.wordSettings.currentBook).find(w => w.id === id);
          return word ? { ...word, progress: p } : null;
        })
        .filter(Boolean);
    }
    
    // è·å–æ–°å•è¯
    function getNewWords(count) {
      const words = getWordBook(state.wordSettings.currentBook);
      return words
        .filter(w => !state.wordProgress[w.id])
        .slice(0, count);
    }
    
    // ç”Ÿæˆé€‰é¡¹ï¼ˆ1ä¸ªæ­£ç¡® + 3ä¸ªé”™è¯¯ï¼‰
    function generateOptions(correctWord) {
      const words = getWordBook(state.wordSettings.currentBook);
      const wrongOptions = words
        .filter(w => w.id !== correctWord.id)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3)
        .map(w => ({ meaning: w.meaning, correct: false }));
      
      const options = [
        { meaning: correctWord.meaning, correct: true },
        ...wrongOptions
      ].sort(() => Math.random() - 0.5);
      
      return options;
    }
    
    // å¼€å§‹å­¦ä¹ 
    function startWordLearning(mode = 'mixed') {
      const reviewWords = getWordsToReview();
      const newWords = getNewWords(state.wordSettings.dailyNew);
      
      let queue = [];
      if (mode === 'new') {
        queue = newWords;
      } else if (mode === 'review') {
        queue = reviewWords;
      } else {
        // æ··åˆæ¨¡å¼ï¼šå…ˆå¤ä¹ ï¼Œå†æ–°å­¦
        queue = [...reviewWords.slice(0, state.wordSettings.dailyReview), ...newWords];
      }
      
      if (queue.length === 0) {
        alert('æ²¡æœ‰éœ€è¦å­¦ä¹ çš„å•è¯äº†ï¼');
        return;
      }
      
      state.wordSlash = {
        mode: 'learning',
        queue: queue.sort(() => Math.random() - 0.5),
        currentIndex: 0,
        options: generateOptions(queue[0]),
        answered: false,
        correct: null,
        selectedIndex: null,
        results: [],
        todayNew: 0,
        todayReview: 0,
      };
      render();
    }
    
    // é€‰æ‹©ç­”æ¡ˆ
    function selectWordAnswer(optionIndex) {
      if (state.wordSlash.answered) return;
      
      const ws = state.wordSlash;
      const currentWord = ws.queue[ws.currentIndex];
      const selected = ws.options[optionIndex];
      const isCorrect = selected.correct;
      
      ws.answered = true;
      ws.correct = isCorrect;
      ws.selectedIndex = optionIndex; // è®°å½•ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹ç´¢å¼•
      ws.results.push({ 
        word: currentWord, 
        correct: isCorrect 
      });
      
      // æ›´æ–°è¿›åº¦
      const progress = state.wordProgress[currentWord.id] || {
        status: 'new',
        correctCount: 0,
        wrongCount: 0,
        lastSeen: null,
        nextReview: null
      };
      
      progress.lastSeen = new Date().toISOString();
      
      if (isCorrect) {
        progress.correctCount = (progress.correctCount || 0) + 1;
        progress.wrongCount = progress.wrongCount || 0;
        
        // æ£€æŸ¥æ˜¯å¦æŒæ¡
        if (progress.correctCount >= 5) {
          progress.status = 'mastered';
          progress.nextReview = null;
        } else {
          progress.status = progress.status === 'new' ? 'learning' : 'reviewing';
          progress.nextReview = getNextReviewTime(progress.correctCount);
        }
      } else {
        progress.wrongCount = (progress.wrongCount || 0) + 1;
        progress.correctCount = Math.max(0, (progress.correctCount || 0) - 1);
        progress.status = 'learning';
        progress.nextReview = getNextReviewTime(0); // é‡ç½®å¤ä¹ é—´éš”
      }
      
      state.wordProgress[currentWord.id] = progress;
      
      // ä¿å­˜è¿›åº¦
      if (state.user) {
        Storage.setUserData(state.user.id, 'wordProgress', state.wordProgress);
      }
      
      // æ’­æ”¾å•è¯å‘éŸ³
      speak(currentWord.word);
      
      render();
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
    }
    
    // ä¸‹ä¸€ä¸ªå•è¯
    function nextWord() {
      const ws = state.wordSlash;
      
      if (ws.currentIndex >= ws.queue.length - 1) {
        // å­¦ä¹ å®Œæˆ
        ws.mode = 'result';
        render();
        return;
      }
      
      ws.currentIndex++;
      ws.options = generateOptions(ws.queue[ws.currentIndex]);
      ws.answered = false;
      ws.correct = null;
      ws.selectedIndex = null;
      render();
    }
    
    // æ¸²æŸ“æ–©å•è¯é¡µé¢
    function renderWordSlash() {
      const ws = state.wordSlash;
      
      if (ws.mode === 'learning') {
        return renderWordLearning();
      } else if (ws.mode === 'dictation') {
        return renderDictation();
      } else if (ws.mode === 'result') {
        return renderWordResult();
      } else {
        return renderWordHome();
      }
    }
    
    // æ–©å•è¯é¦–é¡µ
    function renderWordHome() {
      const book = WORD_BOOKS[state.wordSettings.currentBook];
      const words = getWordBook(state.wordSettings.currentBook);
      const totalWords = words.length;
      const mastered = Object.values(state.wordProgress).filter(p => p.status === 'mastered').length;
      const learning = Object.values(state.wordProgress).filter(p => p.status === 'learning' || p.status === 'reviewing').length;
      const newCount = totalWords - mastered - learning;
      const progress = totalWords > 0 ? Math.round((mastered / totalWords) * 100) : 0;
      
      const reviewCount = getWordsToReview().length;
      const canLearnNew = newCount > 0;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r ${book.color} p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center gap-4">
              <div class="text-5xl">${book.icon}</div>
              <div>
                <h1 class="text-xl font-bold">âš”ï¸ æ–©å•è¯</h1>
                <p class="text-white/80 text-sm">${book.name}</p>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- å­¦ä¹ è¿›åº¦ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š å­¦ä¹ è¿›åº¦</h3>
              <div class="mb-3">
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-600">å·²æŒæ¡ ${mastered}/${totalWords}</span>
                  <span class="text-primary-600 font-bold">${progress}%</span>
                </div>
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r ${book.color} rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-green-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-green-600">${mastered}</div>
                  <div class="text-xs text-gray-500">å·²æŒæ¡ âœ…</div>
                </div>
                <div class="bg-amber-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-amber-600">${learning}</div>
                  <div class="text-xs text-gray-500">å­¦ä¹ ä¸­ ğŸ“–</div>
                </div>
                <div class="bg-gray-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-gray-600">${newCount}</div>
                  <div class="text-xs text-gray-500">å¾…å­¦ä¹  ğŸ†•</div>
                </div>
              </div>
            </div>
            
            <!-- ä»Šæ—¥ä»»åŠ¡ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ¯ ä»Šæ—¥ä»»åŠ¡</h3>
              <div class="space-y-3">
                ${reviewCount > 0 ? `
                  <button onclick="startWordLearning('review')" 
                    class="w-full p-4 rounded-xl bg-gradient-to-r from-amber-400 to-orange-500 text-white flex items-center gap-3 hover:shadow-lg active:scale-98 transition-all">
                    <span class="text-3xl">ğŸ”„</span>
                    <div class="flex-1 text-left">
                      <div class="font-bold">å¤ä¹ å•è¯</div>
                      <div class="text-white/80 text-sm">${reviewCount} ä¸ªå•è¯å¾…å¤ä¹ </div>
                    </div>
                    <span class="text-2xl">â†’</span>
                  </button>
                ` : `
                  <div class="p-4 rounded-xl bg-gray-100 text-gray-500 text-center">
                    âœ… ä»Šæ—¥å¤ä¹ å·²å®Œæˆ
                  </div>
                `}
                
                ${canLearnNew ? `
                  <button onclick="startWordLearning('new')" 
                    class="w-full p-4 rounded-xl bg-gradient-to-r from-green-400 to-emerald-500 text-white flex items-center gap-3 hover:shadow-lg active:scale-98 transition-all">
                    <span class="text-3xl">ğŸ†•</span>
                    <div class="flex-1 text-left">
                      <div class="font-bold">å­¦ä¹ æ–°è¯</div>
                      <div class="text-white/80 text-sm">ä»Šæ—¥ç›®æ ‡ ${state.wordSettings.dailyNew} ä¸ª</div>
                    </div>
                    <span class="text-2xl">â†’</span>
                  </button>
                ` : `
                  <div class="p-4 rounded-xl bg-gray-100 text-gray-500 text-center">
                    ğŸ‰ æ‰€æœ‰å•è¯å·²å­¦å®Œï¼
                  </div>
                `}
                
                <button onclick="startWordLearning('mixed')" 
                  class="w-full p-4 rounded-xl bg-gradient-to-r ${book.color} text-white flex items-center gap-3 hover:shadow-lg active:scale-98 transition-all">
                  <span class="text-3xl">âš”ï¸</span>
                  <div class="flex-1 text-left">
                    <div class="font-bold">å¼€å§‹æ–©è¯</div>
                    <div class="text-white/80 text-sm">å¤ä¹  + æ–°è¯æ··åˆæ¨¡å¼</div>
                  </div>
                  <span class="text-2xl">â†’</span>
                </button>
                
                <button onclick="startDictation()" 
                  class="w-full p-4 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-600 text-white flex items-center gap-3 hover:shadow-lg active:scale-98 transition-all">
                  <span class="text-3xl">âœï¸</span>
                  <div class="flex-1 text-left">
                    <div class="font-bold">å¬å†™æ¨¡å¼</div>
                    <div class="text-white/80 text-sm">å¬éŸ³æ‹¼å†™ï¼Œå¼ºåŒ–è®°å¿†</div>
                  </div>
                  <span class="text-2xl">â†’</span>
                </button>
              </div>
            </div>
            
            <!-- é€‰æ‹©è¯åº“ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“š é€‰æ‹©è¯åº“</h3>
              <div class="grid grid-cols-2 gap-2">
                ${Object.values(WORD_BOOKS).map(b => `
                  <button onclick="state.wordSettings.currentBook='${b.id}';Storage.setUserData(state.user.id,'wordSettings',state.wordSettings);render()" 
                    class="p-3 rounded-xl border-2 ${state.wordSettings.currentBook === b.id ? 'border-primary-500 bg-primary-50' : 'border-gray-100'} hover:border-primary-300 transition-all text-left">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-xl">${b.icon}</span>
                      <span class="font-bold text-gray-800 text-sm">${b.name}</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">${b.desc}</div>
                    <div class="text-xs text-primary-600 font-medium">${b.count} è¯</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- å­¦ä¹ è®¾ç½® -->
            <div class="bg-white rounded-2xl shadow-sm p-4">
              <h3 class="font-bold text-gray-800 mb-3">âš™ï¸ å­¦ä¹ è®¾ç½®</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">æ¯æ—¥æ–°è¯</span>
                  <div class="flex items-center gap-2">
                    <button onclick="state.wordSettings.dailyNew=Math.max(5,state.wordSettings.dailyNew-5);Storage.setUserData(state.user.id,'wordSettings',state.wordSettings);render()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">-</button>
                    <span class="w-12 text-center font-bold">${state.wordSettings.dailyNew}</span>
                    <button onclick="state.wordSettings.dailyNew=Math.min(50,state.wordSettings.dailyNew+5);Storage.setUserData(state.user.id,'wordSettings',state.wordSettings);render()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">+</button>
                  </div>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">æ¯æ—¥å¤ä¹ </span>
                  <div class="flex items-center gap-2">
                    <button onclick="state.wordSettings.dailyReview=Math.max(10,state.wordSettings.dailyReview-10);Storage.setUserData(state.user.id,'wordSettings',state.wordSettings);render()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">-</button>
                    <span class="w-12 text-center font-bold">${state.wordSettings.dailyReview}</span>
                    <button onclick="state.wordSettings.dailyReview=Math.min(100,state.wordSettings.dailyReview+10);Storage.setUserData(state.user.id,'wordSettings',state.wordSettings);render()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">+</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // å­¦ä¹ ç•Œé¢
    function renderWordLearning() {
      const ws = state.wordSlash;
      const currentWord = ws.queue[ws.currentIndex];
      const progress = state.wordProgress[currentWord.id];
      const isNew = !progress || progress.status === 'new';
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨è¿›åº¦ -->
          <div class="bg-white border-b p-4">
            <div class="flex items-center justify-between mb-2">
              <button onclick="state.wordSlash.mode='home';render()" class="text-gray-500">âœ• é€€å‡º</button>
              <span class="text-sm text-gray-500">${ws.currentIndex + 1} / ${ws.queue.length}</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-primary-500 rounded-full transition-all duration-300" 
                style="width: ${((ws.currentIndex + 1) / ws.queue.length) * 100}%"></div>
            </div>
          </div>
          
          <!-- å•è¯å¡ç‰‡ -->
          <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="text-center mb-8">
              ${isNew ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full mb-2 inline-block">ğŸ†• æ–°è¯</span>' : 
                '<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full mb-2 inline-block">ğŸ”„ å¤ä¹ </span>'}
              <div class="text-6xl mb-4">${currentWord.image}</div>
              <div class="text-3xl font-bold text-gray-800 mb-2">${currentWord.word}</div>
              <button onclick="speak('${currentWord.word}')" class="text-primary-500 text-sm">ğŸ”Š æ’­æ”¾å‘éŸ³</button>
            </div>
            
            <!-- é€‰é¡¹ -->
            <div class="w-full max-w-sm grid grid-cols-2 gap-3">
              ${ws.options.map((opt, i) => {
                let btnClass = 'bg-white border-2 border-gray-200 hover:border-primary-400';
                if (ws.answered) {
                  if (opt.correct) {
                    btnClass = 'bg-green-100 border-2 border-green-500 text-green-700';
                  } else if (i === ws.selectedIndex && !opt.correct) {
                    btnClass = 'bg-red-100 border-2 border-red-500 text-red-700';
                  } else {
                    btnClass = 'bg-gray-100 border-2 border-gray-200 text-gray-400';
                  }
                }
                return `
                  <button onclick="selectWordAnswer(${i})" 
                    class="p-4 rounded-xl ${btnClass} font-medium transition-all ${ws.answered ? 'cursor-default' : 'active:scale-95'}">
                    ${opt.meaning}
                  </button>
                `;
              }).join('')}
            </div>
            
            <!-- ç­”æ¡ˆåé¦ˆ -->
            ${ws.answered ? `
              <div class="mt-6 w-full max-w-sm">
                <div class="p-4 rounded-xl ${ws.correct ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">${ws.correct ? 'âœ…' : 'âŒ'}</span>
                    <span class="font-bold ${ws.correct ? 'text-green-700' : 'text-red-700'}">
                      ${ws.correct ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}
                    </span>
                  </div>
                  <div class="text-gray-700 mb-2">
                    <span class="font-bold">${currentWord.word}</span> = ${currentWord.meaning}
                  </div>
                  <div class="text-sm text-gray-600">
                    <div class="italic">"${currentWord.example}"</div>
                    <div class="text-gray-500">${currentWord.exampleZh}</div>
                  </div>
                </div>
                
                <button onclick="nextWord()" 
                  class="w-full mt-4 p-4 rounded-xl bg-primary-500 text-white font-bold hover:bg-primary-600 active:scale-98 transition-all">
                  ${ws.currentIndex >= ws.queue.length - 1 ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€ä¸ª â†’'}
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // ç»“æœé¡µé¢
    function renderWordResult() {
      const ws = state.wordSlash;
      const correct = ws.results.filter(r => r.correct).length;
      const total = ws.results.length;
      const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-primary-500 to-indigo-600 p-6 text-white text-center">
            <div class="text-5xl mb-2">ğŸ‰</div>
            <h1 class="text-xl font-bold">å­¦ä¹ å®Œæˆï¼</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- ç»Ÿè®¡ -->
            <div class="bg-white rounded-2xl shadow-sm p-6 mb-4 text-center">
              <div class="text-6xl font-bold text-primary-600 mb-2">${accuracy}%</div>
              <div class="text-gray-500">æ­£ç¡®ç‡</div>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-green-50 rounded-xl p-3">
                  <div class="text-2xl font-bold text-green-600">${correct}</div>
                  <div class="text-xs text-gray-500">ç­”å¯¹ âœ…</div>
                </div>
                <div class="bg-red-50 rounded-xl p-3">
                  <div class="text-2xl font-bold text-red-600">${total - correct}</div>
                  <div class="text-xs text-gray-500">ç­”é”™ âŒ</div>
                </div>
              </div>
            </div>
            
            <!-- å•è¯åˆ—è¡¨ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“ æœ¬æ¬¡å­¦ä¹ </h3>
              <div class="space-y-2 max-h-60 overflow-auto">
                ${ws.results.map(r => `
                  <div class="flex items-center gap-3 p-2 rounded-lg ${r.correct ? 'bg-green-50' : 'bg-red-50'}">
                    <span class="text-xl">${r.word.image}</span>
                    <div class="flex-1">
                      <span class="font-bold">${r.word.word}</span>
                      <span class="text-gray-500 text-sm ml-2">${r.word.meaning}</span>
                    </div>
                    <span>${r.correct ? 'âœ…' : 'âŒ'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="space-y-3">
              <button onclick="startWordLearning('mixed')" 
                class="w-full p-4 rounded-xl bg-primary-500 text-white font-bold hover:bg-primary-600 active:scale-98 transition-all">
                âš”ï¸ ç»§ç»­æ–©è¯
              </button>
              <button onclick="state.wordSlash.mode='home';render()" 
                class="w-full p-4 rounded-xl bg-gray-100 text-gray-700 font-bold hover:bg-gray-200 active:scale-98 transition-all">
                è¿”å›é¦–é¡µ
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== âœï¸ å¬å†™æ¨¡å¼ ====================
    
    // å¼€å§‹å¬å†™
    function startDictation() {
      const words = getWordBook(state.wordSettings.currentBook);
      // ä¼˜å…ˆé€‰æ‹©å·²å­¦è¿‡çš„å•è¯è¿›è¡Œå¬å†™
      const learnedWords = words.filter(w => state.wordProgress[w.id]);
      const queue = learnedWords.length >= 10 
        ? learnedWords.sort(() => Math.random() - 0.5).slice(0, 20)
        : words.sort(() => Math.random() - 0.5).slice(0, 20);
      
      if (queue.length === 0) {
        alert('è¯·å…ˆå­¦ä¹ ä¸€äº›å•è¯å†æ¥å¬å†™ï¼');
        return;
      }
      
      state.wordSlash = {
        ...state.wordSlash,
        mode: 'dictation',
        queue: queue,
        currentIndex: 0,
        dictationInput: '',
        dictationAnswered: false,
        dictationCorrect: null,
        dictationHint: 0, // 0=æ— æç¤º, 1=é¦–å­—æ¯, 2=æ›´å¤šæç¤º
        results: [],
      };
      
      render();
      
      // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€ä¸ªå•è¯
      setTimeout(() => speak(queue[0].word), 500);
    }
    
    // å¬å†™è¾“å…¥å¤„ç†
    function handleDictationInput(value) {
      state.wordSlash.dictationInput = value;
      render();
    }
    
    // è·å–æç¤º
    function getDictationHint() {
      const ws = state.wordSlash;
      const currentWord = ws.queue[ws.currentIndex];
      ws.dictationHint = Math.min(ws.dictationHint + 1, 2);
      render();
    }
    
    // ç”Ÿæˆæç¤ºæ–‡å­—
    function getHintText(word, hintLevel) {
      if (hintLevel === 0) return '';
      if (hintLevel === 1) {
        // æ˜¾ç¤ºé¦–å­—æ¯å’Œé•¿åº¦
        return word.charAt(0) + '_'.repeat(word.length - 1) + ` (${word.length}å­—æ¯)`;
      }
      // æ˜¾ç¤ºæ›´å¤šå­—æ¯
      const revealed = Math.ceil(word.length / 2);
      return word.substring(0, revealed) + '_'.repeat(word.length - revealed);
    }
    
    // æäº¤å¬å†™ç­”æ¡ˆ
    function submitDictation() {
      const ws = state.wordSlash;
      if (ws.dictationAnswered) return;
      
      const currentWord = ws.queue[ws.currentIndex];
      const userInput = ws.dictationInput.trim().toLowerCase();
      const correctAnswer = currentWord.word.toLowerCase();
      
      // æ£€æŸ¥ç­”æ¡ˆï¼ˆå¿½ç•¥é‡éŸ³ç¬¦å·è¿›è¡Œå®½æ¾åŒ¹é…ï¼‰
      const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const isCorrect = normalize(userInput) === normalize(correctAnswer) || userInput === correctAnswer;
      
      ws.dictationAnswered = true;
      ws.dictationCorrect = isCorrect;
      ws.results.push({
        word: currentWord,
        correct: isCorrect,
        userAnswer: ws.dictationInput
      });
      
      // æ›´æ–°è¿›åº¦ï¼ˆå¬å†™æ¨¡å¼ä¹Ÿè®¡å…¥å­¦ä¹ è¿›åº¦ï¼‰
      const progress = state.wordProgress[currentWord.id] || {
        status: 'new',
        correctCount: 0,
        wrongCount: 0,
        lastSeen: null,
        nextReview: null
      };
      
      progress.lastSeen = new Date().toISOString();
      if (isCorrect) {
        progress.correctCount = (progress.correctCount || 0) + 1;
        if (progress.correctCount >= 5) {
          progress.status = 'mastered';
        } else {
          progress.status = 'reviewing';
          progress.nextReview = getNextReviewTime(progress.correctCount);
        }
      } else {
        progress.wrongCount = (progress.wrongCount || 0) + 1;
        progress.correctCount = Math.max(0, (progress.correctCount || 0) - 1);
        progress.status = 'learning';
        progress.nextReview = getNextReviewTime(0);
      }
      
      state.wordProgress[currentWord.id] = progress;
      if (state.user) {
        Storage.setUserData(state.user.id, 'wordProgress', state.wordProgress);
      }
      
      render();
      checkAchievements();
    }
    
    // ä¸‹ä¸€ä¸ªå¬å†™å•è¯
    function nextDictation() {
      const ws = state.wordSlash;
      
      if (ws.currentIndex >= ws.queue.length - 1) {
        ws.mode = 'result';
        render();
        return;
      }
      
      ws.currentIndex++;
      ws.dictationInput = '';
      ws.dictationAnswered = false;
      ws.dictationCorrect = null;
      ws.dictationHint = 0;
      
      render();
      
      // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªå•è¯
      setTimeout(() => speak(ws.queue[ws.currentIndex].word), 300);
    }
    
    // æ¸²æŸ“å¬å†™ç•Œé¢
    function renderDictation() {
      const ws = state.wordSlash;
      const currentWord = ws.queue[ws.currentIndex];
      const hintText = getHintText(currentWord.word, ws.dictationHint);
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨è¿›åº¦ -->
          <div class="bg-white border-b p-4">
            <div class="flex items-center justify-between mb-2">
              <button onclick="state.wordSlash.mode='home';render()" class="text-gray-500">âœ• é€€å‡º</button>
              <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">âœï¸ å¬å†™æ¨¡å¼</span>
              <span class="text-sm text-gray-500">${ws.currentIndex + 1} / ${ws.queue.length}</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-purple-500 rounded-full transition-all duration-300" 
                style="width: ${((ws.currentIndex + 1) / ws.queue.length) * 100}%"></div>
            </div>
          </div>
          
          <!-- å¬å†™åŒºåŸŸ -->
          <div class="flex-1 flex flex-col items-center justify-center p-6">
            <div class="text-center mb-6">
              <div class="text-6xl mb-4">${currentWord.image}</div>
              <div class="text-gray-500 mb-2">${currentWord.meaning}</div>
              
              <!-- æ’­æ”¾æŒ‰é’® -->
              <button onclick="speak('${currentWord.word}')" 
                class="w-16 h-16 rounded-full bg-purple-500 text-white text-2xl flex items-center justify-center mx-auto hover:bg-purple-600 active:scale-95 transition-all shadow-lg">
                ğŸ”Š
              </button>
              <p class="text-sm text-gray-400 mt-2">ç‚¹å‡»æ’­æ”¾å‘éŸ³</p>
              
              ${hintText ? `
                <div class="mt-3 px-4 py-2 bg-amber-50 rounded-lg">
                  <span class="text-amber-700 font-mono text-lg">${hintText}</span>
                </div>
              ` : ''}
            </div>
            
            ${!ws.dictationAnswered ? `
              <!-- è¾“å…¥æ¡† -->
              <div class="w-full max-w-sm">
                <input type="text" 
                  id="dictationInput"
                  value="${ws.dictationInput}"
                  oninput="handleDictationInput(this.value)"
                  onkeypress="if(event.key==='Enter')submitDictation()"
                  placeholder="è¾“å…¥ä½ å¬åˆ°çš„å•è¯..."
                  class="w-full p-4 text-center text-xl border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                  autocomplete="off"
                  autocapitalize="off">
                
                <div class="flex gap-2 mt-4">
                  <button onclick="getDictationHint()" 
                    class="flex-1 p-3 rounded-xl bg-amber-100 text-amber-700 font-medium hover:bg-amber-200 transition-all ${ws.dictationHint >= 2 ? 'opacity-50' : ''}">
                    ğŸ’¡ æç¤º
                  </button>
                  <button onclick="submitDictation()" 
                    class="flex-1 p-3 rounded-xl bg-purple-500 text-white font-bold hover:bg-purple-600 active:scale-98 transition-all">
                    ç¡®è®¤ âœ“
                  </button>
                </div>
              </div>
            ` : `
              <!-- ç­”æ¡ˆåé¦ˆ -->
              <div class="w-full max-w-sm">
                <div class="p-4 rounded-xl ${ws.dictationCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">${ws.dictationCorrect ? 'âœ…' : 'âŒ'}</span>
                    <span class="font-bold ${ws.dictationCorrect ? 'text-green-700' : 'text-red-700'}">
                      ${ws.dictationCorrect ? 'æ‹¼å†™æ­£ç¡®ï¼' : 'æ‹¼å†™é”™è¯¯'}
                    </span>
                  </div>
                  
                  ${!ws.dictationCorrect ? `
                    <div class="mb-2">
                      <span class="text-gray-500">ä½ çš„ç­”æ¡ˆï¼š</span>
                      <span class="text-red-600 line-through">${ws.dictationInput || '(ç©º)'}</span>
                    </div>
                  ` : ''}
                  
                  <div class="text-lg">
                    <span class="text-gray-500">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                    <span class="font-bold text-gray-800">${currentWord.word}</span>
                    <button onclick="speak('${currentWord.word}')" class="ml-2 text-purple-500">ğŸ”Š</button>
                  </div>
                  
                  <div class="mt-2 text-sm text-gray-600">
                    <div class="italic">"${currentWord.example}"</div>
                    <div class="text-gray-500">${currentWord.exampleZh}</div>
                  </div>
                </div>
                
                <button onclick="nextDictation()" 
                  class="w-full mt-4 p-4 rounded-xl bg-purple-500 text-white font-bold hover:bg-purple-600 active:scale-98 transition-all">
                  ${ws.currentIndex >= ws.queue.length - 1 ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€ä¸ª â†’'}
                </button>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderTutor() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <div>
              <h1 class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</h1>
              <p class="text-xs text-gray-500">ç‚¹å‡»é€‰æ‹©è§’è‰²å¼€å§‹å¯¹è¯</p>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-lg mx-auto grid grid-cols-2 gap-3">
              ${Object.values(TUTORS).map(t => `
                <button onclick="state.tutor=TUTORS['${t.id}'];state.view='scenario';render()" 
                  class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-98 transition-all">
                  <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${t.color} flex items-center justify-center text-2xl mb-2">${t.avatar}</div>
                    <div class="font-bold text-gray-800 text-sm">${t.name}</div>
                    <div class="text-xs text-primary-600">${t.role}</div>
                    <div class="text-xs text-gray-400 mt-1 line-clamp-2">${t.description.substring(0, 20)}...</div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderScenario() {
      const t = state.tutor;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- è§’è‰²ä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='tutor';render()" class="text-white/80 text-sm flex items-center gap-1">â† æ¢è§’è‰²</button>
              <button onclick="state.view='home';render()" class="text-white/80 text-sm flex items-center gap-1">ğŸ  é¦–é¡µ</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name} ${t.emoji}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">é€‰æ‹©å¯¹è¯åœºæ™¯</h3>
            <div class="grid grid-cols-2 gap-3">
              ${SCENARIOS.map(s => `
                <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                  <div class="text-2xl mb-2">${s.icon}</div>
                  <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                  <div class="text-xs text-gray-400">${s.nameEs}</div>
                  <div class="text-xs text-gray-500 mt-1">${s.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${t.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ¤ ç›´æ¥å¼€å§‹è‡ªç”±å¯¹è¯
            </button>
          </div>
        </div>
      `;
    }

    function renderChat() {
      const t = state.tutor;
      const user = state.user;
      
      return `
        <div class="h-full bg-gray-100 flex flex-col">
          <!-- é¡¶æ  -->
          <div class="glass border-b p-3">
            <div class="flex items-center justify-between max-w-lg mx-auto">
              <button onclick="endChat()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                <span>â†</span>
                <span class="text-sm">è¿”å›</span>
              </button>
              <div class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-xl">${t.avatar}</span>
                  <span class="font-bold text-gray-800">${t.name}</span>
                </div>
                <div class="text-xs text-gray-500">${state.scenario?.name || 'è‡ªç”±èŠå¤©'} Â· ${user.level}</div>
              </div>
              <button onclick="exitToHome()" class="w-10 h-10 rounded-full hover:bg-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-700" title="è¿”å›é¦–é¡µ">
                ğŸ 
              </button>
            </div>
          </div>
          
          <!-- æ¶ˆæ¯åˆ—è¡¨ -->
          <div id="messages" class="flex-1 overflow-auto p-4 no-scrollbar">
            <div class="max-w-lg mx-auto space-y-4">
              ${state.messages.map(msg => renderMessage(msg, t)).join('')}
              
              ${state.isLoading ? `
                <div class="flex justify-start fade-in">
                  <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- çº æ­£ç»Ÿè®¡ -->
          ${state.corrections > 0 ? `
            <div class="bg-amber-50 border-t border-amber-100 py-2 text-center">
              <span class="text-sm text-amber-700">ğŸ“ æœ¬æ¬¡å¯¹è¯å·²çº æ­£ <strong>${state.corrections}</strong> å¤„</span>
            </div>
          ` : ''}
          
          <!-- æ™ºèƒ½å»ºè®®é¢æ¿ -->
          ${state.showSuggestions ? `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-t border-green-200 p-3 slide-up">
              <div class="max-w-lg mx-auto">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-green-800">ğŸ’¡ å›å¤å»ºè®®</span>
                  <button onclick="hideSuggestions()" class="text-green-600 text-xs hover:text-green-800">æ”¶èµ· âœ•</button>
                </div>
                ${state.isLoadingSuggestions ? `
                  <div class="flex items-center justify-center py-4">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                    <span class="ml-2 text-sm text-green-600">æ­£åœ¨ç”Ÿæˆå»ºè®®...</span>
                  </div>
                ` : `
                  <div class="space-y-2">
                    ${state.suggestions.map((s, i) => `
                      <button onclick="useSuggestion(${i})" 
                        class="w-full text-left p-3 bg-white rounded-xl border border-green-200 text-sm hover:border-green-400 hover:shadow-sm active:scale-98 transition-all">
                        <span class="text-gray-800">${s}</span>
                      </button>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          ` : ''}
          
          <!-- è¯æ±‡æ”¶è—æ¨¡æ€æ¡† -->
          ${state.vocabModal.show ? `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="closeVocabModal()">
              <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl slide-up" onclick="event.stopPropagation()">
                <div class="p-5 border-b border-gray-100">
                  <div class="flex items-center justify-between">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                      <span class="text-xl">ğŸ“š</span>
                      <span>æ”¶è—åˆ°è¯æ±‡æœ¬</span>
                    </h3>
                    <button onclick="closeVocabModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500">âœ•</button>
                  </div>
                </div>
                <div class="p-5 space-y-4">
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">è¥¿ç­ç‰™è¯­å•è¯</label>
                    <input id="vocabModalWord" type="text" value="${state.vocabModal.word}" 
                      oninput="state.vocabModal.word=this.value"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-lg font-medium">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¸­æ–‡æ„æ€</label>
                    <div class="relative">
                      <input id="vocabModalMeaning" type="text" value="${state.vocabModal.meaning}" 
                        oninput="state.vocabModal.meaning=this.value"
                        placeholder="${state.vocabModal.isLoading ? 'æ­£åœ¨ç¿»è¯‘...' : 'è¾“å…¥ä¸­æ–‡æ„æ€'}"
                        class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none ${state.vocabModal.isLoading ? 'bg-gray-50' : ''}">
                      ${state.vocabModal.isLoading ? `
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                          <div class="w-5 h-5 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¾‹å¥ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="vocabModalExample" type="text" value="${state.vocabModal.example}" 
                      oninput="state.vocabModal.example=this.value"
                      placeholder="å¯ä»¥è¾“å…¥ä¸€ä¸ªä¾‹å¥"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-sm">
                  </div>
                </div>
                <div class="p-5 border-t border-gray-100 flex gap-3">
                  <button onclick="closeVocabModal()" 
                    class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">å–æ¶ˆ</button>
                  <button onclick="saveVocabFromModal()" 
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-medium hover:from-green-600 hover:to-emerald-600 shadow-lg">
                    æ”¶è—
                  </button>
                </div>
              </div>
            </div>
          ` : ''}
          
          <!-- è¾“å…¥åŒº -->
          <div class="glass border-t p-3 safe-bottom">
            <div class="max-w-lg mx-auto">
              <div class="flex gap-2 items-center">
                <button onclick="toggleListening()" 
                  class="relative w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.isListening ? 'bg-red-500 text-white mic-recording' : 'bg-gray-200 hover:bg-gray-300'}">
                  ${state.isListening ? 'â¹' : 'ğŸ¤'}
                </button>
                
                <input id="chatInput" type="text" value="${state.inputText.replace(/"/g, '&quot;')}" 
                  placeholder="${state.isListening ? 'ğŸ™ï¸ æ­£åœ¨å¬...' : 'ç”¨è¥¿ç­ç‰™è¯­è¾“å…¥...'}"
                  oninput="state.inputText=this.value"
                  onkeydown="if(event.key==='Enter')sendMessage()"
                  class="flex-1 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${state.isListening ? 'bg-red-50 border-2 border-red-200' : 'bg-white border border-gray-200'}">
                
                <button onclick="sendMessage()" 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.inputText.trim() && !state.isLoading ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-200 text-gray-400'}">
                  â¤
                </button>
              </div>
              
              <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar">
                <!-- æ™ºèƒ½å»ºè®®æŒ‰é’® -->
                <button onclick="getSuggestions()" 
                  class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full text-xs whitespace-nowrap hover:from-green-600 hover:to-emerald-600 shadow-sm flex items-center gap-1 ${state.isLoadingSuggestions ? 'opacity-50' : ''}">
                  <span>ğŸ’¡</span>
                  <span>ä¸çŸ¥é“è¯´ä»€ä¹ˆï¼Ÿ</span>
                </button>
                ${['No entiendo', 'Â¿Puedes repetir?', 'MÃ¡s despacio'].map(p => `
                  <button onclick="state.inputText='${p}';render()" 
                    class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded-full text-xs whitespace-nowrap hover:border-primary-300 hover:text-primary-600">${p}</button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMessage(msg, tutor) {
      const isUser = msg.type === 'user';
      const showTrans = state.showTranslation[msg.id];
      const translation = state.translationCache[msg.id];
      
      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} fade-in">
          <div class="max-w-[85%]">
            ${!isUser ? `
              <div class="flex items-center gap-2 mb-1">
                <div class="w-7 h-7 rounded-full bg-gradient-to-br ${tutor.color} flex items-center justify-center text-sm">${tutor.avatar}</div>
                <span class="text-xs text-gray-500">${tutor.name}</span>
              </div>
            ` : ''}
            
            <div class="relative">
              <div id="msg-${msg.id}"
                class="p-4 rounded-2xl text-sm select-text ${isUser 
                  ? 'bg-primary-500 text-white rounded-br-sm' 
                  : 'bg-white shadow-sm rounded-bl-sm'}">
                ${msg.text}
              </div>
              
              ${!isUser && showTrans && translation ? `
                <div class="mt-2 p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-800 whitespace-pre-line">
                  ${translation}
                </div>
              ` : ''}
              
              ${!isUser ? `
                <div class="absolute -right-12 top-0 flex flex-col gap-1">
                  <button onclick="handleSpeakClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-gray-50" title="æœ—è¯»">
                    ğŸ”Š
                  </button>
                  <button onclick="handleTranslateClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-blue-50 hover:text-blue-600 ${showTrans ? 'bg-blue-100 text-blue-600' : ''}" title="ç¿»è¯‘">
                    ğŸŒ
                  </button>
                  <button onclick="openVocabModalFromSelection(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-green-50 hover:text-green-600" title="é€‰ä¸­å•è¯åæ”¶è—">
                    ğŸ“š
                  </button>
                </div>
              ` : ''}
            </div>
            
            ${msg.correction ? `
              <div class="correction-card mt-3 p-4 slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-amber-800 font-medium">
                    <span class="text-lg">âœï¸</span>
                    <span>è¯­æ³•çº æ­£</span>
                  </div>
                  <button onclick="handleCorrectionTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showCorrectionTrans[msg.id] ? 'bg-amber-200 text-amber-800' : 'bg-amber-100 text-amber-600'} hover:bg-amber-200 transition-colors">
                    ğŸŒ ${state.showCorrectionTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-amber-900">${msg.correction}</div>
                ${state.showCorrectionTrans[msg.id] && state.correctionTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-amber-800 border border-amber-200 whitespace-pre-line">
                    ${state.correctionTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${msg.grammar ? `
              <div class="mt-3 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-xl slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-blue-800 font-medium">
                    <span class="text-lg">ğŸ“š</span>
                    <span>è¯­æ³•çŸ¥è¯†</span>
                  </div>
                  <button onclick="handleGrammarTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showGrammarTrans[msg.id] ? 'bg-blue-200 text-blue-800' : 'bg-blue-100 text-blue-600'} hover:bg-blue-200 transition-colors">
                    ğŸŒ ${state.showGrammarTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-blue-900">${msg.grammar}</div>
                ${state.showGrammarTrans[msg.id] && state.grammarTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-blue-800 border border-blue-200 whitespace-pre-line">
                    ${state.grammarTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // å¤„ç†ç¿»è¯‘ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
    function handleTranslateClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        getTranslation(msgId, msg.text);
      }
    }
    
    // å¤„ç†æœ—è¯»ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬
    function handleSpeakClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        speak(msg.text);
      }
    }
    
    // ==================== å¿«é€Ÿæ”¶è—è¯æ±‡åŠŸèƒ½ ====================
    // æ‰“å¼€è¯æ±‡æ”¶è—æ¨¡æ€æ¡†
    function openVocabModalFromSelection(msgId) {
      // è·å–ç”¨æˆ·é€‰ä¸­çš„æ–‡å­—
      const selection = window.getSelection();
      let selectedText = selection.toString().trim();
      
      // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡å­—ï¼Œæç¤ºç”¨æˆ·
      if (!selectedText) {
        // å°è¯•è·å–æ•´ä¸ªå•è¯ï¼ˆå¦‚æœç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªä½ç½®ï¼‰
        alert('è¯·å…ˆåœ¨AIå›å¤ä¸­é€‰ä¸­è¦æ”¶è—çš„å•è¯æˆ–çŸ­è¯­ï¼Œç„¶åå†ç‚¹å‡»æ”¶è—æŒ‰é’®');
        return;
      }
      
      // æ¸…ç†é€‰ä¸­çš„æ–‡å­—ï¼ˆå»é™¤æ ‡ç‚¹ç¬¦å·ï¼‰
      selectedText = selectedText.replace(/[.,!?Â¡Â¿;:"()]/g, '').trim();
      
      if (!selectedText) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å•è¯æˆ–çŸ­è¯­');
        return;
      }
      
      // è·å–å½“å‰æ¶ˆæ¯ä½œä¸ºä¾‹å¥
      const msg = state.messages.find(m => m.id === msgId);
      const example = msg ? msg.text.substring(0, 100) : '';
      
      // è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
      state.vocabModal = {
        show: true,
        word: selectedText,
        meaning: '',
        example: example,
        isLoading: true
      };
      render();
      
      // è‡ªåŠ¨ç¿»è¯‘
      autoTranslateWord(selectedText);
    }
    
    // è‡ªåŠ¨ç¿»è¯‘å•è¯
    async function autoTranslateWord(word) {
      try {
        const translation = await callAPI(word, true);
        state.vocabModal.meaning = translation;
        state.vocabModal.isLoading = false;
        render();
        
        // èšç„¦åˆ°æ„æ€è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('vocabModalMeaning');
          if (input) input.focus();
        }, 100);
      } catch (err) {
        state.vocabModal.isLoading = false;
        render();
      }
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeVocabModal() {
      state.vocabModal = { show: false, word: '', meaning: '', example: '', isLoading: false };
      render();
    }
    
    // ä»æ¨¡æ€æ¡†ä¿å­˜è¯æ±‡
    function saveVocabFromModal() {
      const word = state.vocabModal.word.trim();
      const meaning = state.vocabModal.meaning.trim();
      const example = state.vocabModal.example.trim();
      
      if (!word) {
        alert('è¯·è¾“å…¥å•è¯');
        return;
      }
      if (!meaning) {
        alert('è¯·è¾“å…¥ä¸­æ–‡æ„æ€');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const exists = state.vocabulary.some(v => v.word.toLowerCase() === word.toLowerCase());
      if (exists) {
        if (!confirm(`è¯æ±‡"${word}"å·²å­˜åœ¨ï¼Œæ˜¯å¦ä»è¦æ·»åŠ ï¼Ÿ`)) {
          return;
        }
      }
      
      // ä¿å­˜åˆ°è¯æ±‡æœ¬
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example,
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      
      // å…³é—­æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæˆåŠŸæç¤º
      closeVocabModal();
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä½¿ç”¨ä¸´æ—¶æç¤ºï¼‰
      showToast(`âœ… å·²æ”¶è—: ${word}`);
    }
    
    // æ˜¾ç¤ºä¸´æ—¶æç¤º
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50 fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }
    
    // å¤„ç†çº æ­£å¡ç‰‡ç¿»è¯‘
    async function handleCorrectionTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.correctionTransCache[msgId]) {
        state.showCorrectionTrans[msgId] = !state.showCorrectionTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.correction) return;
      
      state.showCorrectionTrans[msgId] = true;
      state.correctionTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.correction, true);
      state.correctionTransCache[msgId] = translation;
      render();
    }
    
    // å¤„ç†è¯­æ³•å¡ç‰‡ç¿»è¯‘
    async function handleGrammarTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.grammarTransCache[msgId]) {
        state.showGrammarTrans[msgId] = !state.showGrammarTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.grammar) return;
      
      state.showGrammarTrans[msgId] = true;
      state.grammarTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.grammar, true);
      state.grammarTransCache[msgId] = translation;
      render();
    }

    function endChat() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      // å›åˆ°åœºæ™¯é€‰æ‹©é¡µé¢ï¼Œæ–¹ä¾¿åˆ‡æ¢åœºæ™¯
      state.view = 'scenario';
      render();
    }
    
    // å®Œå…¨é€€å‡ºå¯¹è¯å›åˆ°é¦–é¡µ
    function exitToHome() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      state.tutor = null;
      state.scenario = null;
      state.view = 'home';
      render();
    }
    
    // åŠ è½½å†å²å¯¹è¯
    function loadHistoryChat(index) {
      const chat = state.chatHistory[index];
      if (!chat) return;
      
      const tutor = TUTORS[chat.tutor];
      const scenario = SCENARIOS.find(s => s.id === chat.scenario);
      
      if (!tutor) {
        alert('å¯¹è¯è®°å½•æŸåï¼Œæ— æ³•æ‰“å¼€');
        return;
      }
      
      state.tutor = tutor;
      state.scenario = scenario || SCENARIOS[0];
      state.messages = chat.messages || [];
      state.corrections = chat.corrections || 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      render();
      scrollToBottom();
    }

    function renderSettings() {
      const user = state.user;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800">è®¾ç½®</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
              <!-- ä¸ªäººä¿¡æ¯ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-gray-500">åå­—</label>
                    <input id="settingName" type="text" value="${user.name}" 
                      class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-500">è¥¿è¯­æ°´å¹³</label>
                    <select id="settingLevel" class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                      ${LEVELS.map(l => `<option value="${l.id}" ${user.level === l.id ? 'selected' : ''}>${l.id} - ${l.name}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ åå¥½</h3>
                <div class="space-y-4">
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</span>
                    <input id="settingAutoTrans" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.autoTranslate ? 'checked' : ''}>
                  </label>
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">ä¸¥æ ¼çº é”™æ¨¡å¼</span>
                    <input id="settingStrict" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.strictMode ? 'checked' : ''}>
                  </label>
                  <div>
                    <label class="text-gray-700">ç¿»è¯‘è¯­è¨€</label>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                      <button type="button" onclick="document.getElementById('settingTransLang').value='zh';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${(user.transLang || 'zh') === 'zh' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                      </button>
                      <button type="button" onclick="document.getElementById('settingTransLang').value='en';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${user.transLang === 'en' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸ‡¬ğŸ‡§ è‹±è¯­
                      </button>
                      <button type="button" onclick="document.getElementById('settingTransLang').value='both';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${user.transLang === 'both' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸŒ åŒè¯­
                      </button>
                    </div>
                    <input type="hidden" id="settingTransLang" value="${user.transLang || 'zh'}">
                  </div>
                  <div>
                    <label class="text-gray-700">è¯­éŸ³é€Ÿåº¦</label>
                    <input id="settingSpeechRate" type="range" min="0.5" max="1.2" step="0.05" value="${user.speechRate || 0.85}"
                      class="w-full mt-2" oninput="document.getElementById('rateValue').textContent=this.value">
                    <div class="flex justify-between text-xs text-gray-400">
                      <span>æ…¢</span>
                      <span id="rateValue">${user.speechRate || 0.85}</span>
                      <span>å¿«</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å¤–è§‚è®¾ç½® -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ¨ å¤–è§‚è®¾ç½®</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <span class="text-gray-700">æ·±è‰²æ¨¡å¼</span>
                      <div class="text-xs text-gray-400">å¤œé—´æŠ¤çœ¼</div>
                    </div>
                    <button onclick="toggleDarkMode()" 
                      class="w-14 h-8 rounded-full transition-colors ${state.darkMode ? 'bg-primary-500' : 'bg-gray-300'} relative">
                      <div class="absolute top-1 ${state.darkMode ? 'right-1' : 'left-1'} w-6 h-6 bg-white rounded-full shadow transition-all flex items-center justify-center text-xs">
                        ${state.darkMode ? 'ğŸŒ™' : 'â˜€ï¸'}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- æ•°æ®ç®¡ç† -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">å¯¹è¯è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.chatHistory.length} æ¡</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">é”™é¢˜æœ¬</span>
                    <span class="text-gray-800 font-medium">${state.mistakeBook.length} æ¡</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">è¯æ±‡æœ¬</span>
                    <span class="text-gray-800 font-medium">${state.vocabulary.length} ä¸ª</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">æ‰“å¡è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.checkinDays.length} å¤©</span>
                  </div>
                  
                  <div class="border-t border-gray-100 pt-4 mt-2 space-y-2">
                    <button onclick="exportUserData()" 
                      class="w-full py-3 rounded-xl border border-primary-200 text-primary-600 hover:bg-primary-50 flex items-center justify-center gap-2">
                      <span>ğŸ“¤</span>
                      <span>å¯¼å‡ºæ•°æ®å¤‡ä»½</span>
                    </button>
                    <label class="w-full py-3 rounded-xl border border-green-200 text-green-600 hover:bg-green-50 flex items-center justify-center gap-2 cursor-pointer">
                      <span>ğŸ“¥</span>
                      <span>å¯¼å…¥æ•°æ®</span>
                      <input type="file" accept=".json" onchange="importUserData(event)" class="hidden">
                    </label>
                  </div>
                  
                  <div class="border-t border-gray-100 pt-4 mt-2">
                    <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                      class="w-full py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50">
                      æ¸…é™¤å¯¹è¯è®°å½•
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="saveSettings()" 
              class="w-full py-4 rounded-xl bg-primary-500 text-white font-bold shadow-lg">
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      `;
    }

    function saveSettings() {
      const name = document.getElementById('settingName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('settingLevel').value;
      const autoTranslate = document.getElementById('settingAutoTrans').checked;
      const strictMode = document.getElementById('settingStrict').checked;
      const speechRate = parseFloat(document.getElementById('settingSpeechRate').value);
      const transLang = document.getElementById('settingTransLang').value;
      
      // æ›´æ–°ç°æœ‰ç”¨æˆ·ï¼Œä¸æ˜¯åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ ...state.user, name, level, autoTranslate, strictMode, speechRate, transLang }, false);
      state.view = 'home';
      render();
    }

    // å¯¼å‡ºç”¨æˆ·æ•°æ®
    function exportUserData() {
      if (!state.user) return;
      
      const exportData = {
        exportDate: new Date().toISOString(),
        version: '2.0',
        user: {
          name: state.user.name,
          level: state.user.level,
          transLang: state.user.transLang,
          autoTranslate: state.user.autoTranslate,
          strictMode: state.user.strictMode,
          speechRate: state.user.speechRate
        },
        chatHistory: state.chatHistory,
        mistakeBook: state.mistakeBook,
        vocabulary: state.vocabulary,
        checkinDays: state.checkinDays,
        achievements: state.achievements,
        stats: state.stats,
        relationData: state.relationData,
        wordProgress: state.wordProgress,
        wordSettings: state.wordSettings
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `habla_backup_${state.user.name}_${getTodayStr()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('ğŸ“¤ æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
    }
    
    // å¯¼å…¥ç”¨æˆ·æ•°æ®
    function importUserData(event) {
      const file = event.target.files[0];
      if (!file || !state.user) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          // éªŒè¯æ•°æ®æ ¼å¼
          if (!importData.version || !importData.exportDate) {
            alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            return;
          }
          
          // ç¡®è®¤å¯¼å…¥
          const info = `å¤‡ä»½æ—¥æœŸ: ${new Date(importData.exportDate).toLocaleDateString()}
å¯¹è¯è®°å½•: ${importData.chatHistory?.length || 0} æ¡
é”™é¢˜æœ¬: ${importData.mistakeBook?.length || 0} æ¡
è¯æ±‡æœ¬: ${importData.vocabulary?.length || 0} ä¸ª
æ‰“å¡è®°å½•: ${importData.checkinDays?.length || 0} å¤©
æˆå°±: ${importData.achievements?.length || 0} ä¸ª
æ–©å•è¯è¿›åº¦: ${Object.keys(importData.wordProgress || {}).length} ä¸ª

å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`;
          
          if (!confirm(info)) return;
          
          // å¯¼å…¥æ•°æ®
          if (importData.chatHistory) {
            state.chatHistory = importData.chatHistory;
            Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
          }
          if (importData.mistakeBook) {
            state.mistakeBook = importData.mistakeBook;
            Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
          }
          if (importData.vocabulary) {
            state.vocabulary = importData.vocabulary;
            Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
          }
          if (importData.checkinDays) {
            state.checkinDays = importData.checkinDays;
            Storage.setUserData(state.user.id, 'checkinDays', state.checkinDays);
          }
          if (importData.achievements) {
            state.achievements = importData.achievements;
            Storage.setUserData(state.user.id, 'achievements', state.achievements);
          }
          if (importData.stats) {
            state.stats = importData.stats;
            Storage.setUserData(state.user.id, 'stats', state.stats);
          }
          if (importData.relationData) {
            state.relationData = importData.relationData;
            Storage.setUserData(state.user.id, 'relationData', state.relationData);
          }
          if (importData.wordProgress) {
            state.wordProgress = importData.wordProgress;
            Storage.setUserData(state.user.id, 'wordProgress', state.wordProgress);
          }
          if (importData.wordSettings) {
            state.wordSettings = importData.wordSettings;
            Storage.setUserData(state.user.id, 'wordSettings', state.wordSettings);
          }
          
          showToast('ğŸ“¥ æ•°æ®å¯¼å…¥æˆåŠŸï¼');
          render();
          
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
          console.error(err);
        }
      };
      
      reader.readAsText(file);
      // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
      event.target.value = '';
    }

    function clearHistory() {
      if (!state.user) return;
      state.chatHistory = [];
      Storage.setUserData(state.user.id, 'chatHistory', []);
      render();
    }
    
    // åˆ é™¤å•æ¡å†å²è®°å½•
    function deleteHistoryChat(index, event) {
      event.stopPropagation(); // é˜»æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      if (!state.user) return;
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        state.chatHistory.splice(index, 1);
        Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
        render();
      }
    }

    function renderHistory() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800 flex-1">å¯¹è¯å†å²</h1>
            ${state.chatHistory.length > 0 ? `
              <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                class="text-xs px-3 py-1 rounded-full bg-red-50 text-red-500 hover:bg-red-100">æ¸…é™¤å…¨éƒ¨</button>
            ` : ''}
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${state.chatHistory.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${state.chatHistory.map((chat, index) => {
                  const tutor = TUTORS[chat.tutor];
                  const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                  const date = new Date(chat.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div onclick="loadHistoryChat(${index})" class="p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-3">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-2xl flex-shrink-0">${tutor?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'}</div>
                            <div class="text-sm text-gray-500">${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                          </div>
                          <div class="text-right flex-shrink-0">
                            <div class="text-sm text-gray-600">${chat.messages?.length || 0} æ¡</div>
                            ${chat.corrections > 0 ? `<div class="text-xs text-amber-600">çº æ­£ ${chat.corrections}</div>` : ''}
                          </div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteHistoryChat(${index}, event)" 
                          class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1 transition-colors">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤æ­¤å¯¹è¯</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“­</div>
                <div>æš‚æ— å¯¹è¯è®°å½•</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ==================== å­¦ä¹ ç»Ÿè®¡é¡µé¢ ====================
    function renderStats() {
      const user = state.user;
      const totalChats = state.chatHistory.length;
      const totalMessages = state.chatHistory.reduce((sum, c) => sum + (c.messages?.length || 0), 0);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      const totalMistakes = state.mistakeBook.length;
      const totalVocab = state.vocabulary.length;
      
      // è®¡ç®—å­¦ä¹ å¤©æ•°
      const chatDates = state.chatHistory.map(c => new Date(c.date).toDateString());
      const uniqueDays = [...new Set(chatDates)].length;
      
      // è®¡ç®—å¸¸ç”¨è§’è‰²
      const tutorCounts = {};
      state.chatHistory.forEach(c => {
        tutorCounts[c.tutor] = (tutorCounts[c.tutor] || 0) + 1;
      });
      const favoriteTutor = Object.entries(tutorCounts).sort((a, b) => b[1] - a[1])[0];
      
      // è®¡ç®—å¸¸ç”¨åœºæ™¯
      const scenarioCounts = {};
      state.chatHistory.forEach(c => {
        scenarioCounts[c.scenario] = (scenarioCounts[c.scenario] || 0) + 1;
      });
      const favoriteScenario = Object.entries(scenarioCounts).sort((a, b) => b[1] - a[1])[0];
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-2xl font-bold">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h1>
            <p class="text-white/70 text-sm mt-1">ä½ çš„è¥¿è¯­å­¦ä¹ æ•°æ®ä¸€è§ˆ</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-4">
              <!-- æ ¸å¿ƒæ•°æ® -->
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-primary-600">${totalChats}</div>
                  <div class="text-sm text-gray-500">å¯¹è¯æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-blue-600">${totalMessages}</div>
                  <div class="text-sm text-gray-500">æ¶ˆæ¯æ€»æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-amber-600">${totalCorrections}</div>
                  <div class="text-sm text-gray-500">è¢«çº æ­£æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-green-600">${uniqueDays}</div>
                  <div class="text-sm text-gray-500">å­¦ä¹ å¤©æ•°</div>
                </div>
              </div>
              
              <!-- å­¦ä¹ è¿›åº¦ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“ˆ å­¦ä¹ è¿›åº¦</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600">å½“å‰æ°´å¹³</span>
                      <span class="font-bold text-primary-600">${user.level}</span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-primary-400 to-primary-600 rounded-full" 
                        style="width: ${user.level === 'A1' ? '25%' : user.level === 'A2' ? '50%' : user.level === 'B1' ? '75%' : '100%'}"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                      <span>A1</span><span>A2</span><span>B1</span><span>B2</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">â¤ï¸ å­¦ä¹ åå¥½</h3>
                <div class="space-y-3">
                  ${favoriteTutor ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„è§’è‰²</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${TUTORS[favoriteTutor[0]]?.avatar || 'ğŸ‘¤'}</span>
                        <span class="font-medium">${TUTORS[favoriteTutor[0]]?.name || 'æœªçŸ¥'}</span>
                        <span class="text-xs text-gray-400">(${favoriteTutor[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                  ${favoriteScenario ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„åœºæ™¯</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.icon || 'ğŸ’¬'}</span>
                        <span class="font-medium">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.name || 'è‡ªç”±èŠå¤©'}</span>
                        <span class="text-xs text-gray-400">(${favoriteScenario[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- å­¦ä¹ èµ„æ–™ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ èµ„æ–™</h3>
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="state.view='mistakes';render()" class="p-3 bg-amber-50 rounded-xl text-center hover:bg-amber-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="font-bold text-amber-700">${totalMistakes}</div>
                    <div class="text-xs text-amber-600">é”™é¢˜è®°å½•</div>
                  </button>
                  <button onclick="state.view='vocabulary';render()" class="p-3 bg-green-50 rounded-xl text-center hover:bg-green-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“š</div>
                    <div class="font-bold text-green-700">${totalVocab}</div>
                    <div class="text-xs text-green-600">è¯æ±‡æ”¶è—</div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== é”™é¢˜æœ¬é¡µé¢ ====================
    function renderMistakes() {
      const mistakes = state.mistakeBook;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“ é”™é¢˜æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…± ${mistakes.length} æ¡çº æ­£è®°å½•</p>
              </div>
              ${mistakes.length > 0 ? `
                <button onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ'))clearMistakes()" 
                  class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30">æ¸…ç©º</button>
              ` : ''}
            </div>
            ${mistakes.length >= 2 ? `
              <button onclick="startMistakeReview(${Math.min(mistakes.length, 10)})" 
                class="mt-4 w-full py-3 rounded-xl bg-white text-orange-600 font-bold shadow-lg hover:bg-gray-100 active:scale-98 transition-all flex items-center justify-center gap-2">
                <span>ğŸ¯</span>
                <span>å¼€å§‹é”™é¢˜å¤ä¹  (${Math.min(mistakes.length, 10)}é¢˜)</span>
              </button>
            ` : ''}
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${mistakes.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${mistakes.map((m, index) => {
                  const date = new Date(m.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden ${m.reviewed ? 'border-l-4 border-green-400' : ''}">
                      <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                          <div class="flex items-center gap-2 text-xs text-gray-400">
                            <span>${TUTORS[m.tutorId]?.avatar || 'ğŸ‘¤'}</span>
                            <span>${m.tutorName}</span>
                            <span>Â·</span>
                            <span>${m.scenario}</span>
                            ${m.reviewed ? '<span class="text-green-500">âœ“ å·²å¤ä¹ </span>' : ''}
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg mb-2">
                          <div class="text-xs text-red-500 mb-1">âŒ ä½ è¯´çš„</div>
                          <div class="text-sm text-red-700">${m.original}</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                          <div class="text-xs text-green-500 mb-1">âœ… çº æ­£</div>
                          <div class="text-sm text-green-700">${m.correction}</div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-between items-center">
                        <button onclick="speakMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-gray-500 hover:bg-gray-100 flex items-center gap-1">
                          <span>ğŸ”Š</span>
                          <span>æœ—è¯»</span>
                        </button>
                        <button onclick="deleteMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ‰</div>
                <div class="font-medium">æš‚æ— é”™è¯¯è®°å½•</div>
                <div class="text-sm mt-1">ç»§ç»­åŠ æ²¹ï¼å’ŒAIå¯¹è¯æ—¶çš„çº æ­£ä¼šè‡ªåŠ¨è®°å½•åœ¨è¿™é‡Œ</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // é”™é¢˜æœ¬ç›¸å…³å‡½æ•°
    function clearMistakes() {
      if (!state.user) return;
      state.mistakeBook = [];
      Storage.setUserData(state.user.id, 'mistakeBook', []);
      render();
    }
    
    function deleteMistake(index) {
      if (!state.user) return;
      state.mistakeBook.splice(index, 1);
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
      render();
    }
    
    function speakMistake(index) {
      const m = state.mistakeBook[index];
      if (m) {
        // æå–çº æ­£åçš„æ­£ç¡®è¡¨è¾¾
        const correctMatch = m.correction.match(/â†’\s*[""]?([^""(]+)/);
        if (correctMatch) {
          speak(correctMatch[1].trim());
        } else {
          speak(m.correction);
        }
      }
    }

    // ==================== è¯æ±‡æœ¬é¡µé¢ ====================
    function renderVocabulary() {
      const vocab = state.vocabulary;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“š è¯æ±‡æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…±æ”¶è— ${vocab.length} ä¸ªå•è¯</p>
              </div>
              <button onclick="showAddVocabForm()" 
                class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30 flex items-center gap-1">
                <span>+</span>
                <span>æ·»åŠ å•è¯</span>
              </button>
            </div>
            ${vocab.length >= 3 ? `
              <button onclick="startFlashcardReview(${Math.min(vocab.length, 10)})" 
                class="mt-4 w-full py-3 rounded-xl bg-white text-emerald-600 font-bold shadow-lg hover:bg-gray-100 active:scale-98 transition-all flex items-center justify-center gap-2">
                <span>ğŸ´</span>
                <span>å¼€å§‹é—ªå¡å¤ä¹  (${Math.min(vocab.length, 10)}è¯)</span>
              </button>
            ` : ''}
          </div>
          
          <!-- æ·»åŠ å•è¯è¡¨å• -->
          <div id="addVocabForm" class="hidden bg-white border-b p-4">
            <div class="max-w-md mx-auto space-y-3">
              <input id="vocabWord" type="text" placeholder="è¥¿ç­ç‰™è¯­å•è¯" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabMeaning" type="text" placeholder="ä¸­æ–‡æ„æ€" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabExample" type="text" placeholder="ä¾‹å¥ï¼ˆå¯é€‰ï¼‰" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <div class="flex gap-2">
                <button onclick="hideAddVocabForm()" class="flex-1 py-2 rounded-lg border border-gray-200 text-gray-600 text-sm">å–æ¶ˆ</button>
                <button onclick="addVocabulary()" class="flex-1 py-2 rounded-lg bg-green-500 text-white text-sm">ä¿å­˜</button>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${vocab.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${vocab.map((v, index) => {
                  const date = new Date(v.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div class="p-4">
                        <div class="flex items-start justify-between">
                          <div class="flex-1">
                            <div class="flex items-center gap-2">
                              <span class="text-lg font-bold text-gray-800">${v.word}</span>
                              <button onclick="speakVocab('${v.word.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-primary-500">ğŸ”Š</button>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${v.meaning}</div>
                            ${v.example ? `<div class="text-xs text-gray-400 mt-2 italic">"${v.example}"</div>` : ''}
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteVocab(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“–</div>
                <div class="font-medium">è¯æ±‡æœ¬æ˜¯ç©ºçš„</div>
                <div class="text-sm mt-1">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å•è¯"å¼€å§‹æ”¶è—</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // è¯æ±‡æœ¬ç›¸å…³å‡½æ•°
    function showAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.remove('hidden');
    }
    
    function hideAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.add('hidden');
      document.getElementById('vocabWord').value = '';
      document.getElementById('vocabMeaning').value = '';
      document.getElementById('vocabExample').value = '';
    }
    
    function addVocabulary() {
      const word = document.getElementById('vocabWord')?.value.trim();
      const meaning = document.getElementById('vocabMeaning')?.value.trim();
      const example = document.getElementById('vocabExample')?.value.trim();
      
      if (!word || !meaning) {
        alert('è¯·å¡«å†™å•è¯å’Œä¸­æ–‡æ„æ€');
        return;
      }
      
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example: example || '',
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      hideAddVocabForm();
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      render();
    }
    
    function deleteVocab(index) {
      state.vocabulary.splice(index, 1);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      render();
    }
    
    function speakVocab(word) {
      speak(word);
    }

    // ==================== é—ªå¡å¤ä¹ åŠŸèƒ½ ====================
    function startFlashcardReview(count = 10) {
      const vocab = state.vocabulary;
      if (vocab.length === 0) {
        alert('è¯æ±‡æœ¬æ˜¯ç©ºçš„ï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›å•è¯ï¼');
        return;
      }
      
      // éšæœºæ‰“ä¹±å¹¶å–æŒ‡å®šæ•°é‡
      const shuffled = [...vocab].sort(() => Math.random() - 0.5);
      const cards = shuffled.slice(0, Math.min(count, vocab.length));
      
      state.flashcard = {
        cards: cards,
        currentIndex: 0,
        showAnswer: false,
        results: [],
        finished: false
      };
      state.view = 'flashcard';
      render();
    }
    
    function flipCard() {
      state.flashcard.showAnswer = !state.flashcard.showAnswer;
      render();
    }
    
    function markCard(isCorrect) {
      const fc = state.flashcard;
      const currentCard = fc.cards[fc.currentIndex];
      
      // è®°å½•ç»“æœ
      fc.results.push({
        word: currentCard.word,
        meaning: currentCard.meaning,
        correct: isCorrect
      });
      
      // ä¸‹ä¸€å¼ å¡ç‰‡
      if (fc.currentIndex < fc.cards.length - 1) {
        fc.currentIndex++;
        fc.showAnswer = false;
      } else {
        fc.finished = true;
        // è®°å½•é—ªå¡å¤ä¹ å®Œæˆ
        recordFlashcardReview();
        checkAchievements();
      }
      render();
    }
    
    function restartFlashcard() {
      const count = state.flashcard.cards.length;
      startFlashcardReview(count);
    }
    
    function exitFlashcard() {
      state.view = 'vocabulary';
      render();
    }
    
    function renderFlashcard() {
      const fc = state.flashcard;
      
      // å®Œæˆé¡µé¢
      if (fc.finished) {
        const correct = fc.results.filter(r => r.correct).length;
        const total = fc.results.length;
        const percentage = Math.round((correct / total) * 100);
        const wrongCards = fc.results.filter(r => !r.correct);
        
        return `
          <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col">
            <div class="p-4">
              <button onclick="exitFlashcard()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›è¯æ±‡æœ¬</button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
              <div class="text-6xl mb-4">${percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
              <h2 class="text-2xl font-bold text-white mb-2">å¤ä¹ å®Œæˆï¼</h2>
              
              <div class="bg-white/20 backdrop-blur rounded-2xl p-6 mb-6 w-full max-w-xs">
                <div class="text-5xl font-bold text-white mb-2">${percentage}%</div>
                <div class="text-white/80">æ­£ç¡®ç‡</div>
                <div class="flex justify-center gap-8 mt-4 text-sm">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-300">${correct}</div>
                    <div class="text-white/60">è®¤è¯†</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-red-300">${total - correct}</div>
                    <div class="text-white/60">ä¸è®¤è¯†</div>
                  </div>
                </div>
              </div>
              
              ${wrongCards.length > 0 ? `
                <div class="bg-white/10 backdrop-blur rounded-xl p-4 w-full max-w-xs mb-6">
                  <div class="text-white/80 text-sm mb-2">éœ€è¦åŠ å¼ºçš„å•è¯ï¼š</div>
                  <div class="space-y-2">
                    ${wrongCards.map(c => `
                      <div class="flex items-center justify-between text-white text-sm">
                        <span class="font-medium">${c.word}</span>
                        <span class="text-white/60">${c.meaning}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div class="flex gap-3 w-full max-w-xs">
                <button onclick="restartFlashcard()" 
                  class="flex-1 py-3 rounded-xl bg-white text-primary-600 font-bold hover:bg-gray-100 transition-colors">
                  å†æ¥ä¸€æ¬¡
                </button>
                <button onclick="exitFlashcard()" 
                  class="flex-1 py-3 rounded-xl bg-white/20 text-white font-bold hover:bg-white/30 transition-colors">
                  è¿”å›
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // å¤ä¹ é¡µé¢
      const currentCard = fc.cards[fc.currentIndex];
      const progress = ((fc.currentIndex) / fc.cards.length) * 100;
      
      return `
        <div class="h-full bg-gradient-to-br from-green-500 via-emerald-500 to-teal-600 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="p-4">
            <div class="flex items-center justify-between text-white mb-3">
              <button onclick="exitFlashcard()" class="text-white/80 text-sm flex items-center gap-1">â† é€€å‡º</button>
              <div class="text-sm">${fc.currentIndex + 1} / ${fc.cards.length}</div>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="h-2 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
          </div>
          
          <!-- å¡ç‰‡åŒºåŸŸ -->
          <div class="flex-1 flex items-center justify-center p-6">
            <div onclick="flipCard()" 
              class="w-full max-w-sm aspect-[3/4] cursor-pointer perspective-1000">
              <div class="relative w-full h-full transition-transform duration-500 transform-style-3d ${fc.showAnswer ? 'rotate-y-180' : ''}">
                <!-- æ­£é¢ï¼šå•è¯ -->
                <div class="absolute inset-0 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center p-6 backface-hidden">
                  <div class="text-gray-400 text-sm mb-4">ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­</div>
                  <div class="text-3xl font-bold text-gray-800 mb-4">${currentCard.word}</div>
                  <button onclick="event.stopPropagation();speak('${currentCard.word.replace(/'/g, "\\'")}')" 
                    class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-xl hover:bg-gray-200 transition-colors">
                    ğŸ”Š
                  </button>
                  <div class="absolute bottom-6 text-gray-400 text-sm">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ç­”æ¡ˆ</div>
                </div>
                
                <!-- èƒŒé¢ï¼šæ„æ€ -->
                <div class="absolute inset-0 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180">
                  <div class="text-gray-400 text-sm mb-2">ğŸ‡ªğŸ‡¸ ${currentCard.word}</div>
                  <div class="text-2xl font-bold text-gray-800 mb-4">${currentCard.meaning}</div>
                  ${currentCard.example ? `
                    <div class="text-sm text-gray-500 italic text-center px-4">"${currentCard.example}"</div>
                  ` : ''}
                  <div class="absolute bottom-6 text-gray-400 text-sm">ä½ è®¤è¯†è¿™ä¸ªå•è¯å—ï¼Ÿ</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- åº•éƒ¨æŒ‰é’® -->
          <div class="p-6 safe-bottom">
            ${fc.showAnswer ? `
              <div class="flex gap-4 max-w-sm mx-auto">
                <button onclick="markCard(false)" 
                  class="flex-1 py-4 rounded-2xl bg-red-500 text-white font-bold text-lg shadow-lg hover:bg-red-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <span>âŒ</span>
                  <span>ä¸è®¤è¯†</span>
                </button>
                <button onclick="markCard(true)" 
                  class="flex-1 py-4 rounded-2xl bg-green-500 text-white font-bold text-lg shadow-lg hover:bg-green-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <span>âœ…</span>
                  <span>è®¤è¯†</span>
                </button>
              </div>
            ` : `
              <button onclick="flipCard()" 
                class="w-full max-w-sm mx-auto block py-4 rounded-2xl bg-white text-emerald-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all">
                ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ
              </button>
            `}
          </div>
        </div>
      `;
    }

    // ==================== é”™é¢˜å¤ä¹ åŠŸèƒ½ ====================
    function startMistakeReview(count = 10) {
      const mistakes = state.mistakeBook;
      if (mistakes.length === 0) {
        alert('é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼Œç»§ç»­å¯¹è¯ç»ƒä¹ å§ï¼');
        return;
      }
      
      // éšæœºæ‰“ä¹±å¹¶å–æŒ‡å®šæ•°é‡
      const shuffled = [...mistakes].sort(() => Math.random() - 0.5);
      const items = shuffled.slice(0, Math.min(count, mistakes.length));
      
      state.mistakeReview = {
        items: items,
        currentIndex: 0,
        showAnswer: false,
        userAnswer: '',
        results: [],
        finished: false
      };
      state.view = 'mistakeReview';
      render();
    }
    
    function showMistakeAnswer() {
      state.mistakeReview.showAnswer = true;
      render();
    }
    
    function markMistake(mastered) {
      const mr = state.mistakeReview;
      const currentItem = mr.items[mr.currentIndex];
      
      // è®°å½•ç»“æœ
      mr.results.push({
        original: currentItem.original,
        correction: currentItem.correction,
        mastered: mastered
      });
      
      // å¦‚æœæŒæ¡äº†ï¼Œå¯ä»¥æ ‡è®°é”™é¢˜æœ¬ä¸­çš„è¯¥é¡¹
      if (mastered && state.user) {
        const idx = state.mistakeBook.findIndex(m => m.id === currentItem.id);
        if (idx >= 0) {
          state.mistakeBook[idx].reviewed = true;
          Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
        }
      }
      
      // ä¸‹ä¸€é¢˜
      if (mr.currentIndex < mr.items.length - 1) {
        mr.currentIndex++;
        mr.showAnswer = false;
        mr.userAnswer = '';
      } else {
        mr.finished = true;
      }
      render();
    }
    
    function restartMistakeReview() {
      const count = state.mistakeReview.items.length;
      startMistakeReview(count);
    }
    
    function exitMistakeReview() {
      state.view = 'mistakes';
      render();
    }
    
    function updateMistakeAnswer(value) {
      state.mistakeReview.userAnswer = value;
    }
    
    function renderMistakeReview() {
      const mr = state.mistakeReview;
      
      // å®Œæˆé¡µé¢
      if (mr.finished) {
        const mastered = mr.results.filter(r => r.mastered).length;
        const total = mr.results.length;
        const percentage = Math.round((mastered / total) * 100);
        const needPractice = mr.results.filter(r => !r.mastered);
        
        return `
          <div class="h-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 flex flex-col">
            <div class="p-4">
              <button onclick="exitMistakeReview()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›é”™é¢˜æœ¬</button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
              <div class="text-6xl mb-4">${percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
              <h2 class="text-2xl font-bold text-white mb-2">å¤ä¹ å®Œæˆï¼</h2>
              
              <div class="bg-white/20 backdrop-blur rounded-2xl p-6 mb-6 w-full max-w-xs">
                <div class="text-5xl font-bold text-white mb-2">${percentage}%</div>
                <div class="text-white/80">æŒæ¡ç‡</div>
                <div class="flex justify-center gap-8 mt-4 text-sm">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-300">${mastered}</div>
                    <div class="text-white/60">å·²æŒæ¡</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-red-300">${total - mastered}</div>
                    <div class="text-white/60">éœ€åŠ å¼º</div>
                  </div>
                </div>
              </div>
              
              ${needPractice.length > 0 ? `
                <div class="bg-white/10 backdrop-blur rounded-xl p-4 w-full max-w-xs mb-6 text-left">
                  <div class="text-white/80 text-sm mb-2">éœ€è¦ç»§ç»­ç»ƒä¹ ï¼š</div>
                  <div class="space-y-2 max-h-32 overflow-auto">
                    ${needPractice.slice(0, 5).map(c => `
                      <div class="text-white text-xs">
                        <div class="text-red-200 line-through">${c.original.substring(0, 30)}...</div>
                      </div>
                    `).join('')}
                    ${needPractice.length > 5 ? `<div class="text-white/50 text-xs">è¿˜æœ‰ ${needPractice.length - 5} é¡¹...</div>` : ''}
                  </div>
                </div>
              ` : ''}
              
              <div class="flex gap-3 w-full max-w-xs">
                <button onclick="restartMistakeReview()" 
                  class="flex-1 py-3 rounded-xl bg-white text-orange-600 font-bold hover:bg-gray-100 transition-colors">
                  å†æ¥ä¸€æ¬¡
                </button>
                <button onclick="exitMistakeReview()" 
                  class="flex-1 py-3 rounded-xl bg-white/20 text-white font-bold hover:bg-white/30 transition-colors">
                  è¿”å›
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // å¤ä¹ é¡µé¢
      const currentItem = mr.items[mr.currentIndex];
      const progress = ((mr.currentIndex) / mr.items.length) * 100;
      
      // è§£æçº æ­£å†…å®¹ï¼Œæå–æ­£ç¡®ç­”æ¡ˆ
      const correctionText = currentItem.correction;
      // å°è¯•æå– â†’ åé¢çš„æ­£ç¡®å†…å®¹
      const correctMatch = correctionText.match(/â†’\s*[""]?([^""(ï¼ˆ]+)/);
      const correctAnswer = correctMatch ? correctMatch[1].trim() : correctionText;
      
      return `
        <div class="h-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="p-4">
            <div class="flex items-center justify-between text-white mb-3">
              <button onclick="exitMistakeReview()" class="text-white/80 text-sm flex items-center gap-1">â† é€€å‡º</button>
              <div class="text-sm">${mr.currentIndex + 1} / ${mr.items.length}</div>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="h-2 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
          </div>
          
          <!-- é¢˜ç›®åŒºåŸŸ -->
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- é¢˜ç›®å¡ç‰‡ -->
              <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                <div class="text-center mb-4">
                  <span class="text-sm text-gray-500">ğŸ“ è¯·æ‰¾å‡ºå¹¶æ”¹æ­£é”™è¯¯</span>
                </div>
                
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-4">
                  <div class="text-lg text-red-800 font-medium text-center">
                    "${currentItem.original}"
                  </div>
                </div>
                
                <div class="flex items-center justify-center gap-2 text-xs text-gray-400">
                  <span class="px-2 py-1 bg-gray-100 rounded-full">${currentItem.tutorName || 'æœªçŸ¥'}</span>
                  <span class="px-2 py-1 bg-gray-100 rounded-full">${currentItem.scenario || 'è‡ªç”±èŠå¤©'}</span>
                </div>
              </div>
              
              ${!mr.showAnswer ? `
                <!-- è¾“å…¥ç­”æ¡ˆ -->
                <div class="bg-white/90 backdrop-blur rounded-2xl p-4 mb-4">
                  <input type="text" 
                    placeholder="è¾“å…¥ä½ è®¤ä¸ºæ­£ç¡®çš„è¯´æ³•..."
                    value="${mr.userAnswer}"
                    oninput="updateMistakeAnswer(this.value)"
                    class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-orange-400 outline-none text-center">
                </div>
              ` : `
                <!-- æ˜¾ç¤ºç­”æ¡ˆ -->
                <div class="bg-white rounded-2xl shadow-xl p-6 slide-up">
                  <div class="text-center mb-3">
                    <span class="text-sm text-green-600 font-medium">âœ… æ­£ç¡®ç­”æ¡ˆ</span>
                  </div>
                  <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                    <div class="text-lg text-green-800 font-medium text-center">
                      ${correctAnswer}
                    </div>
                    <button onclick="speak('${correctAnswer.replace(/'/g, "\\'")}')" 
                      class="mx-auto mt-2 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-lg hover:bg-green-200">
                      ğŸ”Š
                    </button>
                  </div>
                  
                  <div class="bg-amber-50 rounded-xl p-4">
                    <div class="text-xs text-amber-600 mb-1">ğŸ’¡ çº æ­£è¯´æ˜</div>
                    <div class="text-sm text-amber-900">${correctionText}</div>
                  </div>
                </div>
              `}
            </div>
          </div>
          
          <!-- åº•éƒ¨æŒ‰é’® -->
          <div class="p-4 safe-bottom">
            <div class="max-w-md mx-auto">
              ${mr.showAnswer ? `
                <div class="flex gap-3">
                  <button onclick="markMistake(false)" 
                    class="flex-1 py-4 rounded-2xl bg-white/20 text-white font-bold text-lg hover:bg-white/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>âŒ</span>
                    <span>è¿˜ä¸ä¼š</span>
                  </button>
                  <button onclick="markMistake(true)" 
                    class="flex-1 py-4 rounded-2xl bg-white text-orange-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>âœ…</span>
                    <span>æŒæ¡äº†</span>
                  </button>
                </div>
              ` : `
                <button onclick="showMistakeAnswer()" 
                  class="w-full py-4 rounded-2xl bg-white text-orange-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all">
                  ğŸ‘€ æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== æ¯æ—¥æ‰“å¡åŠŸèƒ½ ====================
    // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
    function getTodayStr() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
    function hasCheckedInToday() {
      const todayStr = getTodayStr();
      return state.checkinDays.includes(todayStr);
    }
    
    // ä»Šæ—¥æ˜¯å¦æœ‰å­¦ä¹ ï¼ˆå¯¹è¯ï¼‰
    function hasStudiedToday() {
      const todayStr = getTodayStr();
      return state.chatHistory.some(chat => {
        const chatDate = new Date(chat.date).toISOString().split('T')[0];
        return chatDate === todayStr;
      });
    }
    
    // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
    function getStreakDays() {
      if (state.checkinDays.length === 0) return 0;
      
      const sortedDays = [...state.checkinDays].sort().reverse();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let checkDate = new Date(today);
      
      // å¦‚æœä»Šå¤©è¿˜æ²¡æ‰“å¡ï¼Œä»æ˜¨å¤©å¼€å§‹ç®—
      if (!hasCheckedInToday()) {
        checkDate.setDate(checkDate.getDate() - 1);
      }
      
      for (let i = 0; i < sortedDays.length; i++) {
        const dayStr = checkDate.toISOString().split('T')[0];
        if (sortedDays.includes(dayStr)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // æ‰“å¡
    function doCheckin() {
      if (!state.user) return;
      
      const todayStr = getTodayStr();
      if (state.checkinDays.includes(todayStr)) {
        showToast('ä»Šå¤©å·²ç»æ‰“å¡è¿‡äº†ï¼');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ä¹ 
      if (!hasStudiedToday()) {
        if (!confirm('ä»Šå¤©è¿˜æ²¡æœ‰è¿›è¡Œå¯¹è¯ç»ƒä¹ ï¼Œç¡®å®šè¦æ‰“å¡å—ï¼Ÿ')) {
          return;
        }
      }
      
      state.checkinDays.push(todayStr);
      Storage.setUserData(state.user.id, 'checkinDays', state.checkinDays);
      
      const streak = getStreakDays();
      showToast(`ğŸ‰ æ‰“å¡æˆåŠŸï¼è¿ç»­ ${streak} å¤©`);
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      render();
    }
    
    // æ¸²æŸ“æ—¥å†é¡µé¢
    function renderCalendar() {
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const todayStr = getTodayStr();
      
      // è·å–æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startWeekDay = firstDay.getDay(); // 0=å‘¨æ—¥
      
      // æœˆä»½åç§°
      const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                          'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
      
      const streak = getStreakDays();
      const totalCheckins = state.checkinDays.length;
      const checkedToday = hasCheckedInToday();
      const studiedToday = hasStudiedToday();
      
      // ç”Ÿæˆæ—¥å†æ ¼å­
      let calendarDays = [];
      // å¡«å……æœˆåˆç©ºç™½
      for (let i = 0; i < startWeekDay; i++) {
        calendarDays.push({ day: '', status: 'empty' });
      }
      // å¡«å……æ—¥æœŸ
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const isChecked = state.checkinDays.includes(dateStr);
        const isFuture = new Date(dateStr) > today;
        
        calendarDays.push({
          day: d,
          dateStr,
          isToday,
          isChecked,
          isFuture
        });
      }
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between mb-4">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“… å­¦ä¹ æ—¥å†</h1>
                <p class="text-white/70 text-sm mt-1">${currentYear}å¹´ ${monthNames[currentMonth]}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold">ğŸ”¥ ${streak}</div>
                <div class="text-white/70 text-xs">è¿ç»­æ‰“å¡</div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${totalCheckins}</div>
                <div class="text-xs text-white/70">æ€»æ‰“å¡å¤©æ•°</div>
              </div>
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${state.chatHistory.length}</div>
                <div class="text-xs text-white/70">æ€»å¯¹è¯æ•°</div>
              </div>
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${state.vocabulary.length}</div>
                <div class="text-xs text-white/70">è¯æ±‡ç§¯ç´¯</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- æ—¥å† -->
              <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
                <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `
                    <div class="text-center text-xs text-gray-400 py-2">${d}</div>
                  `).join('')}
                </div>
                
                <!-- æ—¥æœŸæ ¼å­ -->
                <div class="grid grid-cols-7 gap-1">
                  ${calendarDays.map(d => {
                    if (d.status === 'empty') {
                      return '<div class="aspect-square"></div>';
                    }
                    
                    let bgClass = 'bg-gray-50';
                    let textClass = 'text-gray-600';
                    let icon = '';
                    
                    if (d.isFuture) {
                      textClass = 'text-gray-300';
                    } else if (d.isChecked) {
                      bgClass = 'bg-green-100';
                      textClass = 'text-green-700';
                      icon = 'âœ“';
                    }
                    
                    if (d.isToday) {
                      bgClass = d.isChecked ? 'bg-green-500' : 'bg-purple-500';
                      textClass = 'text-white';
                    }
                    
                    return `
                      <div class="aspect-square ${bgClass} rounded-lg flex flex-col items-center justify-center ${d.isToday ? 'ring-2 ring-purple-300' : ''}">
                        <span class="text-sm font-medium ${textClass}">${d.day}</span>
                        ${icon ? `<span class="text-xs ${d.isToday ? 'text-white' : 'text-green-500'}">${icon}</span>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              
              <!-- ä»Šæ—¥çŠ¶æ€ -->
              <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š ä»Šæ—¥å­¦ä¹ </h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">å¯¹è¯ç»ƒä¹ </span>
                    <span class="${studiedToday ? 'text-green-500' : 'text-gray-400'}">${studiedToday ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ'}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">æ¯æ—¥æ‰“å¡</span>
                    <span class="${checkedToday ? 'text-green-500' : 'text-gray-400'}">${checkedToday ? 'âœ… å·²æ‰“å¡' : 'â³ æœªæ‰“å¡'}</span>
                  </div>
                </div>
              </div>
              
              <!-- å›¾ä¾‹ -->
              <div class="flex items-center justify-center gap-4 text-xs text-gray-500">
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-green-100 rounded"></div>
                  <span>å·²æ‰“å¡</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-purple-500 rounded"></div>
                  <span>ä»Šå¤©</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-gray-50 rounded border"></div>
                  <span>æœªæ‰“å¡</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ‰“å¡æŒ‰é’® -->
          <div class="p-4 safe-bottom">
            <div class="max-w-md mx-auto">
              ${checkedToday ? `
                <div class="py-4 rounded-2xl bg-green-100 text-green-700 font-bold text-center">
                  âœ… ä»Šæ—¥å·²æ‰“å¡ Â· è¿ç»­ ${streak} å¤©
                </div>
              ` : `
                <button onclick="doCheckin()" 
                  class="w-full py-4 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold text-lg shadow-lg hover:shadow-xl active:scale-98 transition-all flex items-center justify-center gap-2">
                  <span>âœ…</span>
                  <span>æ‰“å¡</span>
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== æˆå°±ç³»ç»Ÿ ====================
    // æ£€æŸ¥å¹¶è§£é”æˆå°±
    function checkAchievements() {
      if (!state.user) return;
      
      let newUnlocked = [];
      
      ACHIEVEMENTS.forEach(achievement => {
        // å¦‚æœå·²è§£é”ï¼Œè·³è¿‡
        if (state.achievements.includes(achievement.id)) return;
        
        // æ£€æŸ¥æ¡ä»¶
        try {
          if (achievement.condition(state)) {
            state.achievements.push(achievement.id);
            newUnlocked.push(achievement);
          }
        } catch (e) {
          // æ¡ä»¶æ£€æŸ¥å‡ºé”™ï¼Œè·³è¿‡
        }
      });
      
      // ä¿å­˜æˆå°±
      if (newUnlocked.length > 0) {
        Storage.setUserData(state.user.id, 'achievements', state.achievements);
        
        // æ˜¾ç¤ºè§£é”æç¤º
        newUnlocked.forEach(a => {
          setTimeout(() => {
            showAchievementToast(a);
          }, 500);
        });
      }
    }
    
    // æ˜¾ç¤ºæˆå°±è§£é”æç¤º
    function showAchievementToast(achievement) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-amber-500 text-white px-6 py-4 rounded-2xl shadow-2xl z-50 flex items-center gap-3 animate-bounce';
      toast.innerHTML = `
        <span class="text-3xl">${achievement.icon}</span>
        <div>
          <div class="text-xs opacity-80">ğŸ‰ æˆå°±è§£é”ï¼</div>
          <div class="font-bold">${achievement.name}</div>
        </div>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }
    
    // è®°å½•ä½¿ç”¨çš„å¯¼å¸ˆ
    function recordTutorUsed(tutorId) {
      if (!state.user || !tutorId) return;
      
      if (!state.stats.tutorsUsed.includes(tutorId)) {
        state.stats.tutorsUsed.push(tutorId);
        Storage.setUserData(state.user.id, 'stats', state.stats);
      }
    }
    
    // è®°å½•é—ªå¡å¤ä¹ æ¬¡æ•°
    function recordFlashcardReview() {
      if (!state.user) return;
      
      state.stats.flashcardReviews = (state.stats.flashcardReviews || 0) + 1;
      Storage.setUserData(state.user.id, 'stats', state.stats);
    }
    
    // æ¸²æŸ“æˆå°±é¡µé¢
    function renderAchievements() {
      const unlockedCount = state.achievements.length;
      const totalCount = ACHIEVEMENTS.length;
      const percentage = Math.round((unlockedCount / totalCount) * 100);
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-yellow-500 to-amber-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ† æˆ‘çš„æˆå°±</h1>
                <p class="text-white/80 text-sm mt-1">å·²è§£é” ${unlockedCount}/${totalCount} ä¸ªæˆå°±</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold">${percentage}%</div>
                <div class="text-white/70 text-xs">å®Œæˆåº¦</div>
              </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="mt-4 h-3 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- æˆå°±ç½‘æ ¼ -->
              <div class="grid grid-cols-2 gap-3">
                ${ACHIEVEMENTS.map(a => {
                  const unlocked = state.achievements.includes(a.id);
                  return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm ${unlocked ? 'border-2 border-amber-400' : 'opacity-60'}">
                      <div class="text-center">
                        <div class="text-4xl mb-2 ${unlocked ? '' : 'grayscale'}">${a.icon}</div>
                        <div class="font-bold text-gray-800 text-sm">${a.name}</div>
                        <div class="text-xs text-gray-500 mt-1">${a.desc}</div>
                        ${unlocked ? `
                          <div class="mt-2 text-xs text-amber-600 font-medium">âœ… å·²è§£é”</div>
                        ` : `
                          <div class="mt-2 text-xs text-gray-400">ğŸ”’ æœªè§£é”</div>
                        `}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <!-- æç¤º -->
              <div class="mt-6 text-center text-sm text-gray-400">
                ç»§ç»­å­¦ä¹ ï¼Œè§£é”æ›´å¤šæˆå°±ï¼
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      render();
      
      setTimeout(() => {
        if (state.user) {
          // æœ‰å½“å‰ç”¨æˆ·ï¼Œè¿›å…¥ä¸»é¡µ
          state.view = 'home';
        } else if (state.users.length > 0) {
          // æœ‰ç”¨æˆ·ä½†æœªé€‰æ‹©ï¼Œæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©é¡µé¢
          state.view = 'userSelect';
        } else {
          // æ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢
          state.view = 'welcome';
        }
        render();
      }, 1000);
    }

    init();
  </script>
</body>
</html>
