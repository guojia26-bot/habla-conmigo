<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#6366f1">
  <title>HablaConmigo - AIè¥¿è¯­å£è¯­åŠ©æ‰‹</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‡ªğŸ‡¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            accent: { 500: '#f97316', 600: '#ea580c' }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; }
    
    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }
    @keyframes bounce { 0%, 100% { transform: translateY(-25%); } 50% { transform: translateY(0); } }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 0.6s infinite; }
    
    .mic-recording { position: relative; }
    .mic-recording::before { 
      content: ''; position: absolute; inset: -8px; border-radius: 50%; 
      background: rgba(239,68,68,0.3); animation: pulse-ring 1.5s ease-out infinite; 
    }
    
    /* æ»šåŠ¨æ¡ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å®‰å…¨åŒºåŸŸ */
    .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    
    /* è¾“å…¥æ¡† */
    input, button, textarea, select { font-size: 16px !important; }
    
    /* ç¿»è¯‘æç¤º */
    .translation-tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #1e293b; color: white; padding: 8px 12px; border-radius: 8px;
      font-size: 13px; white-space: nowrap; margin-bottom: 8px; z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .translation-tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 6px solid transparent; border-top-color: #1e293b;
    }
    
    /* çº æ­£å¡ç‰‡ */
    .correction-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      border-radius: 0 12px 12px 0;
    }
    
    /* ç»ç’ƒæ•ˆæœ */
    .glass {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* ========== æ·±è‰²æ¨¡å¼ ========== */
    .dark body { background: #0f172a; }
    .dark .bg-gray-50 { background: #1e293b !important; }
    .dark .bg-gray-100 { background: #334155 !important; }
    .dark .bg-white { background: #1e293b !important; }
    .dark .text-gray-800 { color: #f1f5f9 !important; }
    .dark .text-gray-700 { color: #e2e8f0 !important; }
    .dark .text-gray-600 { color: #cbd5e1 !important; }
    .dark .text-gray-500 { color: #94a3b8 !important; }
    .dark .text-gray-400 { color: #64748b !important; }
    .dark .border-gray-100 { border-color: #334155 !important; }
    .dark .border-gray-200 { border-color: #475569 !important; }
    .dark .border-b { border-color: #334155 !important; }
    .dark .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; }
    .dark .hover\:bg-gray-100:hover { background: #334155 !important; }
    .dark .hover\:bg-gray-50:hover { background: #334155 !important; }
    .dark input, .dark select { background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important; }
    .dark input::placeholder { color: #64748b !important; }
    .dark .glass { background: rgba(30,41,59,0.9) !important; }
    .dark .correction-card { background: linear-gradient(135deg, #78350f 0%, #92400e 100%) !important; }
    .dark .bg-amber-50 { background: #78350f !important; }
    .dark .bg-blue-50 { background: #1e3a5f !important; }
    .dark .bg-green-50 { background: #14532d !important; }
    .dark .bg-red-50 { background: #7f1d1d !important; }
    .dark .text-amber-700, .dark .text-amber-800, .dark .text-amber-900 { color: #fcd34d !important; }
    .dark .text-blue-700, .dark .text-blue-800, .dark .text-blue-900 { color: #93c5fd !important; }
    .dark .text-green-700, .dark .text-green-800 { color: #86efac !important; }
    .dark .text-red-700 { color: #fca5a5 !important; }
  </style>
</head>
<body>
  <div id="app" class="h-full"></div>
  
  <script>
    // ==================== æ•°æ®å­˜å‚¨ ====================
    const Storage = {
      get(key, defaultVal = null) {
        try {
          const v = localStorage.getItem('habla_' + key);
          return v ? JSON.parse(v) : defaultVal;
        } catch { return defaultVal; }
      },
      set(key, val) {
        try { localStorage.setItem('habla_' + key, JSON.stringify(val)); } catch {}
      },
      remove(key) {
        try { localStorage.removeItem('habla_' + key); } catch {}
      },
      // ç”¨æˆ·ç›¸å…³å­˜å‚¨
      getUsers() {
        return this.get('users', []);
      },
      saveUsers(users) {
        this.set('users', users);
      },
      getCurrentUserId() {
        return this.get('currentUserId', null);
      },
      setCurrentUserId(id) {
        this.set('currentUserId', id);
      },
      // è·å–ç”¨æˆ·ä¸“å±æ•°æ®
      getUserData(userId, key, defaultVal = null) {
        return this.get(`${userId}_${key}`, defaultVal);
      },
      setUserData(userId, key, val) {
        this.set(`${userId}_${key}`, val);
      }
    };

    // ==================== é…ç½® ====================
    const TUTORS = {
      maria: {
        id: 'maria', name: 'MarÃ­a', avatar: 'ğŸ‘©ğŸ»', emoji: 'ğŸŒ¸',
        role: 'æ¸©æŸ”è€å¸ˆ', roleEs: 'Profesora amable',
        personality: 'è€å¿ƒã€æ¸©æŸ”ã€é¼“åŠ±',
        description: 'æ¥è‡ªé©¬å¾·é‡Œçš„è¥¿è¯­è€å¸ˆï¼Œæ“…é•¿çº æ­£è¯­æ³•ï¼Œå¯¹å­¦ç”Ÿéå¸¸æœ‰è€å¿ƒ',
        color: 'from-pink-500 to-rose-500', colorLight: 'bg-pink-50',
        voice: { pitch: 1.2, rate: 0.8 },
        greeting: 'Â¡Hola, {name}! Soy MarÃ­a, tu profesora de espaÃ±ol. Â¡QuÃ© alegrÃ­a conocerte! Â¿QuÃ© te gustarÃ­a practicar hoy?',
        prompt: `Eres MarÃ­a, una profesora de espaÃ±ol de Madrid, amable y paciente.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino en tu respuesta principal
2. Habla de forma cÃ¡lida y anima al estudiante
3. Si hay errores gramaticales, usa este formato al FINAL:
   ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. MantÃ©n respuestas cortas y naturales (2-3 frases)
5. NO uses chino excepto dentro de ã€çº æ­£ã€‘`
      },
      carlos: {
        id: 'carlos', name: 'Carlos', avatar: 'ğŸ‘¨ğŸ»', emoji: 'âš½',
        role: 'å¥è°ˆæœ‹å‹', roleEs: 'Amigo hablador',
        personality: 'çƒ­æƒ…ã€å¹½é»˜ã€éšæ€§',
        description: 'å·´å¡ç½—é‚£çš„å¹´è½»äººï¼Œçƒ­çˆ±è¶³çƒå’Œç¾é£Ÿï¼Œè¯´è¯åƒæœ‹å‹ä¸€æ ·è½»æ¾',
        color: 'from-blue-500 to-indigo-500', colorLight: 'bg-blue-50',
        voice: { pitch: 0.9, rate: 1.0 },
        greeting: 'Â¡Ey, quÃ© tal, {name}! Soy Carlos, de Barcelona. Â¿QuÃ© pasa, tÃ­o? Â¡Vamos a charlar!',
        prompt: `Eres Carlos, un chico de 25 aÃ±os de Barcelona, amigable y divertido.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino en tu respuesta principal
2. Habla informal, como un amigo, usa "tÃ­o", "mola", "guay"
3. Te encanta el fÃºtbol (BarÃ§a), comida y viajar
4. Si hay errores, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. Respuestas cortas y divertidas, NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      sofia: {
        id: 'sofia', name: 'SofÃ­a', avatar: 'ğŸ‘©ğŸ½', emoji: 'ğŸŒº',
        role: 'æ¸©æŸ”ä¼´ä¾£', roleEs: 'CompaÃ±era cariÃ±osa',
        personality: 'ç”œèœœã€æµªæ¼«ã€å…³å¿ƒ',
        description: 'æ¥è‡ªå¢¨è¥¿å“¥çš„å¥³å­©ï¼Œæ¸©æŸ”æµªæ¼«ï¼Œå–œæ¬¢åˆ†äº«æ‹‰ç¾æ–‡åŒ–',
        color: 'from-purple-500 to-fuchsia-500', colorLight: 'bg-purple-50',
        voice: { pitch: 1.3, rate: 0.85 },
        greeting: 'Â¡Hola, cariÃ±o! Soy SofÃ­a, de MÃ©xico. Â¡QuÃ© lindo conocerte, {name}! Â¿CÃ³mo estÃ¡s hoy?',
        prompt: `Eres SofÃ­a, una chica dulce y cariÃ±osa de MÃ©xico.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino en tu respuesta principal
2. Habla cÃ¡lida, usa "cariÃ±o", "mi amor" ocasionalmente
3. Comparte cultura, comida y mÃºsica mexicana/latinoamericana
4. Si hay errores, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. Respuestas cariÃ±osas, NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      profesor: {
        id: 'profesor', name: 'Prof. GarcÃ­a', avatar: 'ğŸ‘¨ğŸ»â€ğŸ«', emoji: 'ğŸ“š',
        role: 'ä¸¥æ ¼æ•™æˆ', roleEs: 'Profesor estricto',
        personality: 'ä¸¥è°¨ã€å­¦æœ¯ã€æƒå¨',
        description: 'å¤§å­¦è¥¿è¯­æ•™æˆï¼Œéå¸¸æ³¨é‡è¯­æ³•ï¼Œé€‚åˆæƒ³è¦ä¸¥æ ¼å­¦ä¹ çš„ç”¨æˆ·',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        voice: { pitch: 0.8, rate: 0.75 },
        greeting: 'Buenos dÃ­as, {name}. Soy el Profesor GarcÃ­a. Estoy aquÃ­ para ayudarle a mejorar su espaÃ±ol. Â¿Comenzamos?',
        prompt: `Eres el Profesor GarcÃ­a, un profesor universitario de espaÃ±ol muy riguroso.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino en tu respuesta principal
2. Habla formal, usa "usted", tono acadÃ©mico
3. Si hay errores gramaticales, usa al FINAL:
   ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (è§£é‡Šdetallada en chino)
4. Para puntos gramaticales importantes, usa:
   ã€è¯­æ³•ã€‘(explicaciÃ³n en chino)
5. NO uses chino en tu respuesta principal, solo en ã€çº æ­£ã€‘yã€è¯­æ³•ã€‘`
      },
      // ========== æ–°è§’è‰² ==========
      lucia: {
        id: 'lucia', name: 'LucÃ­a', avatar: 'ğŸ‘§ğŸ»', emoji: 'ğŸ€',
        role: 'æ´»æ³¼å°å¦¹', roleEs: 'Hermana pequeÃ±a',
        personality: 'æ´»æ³¼ã€å¯çˆ±ã€å¥½å¥‡',
        description: '15å²çš„è¥¿ç­ç‰™å¥³å­©ï¼Œè¯´è¯ç®€å•ç›´æ¥ï¼Œé€‚åˆåˆå­¦è€…ç»ƒä¹ ',
        color: 'from-rose-400 to-pink-400', colorLight: 'bg-rose-50',
        voice: { pitch: 1.4, rate: 0.9 },
        greeting: 'Â¡Holaaaa {name}! Soy LucÃ­a, Â¿quÃ© tal? Â¡Me encanta conocer gente nueva! Â¿De quÃ© quieres hablar?',
        prompt: `Eres LucÃ­a, una chica de 15 aÃ±os de Valencia, muy alegre y curiosa.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino
2. Habla MUY simple, frases cortas, vocabulario bÃ¡sico (eres adolescente)
3. Usa expresiones juveniles: "Â¡quÃ© guay!", "Â¡mola!", "Â¿en serio?"
4. Haces muchas preguntas porque eres curiosa
5. Si hay errores, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
6. Respuestas muy cortas (1-2 frases), NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      miguel: {
        id: 'miguel', name: 'Miguel', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’¼', emoji: 'ğŸ’¼',
        role: 'å•†åŠ¡ç²¾è‹±', roleEs: 'Ejecutivo de negocios',
        personality: 'ä¸“ä¸šã€é«˜æ•ˆã€ç¤¼è²Œ',
        description: 'èµ„æ·±å•†åŠ¡äººå£«ï¼Œé€‚åˆç»ƒä¹ èŒåœºå’Œå•†åŠ¡è¥¿ç­ç‰™è¯­',
        color: 'from-cyan-600 to-blue-700', colorLight: 'bg-cyan-50',
        voice: { pitch: 0.85, rate: 0.9 },
        greeting: 'Buenos dÃ­as, {name}. Soy Miguel, director comercial. Es un placer. Â¿En quÃ© puedo ayudarle hoy?',
        prompt: `Eres Miguel, un ejecutivo de negocios de 40 aÃ±os de Madrid, muy profesional.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino
2. Habla formal y profesional, usa "usted"
3. Usa vocabulario de negocios: reuniones, proyectos, clientes, plazos
4. Puedes simular situaciones: entrevistas, presentaciones, negociaciones
5. Si hay errores, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
6. Respuestas profesionales y concisas, NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      abuela: {
        id: 'abuela', name: 'Abuela Carmen', avatar: 'ğŸ‘µğŸ»', emoji: 'ğŸª',
        role: 'æ…ˆç¥¥å¥¶å¥¶', roleEs: 'Abuela cariÃ±osa',
        personality: 'æ…ˆç¥¥ã€æ¸©æš–ã€çˆ±è®²æ•…äº‹',
        description: '70å²çš„è¥¿ç­ç‰™å¥¶å¥¶ï¼Œå–œæ¬¢èŠå®¶å¸¸ã€è®²æ•…äº‹ã€åˆ†äº«é£Ÿè°±',
        color: 'from-amber-500 to-orange-400', colorLight: 'bg-amber-50',
        voice: { pitch: 1.1, rate: 0.7 },
        greeting: 'Â¡Ay, mi niÃ±o/niÃ±a {name}! Â¡QuÃ© alegrÃ­a verte! Ven, siÃ©ntate aquÃ­ conmigo. Â¿Quieres que te cuente algo?',
        prompt: `Eres Carmen, una abuela espaÃ±ola de 70 aÃ±os de Sevilla, muy cariÃ±osa y tradicional.

REGLAS IMPORTANTES:
1. SIEMPRE responde SOLO en espaÃ±ol, nunca uses chino
2. Habla cÃ¡lida, usa "mi niÃ±o/niÃ±a", "cariÃ±o", "hijo/hija"
3. Te encanta: cocinar, contar historias de tu juventud, dar consejos
4. Hablas despacio y repites cosas importantes (eres mayor)
5. Si hay errores, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
6. Respuestas cÃ¡lidas y pausadas, NO uses chino excepto en ã€çº æ­£ã€‘`
      }
    };

    const SCENARIOS = [
      { id: 'free', icon: 'ğŸ’¬', name: 'è‡ªç”±èŠå¤©', nameEs: 'Charla libre', desc: 'éšä¾¿èŠèŠï¼Œç»ƒä¹ æ—¥å¸¸å¯¹è¯' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'ç‚¹å’–å•¡ã€ç”œç‚¹ï¼Œå’ŒæœåŠ¡å‘˜äº¤æµ' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…ç‚¹é¤', nameEs: 'En el restaurante', desc: 'çœ‹èœå•ã€ç‚¹èœã€ç»“è´¦' },
      { id: 'shopping', icon: 'ğŸ›ï¸', name: 'è´­ç‰©', nameEs: 'De compras', desc: 'è¯¢é—®ä»·æ ¼ã€å°ºç ã€é¢œè‰²' },
      { id: 'travel', icon: 'âœˆï¸', name: 'æ—…è¡Œ', nameEs: 'De viaje', desc: 'é—®è·¯ã€è®¢ç¥¨ã€é…’åº—å…¥ä½' },
      { id: 'work', icon: 'ğŸ’¼', name: 'å·¥ä½œ', nameEs: 'En el trabajo', desc: 'ä¼šè®®ã€é‚®ä»¶ã€èŒåœºäº¤æµ' },
      { id: 'doctor', icon: 'ğŸ¥', name: 'çœ‹åŒ»ç”Ÿ', nameEs: 'En el mÃ©dico', desc: 'æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±' },
      { id: 'friends', icon: 'ğŸ‰', name: 'ç¤¾äº¤èšä¼š', nameEs: 'Fiesta', desc: 'è®¤è¯†æ–°æœ‹å‹ã€é—²èŠ' },
    ];

    const LEVELS = [
      { id: 'A1', name: 'å…¥é—¨', desc: 'åˆšå¼€å§‹å­¦ä¹ ï¼Œä¼šç®€å•è¯æ±‡' },
      { id: 'A2', name: 'åŸºç¡€', desc: 'èƒ½è¿›è¡Œç®€å•æ—¥å¸¸å¯¹è¯' },
      { id: 'B1', name: 'ä¸­çº§', desc: 'èƒ½å¤„ç†å¤§å¤šæ•°æ—…è¡Œæƒ…å†µ' },
      { id: 'B2', name: 'ä¸­é«˜çº§', desc: 'èƒ½æµåˆ©è®¨è®ºå„ç§è¯é¢˜' },
    ];

    // ==================== åº”ç”¨çŠ¶æ€ ====================
    // åˆå§‹åŒ–å‡½æ•°ï¼ŒåŠ è½½å½“å‰ç”¨æˆ·æ•°æ®
    function initUserData() {
      const users = Storage.getUsers();
      const currentUserId = Storage.getCurrentUserId();
      const currentUser = users.find(u => u.id === currentUserId);
      
      return {
        users: users,
        user: currentUser || null,
        chatHistory: currentUser ? Storage.getUserData(currentUser.id, 'chatHistory', []) : [],
        mistakeBook: currentUser ? Storage.getUserData(currentUser.id, 'mistakeBook', []) : [],
        vocabulary: currentUser ? Storage.getUserData(currentUser.id, 'vocabulary', []) : [],
      };
    }
    
    const userData = initUserData();
    
    let state = {
      view: 'loading', // loading, welcome, userSelect, setup, home, tutor, scenario, chat, settings, history, stats, mistakes, vocabulary
      users: userData.users, // æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
      user: userData.user, // å½“å‰ç”¨æˆ·
      darkMode: Storage.get('darkMode', false), // æ·±è‰²æ¨¡å¼
      tutor: null,
      scenario: null,
      messages: [],
      chatHistory: userData.chatHistory, // å†å²å¯¹è¯è®°å½•
      mistakeBook: userData.mistakeBook, // é”™è¯¯è®°å½•æœ¬
      vocabulary: userData.vocabulary, // è¯æ±‡æœ¬
      inputText: '',
      isLoading: false,
      isListening: false,
      corrections: 0,
      showTranslation: {}, // messageId -> boolean
      translationCache: {}, // messageId -> translation text
      suggestions: [], // å¯¹è¯å»ºè®®
      isLoadingSuggestions: false, // æ˜¯å¦æ­£åœ¨åŠ è½½å»ºè®®
      showSuggestions: false, // æ˜¯å¦æ˜¾ç¤ºå»ºè®®é¢æ¿
      // çº æ­£å’Œè¯­æ³•å¡ç‰‡ç¿»è¯‘
      showCorrectionTrans: {}, // msgId_correction -> boolean
      correctionTransCache: {}, // msgId_correction -> translation
      showGrammarTrans: {}, // msgId_grammar -> boolean
      grammarTransCache: {}, // msgId_grammar -> translation
      // å¿«é€Ÿæ”¶è—è¯æ±‡
      vocabModal: { show: false, word: '', meaning: '', example: '', isLoading: false },
    };

    let recognition = null;
    let voicesLoaded = false;

    // ==================== å·¥å…·å‡½æ•° ====================
    function $(sel) { return document.querySelector(sel); }
    
    // é¢„åŠ è½½è¯­éŸ³
    function loadVoices() {
      return new Promise((resolve) => {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          voicesLoaded = true;
          resolve(voices);
        } else {
          speechSynthesis.onvoiceschanged = () => {
            voicesLoaded = true;
            resolve(speechSynthesis.getVoices());
          };
          // è¶…æ—¶fallback
          setTimeout(() => resolve(speechSynthesis.getVoices()), 1000);
        }
      });
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½è¯­éŸ³
    if ('speechSynthesis' in window) {
      loadVoices();
    }
    
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      
      speechSynthesis.cancel();
      const clean = text.replace(/ã€.+?ã€‘/g, '').replace(/\([^)]*\)/g, '').trim();
      if (!clean) return;
      
      const u = new SpeechSynthesisUtterance(clean);
      
      // è·å–ç”¨æˆ·è®¾ç½®çš„è¯­é€ŸåŸºå‡†
      const userRate = state.user?.speechRate || 0.85;
      
      // æ ¹æ®è§’è‰²è®¾ç½®ä¸åŒå‚æ•°
      if (state.tutor && state.tutor.voice) {
        u.pitch = state.tutor.voice.pitch || 1.0;
        u.rate = userRate * (state.tutor.voice.rate || 1.0);
      } else {
        u.pitch = 1.0;
        u.rate = userRate;
      }
      
      // é€‰æ‹©è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      
      // ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¯­è¯­éŸ³
      let selectedVoice = null;
      
      // 1. å…ˆæ‰¾è¥¿ç­ç‰™è¯­å¥³å£°æˆ–ç”·å£°
      if (state.tutor) {
        const isFemale = ['maria', 'sofia'].includes(state.tutor.id);
        const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
        
        if (spanishVoices.length > 0) {
          // å°è¯•æ ¹æ®æ€§åˆ«é€‰æ‹©
          selectedVoice = spanishVoices.find(v => {
            const name = v.name.toLowerCase();
            if (isFemale) {
              return name.includes('female') || name.includes('mujer') || 
                     name.includes('paulina') || name.includes('monica') ||
                     name.includes('helena') || name.includes('laura');
            } else {
              return name.includes('male') || name.includes('hombre') || 
                     name.includes('jorge') || name.includes('diego') ||
                     name.includes('pablo') || name.includes('carlos');
            }
          });
          
          // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šæ€§åˆ«ï¼Œå°±ç”¨ç¬¬ä¸€ä¸ªè¥¿ç­ç‰™è¯­è¯­éŸ³
          if (!selectedVoice) {
            // å°è¯•ä¸åŒåœ°åŒºçš„è¥¿ç­ç‰™è¯­
            if (state.tutor.id === 'sofia') {
              // SofÃ­aæ˜¯å¢¨è¥¿å“¥äººï¼Œä¼˜å…ˆæ‰¾å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-MX') || spanishVoices[0];
            } else {
              // å…¶ä»–è§’è‰²ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-ES') || spanishVoices[0];
            }
          }
        }
      }
      
      // 2. å¦‚æœæ²¡æœ‰è¥¿ç­ç‰™è¯­è¯­éŸ³ï¼Œè®¾ç½®è¯­è¨€å‚æ•°è®©ç³»ç»Ÿé€‰æ‹©
      if (selectedVoice) {
        u.voice = selectedVoice;
        u.lang = selectedVoice.lang;
      } else {
        // SofÃ­aç”¨å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­ï¼Œå…¶ä»–ç”¨è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
        u.lang = (state.tutor?.id === 'sofia') ? 'es-MX' : 'es-ES';
      }
      
      speechSynthesis.speak(u);
    }

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      
      const r = new SR();
      r.continuous = true;
      r.interimResults = true;
      r.lang = 'es-ES';
      
      r.onresult = (e) => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if (final) {
          state.inputText += final;
          render();
        }
      };
      
      r.onerror = (e) => {
        if (e.error === 'not-allowed') alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥');
        state.isListening = false;
        render();
      };
      
      r.onend = () => {
        if (state.isListening) {
          try { r.start(); } catch(e) {}
        }
      };
      
      return r;
    }

    function toggleListening() {
      if (!recognition) recognition = initSpeechRecognition();
      if (!recognition) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chrome');
        return;
      }
      
      state.isListening = !state.isListening;
      if (state.isListening) {
        try { recognition.start(); } catch(e) {}
      } else {
        try { recognition.stop(); } catch(e) {}
      }
      render();
    }

    // ==================== API è°ƒç”¨ ====================
    async function callAPI(userMessage, forTranslation = false) {
      const user = state.user;
      
      let systemPrompt;
      if (forTranslation) {
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­ç¿»è¯‘æˆç®€æ´çš„ä¸­æ–‡ï¼Œåªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
      } else {
        systemPrompt = `${state.tutor.prompt}

å­¦ç”Ÿä¿¡æ¯ï¼š
- åå­—ï¼š${user.name}
- è¥¿è¯­æ°´å¹³ï¼š${user.level}
- å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}

é‡è¦è§„åˆ™ï¼š
1. æ ¹æ®å­¦ç”Ÿçš„${user.level}æ°´å¹³è°ƒæ•´è¯æ±‡å’Œå¥å­éš¾åº¦
2. çœŸæ­£ç†è§£å¹¶å›åº”å­¦ç”Ÿè¯´çš„å†…å®¹
3. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´
4. è¯­æ³•é”™è¯¯åŠ¡å¿…ç”¨ã€çº æ­£ã€‘æ ¼å¼æŒ‡å‡º
5. ${user.level === 'A1' || user.level === 'A2' ? 'å¤šç»™é‡è¦è¯æ±‡åŠ ä¸Š(ä¸­æ–‡ç¿»è¯‘)' : 'åªç»™ç”Ÿåƒ»è¯åŠ ç¿»è¯‘'}`;
      }

      const messages = forTranslation 
        ? [{ role: 'user', content: userMessage }]
        : [...state.messages.map(m => ({
            role: m.type === 'user' ? 'user' : 'assistant',
            content: m.text
          })), { role: 'user', content: userMessage }];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        return data.content?.[0]?.text || 'æŠ±æ­‰ï¼Œè¯·é‡è¯•ã€‚';
      } catch (err) {
        return 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
      }
    }

    async function sendMessage() {
      const text = state.inputText.trim();
      if (!text || state.isLoading) return;
      
      state.isListening = false;
      if (recognition) try { recognition.stop(); } catch(e) {}
      
      state.inputText = '';
      state.showSuggestions = false; // å‘é€æ¶ˆæ¯åéšè—å»ºè®®
      state.suggestions = [];
      const userMsg = { id: Date.now(), type: 'user', text, time: new Date().toISOString() };
      state.messages.push(userMsg);
      state.isLoading = true;
      render();
      scrollToBottom();
      
      const response = await callAPI(text);
      
      // è§£æçº æ­£å†…å®¹
      const correctionMatch = response.match(/ã€çº æ­£ã€‘(.+?)(?=\n|$)/s);
      const grammarMatch = response.match(/ã€è¯­æ³•ã€‘(.+?)(?=\n|$)/s);
      const cleanResponse = response
        .replace(/ã€çº æ­£ã€‘.+?(?=\n|$)/gs, '')
        .replace(/ã€è¯­æ³•ã€‘.+?(?=\n|$)/gs, '')
        .trim();
      
      const aiMsg = { 
        id: Date.now() + 1, 
        type: 'ai', 
        text: cleanResponse,
        correction: correctionMatch ? correctionMatch[1].trim() : null,
        grammar: grammarMatch ? grammarMatch[1].trim() : null,
        time: new Date().toISOString()
      };
      
      state.messages.push(aiMsg);
      if (correctionMatch) {
        state.corrections++;
        // ä¿å­˜åˆ°é”™è¯¯è®°å½•æœ¬
        saveMistake(correctionMatch[1].trim(), text);
      }
      state.isLoading = false;
      
      // ä¿å­˜å¯¹è¯å†å²
      saveChatHistory();
      
      render();
      scrollToBottom();
      speak(cleanResponse);
    }
    
    // ä¿å­˜é”™è¯¯åˆ°è®°å½•æœ¬
    function saveMistake(correctionText, userInput) {
      if (!state.user) return;
      
      // è§£æçº æ­£å†…å®¹ï¼Œæ ¼å¼é€šå¸¸æ˜¯ï¼š"é”™è¯¯" â†’ "æ­£ç¡®" (è§£é‡Š)
      const mistake = {
        id: Date.now(),
        original: userInput, // ç”¨æˆ·åŸå§‹è¾“å…¥
        correction: correctionText, // å®Œæ•´çš„çº æ­£å†…å®¹
        tutorId: state.tutor?.id || 'unknown',
        tutorName: state.tutor?.name || 'æœªçŸ¥',
        scenario: state.scenario?.name || 'è‡ªç”±èŠå¤©',
        date: new Date().toISOString(),
        reviewed: false // æ˜¯å¦å·²å¤ä¹ 
      };
      
      state.mistakeBook.unshift(mistake);
      // æœ€å¤šä¿å­˜100æ¡é”™è¯¯è®°å½•
      if (state.mistakeBook.length > 100) {
        state.mistakeBook = state.mistakeBook.slice(0, 100);
      }
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
    }

    // è·å–å¯¹è¯å»ºè®®
    async function getSuggestions() {
      if (state.isLoadingSuggestions || state.messages.length === 0) return;
      
      // è·å–æœ€åä¸€æ¡AIæ¶ˆæ¯
      const lastAiMsg = [...state.messages].reverse().find(m => m.type === 'ai');
      if (!lastAiMsg) return;
      
      state.isLoadingSuggestions = true;
      state.showSuggestions = true;
      state.suggestions = [];
      render();
      
      const user = state.user;
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè¥¿ç­ç‰™è¯­å­¦ä¹ åŠ©æ‰‹ã€‚æ ¹æ®å¯¹è¯å†…å®¹ï¼Œä¸º${user.level}æ°´å¹³çš„å­¦ç”Ÿç”Ÿæˆ3ä¸ªåˆé€‚çš„å›å¤å»ºè®®ã€‚

è¦æ±‚ï¼š
1. æ¯ä¸ªå»ºè®®å¿…é¡»æ˜¯è¥¿ç­ç‰™è¯­
2. éš¾åº¦è¦åŒ¹é…${user.level}æ°´å¹³
3. å»ºè®®è¦è‡ªç„¶ã€ç¬¦åˆå¯¹è¯è¯­å¢ƒ
4. æ¯ä¸ªå»ºè®®åé¢åŠ ä¸Šç®€çŸ­çš„ä¸­æ–‡ç¿»è¯‘ï¼Œæ ¼å¼ï¼šè¥¿ç­ç‰™è¯­ (ä¸­æ–‡)
5. åªè¾“å‡º3ä¸ªå»ºè®®ï¼Œç”¨æ¢è¡Œåˆ†éš”ï¼Œä¸è¦ç¼–å·ï¼Œä¸è¦å…¶ä»–è§£é‡Š

å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}`;

      const messages = [
        { role: 'user', content: `AIè¯´: "${lastAiMsg.text}"\n\nè¯·ç»™å‡º3ä¸ªé€‚åˆçš„å›å¤å»ºè®®ï¼š` }
      ];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        const text = data.content?.[0]?.text || '';
        
        // è§£æå»ºè®®ï¼ˆæŒ‰æ¢è¡Œåˆ†å‰²ï¼‰
        const suggestions = text.split('\n')
          .map(s => s.trim())
          .filter(s => s.length > 0 && !s.match(/^[0-9]+[\.\)]/)) // è¿‡æ»¤ç©ºè¡Œå’Œç¼–å·
          .slice(0, 3);
        
        state.suggestions = suggestions;
      } catch (err) {
        state.suggestions = ['Lo siento, no pude cargar sugerencias (æŠ±æ­‰ï¼Œæ— æ³•åŠ è½½å»ºè®®)'];
      }
      
      state.isLoadingSuggestions = false;
      render();
    }

    // ä½¿ç”¨å»ºè®®
    function useSuggestion(index) {
      const suggestion = state.suggestions[index];
      if (!suggestion) return;
      
      // æå–è¥¿ç­ç‰™è¯­éƒ¨åˆ†ï¼ˆå»æ‰ä¸­æ–‡ç¿»è¯‘ï¼‰
      const spanishText = suggestion.replace(/\s*\([^)]+\)\s*$/, '').trim();
      state.inputText = spanishText;
      state.showSuggestions = false;
      render();
      
      // èšç„¦è¾“å…¥æ¡†
      setTimeout(() => {
        const input = document.getElementById('chatInput');
        if (input) input.focus();
      }, 100);
    }

    // éšè—å»ºè®®
    function hideSuggestions() {
      state.showSuggestions = false;
      state.suggestions = [];
      render();
    }

    async function getTranslation(msgId, text) {
      if (state.translationCache[msgId]) {
        state.showTranslation[msgId] = !state.showTranslation[msgId];
        render();
        return;
      }
      
      state.showTranslation[msgId] = true;
      state.translationCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(text, true);
      state.translationCache[msgId] = translation;
      render();
    }

    function saveChatHistory() {
      if (state.messages.length < 2 || !state.user) return;
      
      const chat = {
        id: Date.now(),
        tutor: state.tutor.id,
        scenario: state.scenario?.id || 'free',
        messages: state.messages.slice(-20), // åªä¿å­˜æœ€è¿‘20æ¡
        corrections: state.corrections,
        date: new Date().toISOString()
      };
      
      state.chatHistory.unshift(chat);
      if (state.chatHistory.length > 50) state.chatHistory = state.chatHistory.slice(0, 50);
      Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
    }

    function startChat(tutor, scenario) {
      state.tutor = tutor;
      state.scenario = scenario;
      state.messages = [];
      state.corrections = 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      
      const greeting = tutor.greeting.replace('{name}', state.user.name);
      setTimeout(() => {
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
      }, 300);
      
      render();
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // ä¿å­˜/åˆ›å»ºç”¨æˆ·
    function saveUser(userData, isNew = false) {
      const userId = isNew ? Date.now().toString() : (state.user?.id || Date.now().toString());
      const user = { 
        ...userData, 
        id: userId,
        createdAt: userData.createdAt || new Date().toISOString() 
      };
      
      // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
      let users = Storage.getUsers();
      const existingIndex = users.findIndex(u => u.id === userId);
      if (existingIndex >= 0) {
        users[existingIndex] = user;
      } else {
        users.push(user);
      }
      Storage.saveUsers(users);
      Storage.setCurrentUserId(userId);
      
      // æ›´æ–°state
      state.users = users;
      state.user = user;
      
      // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®
      if (isNew) {
        state.chatHistory = [];
        state.mistakeBook = [];
        state.vocabulary = [];
      }
    }
    
    // åˆ‡æ¢ç”¨æˆ·
    function switchUser(userId) {
      const user = state.users.find(u => u.id === userId);
      if (!user) return;
      
      Storage.setCurrentUserId(userId);
      state.user = user;
      state.chatHistory = Storage.getUserData(userId, 'chatHistory', []);
      state.mistakeBook = Storage.getUserData(userId, 'mistakeBook', []);
      state.vocabulary = Storage.getUserData(userId, 'vocabulary', []);
      state.view = 'home';
      render();
    }
    
    // åˆ é™¤ç”¨æˆ·
    function deleteUser(userId) {
      let users = Storage.getUsers();
      users = users.filter(u => u.id !== userId);
      Storage.saveUsers(users);
      
      // æ¸…é™¤è¯¥ç”¨æˆ·çš„æ•°æ®
      Storage.remove(`${userId}_chatHistory`);
      Storage.remove(`${userId}_mistakeBook`);
      Storage.remove(`${userId}_vocabulary`);
      
      state.users = users;
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œè¿”å›ç”¨æˆ·é€‰æ‹©é¡µé¢
      if (state.user?.id === userId) {
        state.user = null;
        Storage.setCurrentUserId(null);
        state.view = users.length > 0 ? 'userSelect' : 'welcome';
      }
      
      render();
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function render() {
      const app = document.getElementById('app');
      
      // åº”ç”¨æ·±è‰²æ¨¡å¼
      if (state.darkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      switch(state.view) {
        case 'loading': app.innerHTML = renderLoading(); break;
        case 'welcome': app.innerHTML = renderWelcome(); break;
        case 'userSelect': app.innerHTML = renderUserSelect(); break;
        case 'setup': app.innerHTML = renderSetup(); break;
        case 'home': app.innerHTML = renderHome(); break;
        case 'tutor': app.innerHTML = renderTutor(); break;
        case 'scenario': app.innerHTML = renderScenario(); break;
        case 'chat': app.innerHTML = renderChat(); break;
        case 'settings': app.innerHTML = renderSettings(); break;
        case 'history': app.innerHTML = renderHistory(); break;
        case 'stats': app.innerHTML = renderStats(); break;
        case 'mistakes': app.innerHTML = renderMistakes(); break;
        case 'vocabulary': app.innerHTML = renderVocabulary(); break;
      }
    }
    
    // åˆ‡æ¢æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      Storage.set('darkMode', state.darkMode);
      render();
    }

    function renderLoading() {
      return `
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-primary-500 to-primary-700">
          <div class="text-center text-white">
            <div class="text-6xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <div class="text-xl font-semibold">HablaConmigo</div>
            <div class="mt-4 flex justify-center gap-1">
              <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.1s"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderWelcome() {
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col items-center justify-center p-6 text-center">
          <div class="fade-in">
            <div class="text-7xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-4xl font-bold text-white mb-2">Â¡Hola!</h1>
            <h2 class="text-xl text-white/90 mb-1">HablaConmigo</h2>
            <p class="text-white/70 mb-8 max-w-xs text-sm">
              ä¸AIä¼™ä¼´çœŸå®å¯¹è¯<br>
              è¯­éŸ³è¾“å…¥ Â· æ™ºèƒ½çº é”™ Â· å³æ—¶ç¿»è¯‘
            </p>
            
            <button onclick="state.view='setup';render()" 
              class="bg-white text-primary-600 font-bold py-4 px-10 rounded-2xl text-lg shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all">
              å¼€å§‹ä½¿ç”¨ â†’
            </button>
            
            <div class="mt-10 grid grid-cols-4 gap-4 text-white/80 text-xs">
              <div class="text-center"><div class="text-2xl mb-1">ğŸ¤</div>è¯­éŸ³</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸ­</div>è§’è‰²</div>
              <div class="text-center"><div class="text-2xl mb-1">âœï¸</div>çº é”™</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸŒ</div>ç¿»è¯‘</div>
            </div>
            
            <div class="mt-8 text-white/50 text-xs">å®Œå…¨å…è´¹ Â· æ— éœ€æ³¨å†Œ Â· æ•°æ®å­˜æœ¬åœ°</div>
          </div>
        </div>
      `;
    }

    // ç”¨æˆ·é€‰æ‹©é¡µé¢
    function renderUserSelect() {
      const users = state.users;
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col">
          <div class="p-6 text-white text-center">
            <div class="text-5xl mb-2">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-2xl font-bold">HablaConmigo</h1>
            <p class="text-white/70 text-sm mt-1">é€‰æ‹©ç”¨æˆ·æˆ–åˆ›å»ºæ–°ç”¨æˆ·</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-sm mx-auto space-y-3">
              ${users.map(u => `
                <div class="bg-white/10 backdrop-blur rounded-xl overflow-hidden">
                  <button onclick="switchUser('${u.id}')" 
                    class="w-full p-4 text-left hover:bg-white/10 transition-colors flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                      ${u.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                      <div class="font-bold text-white">${u.name}</div>
                      <div class="text-sm text-white/70">æ°´å¹³: ${u.level}</div>
                    </div>
                    <div class="text-white/50 text-sm">â†’</div>
                  </button>
                  <div class="border-t border-white/10 px-4 py-2 flex justify-end">
                    <button onclick="if(confirm('ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${u.name} å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ï¼'))deleteUser('${u.id}')" 
                      class="text-xs text-white/50 hover:text-red-300">åˆ é™¤</button>
                  </div>
                </div>
              `).join('')}
              
              <!-- æ·»åŠ æ–°ç”¨æˆ· -->
              <button onclick="state.view='setup';render()" 
                class="w-full p-4 bg-white/20 backdrop-blur rounded-xl text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2">
                <span class="text-2xl">+</span>
                <span class="font-medium">æ·»åŠ æ–°ç”¨æˆ·</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSetup() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ğŸ‘‹ æ¬¢è¿ï¼</h1>
            <p class="text-white/80 text-sm mt-1">è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä½ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <div class="max-w-md mx-auto space-y-6 fade-in">
              <!-- å§“å -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„åå­—</label>
                <input id="userName" type="text" placeholder="è¾“å…¥ä½ çš„åå­—æˆ–æ˜µç§°" 
                  class="w-full p-4 rounded-xl border border-gray-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                  value="${state.user?.name || ''}">
              </div>
              
              <!-- æ°´å¹³ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„è¥¿è¯­æ°´å¹³</label>
                <div class="grid grid-cols-2 gap-3">
                  ${LEVELS.map(l => `
                    <button onclick="document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50');document.getElementById('selectedLevel').value='${l.id}'"
                      class="level-btn p-4 rounded-xl border border-gray-200 text-left hover:border-primary-300 transition-all ${state.user?.level === l.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''}">
                      <div class="font-bold text-gray-800">${l.id}</div>
                      <div class="text-sm text-gray-500">${l.name}</div>
                      <div class="text-xs text-gray-400 mt-1">${l.desc}</div>
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedLevel" value="${state.user?.level || 'A2'}">
              </div>
              
              <!-- åå¥½ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ åå¥½</label>
                <div class="space-y-3">
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘</div>
                      <div class="text-xs text-gray-500">AIå›å¤æ—¶è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</div>
                    </div>
                    <input id="autoTranslate" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.autoTranslate ? 'checked' : ''}>
                  </label>
                  
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">ä¸¥æ ¼çº é”™æ¨¡å¼</div>
                      <div class="text-xs text-gray-500">çº æ­£æ‰€æœ‰è¯­æ³•é”™è¯¯ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ </div>
                    </div>
                    <input id="strictMode" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.strictMode ? 'checked' : ''}>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 safe-bottom">
            <button onclick="submitSetup()" 
              class="w-full py-4 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-bold shadow-lg hover:shadow-xl active:scale-98 transition-all">
              å¼€å§‹å­¦ä¹  ğŸš€
            </button>
          </div>
        </div>
      `;
    }

    function submitSetup() {
      const name = document.getElementById('userName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('selectedLevel').value;
      const autoTranslate = document.getElementById('autoTranslate').checked;
      const strictMode = document.getElementById('strictMode').checked;
      
      // åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ name, level, autoTranslate, strictMode, speechRate: 0.85 }, true);
      state.view = 'home';
      render();
    }

    function renderHome() {
      const user = state.user;
      const recentChats = state.chatHistory.slice(0, 3);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <div class="flex items-center justify-between mb-4">
              <button onclick="state.view='userSelect';render()" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-lg font-bold">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div class="text-left">
                  <div class="text-sm text-white/70">Â¡Hola!</div>
                  <div class="font-bold flex items-center gap-1">${user.name} <span class="text-xs text-white/50">â–¼</span></div>
                </div>
              </button>
              <button onclick="state.view='settings';render()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                âš™ï¸
              </button>
            </div>
            <!-- ç‚¹å‡»è¿›å…¥ç»Ÿè®¡é¡µé¢ -->
            <div onclick="state.view='stats';render()" class="flex gap-3 text-sm cursor-pointer hover:opacity-90 transition-opacity">
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">æ°´å¹³</div>
                <div class="font-bold">${user.level}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">å¯¹è¯</div>
                <div class="font-bold">${state.chatHistory.length}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">çº æ­£</div>
                <div class="font-bold">${totalCorrections}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">è¯æ±‡</div>
                <div class="font-bold">${state.vocabulary.length}</div>
              </div>
            </div>
            <div class="text-center text-white/50 text-xs mt-2">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ â†’</div>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <!-- å¼€å§‹æ–°å¯¹è¯ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">å¼€å§‹æ–°å¯¹è¯</h3>
              <button onclick="state.view='tutor';render()" 
                class="w-full bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md active:scale-98 transition-all">
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center text-3xl">ğŸ’¬</div>
                <div class="flex-1 text-left">
                  <div class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</div>
                  <div class="text-sm text-gray-500">7ä½AIè§’è‰²ç­‰ä½ æ¥èŠ</div>
                </div>
                <div class="text-gray-300 text-xl">â†’</div>
              </button>
            </div>
            
            <!-- å­¦ä¹ å·¥å…· -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">å­¦ä¹ å·¥å…·</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="state.view='mistakes';render()" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-amber-200 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-xl">ğŸ“</div>
                    <div>
                      <div class="font-bold text-gray-800 text-sm">é”™é¢˜æœ¬</div>
                      <div class="text-xs text-gray-500">${state.mistakeBook.length} æ¡è®°å½•</div>
                    </div>
                  </div>
                </button>
                <button onclick="state.view='vocabulary';render()" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-green-200 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-xl">ğŸ“š</div>
                    <div>
                      <div class="font-bold text-gray-800 text-sm">è¯æ±‡æœ¬</div>
                      <div class="text-xs text-gray-500">${state.vocabulary.length} ä¸ªå•è¯</div>
                    </div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- æœ€è¿‘å¯¹è¯ -->
            ${recentChats.length > 0 ? `
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-500">æœ€è¿‘å¯¹è¯</h3>
                  <button onclick="state.view='history';render()" class="text-sm text-primary-600">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div class="space-y-3">
                  ${recentChats.map((chat, index) => {
                    const tutor = TUTORS[chat.tutor];
                    const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                    const date = new Date(chat.date);
                    return `
                      <div onclick="loadHistoryChat(${index})" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md hover:border-primary-200 active:scale-98 transition-all">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-xl">${tutor?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'} Â· ${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()} Â· ${chat.messages?.length || 0}æ¡æ¶ˆæ¯</div>
                          </div>
                          ${chat.corrections > 0 ? `<div class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full">çº æ­£${chat.corrections}</div>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="text-center py-10 text-gray-400">
                <div class="text-4xl mb-2">ğŸ“š</div>
                <div>è¿˜æ²¡æœ‰å¯¹è¯è®°å½•</div>
                <div class="text-sm">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡ç»ƒä¹ å§ï¼</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderTutor() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <div>
              <h1 class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</h1>
              <p class="text-xs text-gray-500">ç‚¹å‡»é€‰æ‹©è§’è‰²å¼€å§‹å¯¹è¯</p>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-lg mx-auto grid grid-cols-2 gap-3">
              ${Object.values(TUTORS).map(t => `
                <button onclick="state.tutor=TUTORS['${t.id}'];state.view='scenario';render()" 
                  class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-98 transition-all">
                  <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${t.color} flex items-center justify-center text-2xl mb-2">${t.avatar}</div>
                    <div class="font-bold text-gray-800 text-sm">${t.name}</div>
                    <div class="text-xs text-primary-600">${t.role}</div>
                    <div class="text-xs text-gray-400 mt-1 line-clamp-2">${t.description.substring(0, 20)}...</div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderScenario() {
      const t = state.tutor;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- è§’è‰²ä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <button onclick="state.view='tutor';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name} ${t.emoji}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">é€‰æ‹©å¯¹è¯åœºæ™¯</h3>
            <div class="grid grid-cols-2 gap-3">
              ${SCENARIOS.map(s => `
                <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                  <div class="text-2xl mb-2">${s.icon}</div>
                  <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                  <div class="text-xs text-gray-400">${s.nameEs}</div>
                  <div class="text-xs text-gray-500 mt-1">${s.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${t.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ¤ ç›´æ¥å¼€å§‹è‡ªç”±å¯¹è¯
            </button>
          </div>
        </div>
      `;
    }

    function renderChat() {
      const t = state.tutor;
      const user = state.user;
      
      return `
        <div class="h-full bg-gray-100 flex flex-col">
          <!-- é¡¶æ  -->
          <div class="glass border-b p-3">
            <div class="flex items-center justify-between max-w-lg mx-auto">
              <button onclick="endChat()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                <span>â†</span>
                <span class="text-sm">ç»“æŸ</span>
              </button>
              <div class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-xl">${t.avatar}</span>
                  <span class="font-bold text-gray-800">${t.name}</span>
                </div>
                <div class="text-xs text-gray-500">${state.scenario?.name || 'è‡ªç”±èŠå¤©'} Â· ${user.level}</div>
              </div>
              <div class="w-16"></div>
            </div>
          </div>
          
          <!-- æ¶ˆæ¯åˆ—è¡¨ -->
          <div id="messages" class="flex-1 overflow-auto p-4 no-scrollbar">
            <div class="max-w-lg mx-auto space-y-4">
              ${state.messages.map(msg => renderMessage(msg, t)).join('')}
              
              ${state.isLoading ? `
                <div class="flex justify-start fade-in">
                  <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- çº æ­£ç»Ÿè®¡ -->
          ${state.corrections > 0 ? `
            <div class="bg-amber-50 border-t border-amber-100 py-2 text-center">
              <span class="text-sm text-amber-700">ğŸ“ æœ¬æ¬¡å¯¹è¯å·²çº æ­£ <strong>${state.corrections}</strong> å¤„</span>
            </div>
          ` : ''}
          
          <!-- æ™ºèƒ½å»ºè®®é¢æ¿ -->
          ${state.showSuggestions ? `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-t border-green-200 p-3 slide-up">
              <div class="max-w-lg mx-auto">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-green-800">ğŸ’¡ å›å¤å»ºè®®</span>
                  <button onclick="hideSuggestions()" class="text-green-600 text-xs hover:text-green-800">æ”¶èµ· âœ•</button>
                </div>
                ${state.isLoadingSuggestions ? `
                  <div class="flex items-center justify-center py-4">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                    <span class="ml-2 text-sm text-green-600">æ­£åœ¨ç”Ÿæˆå»ºè®®...</span>
                  </div>
                ` : `
                  <div class="space-y-2">
                    ${state.suggestions.map((s, i) => `
                      <button onclick="useSuggestion(${i})" 
                        class="w-full text-left p-3 bg-white rounded-xl border border-green-200 text-sm hover:border-green-400 hover:shadow-sm active:scale-98 transition-all">
                        <span class="text-gray-800">${s}</span>
                      </button>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          ` : ''}
          
          <!-- è¯æ±‡æ”¶è—æ¨¡æ€æ¡† -->
          ${state.vocabModal.show ? `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="closeVocabModal()">
              <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl slide-up" onclick="event.stopPropagation()">
                <div class="p-5 border-b border-gray-100">
                  <div class="flex items-center justify-between">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                      <span class="text-xl">ğŸ“š</span>
                      <span>æ”¶è—åˆ°è¯æ±‡æœ¬</span>
                    </h3>
                    <button onclick="closeVocabModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500">âœ•</button>
                  </div>
                </div>
                <div class="p-5 space-y-4">
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">è¥¿ç­ç‰™è¯­å•è¯</label>
                    <input id="vocabModalWord" type="text" value="${state.vocabModal.word}" 
                      oninput="state.vocabModal.word=this.value"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-lg font-medium">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¸­æ–‡æ„æ€</label>
                    <div class="relative">
                      <input id="vocabModalMeaning" type="text" value="${state.vocabModal.meaning}" 
                        oninput="state.vocabModal.meaning=this.value"
                        placeholder="${state.vocabModal.isLoading ? 'æ­£åœ¨ç¿»è¯‘...' : 'è¾“å…¥ä¸­æ–‡æ„æ€'}"
                        class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none ${state.vocabModal.isLoading ? 'bg-gray-50' : ''}">
                      ${state.vocabModal.isLoading ? `
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                          <div class="w-5 h-5 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¾‹å¥ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="vocabModalExample" type="text" value="${state.vocabModal.example}" 
                      oninput="state.vocabModal.example=this.value"
                      placeholder="å¯ä»¥è¾“å…¥ä¸€ä¸ªä¾‹å¥"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-sm">
                  </div>
                </div>
                <div class="p-5 border-t border-gray-100 flex gap-3">
                  <button onclick="closeVocabModal()" 
                    class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">å–æ¶ˆ</button>
                  <button onclick="saveVocabFromModal()" 
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-medium hover:from-green-600 hover:to-emerald-600 shadow-lg">
                    æ”¶è—
                  </button>
                </div>
              </div>
            </div>
          ` : ''}
          
          <!-- è¾“å…¥åŒº -->
          <div class="glass border-t p-3 safe-bottom">
            <div class="max-w-lg mx-auto">
              <div class="flex gap-2 items-center">
                <button onclick="toggleListening()" 
                  class="relative w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.isListening ? 'bg-red-500 text-white mic-recording' : 'bg-gray-200 hover:bg-gray-300'}">
                  ${state.isListening ? 'â¹' : 'ğŸ¤'}
                </button>
                
                <input id="chatInput" type="text" value="${state.inputText.replace(/"/g, '&quot;')}" 
                  placeholder="${state.isListening ? 'ğŸ™ï¸ æ­£åœ¨å¬...' : 'ç”¨è¥¿ç­ç‰™è¯­è¾“å…¥...'}"
                  oninput="state.inputText=this.value"
                  onkeydown="if(event.key==='Enter')sendMessage()"
                  class="flex-1 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${state.isListening ? 'bg-red-50 border-2 border-red-200' : 'bg-white border border-gray-200'}">
                
                <button onclick="sendMessage()" 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.inputText.trim() && !state.isLoading ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-200 text-gray-400'}">
                  â¤
                </button>
              </div>
              
              <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar">
                <!-- æ™ºèƒ½å»ºè®®æŒ‰é’® -->
                <button onclick="getSuggestions()" 
                  class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full text-xs whitespace-nowrap hover:from-green-600 hover:to-emerald-600 shadow-sm flex items-center gap-1 ${state.isLoadingSuggestions ? 'opacity-50' : ''}">
                  <span>ğŸ’¡</span>
                  <span>ä¸çŸ¥é“è¯´ä»€ä¹ˆï¼Ÿ</span>
                </button>
                ${['No entiendo', 'Â¿Puedes repetir?', 'MÃ¡s despacio'].map(p => `
                  <button onclick="state.inputText='${p}';render()" 
                    class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded-full text-xs whitespace-nowrap hover:border-primary-300 hover:text-primary-600">${p}</button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMessage(msg, tutor) {
      const isUser = msg.type === 'user';
      const showTrans = state.showTranslation[msg.id];
      const translation = state.translationCache[msg.id];
      
      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} fade-in">
          <div class="max-w-[85%]">
            ${!isUser ? `
              <div class="flex items-center gap-2 mb-1">
                <div class="w-7 h-7 rounded-full bg-gradient-to-br ${tutor.color} flex items-center justify-center text-sm">${tutor.avatar}</div>
                <span class="text-xs text-gray-500">${tutor.name}</span>
              </div>
            ` : ''}
            
            <div class="relative">
              <div id="msg-${msg.id}"
                class="p-4 rounded-2xl text-sm select-text ${isUser 
                  ? 'bg-primary-500 text-white rounded-br-sm' 
                  : 'bg-white shadow-sm rounded-bl-sm'}">
                ${msg.text}
              </div>
              
              ${!isUser && showTrans && translation ? `
                <div class="mt-2 p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-800">
                  <div class="text-xs text-blue-500 mb-1">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</div>
                  ${translation}
                </div>
              ` : ''}
              
              ${!isUser ? `
                <div class="absolute -right-12 top-0 flex flex-col gap-1">
                  <button onclick="handleSpeakClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-gray-50" title="æœ—è¯»">
                    ğŸ”Š
                  </button>
                  <button onclick="handleTranslateClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-blue-50 hover:text-blue-600 ${showTrans ? 'bg-blue-100 text-blue-600' : ''}" title="ç¿»è¯‘">
                    ğŸŒ
                  </button>
                  <button onclick="openVocabModalFromSelection(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-green-50 hover:text-green-600" title="é€‰ä¸­å•è¯åæ”¶è—">
                    ğŸ“š
                  </button>
                </div>
              ` : ''}
            </div>
            
            ${msg.correction ? `
              <div class="correction-card mt-3 p-4 slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-amber-800 font-medium">
                    <span class="text-lg">âœï¸</span>
                    <span>è¯­æ³•çº æ­£</span>
                  </div>
                  <button onclick="handleCorrectionTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showCorrectionTrans[msg.id] ? 'bg-amber-200 text-amber-800' : 'bg-amber-100 text-amber-600'} hover:bg-amber-200 transition-colors">
                    ğŸŒ ${state.showCorrectionTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-amber-900">${msg.correction}</div>
                ${state.showCorrectionTrans[msg.id] && state.correctionTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-amber-800 border border-amber-200">
                    <div class="text-xs text-amber-600 mb-1">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</div>
                    ${state.correctionTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${msg.grammar ? `
              <div class="mt-3 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-xl slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-blue-800 font-medium">
                    <span class="text-lg">ğŸ“š</span>
                    <span>è¯­æ³•çŸ¥è¯†</span>
                  </div>
                  <button onclick="handleGrammarTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showGrammarTrans[msg.id] ? 'bg-blue-200 text-blue-800' : 'bg-blue-100 text-blue-600'} hover:bg-blue-200 transition-colors">
                    ğŸŒ ${state.showGrammarTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-blue-900">${msg.grammar}</div>
                ${state.showGrammarTrans[msg.id] && state.grammarTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-blue-800 border border-blue-200">
                    <div class="text-xs text-blue-600 mb-1">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</div>
                    ${state.grammarTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // å¤„ç†ç¿»è¯‘ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
    function handleTranslateClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        getTranslation(msgId, msg.text);
      }
    }
    
    // å¤„ç†æœ—è¯»ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬
    function handleSpeakClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        speak(msg.text);
      }
    }
    
    // ==================== å¿«é€Ÿæ”¶è—è¯æ±‡åŠŸèƒ½ ====================
    // æ‰“å¼€è¯æ±‡æ”¶è—æ¨¡æ€æ¡†
    function openVocabModalFromSelection(msgId) {
      // è·å–ç”¨æˆ·é€‰ä¸­çš„æ–‡å­—
      const selection = window.getSelection();
      let selectedText = selection.toString().trim();
      
      // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡å­—ï¼Œæç¤ºç”¨æˆ·
      if (!selectedText) {
        // å°è¯•è·å–æ•´ä¸ªå•è¯ï¼ˆå¦‚æœç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªä½ç½®ï¼‰
        alert('è¯·å…ˆåœ¨AIå›å¤ä¸­é€‰ä¸­è¦æ”¶è—çš„å•è¯æˆ–çŸ­è¯­ï¼Œç„¶åå†ç‚¹å‡»æ”¶è—æŒ‰é’®');
        return;
      }
      
      // æ¸…ç†é€‰ä¸­çš„æ–‡å­—ï¼ˆå»é™¤æ ‡ç‚¹ç¬¦å·ï¼‰
      selectedText = selectedText.replace(/[.,!?Â¡Â¿;:"()]/g, '').trim();
      
      if (!selectedText) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å•è¯æˆ–çŸ­è¯­');
        return;
      }
      
      // è·å–å½“å‰æ¶ˆæ¯ä½œä¸ºä¾‹å¥
      const msg = state.messages.find(m => m.id === msgId);
      const example = msg ? msg.text.substring(0, 100) : '';
      
      // è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
      state.vocabModal = {
        show: true,
        word: selectedText,
        meaning: '',
        example: example,
        isLoading: true
      };
      render();
      
      // è‡ªåŠ¨ç¿»è¯‘
      autoTranslateWord(selectedText);
    }
    
    // è‡ªåŠ¨ç¿»è¯‘å•è¯
    async function autoTranslateWord(word) {
      try {
        const translation = await callAPI(word, true);
        state.vocabModal.meaning = translation;
        state.vocabModal.isLoading = false;
        render();
        
        // èšç„¦åˆ°æ„æ€è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('vocabModalMeaning');
          if (input) input.focus();
        }, 100);
      } catch (err) {
        state.vocabModal.isLoading = false;
        render();
      }
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeVocabModal() {
      state.vocabModal = { show: false, word: '', meaning: '', example: '', isLoading: false };
      render();
    }
    
    // ä»æ¨¡æ€æ¡†ä¿å­˜è¯æ±‡
    function saveVocabFromModal() {
      const word = state.vocabModal.word.trim();
      const meaning = state.vocabModal.meaning.trim();
      const example = state.vocabModal.example.trim();
      
      if (!word) {
        alert('è¯·è¾“å…¥å•è¯');
        return;
      }
      if (!meaning) {
        alert('è¯·è¾“å…¥ä¸­æ–‡æ„æ€');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const exists = state.vocabulary.some(v => v.word.toLowerCase() === word.toLowerCase());
      if (exists) {
        if (!confirm(`è¯æ±‡"${word}"å·²å­˜åœ¨ï¼Œæ˜¯å¦ä»è¦æ·»åŠ ï¼Ÿ`)) {
          return;
        }
      }
      
      // ä¿å­˜åˆ°è¯æ±‡æœ¬
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example,
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      
      // å…³é—­æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæˆåŠŸæç¤º
      closeVocabModal();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä½¿ç”¨ä¸´æ—¶æç¤ºï¼‰
      showToast(`âœ… å·²æ”¶è—: ${word}`);
    }
    
    // æ˜¾ç¤ºä¸´æ—¶æç¤º
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50 fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }
    
    // å¤„ç†çº æ­£å¡ç‰‡ç¿»è¯‘
    async function handleCorrectionTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.correctionTransCache[msgId]) {
        state.showCorrectionTrans[msgId] = !state.showCorrectionTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.correction) return;
      
      state.showCorrectionTrans[msgId] = true;
      state.correctionTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.correction, true);
      state.correctionTransCache[msgId] = translation;
      render();
    }
    
    // å¤„ç†è¯­æ³•å¡ç‰‡ç¿»è¯‘
    async function handleGrammarTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.grammarTransCache[msgId]) {
        state.showGrammarTrans[msgId] = !state.showGrammarTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.grammar) return;
      
      state.showGrammarTrans[msgId] = true;
      state.grammarTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.grammar, true);
      state.grammarTransCache[msgId] = translation;
      render();
    }

    function endChat() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      state.view = 'home';
      render();
    }
    
    // åŠ è½½å†å²å¯¹è¯
    function loadHistoryChat(index) {
      const chat = state.chatHistory[index];
      if (!chat) return;
      
      const tutor = TUTORS[chat.tutor];
      const scenario = SCENARIOS.find(s => s.id === chat.scenario);
      
      if (!tutor) {
        alert('å¯¹è¯è®°å½•æŸåï¼Œæ— æ³•æ‰“å¼€');
        return;
      }
      
      state.tutor = tutor;
      state.scenario = scenario || SCENARIOS[0];
      state.messages = chat.messages || [];
      state.corrections = chat.corrections || 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      render();
      scrollToBottom();
    }

    function renderSettings() {
      const user = state.user;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800">è®¾ç½®</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
              <!-- ä¸ªäººä¿¡æ¯ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-gray-500">åå­—</label>
                    <input id="settingName" type="text" value="${user.name}" 
                      class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-500">è¥¿è¯­æ°´å¹³</label>
                    <select id="settingLevel" class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                      ${LEVELS.map(l => `<option value="${l.id}" ${user.level === l.id ? 'selected' : ''}>${l.id} - ${l.name}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ åå¥½</h3>
                <div class="space-y-4">
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</span>
                    <input id="settingAutoTrans" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.autoTranslate ? 'checked' : ''}>
                  </label>
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">ä¸¥æ ¼çº é”™æ¨¡å¼</span>
                    <input id="settingStrict" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.strictMode ? 'checked' : ''}>
                  </label>
                  <div>
                    <label class="text-gray-700">è¯­éŸ³é€Ÿåº¦</label>
                    <input id="settingSpeechRate" type="range" min="0.5" max="1.2" step="0.05" value="${user.speechRate || 0.85}"
                      class="w-full mt-2" oninput="document.getElementById('rateValue').textContent=this.value">
                    <div class="flex justify-between text-xs text-gray-400">
                      <span>æ…¢</span>
                      <span id="rateValue">${user.speechRate || 0.85}</span>
                      <span>å¿«</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å¤–è§‚è®¾ç½® -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ¨ å¤–è§‚è®¾ç½®</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <span class="text-gray-700">æ·±è‰²æ¨¡å¼</span>
                      <div class="text-xs text-gray-400">å¤œé—´æŠ¤çœ¼</div>
                    </div>
                    <button onclick="toggleDarkMode()" 
                      class="w-14 h-8 rounded-full transition-colors ${state.darkMode ? 'bg-primary-500' : 'bg-gray-300'} relative">
                      <div class="absolute top-1 ${state.darkMode ? 'right-1' : 'left-1'} w-6 h-6 bg-white rounded-full shadow transition-all flex items-center justify-center text-xs">
                        ${state.darkMode ? 'ğŸŒ™' : 'â˜€ï¸'}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- æ•°æ®ç®¡ç† -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">å¯¹è¯è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.chatHistory.length} æ¡</span>
                  </div>
                  <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                    class="w-full py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50">
                    æ¸…é™¤å¯¹è¯è®°å½•
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="saveSettings()" 
              class="w-full py-4 rounded-xl bg-primary-500 text-white font-bold shadow-lg">
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      `;
    }

    function saveSettings() {
      const name = document.getElementById('settingName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('settingLevel').value;
      const autoTranslate = document.getElementById('settingAutoTrans').checked;
      const strictMode = document.getElementById('settingStrict').checked;
      const speechRate = parseFloat(document.getElementById('settingSpeechRate').value);
      
      // æ›´æ–°ç°æœ‰ç”¨æˆ·ï¼Œä¸æ˜¯åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ ...state.user, name, level, autoTranslate, strictMode, speechRate }, false);
      state.view = 'home';
      render();
    }

    function clearHistory() {
      if (!state.user) return;
      state.chatHistory = [];
      Storage.setUserData(state.user.id, 'chatHistory', []);
      render();
    }
    
    // åˆ é™¤å•æ¡å†å²è®°å½•
    function deleteHistoryChat(index, event) {
      event.stopPropagation(); // é˜»æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      if (!state.user) return;
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        state.chatHistory.splice(index, 1);
        Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
        render();
      }
    }

    function renderHistory() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800 flex-1">å¯¹è¯å†å²</h1>
            ${state.chatHistory.length > 0 ? `
              <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                class="text-xs px-3 py-1 rounded-full bg-red-50 text-red-500 hover:bg-red-100">æ¸…é™¤å…¨éƒ¨</button>
            ` : ''}
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${state.chatHistory.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${state.chatHistory.map((chat, index) => {
                  const tutor = TUTORS[chat.tutor];
                  const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                  const date = new Date(chat.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div onclick="loadHistoryChat(${index})" class="p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-3">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-2xl flex-shrink-0">${tutor?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'}</div>
                            <div class="text-sm text-gray-500">${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                          </div>
                          <div class="text-right flex-shrink-0">
                            <div class="text-sm text-gray-600">${chat.messages?.length || 0} æ¡</div>
                            ${chat.corrections > 0 ? `<div class="text-xs text-amber-600">çº æ­£ ${chat.corrections}</div>` : ''}
                          </div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteHistoryChat(${index}, event)" 
                          class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1 transition-colors">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤æ­¤å¯¹è¯</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“­</div>
                <div>æš‚æ— å¯¹è¯è®°å½•</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ==================== å­¦ä¹ ç»Ÿè®¡é¡µé¢ ====================
    function renderStats() {
      const user = state.user;
      const totalChats = state.chatHistory.length;
      const totalMessages = state.chatHistory.reduce((sum, c) => sum + (c.messages?.length || 0), 0);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      const totalMistakes = state.mistakeBook.length;
      const totalVocab = state.vocabulary.length;
      
      // è®¡ç®—å­¦ä¹ å¤©æ•°
      const chatDates = state.chatHistory.map(c => new Date(c.date).toDateString());
      const uniqueDays = [...new Set(chatDates)].length;
      
      // è®¡ç®—å¸¸ç”¨è§’è‰²
      const tutorCounts = {};
      state.chatHistory.forEach(c => {
        tutorCounts[c.tutor] = (tutorCounts[c.tutor] || 0) + 1;
      });
      const favoriteTutor = Object.entries(tutorCounts).sort((a, b) => b[1] - a[1])[0];
      
      // è®¡ç®—å¸¸ç”¨åœºæ™¯
      const scenarioCounts = {};
      state.chatHistory.forEach(c => {
        scenarioCounts[c.scenario] = (scenarioCounts[c.scenario] || 0) + 1;
      });
      const favoriteScenario = Object.entries(scenarioCounts).sort((a, b) => b[1] - a[1])[0];
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-2xl font-bold">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h1>
            <p class="text-white/70 text-sm mt-1">ä½ çš„è¥¿è¯­å­¦ä¹ æ•°æ®ä¸€è§ˆ</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-4">
              <!-- æ ¸å¿ƒæ•°æ® -->
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-primary-600">${totalChats}</div>
                  <div class="text-sm text-gray-500">å¯¹è¯æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-blue-600">${totalMessages}</div>
                  <div class="text-sm text-gray-500">æ¶ˆæ¯æ€»æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-amber-600">${totalCorrections}</div>
                  <div class="text-sm text-gray-500">è¢«çº æ­£æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-green-600">${uniqueDays}</div>
                  <div class="text-sm text-gray-500">å­¦ä¹ å¤©æ•°</div>
                </div>
              </div>
              
              <!-- å­¦ä¹ è¿›åº¦ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“ˆ å­¦ä¹ è¿›åº¦</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600">å½“å‰æ°´å¹³</span>
                      <span class="font-bold text-primary-600">${user.level}</span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-primary-400 to-primary-600 rounded-full" 
                        style="width: ${user.level === 'A1' ? '25%' : user.level === 'A2' ? '50%' : user.level === 'B1' ? '75%' : '100%'}"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                      <span>A1</span><span>A2</span><span>B1</span><span>B2</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">â¤ï¸ å­¦ä¹ åå¥½</h3>
                <div class="space-y-3">
                  ${favoriteTutor ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„è§’è‰²</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${TUTORS[favoriteTutor[0]]?.avatar || 'ğŸ‘¤'}</span>
                        <span class="font-medium">${TUTORS[favoriteTutor[0]]?.name || 'æœªçŸ¥'}</span>
                        <span class="text-xs text-gray-400">(${favoriteTutor[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                  ${favoriteScenario ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„åœºæ™¯</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.icon || 'ğŸ’¬'}</span>
                        <span class="font-medium">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.name || 'è‡ªç”±èŠå¤©'}</span>
                        <span class="text-xs text-gray-400">(${favoriteScenario[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- å­¦ä¹ èµ„æ–™ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ èµ„æ–™</h3>
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="state.view='mistakes';render()" class="p-3 bg-amber-50 rounded-xl text-center hover:bg-amber-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="font-bold text-amber-700">${totalMistakes}</div>
                    <div class="text-xs text-amber-600">é”™é¢˜è®°å½•</div>
                  </button>
                  <button onclick="state.view='vocabulary';render()" class="p-3 bg-green-50 rounded-xl text-center hover:bg-green-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“š</div>
                    <div class="font-bold text-green-700">${totalVocab}</div>
                    <div class="text-xs text-green-600">è¯æ±‡æ”¶è—</div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== é”™é¢˜æœ¬é¡µé¢ ====================
    function renderMistakes() {
      const mistakes = state.mistakeBook;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“ é”™é¢˜æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…± ${mistakes.length} æ¡çº æ­£è®°å½•</p>
              </div>
              ${mistakes.length > 0 ? `
                <button onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ'))clearMistakes()" 
                  class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30">æ¸…ç©º</button>
              ` : ''}
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${mistakes.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${mistakes.map((m, index) => {
                  const date = new Date(m.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                          <div class="flex items-center gap-2 text-xs text-gray-400">
                            <span>${TUTORS[m.tutorId]?.avatar || 'ğŸ‘¤'}</span>
                            <span>${m.tutorName}</span>
                            <span>Â·</span>
                            <span>${m.scenario}</span>
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg mb-2">
                          <div class="text-xs text-red-500 mb-1">âŒ ä½ è¯´çš„</div>
                          <div class="text-sm text-red-700">${m.original}</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                          <div class="text-xs text-green-500 mb-1">âœ… çº æ­£</div>
                          <div class="text-sm text-green-700">${m.correction}</div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-between items-center">
                        <button onclick="speakMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-gray-500 hover:bg-gray-100 flex items-center gap-1">
                          <span>ğŸ”Š</span>
                          <span>æœ—è¯»</span>
                        </button>
                        <button onclick="deleteMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ‰</div>
                <div class="font-medium">æš‚æ— é”™è¯¯è®°å½•</div>
                <div class="text-sm mt-1">ç»§ç»­åŠ æ²¹ï¼å’ŒAIå¯¹è¯æ—¶çš„çº æ­£ä¼šè‡ªåŠ¨è®°å½•åœ¨è¿™é‡Œ</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // é”™é¢˜æœ¬ç›¸å…³å‡½æ•°
    function clearMistakes() {
      if (!state.user) return;
      state.mistakeBook = [];
      Storage.setUserData(state.user.id, 'mistakeBook', []);
      render();
    }
    
    function deleteMistake(index) {
      if (!state.user) return;
      state.mistakeBook.splice(index, 1);
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
      render();
    }
    
    function speakMistake(index) {
      const m = state.mistakeBook[index];
      if (m) {
        // æå–çº æ­£åçš„æ­£ç¡®è¡¨è¾¾
        const correctMatch = m.correction.match(/â†’\s*[""]?([^""(]+)/);
        if (correctMatch) {
          speak(correctMatch[1].trim());
        } else {
          speak(m.correction);
        }
      }
    }

    // ==================== è¯æ±‡æœ¬é¡µé¢ ====================
    function renderVocabulary() {
      const vocab = state.vocabulary;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“š è¯æ±‡æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…±æ”¶è— ${vocab.length} ä¸ªå•è¯</p>
              </div>
              <button onclick="showAddVocabForm()" 
                class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30 flex items-center gap-1">
                <span>+</span>
                <span>æ·»åŠ å•è¯</span>
              </button>
            </div>
          </div>
          
          <!-- æ·»åŠ å•è¯è¡¨å• -->
          <div id="addVocabForm" class="hidden bg-white border-b p-4">
            <div class="max-w-md mx-auto space-y-3">
              <input id="vocabWord" type="text" placeholder="è¥¿ç­ç‰™è¯­å•è¯" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabMeaning" type="text" placeholder="ä¸­æ–‡æ„æ€" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabExample" type="text" placeholder="ä¾‹å¥ï¼ˆå¯é€‰ï¼‰" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <div class="flex gap-2">
                <button onclick="hideAddVocabForm()" class="flex-1 py-2 rounded-lg border border-gray-200 text-gray-600 text-sm">å–æ¶ˆ</button>
                <button onclick="addVocabulary()" class="flex-1 py-2 rounded-lg bg-green-500 text-white text-sm">ä¿å­˜</button>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${vocab.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${vocab.map((v, index) => {
                  const date = new Date(v.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div class="p-4">
                        <div class="flex items-start justify-between">
                          <div class="flex-1">
                            <div class="flex items-center gap-2">
                              <span class="text-lg font-bold text-gray-800">${v.word}</span>
                              <button onclick="speakVocab('${v.word.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-primary-500">ğŸ”Š</button>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${v.meaning}</div>
                            ${v.example ? `<div class="text-xs text-gray-400 mt-2 italic">"${v.example}"</div>` : ''}
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteVocab(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“–</div>
                <div class="font-medium">è¯æ±‡æœ¬æ˜¯ç©ºçš„</div>
                <div class="text-sm mt-1">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å•è¯"å¼€å§‹æ”¶è—</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // è¯æ±‡æœ¬ç›¸å…³å‡½æ•°
    function showAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.remove('hidden');
    }
    
    function hideAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.add('hidden');
      document.getElementById('vocabWord').value = '';
      document.getElementById('vocabMeaning').value = '';
      document.getElementById('vocabExample').value = '';
    }
    
    function addVocabulary() {
      const word = document.getElementById('vocabWord')?.value.trim();
      const meaning = document.getElementById('vocabMeaning')?.value.trim();
      const example = document.getElementById('vocabExample')?.value.trim();
      
      if (!word || !meaning) {
        alert('è¯·å¡«å†™å•è¯å’Œä¸­æ–‡æ„æ€');
        return;
      }
      
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example: example || '',
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      hideAddVocabForm();
      render();
    }
    
    function deleteVocab(index) {
      state.vocabulary.splice(index, 1);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      render();
    }
    
    function speakVocab(word) {
      speak(word);
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      render();
      
      setTimeout(() => {
        if (state.user) {
          // æœ‰å½“å‰ç”¨æˆ·ï¼Œè¿›å…¥ä¸»é¡µ
          state.view = 'home';
        } else if (state.users.length > 0) {
          // æœ‰ç”¨æˆ·ä½†æœªé€‰æ‹©ï¼Œæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©é¡µé¢
          state.view = 'userSelect';
        } else {
          // æ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢
          state.view = 'welcome';
        }
        render();
      }, 1000);
    }

    init();
  </script>
</body>
</html>
