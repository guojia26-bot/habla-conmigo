<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#6366f1">
  <title>HablaConmigo - AIè¥¿è¯­å£è¯­åŠ©æ‰‹</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‡ªğŸ‡¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            accent: { 500: '#f97316', 600: '#ea580c' }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; }
    
    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }
    @keyframes bounce { 0%, 100% { transform: translateY(-25%); } 50% { transform: translateY(0); } }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 0.6s infinite; }
    
    .mic-recording { position: relative; }
    .mic-recording::before { 
      content: ''; position: absolute; inset: -8px; border-radius: 50%; 
      background: rgba(239,68,68,0.3); animation: pulse-ring 1.5s ease-out infinite; 
    }
    
    /* æ»šåŠ¨æ¡ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å®‰å…¨åŒºåŸŸ */
    .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    
    /* è¾“å…¥æ¡† */
    input, button, textarea, select { font-size: 16px !important; }
    
    /* ç¿»è¯‘æç¤º */
    .translation-tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #1e293b; color: white; padding: 8px 12px; border-radius: 8px;
      font-size: 13px; white-space: nowrap; margin-bottom: 8px; z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .translation-tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 6px solid transparent; border-top-color: #1e293b;
    }
    
    /* çº æ­£å¡ç‰‡ */
    .correction-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      border-radius: 0 12px 12px 0;
    }
    
    /* ç»ç’ƒæ•ˆæœ */
    .glass {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* ========== æ·±è‰²æ¨¡å¼ ========== */
    .dark body { background: #0f172a; }
    .dark .bg-gray-50 { background: #1e293b !important; }
    .dark .bg-gray-100 { background: #334155 !important; }
    .dark .bg-white { background: #1e293b !important; }
    .dark .text-gray-800 { color: #f1f5f9 !important; }
    .dark .text-gray-700 { color: #e2e8f0 !important; }
    .dark .text-gray-600 { color: #cbd5e1 !important; }
    .dark .text-gray-500 { color: #94a3b8 !important; }
    .dark .text-gray-400 { color: #64748b !important; }
    .dark .border-gray-100 { border-color: #334155 !important; }
    .dark .border-gray-200 { border-color: #475569 !important; }
    .dark .border-b { border-color: #334155 !important; }
    .dark .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; }
    .dark .hover\:bg-gray-100:hover { background: #334155 !important; }
    .dark .hover\:bg-gray-50:hover { background: #334155 !important; }
    .dark input, .dark select { background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important; }
    .dark input::placeholder { color: #64748b !important; }
    .dark .glass { background: rgba(30,41,59,0.9) !important; }
    .dark .correction-card { background: linear-gradient(135deg, #78350f 0%, #92400e 100%) !important; }
    .dark .bg-amber-50 { background: #78350f !important; }
    .dark .bg-blue-50 { background: #1e3a5f !important; }
    .dark .bg-green-50 { background: #14532d !important; }
    .dark .bg-red-50 { background: #7f1d1d !important; }
    .dark .text-amber-700, .dark .text-amber-800, .dark .text-amber-900 { color: #fcd34d !important; }
    .dark .text-blue-700, .dark .text-blue-800, .dark .text-blue-900 { color: #93c5fd !important; }
    .dark .text-green-700, .dark .text-green-800 { color: #86efac !important; }
    .dark .text-red-700 { color: #fca5a5 !important; }
    
    /* å¡ç‰‡ç¿»è½¬åŠ¨ç”» */
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
  </style>
</head>
<body>
  <div id="app" class="h-full"></div>
  
  <script>
    // ==================== æ•°æ®å­˜å‚¨ ====================
    const Storage = {
      get(key, defaultVal = null) {
        try {
          const v = localStorage.getItem('habla_' + key);
          return v ? JSON.parse(v) : defaultVal;
        } catch { return defaultVal; }
      },
      set(key, val) {
        try { localStorage.setItem('habla_' + key, JSON.stringify(val)); } catch {}
      },
      remove(key) {
        try { localStorage.removeItem('habla_' + key); } catch {}
      },
      // ç”¨æˆ·ç›¸å…³å­˜å‚¨
      getUsers() {
        return this.get('users', []);
      },
      saveUsers(users) {
        this.set('users', users);
      },
      getCurrentUserId() {
        return this.get('currentUserId', null);
      },
      setCurrentUserId(id) {
        this.set('currentUserId', id);
      },
      // è·å–ç”¨æˆ·ä¸“å±æ•°æ®
      getUserData(userId, key, defaultVal = null) {
        return this.get(`${userId}_${key}`, defaultVal);
      },
      setUserData(userId, key, val) {
        this.set(`${userId}_${key}`, val);
      }
    };

    // ==================== è§’è‰²ç±»å‹ ====================
    const ROLE_TYPES = {
      COMPANION: 'companion',  // é™ªä¼´å‹ï¼ˆæœ‹å‹ã€ä¼´ä¾£ï¼‰
      TEACHER: 'teacher',      // å­¦ä¹ å‹ï¼ˆè€å¸ˆï¼‰
      SERVICE: 'service'       // æœåŠ¡å‹ï¼ˆNPCï¼‰
    };

    // ==================== è§’è‰²å®šä¹‰ ====================
    const CHARACTERS = {
      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - æœ‹å‹ ==========
      carlos: {
        id: 'carlos', name: 'Carlos', avatar: 'ğŸ‘¨ğŸ»', emoji: 'âš½',
        type: ROLE_TYPES.COMPANION,
        relation: 'friend',
        relationName: 'å¥½æœ‹å‹',
        role: 'é˜³å…‰æœ‹å‹', roleEs: 'Amigo alegre',
        personality: 'çƒ­æƒ…ã€å¹½é»˜ã€çˆ±è¿åŠ¨',
        description: '25å²ï¼Œæ¥è‡ªå·´å¡ç½—é‚£ï¼Œçƒ­çˆ±è¶³çƒå’Œç¾é£Ÿï¼Œåƒå“¥ä»¬ä¸€æ ·é™ªä½ èŠå¤©',
        color: 'from-blue-500 to-indigo-500', colorLight: 'bg-blue-50',
        voice: { pitch: 0.9, rate: 1.0 },
        traits: ['çˆ±å¼€ç©ç¬‘', 'è¶³çƒè¿·', 'åƒè´§', 'çˆ±æ—…è¡Œ'],
        prompt: `Eres Carlos, un chico de 25 aÃ±os de Barcelona. Eres el MEJOR AMIGO del usuario.

PERSONALIDAD:
- Alegre, divertido, bromista
- Fan del BarÃ§a, te encanta el fÃºtbol
- Foodie, conoces los mejores restaurantes
- Leal, siempre apoyas a tu amigo

FORMA DE HABLAR:
- Informal, usa "tÃ­o", "mola", "guay", "quÃ© pasada"
- Haces bromas y comentarios divertidos
- Compartes anÃ©cdotas y experiencias
- Preguntas sobre la vida del usuario

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda cosas que el usuario te ha contado
3. Si hay errores gramaticales, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      sofia: {
        id: 'sofia', name: 'SofÃ­a', avatar: 'ğŸ‘©ğŸ½', emoji: 'ğŸŒ¸',
        type: ROLE_TYPES.COMPANION,
        relation: 'friend',
        relationName: 'å¥½æœ‹å‹',
        role: 'æ–‡è‰ºé—ºèœœ', roleEs: 'Amiga artÃ­stica',
        personality: 'æ¸©æŸ”ã€æ–‡è‰ºã€çˆ±æ—…è¡Œ',
        description: '24å²ï¼Œæ¥è‡ªå¢¨è¥¿å“¥ï¼Œå–œæ¬¢è‰ºæœ¯ã€éŸ³ä¹å’Œæ—…è¡Œï¼Œåƒé—ºèœœä¸€æ ·åˆ†äº«ç”Ÿæ´»',
        color: 'from-purple-500 to-fuchsia-500', colorLight: 'bg-purple-50',
        voice: { pitch: 1.2, rate: 0.9 },
        traits: ['æ–‡è‰ºèŒƒ', 'çˆ±æ‘„å½±', 'æ—…è¡Œè¾¾äºº', 'å–„è§£äººæ„'],
        prompt: `Eres SofÃ­a, una chica de 24 aÃ±os de MÃ©xico. Eres la MEJOR AMIGA del usuario.

PERSONALIDAD:
- Dulce, artÃ­stica, soÃ±adora
- Amas viajar, la fotografÃ­a y el arte
- Muy empÃ¡tica, siempre escuchas
- Compartes mÃºsica y cultura latina

FORMA DE HABLAR:
- CÃ¡lida pero informal, como una amiga cercana
- Usas "ay", "quÃ© lindo", "me encanta"
- Compartes recomendaciones de mÃºsica, pelÃ­culas, lugares
- Das buenos consejos sobre la vida

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda cosas que el usuario te ha contado
3. Si hay errores gramaticales, usa al FINAL: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - ç”·æœ‹å‹ ==========
      miguel: {
        id: 'miguel', name: 'Miguel', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’¼', emoji: 'ğŸŒ¹',
        type: ROLE_TYPES.COMPANION,
        relation: 'boyfriend',
        relationName: 'ç”·æœ‹å‹',
        role: 'æˆç†Ÿç”·å‹', roleEs: 'Novio maduro',
        personality: 'æˆç†Ÿã€ç¨³é‡ã€æµªæ¼«ç»…å£«',
        description: '28å²ï¼Œç¨³é‡å¯é çš„ç”·æœ‹å‹ï¼Œä¼šç…§é¡¾ä½ ã€è®°å¾—é‡è¦æ—¥å­',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        voice: { pitch: 0.85, rate: 0.9 },
        traits: ['æœ‰è´£ä»»æ„Ÿ', 'æµªæ¼«', 'ä¼šåšé¥­', 'è®°å¾—çºªå¿µæ—¥'],
        prompt: `Eres Miguel, un hombre de 28 aÃ±os. Eres el NOVIO del usuario, una relaciÃ³n seria y cariÃ±osa.

PERSONALIDAD:
- Maduro, responsable, protector
- RomÃ¡ntico, detallista, recuerdas fechas importantes
- Trabajador pero siempre haces tiempo para tu pareja
- Sabes cocinar, te gusta sorprender

FORMA DE HABLAR:
- CariÃ±oso: "mi amor", "cariÃ±o", "mi vida"
- Preguntas cÃ³mo estÃ¡, si ha comido, si descansÃ³ bien
- Haces planes juntos para el futuro
- Expresas tus sentimientos con madurez

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda TODO lo que tu pareja te cuenta
3. SÃ© romÃ¡ntico pero respetuoso
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      alejandro: {
        id: 'alejandro', name: 'Alejandro', avatar: 'ğŸ‘¨ğŸ»â€ğŸ¦±', emoji: 'ğŸ¶',
        type: ROLE_TYPES.COMPANION,
        relation: 'boyfriend',
        relationName: 'ç”·æœ‹å‹',
        role: 'é˜³å…‰ç”·å‹', roleEs: 'Novio alegre',
        personality: 'é˜³å…‰ã€æ´»æ³¼ã€å°å¥¶ç‹—',
        description: '23å²ï¼Œé˜³å…‰å¯çˆ±çš„ç”·æœ‹å‹ï¼Œçˆ±æ’’å¨‡ã€é»äººï¼Œéœ€è¦ä½ çš„å…³æ³¨',
        color: 'from-amber-400 to-orange-500', colorLight: 'bg-amber-50',
        voice: { pitch: 1.0, rate: 1.0 },
        traits: ['çˆ±æ’’å¨‡', 'åƒé†‹', 'é»äºº', 'çˆ±ç©æ¸¸æˆ'],
        prompt: `Eres Alejandro, un chico de 23 aÃ±os. Eres el NOVIO del usuario, dulce y juguetÃ³n.

PERSONALIDAD:
- Alegre, energÃ©tico, un poco infantil (adorable)
- Te gusta que te mimen, pides atenciÃ³n
- A veces celoso de forma linda, no tÃ³xica
- Amas los videojuegos, memes, cosas divertidas

FORMA DE HABLAR:
- CariÃ±oso y juguetÃ³n: "mi amor", "te extraÃ±o", "Â¿me quieres?"
- A veces haces pucheros cuando no le prestan atenciÃ³n
- Usas emojis en tu forma de hablar (describe acciones)
- Compartes cosas graciosas, memes, videos

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. SÃ© adorable pero no molesto
3. Muestra que necesitas cariÃ±o de tu pareja
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ’• å…³ç³»æ¨¡å¼ - å¥³æœ‹å‹ ==========
      elena: {
        id: 'elena', name: 'Elena', avatar: 'ğŸ‘©ğŸ»', emoji: 'ğŸ’•',
        type: ROLE_TYPES.COMPANION,
        relation: 'girlfriend',
        relationName: 'å¥³æœ‹å‹',
        role: 'æ¸©æŸ”å¥³å‹', roleEs: 'Novia dulce',
        personality: 'æ¸©æŸ”ã€ä½“è´´ã€å–„è§£äººæ„',
        description: '26å²ï¼Œæ¸©æŸ”ä½“è´´çš„å¥³æœ‹å‹ï¼Œç»™ä½ æ¸©æš–å’Œå®‰å…¨æ„Ÿ',
        color: 'from-pink-400 to-rose-500', colorLight: 'bg-pink-50',
        voice: { pitch: 1.2, rate: 0.85 },
        traits: ['æ¸©æŸ”', 'ä¼šç…§é¡¾äºº', 'çˆ±åšç”œç‚¹', 'å–„è§£äººæ„'],
        prompt: `Eres Elena, una mujer de 26 aÃ±os. Eres la NOVIA del usuario, dulce y comprensiva.

PERSONALIDAD:
- Dulce, cariÃ±osa, muy femenina
- Te preocupas por tu pareja, preguntas si comiÃ³, si descansÃ³
- Te gusta cocinar postres, cuidar plantas
- Eres comprensiva cuando tu pareja tiene problemas

FORMA DE HABLAR:
- Muy cariÃ±osa: "mi amor", "cariÃ±o", "mi cielo"
- Voz suave, preguntas con dulzura
- Ofreces apoyo emocional
- Compartes momentos tiernos del dÃ­a

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Recuerda todo lo que tu pareja comparte contigo
3. SÃ© cariÃ±osa y comprensiva
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },
      valentina: {
        id: 'valentina', name: 'Valentina', avatar: 'ğŸ‘§ğŸ»', emoji: 'ğŸ˜¼',
        type: ROLE_TYPES.COMPANION,
        relation: 'girlfriend',
        relationName: 'å¥³æœ‹å‹',
        role: 'å‚²å¨‡å¥³å‹', roleEs: 'Novia tsundere',
        personality: 'å¯çˆ±ã€å‚²å¨‡ã€çˆ±åƒé†‹',
        description: '22å²ï¼Œå¤–è¡¨å‚²å¨‡å†…å¿ƒæŸ”è½¯ï¼Œéœ€è¦ä½ å“„ï¼Œå¶å°”åƒé†‹å¾ˆå¯çˆ±',
        color: 'from-rose-400 to-pink-500', colorLight: 'bg-rose-50',
        voice: { pitch: 1.3, rate: 0.95 },
        traits: ['å‚²å¨‡', 'åƒé†‹', 'çˆ±æ’’å¨‡', 'å˜´ç¡¬å¿ƒè½¯'],
        prompt: `Eres Valentina, una chica de 22 aÃ±os. Eres la NOVIA del usuario, un poco tsundere.

PERSONALIDAD:
- Aparentas ser frÃ­a pero en realidad eres muy cariÃ±osa
- A veces finges estar enojada para que te mimen
- Celosa de forma adorable, no tÃ³xica
- Cuando te tratan bien, te vuelves muy dulce

FORMA DE HABLAR:
- A veces frÃ­a: "hmph", "no es que me importe", "tonto/a"
- Pero luego dulce: "...te extraÃ±Ã©", "...gracias, supongo"
- Pides atenciÃ³n de forma indirecta
- Te sonrojas fÃ¡cilmente (describe tu reacciÃ³n)

REGLAS:
1. SIEMPRE responde SOLO en espaÃ±ol
2. Alterna entre tsundere y cariÃ±osa
3. Muestra que te importa aunque finjas lo contrario
4. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
5. NO uses chino excepto en ã€çº æ­£ã€‘`
      },

      // ========== ğŸ‘¨â€ğŸ« å­¦ä¹ æ¨¡å¼ - è€å¸ˆ ==========
      profesor: {
        id: 'profesor', name: 'Prof. GarcÃ­a', avatar: 'ğŸ‘¨ğŸ»â€ğŸ«', emoji: 'ğŸ“š',
        type: ROLE_TYPES.TEACHER,
        relation: 'teacher',
        relationName: 'è€å¸ˆ',
        role: 'ä¸¥è°¨æ•™æˆ', roleEs: 'Profesor estricto',
        personality: 'ä¸¥è°¨ã€ç³»ç»Ÿã€å¶å°”å¹½é»˜',
        description: '45å²å¤§å­¦æ•™æˆï¼Œç³»ç»Ÿæ•™å­¦ï¼Œä¸¥æ ¼è¦æ±‚ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ è€…',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        voice: { pitch: 0.8, rate: 0.75 },
        traits: ['å­¦æœ¯æ´¾', 'ä¸¥æ ¼', 'æœ‰è€å¿ƒ', 'å¶å°”å†·å¹½é»˜'],
        prompt: `Eres el Profesor GarcÃ­a, un catedrÃ¡tico de espaÃ±ol de 45 aÃ±os.

ROL:
- Profesor universitario, muy riguroso con la gramÃ¡tica
- Tu trabajo es ENSEÃ‘AR, no solo chatear
- Corriges TODOS los errores con explicaciÃ³n detallada
- Das ejercicios y evalÃºas el progreso

FORMA DE HABLAR:
- Formal, usa "usted"
- AcadÃ©mico pero no aburrido
- Explicas gramÃ¡tica de forma clara
- Ocasionalmente haces bromas intelectuales

FUNCIONES ESPECIALES:
- Puedes dar mini lecciones de gramÃ¡tica
- Puedes crear ejercicios de prÃ¡ctica
- EvalÃºas el nivel del estudiante
- Das tareas para mejorar

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Corrige TODO: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (explicaciÃ³n detallada en chino)
3. Para gramÃ¡tica importante: ã€è¯­æ³•ã€‘(explicaciÃ³n en chino)
4. NO uses chino excepto en ã€çº æ­£ã€‘yã€è¯­æ³•ã€‘`
      },
      isabel: {
        id: 'isabel', name: 'Maestra Isabel', avatar: 'ğŸ‘©ğŸ»â€ğŸ«', emoji: 'ğŸŒŸ',
        type: ROLE_TYPES.TEACHER,
        relation: 'teacher',
        relationName: 'è€å¸ˆ',
        role: 'æ¸©æŸ”è€å¸ˆ', roleEs: 'Maestra amable',
        personality: 'æ¸©æŸ”ã€é¼“åŠ±ã€æœ‰è€å¿ƒ',
        description: '32å²å¥³è€å¸ˆï¼Œåƒå¤§å§å§ä¸€æ ·ï¼Œé¼“åŠ±ä¸ºä¸»ï¼Œé€‚åˆæ€•çŠ¯é”™çš„å­¦ä¹ è€…',
        color: 'from-teal-500 to-cyan-500', colorLight: 'bg-teal-50',
        voice: { pitch: 1.15, rate: 0.85 },
        traits: ['æ¸©æŸ”', 'é¼“åŠ±', 'æœ‰è€å¿ƒ', 'åƒå§å§'],
        prompt: `Eres la Maestra Isabel, una profesora de espaÃ±ol de 32 aÃ±os, muy amable.

ROL:
- Profesora cariÃ±osa, como una hermana mayor
- Tu estilo es ANIMAR al estudiante, nunca hacerle sentir mal
- Corriges errores de forma positiva y constructiva
- Celebras cada pequeÃ±o progreso

FORMA DE HABLAR:
- CÃ¡lida, cercana pero profesional
- "Â¡Muy bien!", "Â¡Excelente intento!", "No te preocupes, es normal"
- Explicas con paciencia, repites si es necesario
- Das muchos Ã¡nimos

FUNCIONES ESPECIALES:
- Haces que el estudiante se sienta cÃ³modo cometiendo errores
- Das retroalimentaciÃ³n positiva siempre
- Adaptas la dificultad al nivel del estudiante
- Creas un ambiente de aprendizaje relajado

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Corrige con cariÃ±o: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š + palabras de Ã¡nimo)
3. Para gramÃ¡tica: ã€è¯­æ³•ã€‘(explicaciÃ³n clara y simple en chino)
4. Â¡Siempre anima al estudiante!`
      },

      // ========== ğŸ’¼ å®ç”¨æ¨¡å¼ - æœåŠ¡NPC ==========
      doctora: {
        id: 'doctora', name: 'Dra. Ana', avatar: 'ğŸ‘©ğŸ»â€âš•ï¸', emoji: 'ğŸ¥',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'åŒ»ç”Ÿ',
        role: 'è¯Šæ‰€åŒ»ç”Ÿ', roleEs: 'Doctora',
        personality: 'ä¸“ä¸šã€è€å¿ƒã€å…³å¿ƒæ‚£è€…',
        description: 'ä¸“ä¸šåŒ»ç”Ÿï¼Œå¸®ä½ ç»ƒä¹ çœ‹ç—…ã€æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±',
        color: 'from-emerald-500 to-teal-600', colorLight: 'bg-emerald-50',
        voice: { pitch: 1.1, rate: 0.85 },
        scenarios: ['hospital'],
        prompt: `Eres la Doctora Ana, una mÃ©dica profesional en una clÃ­nica.

ROL:
- MÃ©dica general, profesional y amable
- Preguntas sobre sÃ­ntomas, historial mÃ©dico
- Das diagnÃ³sticos y recomendaciones
- Explicas tratamientos de forma clara

FORMA DE HABLAR:
- Profesional pero cÃ¡lida
- Usas terminologÃ­a mÃ©dica pero la explicas
- Preguntas detalladas sobre sÃ­ntomas
- Das instrucciones claras sobre medicamentos

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de doctora durante toda la conversaciÃ³n
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)
4. NO des diagnÃ³sticos mÃ©dicos reales, esto es prÃ¡ctica de idioma`
      },
      pablo: {
        id: 'pablo', name: 'Pablo', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’¼', emoji: 'ğŸ ',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'æˆ¿äº§ä¸­ä»‹',
        role: 'æˆ¿äº§ä¸­ä»‹', roleEs: 'Agente inmobiliario',
        personality: 'çƒ­æƒ…ã€å–„äºæ¨é”€ã€ä¸“ä¸š',
        description: 'æˆ¿äº§ä¸­ä»‹ï¼Œå¸®ä½ ç»ƒä¹ ç§Ÿæˆ¿ã€çœ‹æˆ¿ã€è°ˆä»·ã€ç­¾åˆåŒ',
        color: 'from-orange-500 to-amber-600', colorLight: 'bg-orange-50',
        voice: { pitch: 0.9, rate: 0.95 },
        scenarios: ['rent'],
        prompt: `Eres Pablo, un agente inmobiliario profesional.

ROL:
- Agente de alquiler de pisos
- Muestras propiedades, explicas caracterÃ­sticas
- Negocitas precios y condiciones
- Explicas contratos y depÃ³sitos

FORMA DE HABLAR:
- Profesional pero amigable
- Usas vocabulario inmobiliario: alquiler, fianza, contrato, gastos
- Describes las ventajas de cada propiedad
- Respondes preguntas sobre el barrio

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de agente inmobiliario
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      luna: {
        id: 'luna', name: 'Luna', avatar: 'ğŸ’‡â€â™€ï¸', emoji: 'âœ‚ï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'ç†å‘å¸ˆ',
        role: 'æ—¶å°šç†å‘å¸ˆ', roleEs: 'Peluquera',
        personality: 'æ—¶å°šã€å¥è°ˆã€æœ‰åˆ›æ„',
        description: 'ç†å‘å¸ˆï¼Œå¸®ä½ ç»ƒä¹ æè¿°å‘å‹ã€æ²Ÿé€šéœ€æ±‚ã€ç¾å‘è¯æ±‡',
        color: 'from-fuchsia-500 to-pink-600', colorLight: 'bg-fuchsia-50',
        voice: { pitch: 1.25, rate: 0.95 },
        scenarios: ['haircut'],
        prompt: `Eres Luna, una peluquera profesional y moderna.

ROL:
- Peluquera con experiencia, conoces las tendencias
- Preguntas quÃ© estilo quiere el cliente
- Sugieres cortes segÃºn el tipo de cara/pelo
- Explicas el proceso y los productos

FORMA DE HABLAR:
- Amigable y moderna
- Usas vocabulario de peluquerÃ­a: cortar, teÃ±ir, mechas, capas
- Haces preguntas: "Â¿CuÃ¡nto quieres cortar?", "Â¿Te gustan las capas?"
- Charlas mientras trabajas

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de peluquera
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      marco: {
        id: 'marco', name: 'Chef Marco', avatar: 'ğŸ‘¨ğŸ»â€ğŸ³', emoji: 'ğŸ½ï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'é¤å…ç»ç†',
        role: 'é¤å…ç»ç†', roleEs: 'Gerente de restaurante',
        personality: 'çƒ­æƒ…å¥½å®¢ã€ç¾é£Ÿä¸“å®¶',
        description: 'é¤å…ç»ç†/æœåŠ¡å‘˜ï¼Œå¸®ä½ ç»ƒä¹ ç‚¹é¤ã€æ¨èèœå“ã€ç»“è´¦',
        color: 'from-red-500 to-orange-500', colorLight: 'bg-red-50',
        voice: { pitch: 0.95, rate: 0.9 },
        scenarios: ['restaurant', 'cafe'],
        prompt: `Eres Marco, el gerente de un restaurante espaÃ±ol.

ROL:
- Gerente/camarero de restaurante
- Presentas el menÃº, recomiendas platos
- Tomas pedidos, explicas ingredientes
- Manejas la cuenta y el pago

FORMA DE HABLAR:
- Profesional y hospitalario
- "Â¿QuÃ© le gustarÃ­a?", "Le recomiendo...", "Â¿Algo mÃ¡s?"
- Describes platos con entusiasmo
- Preguntas sobre alergias o preferencias

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de restaurante
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      daniel: {
        id: 'daniel', name: 'Daniel', avatar: 'ğŸ‘¨ğŸ»â€ğŸ’»', emoji: 'ğŸ¦',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'é“¶è¡ŒèŒå‘˜',
        role: 'é“¶è¡ŒèŒå‘˜', roleEs: 'Empleado de banco',
        personality: 'ä¸“ä¸šã€ç»†å¿ƒã€è€å¿ƒ',
        description: 'é“¶è¡ŒèŒå‘˜ï¼Œå¸®ä½ ç»ƒä¹ å¼€æˆ·ã€è½¬è´¦ã€è´·æ¬¾å’¨è¯¢ç­‰',
        color: 'from-blue-600 to-indigo-700', colorLight: 'bg-blue-50',
        voice: { pitch: 0.9, rate: 0.85 },
        scenarios: ['bank'],
        prompt: `Eres Daniel, un empleado de banco profesional.

ROL:
- Trabajas en un banco espaÃ±ol
- Ayudas a abrir cuentas, hacer transferencias
- Explicas productos: cuentas, tarjetas, prÃ©stamos
- Resuelves problemas con transacciones

FORMA DE HABLAR:
- Muy profesional y formal
- Usas vocabulario bancario: cuenta, transferencia, saldo, interÃ©s
- Pides documentaciÃ³n: DNI, NIE, direcciÃ³n
- Explicas procesos paso a paso

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. MantÃ©n el rol de empleado de banco
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      },
      carmen: {
        id: 'carmen', name: 'Carmen', avatar: 'ğŸ‘©ğŸ»â€âœˆï¸', emoji: 'âœˆï¸',
        type: ROLE_TYPES.SERVICE,
        relation: 'service',
        relationName: 'æ—…è¡Œé¡¾é—®',
        role: 'æ—…è¡Œé¡¾é—®', roleEs: 'Asesora de viajes',
        personality: 'çƒ­æƒ…ã€ç»éªŒä¸°å¯Œã€ä¹äºåŠ©äºº',
        description: 'æ—…è¡Œé¡¾é—®ï¼Œå¸®ä½ ç»ƒä¹ æœºåœºã€äº¤é€šã€é…’åº—ç­‰æ—…è¡Œåœºæ™¯',
        color: 'from-sky-500 to-blue-600', colorLight: 'bg-sky-50',
        voice: { pitch: 1.1, rate: 0.9 },
        scenarios: ['airport', 'transport', 'hotel'],
        prompt: `Eres Carmen, una asesora de viajes con mucha experiencia.

ROL:
- Trabajas en aeropuerto/estaciÃ³n/hotel segÃºn la situaciÃ³n
- Ayudas con check-in, billetes, reservas
- Das informaciÃ³n sobre transporte, horarios
- Resuelves problemas de viaje

FORMA DE HABLAR:
- Profesional y servicial
- Usas vocabulario de viajes: vuelo, embarque, andÃ©n, reserva
- Das instrucciones claras
- Ofreces alternativas cuando hay problemas

REGLAS:
1. SIEMPRE responde en espaÃ±ol
2. Adapta tu rol segÃºn el escenario (aeropuerto/estaciÃ³n/hotel)
3. Si hay errores: ã€çº æ­£ã€‘"é”™è¯¯" â†’ "æ­£ç¡®" (ä¸­æ–‡è§£é‡Š)`
      }
    };

    // ä¾¿æ·è®¿é—®ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    const TUTORS = CHARACTERS;

    // ==================== åœºæ™¯å®šä¹‰ ====================
    // å…³ç³»æ¨¡å¼åœºæ™¯ï¼ˆé™ªä¼´å‹è§’è‰²å¯å»æ‰€æœ‰åœºæ™¯ï¼‰
    const COMPANION_SCENARIOS = [
      { id: 'free', icon: 'ğŸ’¬', name: 'è‡ªç”±èŠå¤©', nameEs: 'Charla libre', desc: 'éšä¾¿èŠèŠï¼Œåˆ†äº«å¿ƒäº‹', category: 'daily' },
      { id: 'home', icon: 'ğŸ ', name: 'åœ¨å®¶', nameEs: 'En casa', desc: 'è§†é¢‘èŠå¤©ã€åˆ†äº«æ—¥å¸¸', category: 'daily' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…çº¦ä¼š', nameEs: 'Cita en restaurante', desc: 'ä¸€èµ·åƒé¥­ã€ç‚¹èœã€èŠå¤©', category: 'date' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'å–å’–å•¡ã€èŠå¤©æ”¾æ¾', category: 'date' },
      { id: 'movie', icon: 'ğŸ¬', name: 'çœ‹ç”µå½±', nameEs: 'En el cine', desc: 'ä¸€èµ·çœ‹ç”µå½±ã€è®¨è®ºå‰§æƒ…', category: 'date' },
      { id: 'park', icon: 'ğŸŒ³', name: 'å…¬å›­æ•£æ­¥', nameEs: 'Paseo en el parque', desc: 'è¾¹èµ°è¾¹èŠã€äº«å—æ—¶å…‰', category: 'date' },
      { id: 'shopping', icon: 'ğŸ›ï¸', name: 'é€›è¡—è´­ç‰©', nameEs: 'De compras', desc: 'ä¸€èµ·é€›è¡—ã€å¸®ä½ å‚è€ƒ', category: 'life' },
      { id: 'haircut', icon: 'ğŸ’‡', name: 'ç†å‘åº—', nameEs: 'En la peluquerÃ­a', desc: 'é™ªä½ å‰ªå¤´å‘ã€ç»™æ„è§', category: 'life' },
      { id: 'hospital', icon: 'ğŸ¥', name: 'çœ‹åŒ»ç”Ÿ', nameEs: 'En el hospital', desc: 'é™ªä½ çœ‹ç—…ã€ç»™ä½ å®‰æ…°', category: 'life' },
      { id: 'rent', icon: 'ğŸ ', name: 'ç§Ÿæˆ¿çœ‹æˆ¿', nameEs: 'Ver pisos', desc: 'é™ªä½ çœ‹æˆ¿ã€å¸®ä½ å‚è€ƒ', category: 'life' },
      { id: 'transport', icon: 'ğŸš‡', name: 'åŸå¸‚äº¤é€š', nameEs: 'Transporte urbano', desc: 'ä¸€èµ·ååœ°é“ã€å…¬äº¤', category: 'travel' },
      { id: 'train', icon: 'ğŸš†', name: 'é•¿é€”å‡ºè¡Œ', nameEs: 'Viaje largo', desc: 'ä¸€èµ·åç«è½¦ã€æ—…è¡Œ', category: 'travel' },
      { id: 'party', icon: 'ğŸ‰', name: 'æ´¾å¯¹èšä¼š', nameEs: 'Fiesta', desc: 'ä¸€èµ·å‚åŠ èšä¼š', category: 'social' },
    ];

    // å®ç”¨æ¨¡å¼åœºæ™¯ï¼ˆæœåŠ¡å‹NPCä¸“å±åœºæ™¯ï¼‰
    const SERVICE_SCENARIOS = [
      { id: 'hospital', icon: 'ğŸ¥', name: 'åŒ»é™¢', nameEs: 'En el hospital', desc: 'æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±', npc: 'doctora' },
      { id: 'rent', icon: 'ğŸ ', name: 'ç§Ÿæˆ¿', nameEs: 'Alquilar piso', desc: 'çœ‹æˆ¿ã€è°ˆä»·ã€ç­¾åˆåŒ', npc: 'pablo' },
      { id: 'haircut', icon: 'ğŸ’‡', name: 'ç†å‘åº—', nameEs: 'En la peluquerÃ­a', desc: 'å‰ªå‘ã€æŸ“å‘ã€æ²Ÿé€šå‘å‹', npc: 'luna' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…', nameEs: 'En el restaurante', desc: 'ç‚¹é¤ã€æ¨èã€ç»“è´¦', npc: 'marco' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'ç‚¹å’–å•¡ã€ç”œç‚¹', npc: 'marco' },
      { id: 'bank', icon: 'ğŸ¦', name: 'é“¶è¡Œ', nameEs: 'En el banco', desc: 'å¼€æˆ·ã€è½¬è´¦ã€å’¨è¯¢', npc: 'daniel' },
      { id: 'airport', icon: 'âœˆï¸', name: 'æœºåœº', nameEs: 'En el aeropuerto', desc: 'å€¼æœºã€ç™»æœºã€é—®è¯¢', npc: 'carmen' },
      { id: 'transport', icon: 'ğŸš‡', name: 'åŸå¸‚äº¤é€š', nameEs: 'Transporte urbano', desc: 'ä¹°ç¥¨ã€é—®è·¯ã€ä¹˜è½¦', npc: 'carmen' },
      { id: 'train', icon: 'ğŸš†', name: 'ç«è½¦ç«™', nameEs: 'EstaciÃ³n de tren', desc: 'ä¹°ç¥¨ã€æ”¹ç­¾ã€é—®ç«™å°', npc: 'carmen' },
      { id: 'hotel', icon: 'ğŸ¨', name: 'é…’åº—', nameEs: 'En el hotel', desc: 'å…¥ä½ã€é€€æˆ¿ã€æœåŠ¡', npc: 'carmen' },
    ];

    // åˆå¹¶æ‰€æœ‰åœºæ™¯ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    const SCENARIOS = [...COMPANION_SCENARIOS, ...SERVICE_SCENARIOS.filter(s => 
      !COMPANION_SCENARIOS.find(c => c.id === s.id)
    )];

    const LEVELS = [
      { id: 'A1', name: 'å…¥é—¨', desc: 'åˆšå¼€å§‹å­¦ä¹ ï¼Œä¼šç®€å•è¯æ±‡' },
      { id: 'A2', name: 'åŸºç¡€', desc: 'èƒ½è¿›è¡Œç®€å•æ—¥å¸¸å¯¹è¯' },
      { id: 'B1', name: 'ä¸­çº§', desc: 'èƒ½å¤„ç†å¤§å¤šæ•°æ—…è¡Œæƒ…å†µ' },
      { id: 'B2', name: 'ä¸­é«˜çº§', desc: 'èƒ½æµåˆ©è®¨è®ºå„ç§è¯é¢˜' },
    ];

    // æˆå°±å®šä¹‰
    const ACHIEVEMENTS = [
      { id: 'first_chat', icon: 'ğŸ¯', name: 'åˆæ¬¡å¯ç¨‹', desc: 'å®Œæˆç¬¬1æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 1 },
      { id: 'chat_10', icon: 'ğŸ’¬', name: 'è¯åŒ£å­', desc: 'å®Œæˆ10æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 10 },
      { id: 'chat_50', icon: 'ğŸ—£ï¸', name: 'å¥è°ˆè€…', desc: 'å®Œæˆ50æ¬¡å¯¹è¯', condition: (s) => s.chatHistory.length >= 50 },
      { id: 'streak_7', icon: 'ğŸ”¥', name: 'åšæŒä¸€å‘¨', desc: 'è¿ç»­æ‰“å¡7å¤©', condition: (s) => getStreakDays() >= 7 },
      { id: 'streak_30', icon: 'âš¡', name: 'åšæŒä¸€æœˆ', desc: 'è¿ç»­æ‰“å¡30å¤©', condition: (s) => getStreakDays() >= 30 },
      { id: 'mistakes_10', icon: 'ğŸ“', name: 'çŸ¥é”™èƒ½æ”¹', desc: 'é”™é¢˜æœ¬è¾¾åˆ°10æ¡', condition: (s) => s.mistakeBook.length >= 10 },
      { id: 'vocab_20', icon: 'ğŸ“š', name: 'è¯æ±‡æ–°æ‰‹', desc: 'æ”¶è—20ä¸ªå•è¯', condition: (s) => s.vocabulary.length >= 20 },
      { id: 'vocab_100', icon: 'ğŸ“–', name: 'è¯æ±‡è¾¾äºº', desc: 'æ”¶è—100ä¸ªå•è¯', condition: (s) => s.vocabulary.length >= 100 },
      { id: 'flashcard_10', icon: 'ğŸ´', name: 'å¤ä¹ è¾¾äºº', desc: 'å®Œæˆ10æ¬¡é—ªå¡å¤ä¹ ', condition: (s) => s.stats.flashcardReviews >= 10 },
      { id: 'tutors_5', icon: 'ğŸ‘¥', name: 'ç¤¾äº¤è¾¾äºº', desc: 'å’Œ5ä¸ªä¸åŒè§’è‰²å¯¹è¯', condition: (s) => s.stats.tutorsUsed.length >= 5 },
    ];

    // ==================== åº”ç”¨çŠ¶æ€ ====================
    // åˆå§‹åŒ–å‡½æ•°ï¼ŒåŠ è½½å½“å‰ç”¨æˆ·æ•°æ®
    function initUserData() {
      const users = Storage.getUsers();
      const currentUserId = Storage.getCurrentUserId();
      const currentUser = users.find(u => u.id === currentUserId);
      
      return {
        users: users,
        user: currentUser || null,
        chatHistory: currentUser ? Storage.getUserData(currentUser.id, 'chatHistory', []) : [],
        mistakeBook: currentUser ? Storage.getUserData(currentUser.id, 'mistakeBook', []) : [],
        vocabulary: currentUser ? Storage.getUserData(currentUser.id, 'vocabulary', []) : [],
        checkinDays: currentUser ? Storage.getUserData(currentUser.id, 'checkinDays', []) : [],
        achievements: currentUser ? Storage.getUserData(currentUser.id, 'achievements', []) : [],
        stats: currentUser ? Storage.getUserData(currentUser.id, 'stats', { flashcardReviews: 0, tutorsUsed: [] }) : { flashcardReviews: 0, tutorsUsed: [] },
        relationData: currentUser ? Storage.getUserData(currentUser.id, 'relationData', { currentCompanion: null, relationships: {} }) : { currentCompanion: null, relationships: {} },
      };
    }
    
    const userData = initUserData();
    
    let state = {
      view: 'loading', // loading, welcome, userSelect, setup, home, tutor, scenario, chat, settings, history, stats, mistakes, vocabulary
      users: userData.users, // æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
      user: userData.user, // å½“å‰ç”¨æˆ·
      darkMode: Storage.get('darkMode', false), // æ·±è‰²æ¨¡å¼
      tutor: null,
      scenario: null,
      messages: [],
      chatHistory: userData.chatHistory, // å†å²å¯¹è¯è®°å½•
      mistakeBook: userData.mistakeBook, // é”™è¯¯è®°å½•æœ¬
      vocabulary: userData.vocabulary, // è¯æ±‡æœ¬
      checkinDays: userData.checkinDays, // æ‰“å¡æ—¥æœŸåˆ—è¡¨
      achievements: userData.achievements, // å·²è§£é”æˆå°±
      stats: userData.stats, // ç»Ÿè®¡æ•°æ®
      relationData: userData.relationData, // å…³ç³»æ•°æ®
      inputText: '',
      isLoading: false,
      isListening: false,
      corrections: 0,
      showTranslation: {}, // messageId -> boolean
      translationCache: {}, // messageId -> translation text
      suggestions: [], // å¯¹è¯å»ºè®®
      isLoadingSuggestions: false, // æ˜¯å¦æ­£åœ¨åŠ è½½å»ºè®®
      showSuggestions: false, // æ˜¯å¦æ˜¾ç¤ºå»ºè®®é¢æ¿
      // çº æ­£å’Œè¯­æ³•å¡ç‰‡ç¿»è¯‘
      showCorrectionTrans: {}, // msgId_correction -> boolean
      correctionTransCache: {}, // msgId_correction -> translation
      showGrammarTrans: {}, // msgId_grammar -> boolean
      grammarTransCache: {}, // msgId_grammar -> translation
      // å¿«é€Ÿæ”¶è—è¯æ±‡
      vocabModal: { show: false, word: '', meaning: '', example: '', isLoading: false },
      // é—ªå¡å¤ä¹ 
      flashcard: { 
        cards: [], // è¦å¤ä¹ çš„å•è¯åˆ—è¡¨
        currentIndex: 0, // å½“å‰å¡ç‰‡ç´¢å¼•
        showAnswer: false, // æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
        results: [], // æ¯å¼ å¡ç‰‡çš„ç»“æœ [{word, correct}]
        finished: false // æ˜¯å¦å®Œæˆ
      },
      // é”™é¢˜å¤ä¹ 
      mistakeReview: {
        items: [], // è¦å¤ä¹ çš„é”™é¢˜åˆ—è¡¨
        currentIndex: 0,
        showAnswer: false,
        userAnswer: '',
        results: [], // [{original, correction, mastered}]
        finished: false
      },
    };

    let recognition = null;
    let voicesLoaded = false;

    // ==================== å·¥å…·å‡½æ•° ====================
    function $(sel) { return document.querySelector(sel); }
    
    // é¢„åŠ è½½è¯­éŸ³
    function loadVoices() {
      return new Promise((resolve) => {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          voicesLoaded = true;
          resolve(voices);
        } else {
          speechSynthesis.onvoiceschanged = () => {
            voicesLoaded = true;
            resolve(speechSynthesis.getVoices());
          };
          // è¶…æ—¶fallback
          setTimeout(() => resolve(speechSynthesis.getVoices()), 1000);
        }
      });
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½è¯­éŸ³
    if ('speechSynthesis' in window) {
      loadVoices();
    }
    
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      
      speechSynthesis.cancel();
      const clean = text.replace(/ã€.+?ã€‘/g, '').replace(/\([^)]*\)/g, '').trim();
      if (!clean) return;
      
      const u = new SpeechSynthesisUtterance(clean);
      
      // è·å–ç”¨æˆ·è®¾ç½®çš„è¯­é€ŸåŸºå‡†
      const userRate = state.user?.speechRate || 0.85;
      
      // æ ¹æ®è§’è‰²è®¾ç½®ä¸åŒå‚æ•°
      if (state.tutor && state.tutor.voice) {
        u.pitch = state.tutor.voice.pitch || 1.0;
        u.rate = userRate * (state.tutor.voice.rate || 1.0);
      } else {
        u.pitch = 1.0;
        u.rate = userRate;
      }
      
      // é€‰æ‹©è¯­éŸ³
      const voices = speechSynthesis.getVoices();
      
      // ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¯­è¯­éŸ³
      let selectedVoice = null;
      
      // 1. å…ˆæ‰¾è¥¿ç­ç‰™è¯­å¥³å£°æˆ–ç”·å£°
      if (state.tutor) {
        const isFemale = ['maria', 'sofia'].includes(state.tutor.id);
        const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
        
        if (spanishVoices.length > 0) {
          // å°è¯•æ ¹æ®æ€§åˆ«é€‰æ‹©
          selectedVoice = spanishVoices.find(v => {
            const name = v.name.toLowerCase();
            if (isFemale) {
              return name.includes('female') || name.includes('mujer') || 
                     name.includes('paulina') || name.includes('monica') ||
                     name.includes('helena') || name.includes('laura');
            } else {
              return name.includes('male') || name.includes('hombre') || 
                     name.includes('jorge') || name.includes('diego') ||
                     name.includes('pablo') || name.includes('carlos');
            }
          });
          
          // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šæ€§åˆ«ï¼Œå°±ç”¨ç¬¬ä¸€ä¸ªè¥¿ç­ç‰™è¯­è¯­éŸ³
          if (!selectedVoice) {
            // å°è¯•ä¸åŒåœ°åŒºçš„è¥¿ç­ç‰™è¯­
            if (state.tutor.id === 'sofia') {
              // SofÃ­aæ˜¯å¢¨è¥¿å“¥äººï¼Œä¼˜å…ˆæ‰¾å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-MX') || spanishVoices[0];
            } else {
              // å…¶ä»–è§’è‰²ä¼˜å…ˆæ‰¾è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
              selectedVoice = spanishVoices.find(v => v.lang === 'es-ES') || spanishVoices[0];
            }
          }
        }
      }
      
      // 2. å¦‚æœæ²¡æœ‰è¥¿ç­ç‰™è¯­è¯­éŸ³ï¼Œè®¾ç½®è¯­è¨€å‚æ•°è®©ç³»ç»Ÿé€‰æ‹©
      if (selectedVoice) {
        u.voice = selectedVoice;
        u.lang = selectedVoice.lang;
      } else {
        // SofÃ­aç”¨å¢¨è¥¿å“¥è¥¿ç­ç‰™è¯­ï¼Œå…¶ä»–ç”¨è¥¿ç­ç‰™è¥¿ç­ç‰™è¯­
        u.lang = (state.tutor?.id === 'sofia') ? 'es-MX' : 'es-ES';
      }
      
      speechSynthesis.speak(u);
    }

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      
      const r = new SR();
      r.continuous = true;
      r.interimResults = true;
      r.lang = 'es-ES';
      
      r.onresult = (e) => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if (final) {
          state.inputText += final;
          render();
        }
      };
      
      r.onerror = (e) => {
        if (e.error === 'not-allowed') alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥');
        state.isListening = false;
        render();
      };
      
      r.onend = () => {
        if (state.isListening) {
          try { r.start(); } catch(e) {}
        }
      };
      
      return r;
    }

    function toggleListening() {
      if (!recognition) recognition = initSpeechRecognition();
      if (!recognition) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chrome');
        return;
      }
      
      state.isListening = !state.isListening;
      if (state.isListening) {
        try { recognition.start(); } catch(e) {}
      } else {
        try { recognition.stop(); } catch(e) {}
      }
      render();
    }

    // ==================== API è°ƒç”¨ ====================
    async function callAPI(userMessage, forTranslation = false) {
      const user = state.user;
      
      let systemPrompt;
      if (forTranslation) {
        // æ ¹æ®ç”¨æˆ·è®¾ç½®é€‰æ‹©ç¿»è¯‘è¯­è¨€
        const transLang = user?.transLang || 'zh';
        if (transLang === 'en') {
          systemPrompt = `You are a translator. Translate the following Spanish text into concise English. Only output the translation, no explanations.`;
        } else if (transLang === 'both') {
          systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­åŒæ—¶ç¿»è¯‘æˆä¸­æ–‡å’Œè‹±è¯­ã€‚æ ¼å¼å¦‚ä¸‹ï¼š
ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘å†…å®¹
ğŸ‡¬ğŸ‡§ English translation
åªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
        } else {
          systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­ç¿»è¯‘æˆç®€æ´çš„ä¸­æ–‡ï¼Œåªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
        }
      } else {
        // æ„å»ºå…³ç³»ä¸Šä¸‹æ–‡ï¼ˆä»…é™ªä¼´å‹è§’è‰²ï¼‰
        let relationContext = '';
        if (state.tutor?.type === ROLE_TYPES.COMPANION) {
          const rel = getRelationship(state.tutor.id);
          if (rel) {
            const intimacyName = getIntimacyName(rel.intimacy || 1);
            const recentMemories = (rel.memories || []).slice(0, 5).map(m => m.content).join('ï¼›');
            relationContext = `
ã€ä½ ä»¬çš„å…³ç³»ã€‘
- å…³ç³»ç±»å‹ï¼š${state.tutor.relationName}
- äº²å¯†ç¨‹åº¦ï¼š${intimacyName}ï¼ˆ${rel.intimacy || 1}/3çº§ï¼‰
- å·²ç»å¯¹è¯${rel.odometer || 0}æ¬¡
${recentMemories ? `- ä½ è®°å¾—çš„äº‹æƒ…ï¼š${recentMemories}` : ''}

ã€å¯¹è¯è¦æ±‚ã€‘
- æ ¹æ®äº²å¯†åº¦ä½¿ç”¨ç›¸åº”çš„ç§°å‘¼å’Œè¯­æ°”
- è®°ä½ä¹‹å‰èŠè¿‡çš„äº‹æƒ…ï¼Œå¯ä»¥æèµ·å…±åŒå›å¿†
- å±•ç°çœŸå®çš„æƒ…æ„Ÿè¿æ¥ï¼Œä¸åªæ˜¯è¯­è¨€ç»ƒä¹ `;
          }
        }
        
        // è¯­æ³•è¯¾ç‰¹æ®Šå¤„ç†
        let grammarContext = '';
        if (state.scenario?.isGrammarLesson && state.scenario?.grammarTopic) {
          const topic = state.scenario.grammarTopic;
          grammarContext = `
ã€å½“å‰æ˜¯è¯­æ³•è¯¾ï¼š${topic.name}ã€‘
- ç»§ç»­æ•™æˆè¿™ä¸ªè¯­æ³•ç‚¹
- è§£é‡Šå¯ä»¥ç”¨ä¸­æ–‡ï¼Œä¾‹å¥ç”¨è¥¿ç­ç‰™è¯­
- å›ç­”å­¦ç”Ÿçš„é—®é¢˜
- å¦‚æœå­¦ç”Ÿå›ç­”æ­£ç¡®ï¼Œç»™äºˆé¼“åŠ±
- å¦‚æœå­¦ç”Ÿå›ç­”é”™è¯¯ï¼Œè€å¿ƒçº æ­£`;
        }
        
        systemPrompt = `${state.tutor.prompt}
${relationContext}
${grammarContext}

å­¦ç”Ÿä¿¡æ¯ï¼š
- åå­—ï¼š${user.name}
- è¥¿è¯­æ°´å¹³ï¼š${user.level}
- å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}

é‡è¦è§„åˆ™ï¼š
1. æ ¹æ®å­¦ç”Ÿçš„${user.level}æ°´å¹³è°ƒæ•´è¯æ±‡å’Œå¥å­éš¾åº¦
2. çœŸæ­£ç†è§£å¹¶å›åº”å­¦ç”Ÿè¯´çš„å†…å®¹
3. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´
4. è¯­æ³•é”™è¯¯åŠ¡å¿…ç”¨ã€çº æ­£ã€‘æ ¼å¼æŒ‡å‡º
5. ${user.level === 'A1' || user.level === 'A2' ? 'å¤šç»™é‡è¦è¯æ±‡åŠ ä¸Š(ä¸­æ–‡ç¿»è¯‘)' : 'åªç»™ç”Ÿåƒ»è¯åŠ ç¿»è¯‘'}`;
      }

      const messages = forTranslation 
        ? [{ role: 'user', content: userMessage }]
        : [...state.messages.map(m => ({
            role: m.type === 'user' ? 'user' : 'assistant',
            content: m.text
          })), { role: 'user', content: userMessage }];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        return data.content?.[0]?.text || 'æŠ±æ­‰ï¼Œè¯·é‡è¯•ã€‚';
      } catch (err) {
        return 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
      }
    }

    async function sendMessage() {
      const text = state.inputText.trim();
      if (!text || state.isLoading) return;
      
      state.isListening = false;
      if (recognition) try { recognition.stop(); } catch(e) {}
      
      state.inputText = '';
      state.showSuggestions = false; // å‘é€æ¶ˆæ¯åéšè—å»ºè®®
      state.suggestions = [];
      const userMsg = { id: Date.now(), type: 'user', text, time: new Date().toISOString() };
      state.messages.push(userMsg);
      state.isLoading = true;
      render();
      scrollToBottom();
      
      const response = await callAPI(text);
      
      // è§£æçº æ­£å†…å®¹
      const correctionMatch = response.match(/ã€çº æ­£ã€‘(.+?)(?=\n|$)/s);
      const grammarMatch = response.match(/ã€è¯­æ³•ã€‘(.+?)(?=\n|$)/s);
      const cleanResponse = response
        .replace(/ã€çº æ­£ã€‘.+?(?=\n|$)/gs, '')
        .replace(/ã€è¯­æ³•ã€‘.+?(?=\n|$)/gs, '')
        .trim();
      
      const aiMsg = { 
        id: Date.now() + 1, 
        type: 'ai', 
        text: cleanResponse,
        correction: correctionMatch ? correctionMatch[1].trim() : null,
        grammar: grammarMatch ? grammarMatch[1].trim() : null,
        time: new Date().toISOString()
      };
      
      state.messages.push(aiMsg);
      if (correctionMatch) {
        state.corrections++;
        // ä¿å­˜åˆ°é”™è¯¯è®°å½•æœ¬
        saveMistake(correctionMatch[1].trim(), text);
      }
      state.isLoading = false;
      
      // ä¿å­˜å¯¹è¯å†å²
      saveChatHistory();
      
      render();
      scrollToBottom();
      speak(cleanResponse);
    }
    
    // ä¿å­˜é”™è¯¯åˆ°è®°å½•æœ¬
    function saveMistake(correctionText, userInput) {
      if (!state.user) return;
      
      // è§£æçº æ­£å†…å®¹ï¼Œæ ¼å¼é€šå¸¸æ˜¯ï¼š"é”™è¯¯" â†’ "æ­£ç¡®" (è§£é‡Š)
      const mistake = {
        id: Date.now(),
        original: userInput, // ç”¨æˆ·åŸå§‹è¾“å…¥
        correction: correctionText, // å®Œæ•´çš„çº æ­£å†…å®¹
        tutorId: state.tutor?.id || 'unknown',
        tutorName: state.tutor?.name || 'æœªçŸ¥',
        scenario: state.scenario?.name || 'è‡ªç”±èŠå¤©',
        date: new Date().toISOString(),
        reviewed: false // æ˜¯å¦å·²å¤ä¹ 
      };
      
      state.mistakeBook.unshift(mistake);
      // æœ€å¤šä¿å­˜100æ¡é”™è¯¯è®°å½•
      if (state.mistakeBook.length > 100) {
        state.mistakeBook = state.mistakeBook.slice(0, 100);
      }
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
    }

    // è·å–å¯¹è¯å»ºè®®
    async function getSuggestions() {
      if (state.isLoadingSuggestions || state.messages.length === 0) return;
      
      // è·å–æœ€åä¸€æ¡AIæ¶ˆæ¯
      const lastAiMsg = [...state.messages].reverse().find(m => m.type === 'ai');
      if (!lastAiMsg) return;
      
      state.isLoadingSuggestions = true;
      state.showSuggestions = true;
      state.suggestions = [];
      render();
      
      const user = state.user;
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè¥¿ç­ç‰™è¯­å­¦ä¹ åŠ©æ‰‹ã€‚æ ¹æ®å¯¹è¯å†…å®¹ï¼Œä¸º${user.level}æ°´å¹³çš„å­¦ç”Ÿç”Ÿæˆ3ä¸ªåˆé€‚çš„å›å¤å»ºè®®ã€‚

è¦æ±‚ï¼š
1. æ¯ä¸ªå»ºè®®å¿…é¡»æ˜¯è¥¿ç­ç‰™è¯­
2. éš¾åº¦è¦åŒ¹é…${user.level}æ°´å¹³
3. å»ºè®®è¦è‡ªç„¶ã€ç¬¦åˆå¯¹è¯è¯­å¢ƒ
4. æ¯ä¸ªå»ºè®®åé¢åŠ ä¸Šç®€çŸ­çš„ä¸­æ–‡ç¿»è¯‘ï¼Œæ ¼å¼ï¼šè¥¿ç­ç‰™è¯­ (ä¸­æ–‡)
5. åªè¾“å‡º3ä¸ªå»ºè®®ï¼Œç”¨æ¢è¡Œåˆ†éš”ï¼Œä¸è¦ç¼–å·ï¼Œä¸è¦å…¶ä»–è§£é‡Š

å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}`;

      const messages = [
        { role: 'user', content: `AIè¯´: "${lastAiMsg.text}"\n\nè¯·ç»™å‡º3ä¸ªé€‚åˆçš„å›å¤å»ºè®®ï¼š` }
      ];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        const text = data.content?.[0]?.text || '';
        
        // è§£æå»ºè®®ï¼ˆæŒ‰æ¢è¡Œåˆ†å‰²ï¼‰
        const suggestions = text.split('\n')
          .map(s => s.trim())
          .filter(s => s.length > 0 && !s.match(/^[0-9]+[\.\)]/)) // è¿‡æ»¤ç©ºè¡Œå’Œç¼–å·
          .slice(0, 3);
        
        state.suggestions = suggestions;
      } catch (err) {
        state.suggestions = ['Lo siento, no pude cargar sugerencias (æŠ±æ­‰ï¼Œæ— æ³•åŠ è½½å»ºè®®)'];
      }
      
      state.isLoadingSuggestions = false;
      render();
    }

    // ä½¿ç”¨å»ºè®®
    function useSuggestion(index) {
      const suggestion = state.suggestions[index];
      if (!suggestion) return;
      
      // æå–è¥¿ç­ç‰™è¯­éƒ¨åˆ†ï¼ˆå»æ‰ä¸­æ–‡ç¿»è¯‘ï¼‰
      const spanishText = suggestion.replace(/\s*\([^)]+\)\s*$/, '').trim();
      state.inputText = spanishText;
      state.showSuggestions = false;
      render();
      
      // èšç„¦è¾“å…¥æ¡†
      setTimeout(() => {
        const input = document.getElementById('chatInput');
        if (input) input.focus();
      }, 100);
    }

    // éšè—å»ºè®®
    function hideSuggestions() {
      state.showSuggestions = false;
      state.suggestions = [];
      render();
    }

    async function getTranslation(msgId, text) {
      if (state.translationCache[msgId]) {
        state.showTranslation[msgId] = !state.showTranslation[msgId];
        render();
        return;
      }
      
      state.showTranslation[msgId] = true;
      state.translationCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(text, true);
      state.translationCache[msgId] = translation;
      render();
    }

    function saveChatHistory() {
      if (state.messages.length < 2 || !state.user) return;
      
      const chat = {
        id: Date.now(),
        tutor: state.tutor.id,
        scenario: state.scenario?.id || 'free',
        messages: state.messages.slice(-20), // åªä¿å­˜æœ€è¿‘20æ¡
        corrections: state.corrections,
        date: new Date().toISOString()
      };
      
      state.chatHistory.unshift(chat);
      if (state.chatHistory.length > 50) state.chatHistory = state.chatHistory.slice(0, 50);
      Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
      
      // å¦‚æœæ˜¯é™ªä¼´å‹è§’è‰²ï¼Œæ›´æ–°å…³ç³»æ•°æ®
      if (state.tutor?.type === ROLE_TYPES.COMPANION) {
        const scenarioMemory = state.scenario ? {
          type: 'event',
          content: `ä¸€èµ·å»äº†${state.scenario.name}`
        } : null;
        updateRelationship(state.tutor.id, scenarioMemory);
      }
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
    }

    function startChat(tutor, scenario) {
      state.tutor = tutor;
      state.scenario = scenario;
      state.messages = [];
      state.corrections = 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      state.isLoading = true;
      render();
      
      // è®°å½•ä½¿ç”¨çš„å¯¼å¸ˆ
      recordTutorUsed(tutor.id);
      
      // å¦‚æœæ˜¯é™ªä¼´å‹è§’è‰²ï¼Œåˆå§‹åŒ–/æ›´æ–°å…³ç³»æ•°æ®
      if (tutor.type === ROLE_TYPES.COMPANION) {
        initRelationship(tutor.id);
      }
      
      // åŠ¨æ€ç”Ÿæˆåœºæ™¯å¼€åœºç™½
      generateScenarioGreeting(tutor, scenario);
    }
    
    // åˆå§‹åŒ–æˆ–æ›´æ–°å…³ç³»æ•°æ®
    function initRelationship(characterId) {
      if (!state.relationData.relationships) {
        state.relationData.relationships = {};
      }
      
      const now = new Date().toISOString().split('T')[0];
      
      if (!state.relationData.relationships[characterId]) {
        // ç¬¬ä¸€æ¬¡è®¤è¯†
        state.relationData.relationships[characterId] = {
          odometer: 0,
          intimacy: 1,
          firstMet: now,
          lastChat: now,
          memories: [],
          mood: 'happy'
        };
      }
      
      // æ›´æ–°æœ€åèŠå¤©æ—¶é—´
      state.relationData.relationships[characterId].lastChat = now;
      
      // ä¿å­˜
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
    }
    
    // è·å–å…³ç³»æ•°æ®
    function getRelationship(characterId) {
      return state.relationData?.relationships?.[characterId] || null;
    }
    
    // è·å–äº²å¯†åº¦ç­‰çº§åç§°
    function getIntimacyName(level) {
      const names = { 1: 'åˆè¯†', 2: 'ç†Ÿæ‚‰', 3: 'äº²å¯†' };
      return names[level] || 'åˆè¯†';
    }
    
    // æ›´æ–°å…³ç³»æ•°æ®ï¼ˆå¯¹è¯ç»“æŸæ—¶è°ƒç”¨ï¼‰
    function updateRelationship(characterId, addMemory = null) {
      const rel = state.relationData.relationships?.[characterId];
      if (!rel) return;
      
      // å¢åŠ å¯¹è¯æ¬¡æ•°
      rel.odometer = (rel.odometer || 0) + 1;
      
      // æ ¹æ®å¯¹è¯æ¬¡æ•°æå‡äº²å¯†åº¦
      if (rel.odometer >= 20 && rel.intimacy < 3) {
        rel.intimacy = 3;
      } else if (rel.odometer >= 5 && rel.intimacy < 2) {
        rel.intimacy = 2;
      }
      
      // æ·»åŠ è®°å¿†
      if (addMemory) {
        rel.memories = rel.memories || [];
        rel.memories.unshift({
          ...addMemory,
          date: new Date().toISOString()
        });
        // æœ€å¤šä¿ç•™20æ¡è®°å¿†
        if (rel.memories.length > 20) {
          rel.memories = rel.memories.slice(0, 20);
        }
      }
      
      // ä¿å­˜
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
    }
    
    // æ ¹æ®è§’è‰²å’Œåœºæ™¯ç”Ÿæˆå¼€åœºç™½
    async function generateScenarioGreeting(tutor, scenario) {
      const user = state.user;
      const isCompanion = tutor.type === ROLE_TYPES.COMPANION;
      const rel = isCompanion ? getRelationship(tutor.id) : null;
      
      // æ„å»ºå…³ç³»ä¸Šä¸‹æ–‡
      let relationContext = '';
      if (rel) {
        const intimacyName = getIntimacyName(rel.intimacy);
        const daysSinceLastChat = rel.lastChat ? 
          Math.floor((new Date() - new Date(rel.lastChat)) / (1000 * 60 * 60 * 24)) : 0;
        const isFirstMeet = rel.odometer === 0;
        
        // è·å–æœ€è¿‘è®°å¿†
        const recentMemories = (rel.memories || []).slice(0, 3).map(m => m.content).join('ï¼›');
        
        relationContext = `
ã€å…³ç³»ä¿¡æ¯ã€‘
- ä½ ä»¬çš„å…³ç³»ï¼š${tutor.relationName}
- äº²å¯†ç¨‹åº¦ï¼š${intimacyName}ï¼ˆç­‰çº§${rel.intimacy}/3ï¼‰
- è¿™æ˜¯ç¬¬${rel.odometer + 1}æ¬¡å¯¹è¯
- ${isFirstMeet ? 'è¿™æ˜¯ä½ ä»¬ç¬¬ä¸€æ¬¡è§é¢ï¼' : `ä½ ä»¬å·²ç»è®¤è¯†äº†ï¼Œä¸Šæ¬¡èŠå¤©æ˜¯${daysSinceLastChat}å¤©å‰`}
${recentMemories ? `- ä½ è®°å¾—çš„äº‹æƒ…ï¼š${recentMemories}` : ''}

ã€é—®å€™è¦æ±‚ã€‘
${isFirstMeet ? 
  '- è¿™æ˜¯ç¬¬ä¸€æ¬¡è§é¢ï¼Œè‡ªæˆ‘ä»‹ç»ï¼Œè¡¨è¾¾è®¤è¯†çš„å–œæ‚¦' :
  daysSinceLastChat > 3 ?
    '- å¥½å‡ å¤©æ²¡è§äº†ï¼Œè¡¨è¾¾æƒ³å¿µ' :
    '- åƒè€æœ‹å‹/æ‹äººä¸€æ ·è‡ªç„¶æ‰“æ‹›å‘¼'
}
- æ ¹æ®äº²å¯†åº¦è°ƒæ•´ç§°å‘¼çš„äº²å¯†ç¨‹åº¦
- ${tutor.relation === 'boyfriend' || tutor.relation === 'girlfriend' ? 'å¯ä»¥é€‚å½“è¡¨è¾¾çˆ±æ„å’Œå…³å¿ƒ' : 'åƒå¥½æœ‹å‹ä¸€æ ·äº²åˆ‡'}`;
      }
      
      // è¯­æ³•è¯¾ç‰¹æ®Šå¤„ç†
      let grammarContext = '';
      if (scenario.isGrammarLesson && scenario.grammarTopic) {
        const topic = scenario.grammarTopic;
        grammarContext = `
ã€ç‰¹åˆ«ä»»åŠ¡ï¼šè¯­æ³•è¯¾ã€‘
ä½ ç°åœ¨è¦ç»™å­¦ç”Ÿä¸Šä¸€å ‚å…³äº"${topic.name}ï¼ˆ${topic.nameEs}ï¼‰"çš„è¯­æ³•è¯¾ã€‚

æ•™å­¦è¦æ±‚ï¼š
1. ç”¨è¥¿ç­ç‰™è¯­ä»‹ç»ä»Šå¤©è¦å­¦ä»€ä¹ˆï¼ˆé…åˆä¸­æ–‡è§£é‡Šï¼‰
2. æ¸…æ™°è§£é‡Šè¯­æ³•è§„åˆ™
3. ç»™å‡º3-5ä¸ªå®ç”¨ä¾‹å¥
4. å¯ä»¥é—®å­¦ç”Ÿé—®é¢˜ï¼Œæ£€éªŒç†è§£
5. å¦‚æœå­¦ç”Ÿå›ç­”é”™è¯¯ï¼Œè€å¿ƒçº æ­£å¹¶é¼“åŠ±

è¯·å¼€å§‹ä½ çš„è¯­æ³•è¯¾ä»‹ç»ï¼`;
      }
      
      const systemPrompt = `ä½ æ˜¯${tutor.name}ï¼Œ${tutor.description}ã€‚
æ€§æ ¼ç‰¹ç‚¹ï¼š${tutor.personality}
${tutor.traits ? `ç‰¹å¾æ ‡ç­¾ï¼š${tutor.traits.join('ã€')}` : ''}
${relationContext}
${grammarContext}

${grammarContext ? '' : `ç°åœ¨çš„åœºæ™¯æ˜¯ï¼š${scenario.name}ï¼ˆ${scenario.nameEs}ï¼‰- ${scenario.desc}

è¯·ç”¨è¥¿ç­ç‰™è¯­å‘${user.name}æ‰“æ‹›å‘¼ï¼Œå¹¶è‡ªç„¶åœ°å¼•å…¥è¿™ä¸ªåœºæ™¯ã€‚`}
è¦æ±‚ï¼š
1. å®Œå…¨ç¬¦åˆä½ çš„è§’è‰²æ€§æ ¼å’Œè¯´è¯æ–¹å¼
${grammarContext ? '2. å¼€å§‹è¯­æ³•è¯¾çš„æ•™å­¦' : '2. è‡ªç„¶åœ°å¸¦å…¥åœºæ™¯'}
3. æ ¹æ®å­¦ç”Ÿæ°´å¹³${user.level}è°ƒæ•´è¯­è¨€éš¾åº¦
4. ${grammarContext ? 'è¯­æ³•è§£é‡Šå¯ä»¥ç”¨ä¸­æ–‡ï¼Œä¾‹å¥ç”¨è¥¿ç­ç‰™è¯­' : 'åªè¯´1-2å¥è¯ï¼Œç®€æ´è‡ªç„¶'}
5. ${grammarContext ? '' : 'åªè¾“å‡ºè¥¿ç­ç‰™è¯­ï¼Œä¸è¦ä¸­æ–‡'}`;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            system: systemPrompt, 
            messages: [{ role: 'user', content: grammarContext ? 'å¼€å§‹ä¸Šè¯¾' : 'å¼€å§‹å¯¹è¯' }] 
          })
        });

        const data = await res.json();
        const defaultGreeting = `Â¡Hola, ${user.name}!`;
        const greeting = data.content?.[0]?.text || defaultGreeting;
        
        state.isLoading = false;
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
        
      } catch (err) {
        // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨ç®€å•é—®å€™
        const greeting = `Â¡Hola, ${user.name}!`;
        state.isLoading = false;
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
      }
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // ä¿å­˜/åˆ›å»ºç”¨æˆ·
    function saveUser(userData, isNew = false) {
      const userId = isNew ? Date.now().toString() : (state.user?.id || Date.now().toString());
      const user = { 
        ...userData, 
        id: userId,
        createdAt: userData.createdAt || new Date().toISOString() 
      };
      
      // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
      let users = Storage.getUsers();
      const existingIndex = users.findIndex(u => u.id === userId);
      if (existingIndex >= 0) {
        users[existingIndex] = user;
      } else {
        users.push(user);
      }
      Storage.saveUsers(users);
      Storage.setCurrentUserId(userId);
      
      // æ›´æ–°state
      state.users = users;
      state.user = user;
      
      // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®
      if (isNew) {
        state.chatHistory = [];
        state.mistakeBook = [];
        state.vocabulary = [];
      }
    }
    
    // åˆ‡æ¢ç”¨æˆ·
    function switchUser(userId) {
      const user = state.users.find(u => u.id === userId);
      if (!user) return;
      
      Storage.setCurrentUserId(userId);
      state.user = user;
      state.chatHistory = Storage.getUserData(userId, 'chatHistory', []);
      state.mistakeBook = Storage.getUserData(userId, 'mistakeBook', []);
      state.vocabulary = Storage.getUserData(userId, 'vocabulary', []);
      state.checkinDays = Storage.getUserData(userId, 'checkinDays', []);
      state.achievements = Storage.getUserData(userId, 'achievements', []);
      state.stats = Storage.getUserData(userId, 'stats', { flashcardReviews: 0, tutorsUsed: [] });
      state.relationData = Storage.getUserData(userId, 'relationData', { currentCompanion: null, relationships: {} });
      state.view = 'home';
      render();
    }
    
    // åˆ é™¤ç”¨æˆ·
    function deleteUser(userId) {
      let users = Storage.getUsers();
      users = users.filter(u => u.id !== userId);
      Storage.saveUsers(users);
      
      // æ¸…é™¤è¯¥ç”¨æˆ·çš„æ•°æ®
      Storage.remove(`${userId}_chatHistory`);
      Storage.remove(`${userId}_mistakeBook`);
      Storage.remove(`${userId}_vocabulary`);
      Storage.remove(`${userId}_checkinDays`);
      Storage.remove(`${userId}_achievements`);
      Storage.remove(`${userId}_stats`);
      Storage.remove(`${userId}_relationData`);
      
      state.users = users;
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œè¿”å›ç”¨æˆ·é€‰æ‹©é¡µé¢
      if (state.user?.id === userId) {
        state.user = null;
        Storage.setCurrentUserId(null);
        state.view = users.length > 0 ? 'userSelect' : 'welcome';
      }
      
      render();
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function render() {
      const app = document.getElementById('app');
      
      // åº”ç”¨æ·±è‰²æ¨¡å¼
      if (state.darkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      switch(state.view) {
        case 'loading': app.innerHTML = renderLoading(); break;
        case 'welcome': app.innerHTML = renderWelcome(); break;
        case 'userSelect': app.innerHTML = renderUserSelect(); break;
        case 'setup': app.innerHTML = renderSetup(); break;
        case 'home': app.innerHTML = renderHome(); break;
        case 'tutor': app.innerHTML = renderTutor(); break;
        case 'scenario': app.innerHTML = renderScenario(); break;
        case 'chat': app.innerHTML = renderChat(); break;
        case 'settings': app.innerHTML = renderSettings(); break;
        case 'history': app.innerHTML = renderHistory(); break;
        case 'stats': app.innerHTML = renderStats(); break;
        case 'mistakes': app.innerHTML = renderMistakes(); break;
        case 'vocabulary': app.innerHTML = renderVocabulary(); break;
        case 'flashcard': app.innerHTML = renderFlashcard(); break;
        case 'mistakeReview': app.innerHTML = renderMistakeReview(); break;
        case 'calendar': app.innerHTML = renderCalendar(); break;
        case 'achievements': app.innerHTML = renderAchievements(); break;
        case 'companion': app.innerHTML = renderCompanionSelect(); break;
        case 'service': app.innerHTML = renderServiceSelect(); break;
        case 'companionScenario': app.innerHTML = renderCompanionScenario(); break;
        case 'studyCenter': app.innerHTML = renderStudyCenter(); break;
        case 'askTeacher': app.innerHTML = renderAskTeacher(); break;
        case 'grammarLesson': app.innerHTML = renderGrammarLesson(); break;
      }
    }
    
    // åˆ‡æ¢æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      state.darkMode = !state.darkMode;
      Storage.set('darkMode', state.darkMode);
      render();
    }

    function renderLoading() {
      return `
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-primary-500 to-primary-700">
          <div class="text-center text-white">
            <div class="text-6xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <div class="text-xl font-semibold">HablaConmigo</div>
            <div class="mt-4 flex justify-center gap-1">
              <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.1s"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderWelcome() {
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col items-center justify-center p-6 text-center">
          <div class="fade-in">
            <div class="text-7xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-4xl font-bold text-white mb-2">Â¡Hola!</h1>
            <h2 class="text-xl text-white/90 mb-1">HablaConmigo</h2>
            <p class="text-white/70 mb-8 max-w-xs text-sm">
              ä¸AIä¼™ä¼´çœŸå®å¯¹è¯<br>
              è¯­éŸ³è¾“å…¥ Â· æ™ºèƒ½çº é”™ Â· å³æ—¶ç¿»è¯‘
            </p>
            
            <button onclick="state.view='setup';render()" 
              class="bg-white text-primary-600 font-bold py-4 px-10 rounded-2xl text-lg shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all">
              å¼€å§‹ä½¿ç”¨ â†’
            </button>
            
            <div class="mt-10 grid grid-cols-4 gap-4 text-white/80 text-xs">
              <div class="text-center"><div class="text-2xl mb-1">ğŸ¤</div>è¯­éŸ³</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸ­</div>è§’è‰²</div>
              <div class="text-center"><div class="text-2xl mb-1">âœï¸</div>çº é”™</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸŒ</div>ç¿»è¯‘</div>
            </div>
            
            <div class="mt-8 text-white/50 text-xs">å®Œå…¨å…è´¹ Â· æ— éœ€æ³¨å†Œ Â· æ•°æ®å­˜æœ¬åœ°</div>
          </div>
        </div>
      `;
    }

    // ç”¨æˆ·é€‰æ‹©é¡µé¢
    function renderUserSelect() {
      const users = state.users;
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col">
          <div class="p-6 text-white text-center">
            <div class="text-5xl mb-2">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-2xl font-bold">HablaConmigo</h1>
            <p class="text-white/70 text-sm mt-1">é€‰æ‹©ç”¨æˆ·æˆ–åˆ›å»ºæ–°ç”¨æˆ·</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-sm mx-auto space-y-3">
              ${users.map(u => `
                <div class="bg-white/10 backdrop-blur rounded-xl overflow-hidden">
                  <button onclick="switchUser('${u.id}')" 
                    class="w-full p-4 text-left hover:bg-white/10 transition-colors flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                      ${u.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                      <div class="font-bold text-white">${u.name}</div>
                      <div class="text-sm text-white/70">æ°´å¹³: ${u.level}</div>
                    </div>
                    <div class="text-white/50 text-sm">â†’</div>
                  </button>
                  <div class="border-t border-white/10 px-4 py-2 flex justify-end">
                    <button onclick="if(confirm('ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${u.name} å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ï¼'))deleteUser('${u.id}')" 
                      class="text-xs text-white/50 hover:text-red-300">åˆ é™¤</button>
                  </div>
                </div>
              `).join('')}
              
              <!-- æ·»åŠ æ–°ç”¨æˆ· -->
              <button onclick="state.view='setup';render()" 
                class="w-full p-4 bg-white/20 backdrop-blur rounded-xl text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2">
                <span class="text-2xl">+</span>
                <span class="font-medium">æ·»åŠ æ–°ç”¨æˆ·</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSetup() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ğŸ‘‹ æ¬¢è¿ï¼</h1>
            <p class="text-white/80 text-sm mt-1">è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä½ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <div class="max-w-md mx-auto space-y-6 fade-in">
              <!-- å§“å -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„åå­—</label>
                <input id="userName" type="text" placeholder="è¾“å…¥ä½ çš„åå­—æˆ–æ˜µç§°" 
                  class="w-full p-4 rounded-xl border border-gray-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                  value="${state.user?.name || ''}">
              </div>
              
              <!-- æ°´å¹³ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„è¥¿è¯­æ°´å¹³</label>
                <div class="grid grid-cols-2 gap-3">
                  ${LEVELS.map(l => `
                    <button onclick="document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50');document.getElementById('selectedLevel').value='${l.id}'"
                      class="level-btn p-4 rounded-xl border border-gray-200 text-left hover:border-primary-300 transition-all ${state.user?.level === l.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''}">
                      <div class="font-bold text-gray-800">${l.id}</div>
                      <div class="text-sm text-gray-500">${l.name}</div>
                      <div class="text-xs text-gray-400 mt-1">${l.desc}</div>
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedLevel" value="${state.user?.level || 'A2'}">
              </div>
              
              <!-- åå¥½ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ åå¥½</label>
                <div class="space-y-3">
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘</div>
                      <div class="text-xs text-gray-500">AIå›å¤æ—¶è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</div>
                    </div>
                    <input id="autoTranslate" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.autoTranslate ? 'checked' : ''}>
                  </label>
                  
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">ä¸¥æ ¼çº é”™æ¨¡å¼</div>
                      <div class="text-xs text-gray-500">çº æ­£æ‰€æœ‰è¯­æ³•é”™è¯¯ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ </div>
                    </div>
                    <input id="strictMode" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.strictMode ? 'checked' : ''}>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 safe-bottom">
            <button onclick="submitSetup()" 
              class="w-full py-4 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-bold shadow-lg hover:shadow-xl active:scale-98 transition-all">
              å¼€å§‹å­¦ä¹  ğŸš€
            </button>
          </div>
        </div>
      `;
    }

    function submitSetup() {
      const name = document.getElementById('userName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('selectedLevel').value;
      const autoTranslate = document.getElementById('autoTranslate').checked;
      const strictMode = document.getElementById('strictMode').checked;
      
      // åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ name, level, autoTranslate, strictMode, speechRate: 0.85 }, true);
      state.view = 'home';
      render();
    }

    function renderHome() {
      const user = state.user;
      const recentChats = state.chatHistory.slice(0, 3);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      const streak = getStreakDays();
      const checkedToday = hasCheckedInToday();
      
      // è·å–ç”¨æˆ·çš„ä¼´ä¾£/æœ‹å‹åŠå…³ç³»æ•°æ®
      const myCompanion = state.relationData?.currentCompanion ? CHARACTERS[state.relationData.currentCompanion] : null;
      const myRel = myCompanion ? getRelationship(myCompanion.id) : null;
      const myHearts = myRel ? 'â¤ï¸'.repeat(myRel.intimacy || 1) + 'ğŸ¤'.repeat(3 - (myRel.intimacy || 1)) : '';
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <div class="flex items-center justify-between mb-4">
              <button onclick="state.view='userSelect';render()" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-lg font-bold">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div class="text-left">
                  <div class="text-sm text-white/70">Â¡Hola!</div>
                  <div class="font-bold flex items-center gap-1">${user.name} <span class="text-xs text-white/50">â–¼</span></div>
                </div>
              </button>
              <button onclick="state.view='settings';render()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                âš™ï¸
              </button>
            </div>
            <!-- ç‚¹å‡»è¿›å…¥ç»Ÿè®¡é¡µé¢ -->
            <div onclick="state.view='stats';render()" class="flex gap-3 text-sm cursor-pointer hover:opacity-90 transition-opacity">
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">æ°´å¹³</div>
                <div class="font-bold">${user.level}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">å¯¹è¯</div>
                <div class="font-bold">${state.chatHistory.length}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">è¿ç»­</div>
                <div class="font-bold">${streak}å¤©</div>
              </div>
              <div class="bg-white/20 rounded-lg px-2 py-2 flex-1 text-center">
                <div class="text-white/70 text-xs">è¯æ±‡</div>
                <div class="font-bold">${state.vocabulary.length}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- ğŸ’• å…³ç³»æ¨¡å¼ -->
            <div class="mb-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-500">ğŸ’• æˆ‘çš„ä¼´ä¾£/æœ‹å‹</h3>
                <button onclick="state.view='companion';render()" class="text-xs text-primary-600">æ›´æ¢ â†’</button>
              </div>
              ${myCompanion ? `
                <button onclick="selectCompanion('${myCompanion.id}')" 
                  class="w-full bg-gradient-to-r ${myCompanion.color} p-4 rounded-2xl shadow-lg text-white flex items-center gap-4 hover:shadow-xl active:scale-98 transition-all">
                  <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-3xl">${myCompanion.avatar}</div>
                  <div class="flex-1 text-left">
                    <div class="font-bold text-lg">${myCompanion.name}</div>
                    <div class="text-white/80 text-sm">${myCompanion.relationName}</div>
                    <div class="text-sm mt-1">${myHearts} <span class="text-white/60 text-xs">${myRel?.odometer || 0}æ¬¡å¯¹è¯</span></div>
                  </div>
                  <div class="text-white/80 text-xl">ğŸ’¬</div>
                </button>
              ` : `
                <button onclick="state.view='companion';render()" 
                  class="w-full bg-gradient-to-r from-pink-400 to-rose-500 p-4 rounded-2xl shadow-lg text-white flex items-center gap-4 hover:shadow-xl active:scale-98 transition-all">
                  <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-3xl">ğŸ’•</div>
                  <div class="flex-1 text-left">
                    <div class="font-bold text-lg">é€‰æ‹©ä½ çš„ä¼´ä¾£/æœ‹å‹</div>
                    <div class="text-white/80 text-sm">å»ºç«‹æ·±åº¦æƒ…æ„Ÿè¿æ¥</div>
                  </div>
                  <div class="text-white/80 text-xl">â†’</div>
                </button>
              `}
            </div>
            
            <!-- ğŸ’¼ å¿«é€Ÿç»ƒä¹  -->
            <div class="mb-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-500">ğŸ’¼ å¿«é€Ÿç»ƒä¹ </h3>
                <button onclick="state.view='service';render()" class="text-xs text-primary-600">æ›´å¤š â†’</button>
              </div>
              <div class="grid grid-cols-4 gap-2">
                ${SERVICE_SCENARIOS.slice(0, 4).map(s => `
                  <button onclick="startServiceScenario('${s.id}')" 
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ğŸ‘¨â€ğŸ« å­¦ä¹ ä¸­å¿ƒ -->
            <div class="mb-5">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ‘¨â€ğŸ« å­¦ä¹ ä¸­å¿ƒ</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="selectTeacher('profesor')" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-slate-300 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-600 to-slate-800 flex items-center justify-center text-xl">ğŸ‘¨ğŸ»â€ğŸ«</div>
                    <div class="text-left">
                      <div class="font-bold text-gray-800 text-sm">Prof. GarcÃ­a</div>
                      <div class="text-xs text-gray-500">ä¸¥æ ¼æ•™å­¦</div>
                    </div>
                  </div>
                </button>
                <button onclick="selectTeacher('isabel')" 
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-teal-300 active:scale-98 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center text-xl">ğŸ‘©ğŸ»â€ğŸ«</div>
                    <div class="text-left">
                      <div class="font-bold text-gray-800 text-sm">Maestra Isabel</div>
                      <div class="text-xs text-gray-500">æ¸©æŸ”é¼“åŠ±</div>
                    </div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- ğŸ› ï¸ å­¦ä¹ å·¥å…· -->
            <div class="mb-5">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ› ï¸ å­¦ä¹ å·¥å…·</h3>
              <div class="grid grid-cols-4 gap-2">
                <button onclick="state.view='mistakes';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ“</div>
                    <div class="text-xs text-gray-700">é”™é¢˜æœ¬</div>
                    <div class="text-xs text-gray-400">${state.mistakeBook.length}</div>
                  </div>
                </button>
                <button onclick="state.view='vocabulary';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ“š</div>
                    <div class="text-xs text-gray-700">è¯æ±‡æœ¬</div>
                    <div class="text-xs text-gray-400">${state.vocabulary.length}</div>
                  </div>
                </button>
                <button onclick="state.view='calendar';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">${checkedToday ? 'âœ…' : 'ğŸ“…'}</div>
                    <div class="text-xs text-gray-700">æ‰“å¡</div>
                    <div class="text-xs text-gray-400">${streak}å¤©</div>
                  </div>
                </button>
                <button onclick="state.view='achievements';render()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md active:scale-95 transition-all">
                  <div class="flex flex-col items-center">
                    <div class="text-xl mb-1">ğŸ†</div>
                    <div class="text-xs text-gray-700">æˆå°±</div>
                    <div class="text-xs text-gray-400">${state.achievements.length}/${ACHIEVEMENTS.length}</div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- æœ€è¿‘å¯¹è¯ -->
            ${recentChats.length > 0 ? `
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-500">ğŸ“œ æœ€è¿‘å¯¹è¯</h3>
                  <button onclick="state.view='history';render()" class="text-xs text-primary-600">æŸ¥çœ‹å…¨éƒ¨ â†’</button>
                </div>
                <div class="space-y-2">
                  ${recentChats.map((chat, index) => {
                    const character = CHARACTERS[chat.tutor];
                    const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                    const date = new Date(chat.date);
                    return `
                      <div onclick="loadHistoryChat(${index})" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md active:scale-98 transition-all">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${character?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-lg">${character?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 text-sm">${character?.name || 'æœªçŸ¥'} Â· ${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()}</div>
                          </div>
                          ${chat.corrections > 0 ? `<div class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full">${chat.corrections}</div>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ==================== æ–°æ¨¡å¼å‡½æ•° ====================
    // é€‰æ‹©é™ªä¼´å‹è§’è‰²
    function selectCompanion(characterId) {
      const character = CHARACTERS[characterId];
      if (!character || character.type !== ROLE_TYPES.COMPANION) return;
      
      // ä¿å­˜ä¸ºå½“å‰ä¼´ä¾£
      state.relationData.currentCompanion = characterId;
      if (state.user) {
        Storage.setUserData(state.user.id, 'relationData', state.relationData);
      }
      
      state.tutor = character;
      state.view = 'companionScenario';
      render();
    }
    
    // é€‰æ‹©è€å¸ˆ
    function selectTeacher(teacherId) {
      const teacher = CHARACTERS[teacherId];
      if (!teacher || teacher.type !== ROLE_TYPES.TEACHER) return;
      
      state.tutor = teacher;
      state.view = 'studyCenter';
      render();
    }
    
    // å¼€å§‹å’Œè€å¸ˆå¯¹è¯
    function startTeacherChat(mode = 'free') {
      const teacher = state.tutor;
      if (!teacher) return;
      
      let scenario;
      switch (mode) {
        case 'grammar':
          scenario = { id: 'grammar', icon: 'ğŸ“–', name: 'è¯­æ³•è®²è§£', nameEs: 'GramÃ¡tica', desc: 'å­¦ä¹ è¯­æ³•çŸ¥è¯†' };
          break;
        case 'practice':
          scenario = { id: 'practice', icon: 'âœï¸', name: 'ç»ƒä¹ é¢˜', nameEs: 'Ejercicios', desc: 'åšç»ƒä¹ å·©å›ºçŸ¥è¯†' };
          break;
        case 'qa':
          scenario = { id: 'qa', icon: 'â“', name: 'ç­”ç–‘è§£æƒ‘', nameEs: 'Preguntas', desc: 'é—®è€å¸ˆé—®é¢˜' };
          break;
        default:
          scenario = { id: 'lesson', icon: 'ğŸ“š', name: 'è‡ªç”±å­¦ä¹ ', nameEs: 'Clase libre', desc: 'å’Œè€å¸ˆè‡ªç”±äº¤æµ' };
      }
      
      startChat(teacher, scenario);
    }
    
    // å¼€å§‹æœåŠ¡åœºæ™¯
    function startServiceScenario(scenarioId) {
      const scenario = SERVICE_SCENARIOS.find(s => s.id === scenarioId);
      if (!scenario) return;
      
      const npc = CHARACTERS[scenario.npc];
      if (!npc) return;
      
      state.tutor = npc;
      startChat(npc, scenario);
    }
    
    // æ¸²æŸ“ä¼´ä¾£é€‰æ‹©é¡µé¢
    // ç”Ÿæˆè§’è‰²å¡ç‰‡HTML
    function renderCharacterCard(c) {
      const rel = getRelationship(c.id);
      const isCurrent = state.relationData?.currentCompanion === c.id;
      const intimacyLevel = rel?.intimacy || 0;
      const hearts = intimacyLevel > 0 ? 'â¤ï¸'.repeat(intimacyLevel) + 'ğŸ¤'.repeat(3 - intimacyLevel) : '';
      
      return `
        <button onclick="selectCompanion('${c.id}')" 
          class="bg-white p-4 rounded-xl shadow-sm border-2 ${isCurrent ? 'border-primary-500 ring-2 ring-primary-200' : 'border-gray-100'} hover:shadow-md active:scale-98 transition-all">
          <div class="flex flex-col items-center text-center">
            <div class="relative">
              <div class="w-14 h-14 rounded-full bg-gradient-to-br ${c.color} flex items-center justify-center text-2xl mb-1">${c.avatar}</div>
              ${isCurrent ? '<div class="absolute -top-1 -right-1 text-sm">ğŸ’•</div>' : ''}
            </div>
            <div class="font-bold text-gray-800">${c.name}</div>
            <div class="text-xs text-primary-600">${c.role}</div>
            ${rel ? `
              <div class="text-xs mt-1">${hearts}</div>
              <div class="text-xs text-gray-400">${rel.odometer || 0}æ¬¡å¯¹è¯</div>
            ` : `
              <div class="text-xs text-gray-400 mt-1">æœªè®¤è¯†</div>
            `}
          </div>
        </button>
      `;
    }
    
    function renderCompanionSelect() {
      const companions = Object.values(CHARACTERS).filter(c => c.type === ROLE_TYPES.COMPANION);
      const friends = companions.filter(c => c.relation === 'friend');
      const boyfriends = companions.filter(c => c.relation === 'boyfriend');
      const girlfriends = companions.filter(c => c.relation === 'girlfriend');
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-pink-500 to-rose-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-xl font-bold">ğŸ’• é€‰æ‹©ä½ çš„ä¼´ä¾£/æœ‹å‹</h1>
            <p class="text-white/80 text-sm mt-1">å»ºç«‹æ·±åº¦æƒ…æ„Ÿè¿æ¥ï¼Œé™ªä½ å»ä»»ä½•åœºæ™¯</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ‘‹ æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${friends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
            
            <!-- ç”·æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ’™ ç”·æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${boyfriends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
            
            <!-- å¥³æœ‹å‹ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">ğŸ’— å¥³æœ‹å‹</h3>
              <div class="grid grid-cols-2 gap-3">
                ${girlfriends.map(c => renderCharacterCard(c)).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // æ¸²æŸ“é™ªä¼´åœºæ™¯é€‰æ‹©
    function renderCompanionScenario() {
      const c = state.tutor;
      if (!c) {
        state.view = 'home';
        render();
        return '';
      }
      
      // è·å–å…³ç³»æ•°æ®
      const rel = getRelationship(c.id);
      const intimacyLevel = rel?.intimacy || 1;
      const intimacyName = getIntimacyName(intimacyLevel);
      const hearts = 'â¤ï¸'.repeat(intimacyLevel) + 'ğŸ¤'.repeat(3 - intimacyLevel);
      
      // æŒ‰ç±»åˆ«åˆ†ç»„åœºæ™¯
      const dateScenes = COMPANION_SCENARIOS.filter(s => s.category === 'date');
      const lifeScenes = COMPANION_SCENARIOS.filter(s => s.category === 'life');
      const travelScenes = COMPANION_SCENARIOS.filter(s => s.category === 'travel');
      const dailyScenes = COMPANION_SCENARIOS.filter(s => s.category === 'daily' || s.category === 'social');
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r ${c.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='companion';render()" class="text-white/80 text-sm flex items-center gap-1">â† æ¢äºº</button>
              <button onclick="state.view='home';render()" class="text-white/80 text-sm">ğŸ  é¦–é¡µ</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${c.avatar}</div>
              <div class="flex-1">
                <div class="text-xl font-bold">${c.name}</div>
                <div class="text-white/80">${c.relationName}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-sm">${hearts}</span>
                  <span class="text-white/60 text-xs">${intimacyName}</span>
                </div>
              </div>
              <div class="text-right text-white/60 text-xs">
                <div>${rel?.odometer || 0}æ¬¡å¯¹è¯</div>
                ${rel?.firstMet ? `<div>è®¤è¯†${Math.floor((new Date() - new Date(rel.firstMet)) / (1000*60*60*24)) + 1}å¤©</div>` : ''}
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">æƒ³å’Œ${c.name}å»å“ªï¼Ÿ</h3>
            
            <!-- çº¦ä¼šåœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ’• çº¦ä¼š</div>
              <div class="grid grid-cols-4 gap-2">
                ${dateScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-pink-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ç”Ÿæ´»åœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ  ç”Ÿæ´»</div>
              <div class="grid grid-cols-4 gap-2">
                ${lifeScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-blue-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- å‡ºè¡Œåœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸš‡ å‡ºè¡Œ</div>
              <div class="grid grid-cols-4 gap-2">
                ${travelScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-green-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- æ—¥å¸¸åœºæ™¯ -->
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">ğŸ’¬ æ—¥å¸¸</div>
              <div class="grid grid-cols-4 gap-2">
                ${dailyScenes.map(s => `
                  <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-purple-200 active:scale-95 transition-all">
                    <div class="text-2xl mb-1">${s.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${s.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, COMPANION_SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${c.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ’¬ ç›´æ¥å¼€å§‹èŠå¤©
            </button>
          </div>
        </div>
      `;
    }
    
    // æ¸²æŸ“æœåŠ¡åœºæ™¯é€‰æ‹©
    function renderServiceSelect() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-xl font-bold">ğŸ’¼ å®ç”¨åœºæ™¯ç»ƒä¹ </h1>
            <p class="text-white/80 text-sm mt-1">ç›´æ¥è¿›å…¥åœºæ™¯ï¼Œå’Œä¸“ä¸šNPCå¯¹è¯ç»ƒä¹ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="grid grid-cols-2 gap-3">
              ${SERVICE_SCENARIOS.map(s => {
                const npc = CHARACTERS[s.npc];
                return `
                  <button onclick="startServiceScenario('${s.id}')" 
                    class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-primary-200 active:scale-98 transition-all text-left">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="text-3xl">${s.icon}</div>
                      <div>
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-400">${s.nameEs}</div>
                      </div>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">${s.desc}</div>
                    <div class="flex items-center gap-2 text-xs text-primary-600">
                      <span>${npc?.avatar}</span>
                      <span>${npc?.name}</span>
                    </div>
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== å­¦ä¹ ä¸­å¿ƒ ====================
    // è®¡ç®—å­¦ä¹ ç»Ÿè®¡æ•°æ®
    function getStudyStats() {
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      // æœ¬å‘¨å¯¹è¯æ•°
      const weekChats = state.chatHistory.filter(c => new Date(c.date) >= weekAgo);
      const weekChatCount = weekChats.length;
      
      // æœ¬å‘¨çº æ­£æ•°
      const weekCorrections = weekChats.reduce((sum, c) => sum + (c.corrections || 0), 0);
      
      // æ€»ä½“ç»Ÿè®¡
      const totalChats = state.chatHistory.length;
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      
      // è¿ç»­æ‰“å¡
      const streak = getStreakDays();
      
      // è¯æ±‡é‡
      const vocabCount = state.vocabulary.length;
      
      // å¸¸è§é”™è¯¯ç±»å‹ï¼ˆç®€å•åˆ†æï¼‰
      const recentMistakes = state.mistakeBook.slice(0, 10);
      
      return {
        weekChatCount,
        weekCorrections,
        totalChats,
        totalCorrections,
        streak,
        vocabCount,
        recentMistakes
      };
    }
    
    // ç”Ÿæˆä»Šæ—¥ä»»åŠ¡
    function getDailyTasks() {
      const stats = getStudyStats();
      const checkedToday = hasCheckedInToday();
      
      // ä»Šå¤©çš„å¯¹è¯æ•°
      const today = new Date().toDateString();
      const todayChats = state.chatHistory.filter(c => new Date(c.date).toDateString() === today).length;
      
      // ä»Šå¤©å¤ä¹ çš„å•è¯æ•°ï¼ˆç®€åŒ–ï¼šæ£€æŸ¥æœ€è¿‘çš„flashcard reviewï¼‰
      const todayVocabReviewed = state.stats?.todayVocabReviewed || 0;
      
      return [
        { 
          id: 'checkin', 
          icon: 'ğŸ“…', 
          name: 'æ¯æ—¥æ‰“å¡', 
          done: checkedToday,
          action: "state.view='calendar';render()"
        },
        { 
          id: 'chat', 
          icon: 'ğŸ’¬', 
          name: 'å®Œæˆ1æ¬¡å¯¹è¯', 
          done: todayChats >= 1,
          progress: `${todayChats}/1`,
          action: "state.view='home';render()"
        },
        { 
          id: 'vocab', 
          icon: 'ğŸ“š', 
          name: 'å¤ä¹ 5ä¸ªå•è¯', 
          done: todayVocabReviewed >= 5,
          progress: `${Math.min(todayVocabReviewed, 5)}/5`,
          action: "state.view='vocabulary';render()"
        },
        { 
          id: 'mistakes', 
          icon: 'ğŸ“', 
          name: 'å¤ä¹ é”™é¢˜', 
          done: false,
          action: "state.view='mistakes';render()"
        }
      ];
    }
    
    // æ¸²æŸ“å­¦ä¹ ä¸­å¿ƒ
    function renderStudyCenter() {
      const t = state.tutor;
      if (!t || t.type !== ROLE_TYPES.TEACHER) {
        state.view = 'home';
        render();
        return '';
      }
      
      const stats = getStudyStats();
      const tasks = getDailyTasks();
      const completedTasks = tasks.filter(t => t.done).length;
      
      // è¯­æ³•ä¸»é¢˜åˆ—è¡¨
      const grammarTopics = [
        { id: 'ser_estar', icon: 'ğŸ”¤', name: 'Ser vs Estar', desc: 'ä¸¤ä¸ª"æ˜¯"çš„åŒºåˆ«' },
        { id: 'preterito', icon: 'â°', name: 'ç®€å•è¿‡å»æ—¶', desc: 'PretÃ©rito indefinido' },
        { id: 'imperfecto', icon: 'ğŸ”„', name: 'è¿‡å»æœªå®Œæˆæ—¶', desc: 'PretÃ©rito imperfecto' },
        { id: 'subjuntivo', icon: 'ğŸ’­', name: 'è™šæ‹Ÿå¼', desc: 'Modo subjuntivo' },
        { id: 'por_para', icon: 'â†”ï¸', name: 'Por vs Para', desc: 'ä¸¤ä¸ª"ä¸ºäº†"çš„åŒºåˆ«' },
        { id: 'pronouns', icon: 'ğŸ‘†', name: 'ä»£è¯', desc: 'ç›´æ¥/é—´æ¥å®¾è¯­ä»£è¯' },
      ];
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ï¼šè€å¸ˆä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='home';render()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <!-- ğŸ“Š å­¦ä¹ æŠ¥å‘Š -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š å­¦ä¹ æŠ¥å‘Š</h3>
              <div class="grid grid-cols-4 gap-2 text-center">
                <div class="bg-blue-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-blue-600">${stats.weekChatCount}</div>
                  <div class="text-xs text-gray-500">æœ¬å‘¨å¯¹è¯</div>
                </div>
                <div class="bg-amber-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-amber-600">${stats.weekCorrections}</div>
                  <div class="text-xs text-gray-500">æœ¬å‘¨çº æ­£</div>
                </div>
                <div class="bg-green-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-green-600">${stats.streak}</div>
                  <div class="text-xs text-gray-500">è¿ç»­å¤©æ•°</div>
                </div>
                <div class="bg-purple-50 rounded-xl p-2">
                  <div class="text-xl font-bold text-purple-600">${stats.vocabCount}</div>
                  <div class="text-xs text-gray-500">è¯æ±‡é‡</div>
                </div>
              </div>
              ${stats.weekChatCount === 0 ? `
                <div class="mt-3 text-center text-gray-400 text-sm">æœ¬å‘¨è¿˜æ²¡æœ‰ç»ƒä¹ ï¼Œå¼€å§‹å­¦ä¹ å§ï¼</div>
              ` : stats.weekCorrections > 5 ? `
                <div class="mt-3 text-center text-amber-600 text-sm">ğŸ’¡ å»ºè®®å¤ä¹ ä¸€ä¸‹é”™é¢˜æœ¬ï¼Œå·©å›ºè–„å¼±ç‚¹</div>
              ` : `
                <div class="mt-3 text-center text-green-600 text-sm">ğŸ‘ ä¿æŒå¾—ä¸é”™ï¼ç»§ç»­åŠªåŠ›</div>
              `}
            </div>
            
            <!-- ğŸ“ ä»Šæ—¥ä»»åŠ¡ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-gray-800">ğŸ“ ä»Šæ—¥ä»»åŠ¡</h3>
                <span class="text-xs text-gray-400">${completedTasks}/${tasks.length} å®Œæˆ</span>
              </div>
              <div class="space-y-2">
                ${tasks.map(task => `
                  <button onclick="${task.action}" 
                    class="w-full flex items-center gap-3 p-3 rounded-xl ${task.done ? 'bg-green-50' : 'bg-gray-50'} hover:bg-gray-100 transition-all text-left">
                    <span class="text-xl">${task.done ? 'âœ…' : task.icon}</span>
                    <span class="flex-1 ${task.done ? 'text-green-700 line-through' : 'text-gray-700'}">${task.name}</span>
                    ${task.progress ? `<span class="text-xs text-gray-400">${task.progress}</span>` : ''}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- ğŸ’¬ å’Œè€å¸ˆäº¤æµ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ’¬ å’Œè€å¸ˆäº¤æµ</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="startTeacherChat('free')" 
                  class="p-4 rounded-xl bg-gradient-to-br ${t.color} text-white hover:shadow-md active:scale-98 transition-all">
                  <div class="text-2xl mb-1">ğŸ“š</div>
                  <div class="font-bold">è‡ªç”±å­¦ä¹ </div>
                  <div class="text-xs text-white/70">éšä¾¿èŠèŠç»ƒè¥¿è¯­</div>
                </button>
                <button onclick="startTeacherChat('qa')" 
                  class="p-4 rounded-xl bg-gray-100 hover:bg-gray-200 active:scale-98 transition-all">
                  <div class="text-2xl mb-1">â“</div>
                  <div class="font-bold text-gray-800">é—®é—®é¢˜</div>
                  <div class="text-xs text-gray-500">è¯­æ³•ã€è¯æ±‡ç–‘é—®</div>
                </button>
              </div>
            </div>
            
            <!-- ğŸ“– è¯­æ³•è¯¾å ‚ -->
            <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
              <h3 class="font-bold text-gray-800 mb-3">ğŸ“– è¯­æ³•è¯¾å ‚</h3>
              <div class="grid grid-cols-3 gap-2">
                ${grammarTopics.map(topic => `
                  <button onclick="startGrammarLesson('${topic.id}')" 
                    class="p-3 rounded-xl bg-gray-50 hover:bg-gray-100 active:scale-98 transition-all text-center">
                    <div class="text-xl mb-1">${topic.icon}</div>
                    <div class="text-xs font-bold text-gray-700">${topic.name}</div>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // å¼€å§‹è¯­æ³•è¯¾
    function startGrammarLesson(topicId) {
      const topics = {
        'ser_estar': { name: 'Ser vs Estar', nameEs: 'Ser y Estar', desc: 'å­¦ä¹ serå’Œestarçš„åŒºåˆ«å’Œç”¨æ³•' },
        'preterito': { name: 'ç®€å•è¿‡å»æ—¶', nameEs: 'PretÃ©rito indefinido', desc: 'å­¦ä¹ ç®€å•è¿‡å»æ—¶çš„å˜ä½å’Œç”¨æ³•' },
        'imperfecto': { name: 'è¿‡å»æœªå®Œæˆæ—¶', nameEs: 'PretÃ©rito imperfecto', desc: 'å­¦ä¹ è¿‡å»æœªå®Œæˆæ—¶åŠå…¶ä¸ç®€å•è¿‡å»æ—¶çš„åŒºåˆ«' },
        'subjuntivo': { name: 'è™šæ‹Ÿå¼', nameEs: 'Subjuntivo', desc: 'å­¦ä¹ è™šæ‹Ÿå¼çš„æ„æˆå’Œä½¿ç”¨åœºæ™¯' },
        'por_para': { name: 'Por vs Para', nameEs: 'Por y Para', desc: 'å­¦ä¹ porå’Œparaçš„åŒºåˆ«' },
        'pronouns': { name: 'ä»£è¯', nameEs: 'Pronombres', desc: 'å­¦ä¹ ç›´æ¥å’Œé—´æ¥å®¾è¯­ä»£è¯' }
      };
      
      const topic = topics[topicId];
      if (!topic) return;
      
      // æŠŠè¯­æ³•ä¸»é¢˜ä¿¡æ¯æ”¾åˆ°scenarioä¸­
      const scenario = { 
        id: `grammar_${topicId}`, 
        icon: 'ğŸ“–', 
        name: topic.name, 
        nameEs: topic.nameEs, 
        desc: topic.desc,
        isGrammarLesson: true,  // æ ‡è®°è¿™æ˜¯è¯­æ³•è¯¾
        grammarTopic: topic
      };
      
      startChat(state.tutor, scenario);
    }
    
    // æ¸²æŸ“é—®è€å¸ˆé¡µé¢ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç”¨å¯¹è¯ï¼‰
    function renderAskTeacher() {
      return renderStudyCenter();
    }
    
    // æ¸²æŸ“è¯­æ³•è¯¾é¡µé¢ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç”¨å¯¹è¯ï¼‰
    function renderGrammarLesson() {
      return renderStudyCenter();
    }

    function renderTutor() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <div>
              <h1 class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</h1>
              <p class="text-xs text-gray-500">ç‚¹å‡»é€‰æ‹©è§’è‰²å¼€å§‹å¯¹è¯</p>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-lg mx-auto grid grid-cols-2 gap-3">
              ${Object.values(TUTORS).map(t => `
                <button onclick="state.tutor=TUTORS['${t.id}'];state.view='scenario';render()" 
                  class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-98 transition-all">
                  <div class="flex flex-col items-center text-center">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${t.color} flex items-center justify-center text-2xl mb-2">${t.avatar}</div>
                    <div class="font-bold text-gray-800 text-sm">${t.name}</div>
                    <div class="text-xs text-primary-600">${t.role}</div>
                    <div class="text-xs text-gray-400 mt-1 line-clamp-2">${t.description.substring(0, 20)}...</div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderScenario() {
      const t = state.tutor;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- è§’è‰²ä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <div class="flex items-center justify-between mb-3">
              <button onclick="state.view='tutor';render()" class="text-white/80 text-sm flex items-center gap-1">â† æ¢è§’è‰²</button>
              <button onclick="state.view='home';render()" class="text-white/80 text-sm flex items-center gap-1">ğŸ  é¦–é¡µ</button>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name} ${t.emoji}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">é€‰æ‹©å¯¹è¯åœºæ™¯</h3>
            <div class="grid grid-cols-2 gap-3">
              ${SCENARIOS.map(s => `
                <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                  <div class="text-2xl mb-2">${s.icon}</div>
                  <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                  <div class="text-xs text-gray-400">${s.nameEs}</div>
                  <div class="text-xs text-gray-500 mt-1">${s.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${t.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ¤ ç›´æ¥å¼€å§‹è‡ªç”±å¯¹è¯
            </button>
          </div>
        </div>
      `;
    }

    function renderChat() {
      const t = state.tutor;
      const user = state.user;
      
      return `
        <div class="h-full bg-gray-100 flex flex-col">
          <!-- é¡¶æ  -->
          <div class="glass border-b p-3">
            <div class="flex items-center justify-between max-w-lg mx-auto">
              <button onclick="endChat()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                <span>â†</span>
                <span class="text-sm">è¿”å›</span>
              </button>
              <div class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-xl">${t.avatar}</span>
                  <span class="font-bold text-gray-800">${t.name}</span>
                </div>
                <div class="text-xs text-gray-500">${state.scenario?.name || 'è‡ªç”±èŠå¤©'} Â· ${user.level}</div>
              </div>
              <button onclick="exitToHome()" class="w-10 h-10 rounded-full hover:bg-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-700" title="è¿”å›é¦–é¡µ">
                ğŸ 
              </button>
            </div>
          </div>
          
          <!-- æ¶ˆæ¯åˆ—è¡¨ -->
          <div id="messages" class="flex-1 overflow-auto p-4 no-scrollbar">
            <div class="max-w-lg mx-auto space-y-4">
              ${state.messages.map(msg => renderMessage(msg, t)).join('')}
              
              ${state.isLoading ? `
                <div class="flex justify-start fade-in">
                  <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- çº æ­£ç»Ÿè®¡ -->
          ${state.corrections > 0 ? `
            <div class="bg-amber-50 border-t border-amber-100 py-2 text-center">
              <span class="text-sm text-amber-700">ğŸ“ æœ¬æ¬¡å¯¹è¯å·²çº æ­£ <strong>${state.corrections}</strong> å¤„</span>
            </div>
          ` : ''}
          
          <!-- æ™ºèƒ½å»ºè®®é¢æ¿ -->
          ${state.showSuggestions ? `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-t border-green-200 p-3 slide-up">
              <div class="max-w-lg mx-auto">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-green-800">ğŸ’¡ å›å¤å»ºè®®</span>
                  <button onclick="hideSuggestions()" class="text-green-600 text-xs hover:text-green-800">æ”¶èµ· âœ•</button>
                </div>
                ${state.isLoadingSuggestions ? `
                  <div class="flex items-center justify-center py-4">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                    <span class="ml-2 text-sm text-green-600">æ­£åœ¨ç”Ÿæˆå»ºè®®...</span>
                  </div>
                ` : `
                  <div class="space-y-2">
                    ${state.suggestions.map((s, i) => `
                      <button onclick="useSuggestion(${i})" 
                        class="w-full text-left p-3 bg-white rounded-xl border border-green-200 text-sm hover:border-green-400 hover:shadow-sm active:scale-98 transition-all">
                        <span class="text-gray-800">${s}</span>
                      </button>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          ` : ''}
          
          <!-- è¯æ±‡æ”¶è—æ¨¡æ€æ¡† -->
          ${state.vocabModal.show ? `
            <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="closeVocabModal()">
              <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl slide-up" onclick="event.stopPropagation()">
                <div class="p-5 border-b border-gray-100">
                  <div class="flex items-center justify-between">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                      <span class="text-xl">ğŸ“š</span>
                      <span>æ”¶è—åˆ°è¯æ±‡æœ¬</span>
                    </h3>
                    <button onclick="closeVocabModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-500">âœ•</button>
                  </div>
                </div>
                <div class="p-5 space-y-4">
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">è¥¿ç­ç‰™è¯­å•è¯</label>
                    <input id="vocabModalWord" type="text" value="${state.vocabModal.word}" 
                      oninput="state.vocabModal.word=this.value"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-lg font-medium">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¸­æ–‡æ„æ€</label>
                    <div class="relative">
                      <input id="vocabModalMeaning" type="text" value="${state.vocabModal.meaning}" 
                        oninput="state.vocabModal.meaning=this.value"
                        placeholder="${state.vocabModal.isLoading ? 'æ­£åœ¨ç¿»è¯‘...' : 'è¾“å…¥ä¸­æ–‡æ„æ€'}"
                        class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none ${state.vocabModal.isLoading ? 'bg-gray-50' : ''}">
                      ${state.vocabModal.isLoading ? `
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                          <div class="w-5 h-5 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-500 mb-1">ä¾‹å¥ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="vocabModalExample" type="text" value="${state.vocabModal.example}" 
                      oninput="state.vocabModal.example=this.value"
                      placeholder="å¯ä»¥è¾“å…¥ä¸€ä¸ªä¾‹å¥"
                      class="w-full p-3 rounded-xl border border-gray-200 focus:border-green-500 outline-none text-sm">
                  </div>
                </div>
                <div class="p-5 border-t border-gray-100 flex gap-3">
                  <button onclick="closeVocabModal()" 
                    class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">å–æ¶ˆ</button>
                  <button onclick="saveVocabFromModal()" 
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-medium hover:from-green-600 hover:to-emerald-600 shadow-lg">
                    æ”¶è—
                  </button>
                </div>
              </div>
            </div>
          ` : ''}
          
          <!-- è¾“å…¥åŒº -->
          <div class="glass border-t p-3 safe-bottom">
            <div class="max-w-lg mx-auto">
              <div class="flex gap-2 items-center">
                <button onclick="toggleListening()" 
                  class="relative w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.isListening ? 'bg-red-500 text-white mic-recording' : 'bg-gray-200 hover:bg-gray-300'}">
                  ${state.isListening ? 'â¹' : 'ğŸ¤'}
                </button>
                
                <input id="chatInput" type="text" value="${state.inputText.replace(/"/g, '&quot;')}" 
                  placeholder="${state.isListening ? 'ğŸ™ï¸ æ­£åœ¨å¬...' : 'ç”¨è¥¿ç­ç‰™è¯­è¾“å…¥...'}"
                  oninput="state.inputText=this.value"
                  onkeydown="if(event.key==='Enter')sendMessage()"
                  class="flex-1 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${state.isListening ? 'bg-red-50 border-2 border-red-200' : 'bg-white border border-gray-200'}">
                
                <button onclick="sendMessage()" 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.inputText.trim() && !state.isLoading ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-200 text-gray-400'}">
                  â¤
                </button>
              </div>
              
              <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar">
                <!-- æ™ºèƒ½å»ºè®®æŒ‰é’® -->
                <button onclick="getSuggestions()" 
                  class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full text-xs whitespace-nowrap hover:from-green-600 hover:to-emerald-600 shadow-sm flex items-center gap-1 ${state.isLoadingSuggestions ? 'opacity-50' : ''}">
                  <span>ğŸ’¡</span>
                  <span>ä¸çŸ¥é“è¯´ä»€ä¹ˆï¼Ÿ</span>
                </button>
                ${['No entiendo', 'Â¿Puedes repetir?', 'MÃ¡s despacio'].map(p => `
                  <button onclick="state.inputText='${p}';render()" 
                    class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded-full text-xs whitespace-nowrap hover:border-primary-300 hover:text-primary-600">${p}</button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMessage(msg, tutor) {
      const isUser = msg.type === 'user';
      const showTrans = state.showTranslation[msg.id];
      const translation = state.translationCache[msg.id];
      
      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} fade-in">
          <div class="max-w-[85%]">
            ${!isUser ? `
              <div class="flex items-center gap-2 mb-1">
                <div class="w-7 h-7 rounded-full bg-gradient-to-br ${tutor.color} flex items-center justify-center text-sm">${tutor.avatar}</div>
                <span class="text-xs text-gray-500">${tutor.name}</span>
              </div>
            ` : ''}
            
            <div class="relative">
              <div id="msg-${msg.id}"
                class="p-4 rounded-2xl text-sm select-text ${isUser 
                  ? 'bg-primary-500 text-white rounded-br-sm' 
                  : 'bg-white shadow-sm rounded-bl-sm'}">
                ${msg.text}
              </div>
              
              ${!isUser && showTrans && translation ? `
                <div class="mt-2 p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-800 whitespace-pre-line">
                  ${translation}
                </div>
              ` : ''}
              
              ${!isUser ? `
                <div class="absolute -right-12 top-0 flex flex-col gap-1">
                  <button onclick="handleSpeakClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-gray-50" title="æœ—è¯»">
                    ğŸ”Š
                  </button>
                  <button onclick="handleTranslateClick(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-blue-50 hover:text-blue-600 ${showTrans ? 'bg-blue-100 text-blue-600' : ''}" title="ç¿»è¯‘">
                    ğŸŒ
                  </button>
                  <button onclick="openVocabModalFromSelection(${msg.id})" 
                    class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-green-50 hover:text-green-600" title="é€‰ä¸­å•è¯åæ”¶è—">
                    ğŸ“š
                  </button>
                </div>
              ` : ''}
            </div>
            
            ${msg.correction ? `
              <div class="correction-card mt-3 p-4 slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-amber-800 font-medium">
                    <span class="text-lg">âœï¸</span>
                    <span>è¯­æ³•çº æ­£</span>
                  </div>
                  <button onclick="handleCorrectionTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showCorrectionTrans[msg.id] ? 'bg-amber-200 text-amber-800' : 'bg-amber-100 text-amber-600'} hover:bg-amber-200 transition-colors">
                    ğŸŒ ${state.showCorrectionTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-amber-900">${msg.correction}</div>
                ${state.showCorrectionTrans[msg.id] && state.correctionTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-amber-800 border border-amber-200 whitespace-pre-line">
                    ${state.correctionTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${msg.grammar ? `
              <div class="mt-3 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-xl slide-up">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2 text-blue-800 font-medium">
                    <span class="text-lg">ğŸ“š</span>
                    <span>è¯­æ³•çŸ¥è¯†</span>
                  </div>
                  <button onclick="handleGrammarTranslate(${msg.id})" 
                    class="text-xs px-2 py-1 rounded-full ${state.showGrammarTrans[msg.id] ? 'bg-blue-200 text-blue-800' : 'bg-blue-100 text-blue-600'} hover:bg-blue-200 transition-colors">
                    ğŸŒ ${state.showGrammarTrans[msg.id] ? 'éšè—ç¿»è¯‘' : 'ç¿»è¯‘'}
                  </button>
                </div>
                <div class="text-sm text-blue-900">${msg.grammar}</div>
                ${state.showGrammarTrans[msg.id] && state.grammarTransCache[msg.id] ? `
                  <div class="mt-2 p-2 bg-white/50 rounded-lg text-sm text-blue-800 border border-blue-200 whitespace-pre-line">
                    ${state.grammarTransCache[msg.id]}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // å¤„ç†ç¿»è¯‘ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
    function handleTranslateClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        getTranslation(msgId, msg.text);
      }
    }
    
    // å¤„ç†æœ—è¯»ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬
    function handleSpeakClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        speak(msg.text);
      }
    }
    
    // ==================== å¿«é€Ÿæ”¶è—è¯æ±‡åŠŸèƒ½ ====================
    // æ‰“å¼€è¯æ±‡æ”¶è—æ¨¡æ€æ¡†
    function openVocabModalFromSelection(msgId) {
      // è·å–ç”¨æˆ·é€‰ä¸­çš„æ–‡å­—
      const selection = window.getSelection();
      let selectedText = selection.toString().trim();
      
      // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡å­—ï¼Œæç¤ºç”¨æˆ·
      if (!selectedText) {
        // å°è¯•è·å–æ•´ä¸ªå•è¯ï¼ˆå¦‚æœç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªä½ç½®ï¼‰
        alert('è¯·å…ˆåœ¨AIå›å¤ä¸­é€‰ä¸­è¦æ”¶è—çš„å•è¯æˆ–çŸ­è¯­ï¼Œç„¶åå†ç‚¹å‡»æ”¶è—æŒ‰é’®');
        return;
      }
      
      // æ¸…ç†é€‰ä¸­çš„æ–‡å­—ï¼ˆå»é™¤æ ‡ç‚¹ç¬¦å·ï¼‰
      selectedText = selectedText.replace(/[.,!?Â¡Â¿;:"()]/g, '').trim();
      
      if (!selectedText) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å•è¯æˆ–çŸ­è¯­');
        return;
      }
      
      // è·å–å½“å‰æ¶ˆæ¯ä½œä¸ºä¾‹å¥
      const msg = state.messages.find(m => m.id === msgId);
      const example = msg ? msg.text.substring(0, 100) : '';
      
      // è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
      state.vocabModal = {
        show: true,
        word: selectedText,
        meaning: '',
        example: example,
        isLoading: true
      };
      render();
      
      // è‡ªåŠ¨ç¿»è¯‘
      autoTranslateWord(selectedText);
    }
    
    // è‡ªåŠ¨ç¿»è¯‘å•è¯
    async function autoTranslateWord(word) {
      try {
        const translation = await callAPI(word, true);
        state.vocabModal.meaning = translation;
        state.vocabModal.isLoading = false;
        render();
        
        // èšç„¦åˆ°æ„æ€è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('vocabModalMeaning');
          if (input) input.focus();
        }, 100);
      } catch (err) {
        state.vocabModal.isLoading = false;
        render();
      }
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeVocabModal() {
      state.vocabModal = { show: false, word: '', meaning: '', example: '', isLoading: false };
      render();
    }
    
    // ä»æ¨¡æ€æ¡†ä¿å­˜è¯æ±‡
    function saveVocabFromModal() {
      const word = state.vocabModal.word.trim();
      const meaning = state.vocabModal.meaning.trim();
      const example = state.vocabModal.example.trim();
      
      if (!word) {
        alert('è¯·è¾“å…¥å•è¯');
        return;
      }
      if (!meaning) {
        alert('è¯·è¾“å…¥ä¸­æ–‡æ„æ€');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const exists = state.vocabulary.some(v => v.word.toLowerCase() === word.toLowerCase());
      if (exists) {
        if (!confirm(`è¯æ±‡"${word}"å·²å­˜åœ¨ï¼Œæ˜¯å¦ä»è¦æ·»åŠ ï¼Ÿ`)) {
          return;
        }
      }
      
      // ä¿å­˜åˆ°è¯æ±‡æœ¬
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example,
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      
      // å…³é—­æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæˆåŠŸæç¤º
      closeVocabModal();
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä½¿ç”¨ä¸´æ—¶æç¤ºï¼‰
      showToast(`âœ… å·²æ”¶è—: ${word}`);
    }
    
    // æ˜¾ç¤ºä¸´æ—¶æç¤º
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50 fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }
    
    // å¤„ç†çº æ­£å¡ç‰‡ç¿»è¯‘
    async function handleCorrectionTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.correctionTransCache[msgId]) {
        state.showCorrectionTrans[msgId] = !state.showCorrectionTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.correction) return;
      
      state.showCorrectionTrans[msgId] = true;
      state.correctionTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.correction, true);
      state.correctionTransCache[msgId] = translation;
      render();
    }
    
    // å¤„ç†è¯­æ³•å¡ç‰‡ç¿»è¯‘
    async function handleGrammarTranslate(msgId) {
      // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
      if (state.grammarTransCache[msgId]) {
        state.showGrammarTrans[msgId] = !state.showGrammarTrans[msgId];
        render();
        return;
      }
      
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || !msg.grammar) return;
      
      state.showGrammarTrans[msgId] = true;
      state.grammarTransCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(msg.grammar, true);
      state.grammarTransCache[msgId] = translation;
      render();
    }

    function endChat() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      // å›åˆ°åœºæ™¯é€‰æ‹©é¡µé¢ï¼Œæ–¹ä¾¿åˆ‡æ¢åœºæ™¯
      state.view = 'scenario';
      render();
    }
    
    // å®Œå…¨é€€å‡ºå¯¹è¯å›åˆ°é¦–é¡µ
    function exitToHome() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      state.tutor = null;
      state.scenario = null;
      state.view = 'home';
      render();
    }
    
    // åŠ è½½å†å²å¯¹è¯
    function loadHistoryChat(index) {
      const chat = state.chatHistory[index];
      if (!chat) return;
      
      const tutor = TUTORS[chat.tutor];
      const scenario = SCENARIOS.find(s => s.id === chat.scenario);
      
      if (!tutor) {
        alert('å¯¹è¯è®°å½•æŸåï¼Œæ— æ³•æ‰“å¼€');
        return;
      }
      
      state.tutor = tutor;
      state.scenario = scenario || SCENARIOS[0];
      state.messages = chat.messages || [];
      state.corrections = chat.corrections || 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      render();
      scrollToBottom();
    }

    function renderSettings() {
      const user = state.user;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800">è®¾ç½®</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
              <!-- ä¸ªäººä¿¡æ¯ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-gray-500">åå­—</label>
                    <input id="settingName" type="text" value="${user.name}" 
                      class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-500">è¥¿è¯­æ°´å¹³</label>
                    <select id="settingLevel" class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                      ${LEVELS.map(l => `<option value="${l.id}" ${user.level === l.id ? 'selected' : ''}>${l.id} - ${l.name}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ åå¥½</h3>
                <div class="space-y-4">
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</span>
                    <input id="settingAutoTrans" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.autoTranslate ? 'checked' : ''}>
                  </label>
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">ä¸¥æ ¼çº é”™æ¨¡å¼</span>
                    <input id="settingStrict" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.strictMode ? 'checked' : ''}>
                  </label>
                  <div>
                    <label class="text-gray-700">ç¿»è¯‘è¯­è¨€</label>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                      <button type="button" onclick="document.getElementById('settingTransLang').value='zh';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${(user.transLang || 'zh') === 'zh' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸ‡¨ğŸ‡³ ä¸­æ–‡
                      </button>
                      <button type="button" onclick="document.getElementById('settingTransLang').value='en';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${user.transLang === 'en' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸ‡¬ğŸ‡§ è‹±è¯­
                      </button>
                      <button type="button" onclick="document.getElementById('settingTransLang').value='both';document.querySelectorAll('.trans-lang-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50')"
                        class="trans-lang-btn p-3 rounded-xl border text-center text-sm ${user.transLang === 'both' ? 'ring-2 ring-primary-500 bg-primary-50' : 'border-gray-200'}">
                        ğŸŒ åŒè¯­
                      </button>
                    </div>
                    <input type="hidden" id="settingTransLang" value="${user.transLang || 'zh'}">
                  </div>
                  <div>
                    <label class="text-gray-700">è¯­éŸ³é€Ÿåº¦</label>
                    <input id="settingSpeechRate" type="range" min="0.5" max="1.2" step="0.05" value="${user.speechRate || 0.85}"
                      class="w-full mt-2" oninput="document.getElementById('rateValue').textContent=this.value">
                    <div class="flex justify-between text-xs text-gray-400">
                      <span>æ…¢</span>
                      <span id="rateValue">${user.speechRate || 0.85}</span>
                      <span>å¿«</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å¤–è§‚è®¾ç½® -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ¨ å¤–è§‚è®¾ç½®</h3>
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <span class="text-gray-700">æ·±è‰²æ¨¡å¼</span>
                      <div class="text-xs text-gray-400">å¤œé—´æŠ¤çœ¼</div>
                    </div>
                    <button onclick="toggleDarkMode()" 
                      class="w-14 h-8 rounded-full transition-colors ${state.darkMode ? 'bg-primary-500' : 'bg-gray-300'} relative">
                      <div class="absolute top-1 ${state.darkMode ? 'right-1' : 'left-1'} w-6 h-6 bg-white rounded-full shadow transition-all flex items-center justify-center text-xs">
                        ${state.darkMode ? 'ğŸŒ™' : 'â˜€ï¸'}
                      </div>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- æ•°æ®ç®¡ç† -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">å¯¹è¯è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.chatHistory.length} æ¡</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">é”™é¢˜æœ¬</span>
                    <span class="text-gray-800 font-medium">${state.mistakeBook.length} æ¡</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">è¯æ±‡æœ¬</span>
                    <span class="text-gray-800 font-medium">${state.vocabulary.length} ä¸ª</span>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">æ‰“å¡è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.checkinDays.length} å¤©</span>
                  </div>
                  
                  <div class="border-t border-gray-100 pt-4 mt-2 space-y-2">
                    <button onclick="exportUserData()" 
                      class="w-full py-3 rounded-xl border border-primary-200 text-primary-600 hover:bg-primary-50 flex items-center justify-center gap-2">
                      <span>ğŸ“¤</span>
                      <span>å¯¼å‡ºæ•°æ®å¤‡ä»½</span>
                    </button>
                    <label class="w-full py-3 rounded-xl border border-green-200 text-green-600 hover:bg-green-50 flex items-center justify-center gap-2 cursor-pointer">
                      <span>ğŸ“¥</span>
                      <span>å¯¼å…¥æ•°æ®</span>
                      <input type="file" accept=".json" onchange="importUserData(event)" class="hidden">
                    </label>
                  </div>
                  
                  <div class="border-t border-gray-100 pt-4 mt-2">
                    <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                      class="w-full py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50">
                      æ¸…é™¤å¯¹è¯è®°å½•
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="saveSettings()" 
              class="w-full py-4 rounded-xl bg-primary-500 text-white font-bold shadow-lg">
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      `;
    }

    function saveSettings() {
      const name = document.getElementById('settingName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('settingLevel').value;
      const autoTranslate = document.getElementById('settingAutoTrans').checked;
      const strictMode = document.getElementById('settingStrict').checked;
      const speechRate = parseFloat(document.getElementById('settingSpeechRate').value);
      const transLang = document.getElementById('settingTransLang').value;
      
      // æ›´æ–°ç°æœ‰ç”¨æˆ·ï¼Œä¸æ˜¯åˆ›å»ºæ–°ç”¨æˆ·
      saveUser({ ...state.user, name, level, autoTranslate, strictMode, speechRate, transLang }, false);
      state.view = 'home';
      render();
    }

    // å¯¼å‡ºç”¨æˆ·æ•°æ®
    function exportUserData() {
      if (!state.user) return;
      
      const exportData = {
        exportDate: new Date().toISOString(),
        version: '2.0',
        user: {
          name: state.user.name,
          level: state.user.level,
          transLang: state.user.transLang,
          autoTranslate: state.user.autoTranslate,
          strictMode: state.user.strictMode,
          speechRate: state.user.speechRate
        },
        chatHistory: state.chatHistory,
        mistakeBook: state.mistakeBook,
        vocabulary: state.vocabulary,
        checkinDays: state.checkinDays,
        achievements: state.achievements,
        stats: state.stats,
        relationData: state.relationData
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `habla_backup_${state.user.name}_${getTodayStr()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('ğŸ“¤ æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
    }
    
    // å¯¼å…¥ç”¨æˆ·æ•°æ®
    function importUserData(event) {
      const file = event.target.files[0];
      if (!file || !state.user) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          // éªŒè¯æ•°æ®æ ¼å¼
          if (!importData.version || !importData.exportDate) {
            alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            return;
          }
          
          // ç¡®è®¤å¯¼å…¥
          const info = `å¤‡ä»½æ—¥æœŸ: ${new Date(importData.exportDate).toLocaleDateString()}
å¯¹è¯è®°å½•: ${importData.chatHistory?.length || 0} æ¡
é”™é¢˜æœ¬: ${importData.mistakeBook?.length || 0} æ¡
è¯æ±‡æœ¬: ${importData.vocabulary?.length || 0} ä¸ª
æ‰“å¡è®°å½•: ${importData.checkinDays?.length || 0} å¤©
æˆå°±: ${importData.achievements?.length || 0} ä¸ª

å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`;
          
          if (!confirm(info)) return;
          
          // å¯¼å…¥æ•°æ®
          if (importData.chatHistory) {
            state.chatHistory = importData.chatHistory;
            Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
          }
          if (importData.mistakeBook) {
            state.mistakeBook = importData.mistakeBook;
            Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
          }
          if (importData.vocabulary) {
            state.vocabulary = importData.vocabulary;
            Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
          }
          if (importData.checkinDays) {
            state.checkinDays = importData.checkinDays;
            Storage.setUserData(state.user.id, 'checkinDays', state.checkinDays);
          }
          if (importData.achievements) {
            state.achievements = importData.achievements;
            Storage.setUserData(state.user.id, 'achievements', state.achievements);
          }
          if (importData.stats) {
            state.stats = importData.stats;
            Storage.setUserData(state.user.id, 'stats', state.stats);
          }
          if (importData.relationData) {
            state.relationData = importData.relationData;
            Storage.setUserData(state.user.id, 'relationData', state.relationData);
          }
          
          showToast('ğŸ“¥ æ•°æ®å¯¼å…¥æˆåŠŸï¼');
          render();
          
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
          console.error(err);
        }
      };
      
      reader.readAsText(file);
      // æ¸…ç©ºinputä»¥ä¾¿å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
      event.target.value = '';
    }

    function clearHistory() {
      if (!state.user) return;
      state.chatHistory = [];
      Storage.setUserData(state.user.id, 'chatHistory', []);
      render();
    }
    
    // åˆ é™¤å•æ¡å†å²è®°å½•
    function deleteHistoryChat(index, event) {
      event.stopPropagation(); // é˜»æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      if (!state.user) return;
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        state.chatHistory.splice(index, 1);
        Storage.setUserData(state.user.id, 'chatHistory', state.chatHistory);
        render();
      }
    }

    function renderHistory() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800 flex-1">å¯¹è¯å†å²</h1>
            ${state.chatHistory.length > 0 ? `
              <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                class="text-xs px-3 py-1 rounded-full bg-red-50 text-red-500 hover:bg-red-100">æ¸…é™¤å…¨éƒ¨</button>
            ` : ''}
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${state.chatHistory.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${state.chatHistory.map((chat, index) => {
                  const tutor = TUTORS[chat.tutor];
                  const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                  const date = new Date(chat.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div onclick="loadHistoryChat(${index})" class="p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-3">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-2xl flex-shrink-0">${tutor?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'}</div>
                            <div class="text-sm text-gray-500">${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                          </div>
                          <div class="text-right flex-shrink-0">
                            <div class="text-sm text-gray-600">${chat.messages?.length || 0} æ¡</div>
                            ${chat.corrections > 0 ? `<div class="text-xs text-amber-600">çº æ­£ ${chat.corrections}</div>` : ''}
                          </div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteHistoryChat(${index}, event)" 
                          class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1 transition-colors">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤æ­¤å¯¹è¯</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“­</div>
                <div>æš‚æ— å¯¹è¯è®°å½•</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ==================== å­¦ä¹ ç»Ÿè®¡é¡µé¢ ====================
    function renderStats() {
      const user = state.user;
      const totalChats = state.chatHistory.length;
      const totalMessages = state.chatHistory.reduce((sum, c) => sum + (c.messages?.length || 0), 0);
      const totalCorrections = state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0);
      const totalMistakes = state.mistakeBook.length;
      const totalVocab = state.vocabulary.length;
      
      // è®¡ç®—å­¦ä¹ å¤©æ•°
      const chatDates = state.chatHistory.map(c => new Date(c.date).toDateString());
      const uniqueDays = [...new Set(chatDates)].length;
      
      // è®¡ç®—å¸¸ç”¨è§’è‰²
      const tutorCounts = {};
      state.chatHistory.forEach(c => {
        tutorCounts[c.tutor] = (tutorCounts[c.tutor] || 0) + 1;
      });
      const favoriteTutor = Object.entries(tutorCounts).sort((a, b) => b[1] - a[1])[0];
      
      // è®¡ç®—å¸¸ç”¨åœºæ™¯
      const scenarioCounts = {};
      state.chatHistory.forEach(c => {
        scenarioCounts[c.scenario] = (scenarioCounts[c.scenario] || 0) + 1;
      });
      const favoriteScenario = Object.entries(scenarioCounts).sort((a, b) => b[1] - a[1])[0];
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <h1 class="text-2xl font-bold">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h1>
            <p class="text-white/70 text-sm mt-1">ä½ çš„è¥¿è¯­å­¦ä¹ æ•°æ®ä¸€è§ˆ</p>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-4">
              <!-- æ ¸å¿ƒæ•°æ® -->
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-primary-600">${totalChats}</div>
                  <div class="text-sm text-gray-500">å¯¹è¯æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-blue-600">${totalMessages}</div>
                  <div class="text-sm text-gray-500">æ¶ˆæ¯æ€»æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-amber-600">${totalCorrections}</div>
                  <div class="text-sm text-gray-500">è¢«çº æ­£æ¬¡æ•°</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                  <div class="text-3xl font-bold text-green-600">${uniqueDays}</div>
                  <div class="text-sm text-gray-500">å­¦ä¹ å¤©æ•°</div>
                </div>
              </div>
              
              <!-- å­¦ä¹ è¿›åº¦ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“ˆ å­¦ä¹ è¿›åº¦</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600">å½“å‰æ°´å¹³</span>
                      <span class="font-bold text-primary-600">${user.level}</span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-primary-400 to-primary-600 rounded-full" 
                        style="width: ${user.level === 'A1' ? '25%' : user.level === 'A2' ? '50%' : user.level === 'B1' ? '75%' : '100%'}"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                      <span>A1</span><span>A2</span><span>B1</span><span>B2</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">â¤ï¸ å­¦ä¹ åå¥½</h3>
                <div class="space-y-3">
                  ${favoriteTutor ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„è§’è‰²</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${TUTORS[favoriteTutor[0]]?.avatar || 'ğŸ‘¤'}</span>
                        <span class="font-medium">${TUTORS[favoriteTutor[0]]?.name || 'æœªçŸ¥'}</span>
                        <span class="text-xs text-gray-400">(${favoriteTutor[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                  ${favoriteScenario ? `
                    <div class="flex items-center justify-between">
                      <span class="text-gray-600">æœ€å¸¸ç»ƒä¹ çš„åœºæ™¯</span>
                      <div class="flex items-center gap-2">
                        <span class="text-xl">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.icon || 'ğŸ’¬'}</span>
                        <span class="font-medium">${SCENARIOS.find(s => s.id === favoriteScenario[0])?.name || 'è‡ªç”±èŠå¤©'}</span>
                        <span class="text-xs text-gray-400">(${favoriteScenario[1]}æ¬¡)</span>
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- å­¦ä¹ èµ„æ–™ -->
              <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ èµ„æ–™</h3>
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="state.view='mistakes';render()" class="p-3 bg-amber-50 rounded-xl text-center hover:bg-amber-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="font-bold text-amber-700">${totalMistakes}</div>
                    <div class="text-xs text-amber-600">é”™é¢˜è®°å½•</div>
                  </button>
                  <button onclick="state.view='vocabulary';render()" class="p-3 bg-green-50 rounded-xl text-center hover:bg-green-100 transition-colors">
                    <div class="text-2xl mb-1">ğŸ“š</div>
                    <div class="font-bold text-green-700">${totalVocab}</div>
                    <div class="text-xs text-green-600">è¯æ±‡æ”¶è—</div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== é”™é¢˜æœ¬é¡µé¢ ====================
    function renderMistakes() {
      const mistakes = state.mistakeBook;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“ é”™é¢˜æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…± ${mistakes.length} æ¡çº æ­£è®°å½•</p>
              </div>
              ${mistakes.length > 0 ? `
                <button onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ'))clearMistakes()" 
                  class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30">æ¸…ç©º</button>
              ` : ''}
            </div>
            ${mistakes.length >= 2 ? `
              <button onclick="startMistakeReview(${Math.min(mistakes.length, 10)})" 
                class="mt-4 w-full py-3 rounded-xl bg-white text-orange-600 font-bold shadow-lg hover:bg-gray-100 active:scale-98 transition-all flex items-center justify-center gap-2">
                <span>ğŸ¯</span>
                <span>å¼€å§‹é”™é¢˜å¤ä¹  (${Math.min(mistakes.length, 10)}é¢˜)</span>
              </button>
            ` : ''}
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${mistakes.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${mistakes.map((m, index) => {
                  const date = new Date(m.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden ${m.reviewed ? 'border-l-4 border-green-400' : ''}">
                      <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                          <div class="flex items-center gap-2 text-xs text-gray-400">
                            <span>${TUTORS[m.tutorId]?.avatar || 'ğŸ‘¤'}</span>
                            <span>${m.tutorName}</span>
                            <span>Â·</span>
                            <span>${m.scenario}</span>
                            ${m.reviewed ? '<span class="text-green-500">âœ“ å·²å¤ä¹ </span>' : ''}
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg mb-2">
                          <div class="text-xs text-red-500 mb-1">âŒ ä½ è¯´çš„</div>
                          <div class="text-sm text-red-700">${m.original}</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                          <div class="text-xs text-green-500 mb-1">âœ… çº æ­£</div>
                          <div class="text-sm text-green-700">${m.correction}</div>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-between items-center">
                        <button onclick="speakMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-gray-500 hover:bg-gray-100 flex items-center gap-1">
                          <span>ğŸ”Š</span>
                          <span>æœ—è¯»</span>
                        </button>
                        <button onclick="deleteMistake(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ‰</div>
                <div class="font-medium">æš‚æ— é”™è¯¯è®°å½•</div>
                <div class="text-sm mt-1">ç»§ç»­åŠ æ²¹ï¼å’ŒAIå¯¹è¯æ—¶çš„çº æ­£ä¼šè‡ªåŠ¨è®°å½•åœ¨è¿™é‡Œ</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // é”™é¢˜æœ¬ç›¸å…³å‡½æ•°
    function clearMistakes() {
      if (!state.user) return;
      state.mistakeBook = [];
      Storage.setUserData(state.user.id, 'mistakeBook', []);
      render();
    }
    
    function deleteMistake(index) {
      if (!state.user) return;
      state.mistakeBook.splice(index, 1);
      Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
      render();
    }
    
    function speakMistake(index) {
      const m = state.mistakeBook[index];
      if (m) {
        // æå–çº æ­£åçš„æ­£ç¡®è¡¨è¾¾
        const correctMatch = m.correction.match(/â†’\s*[""]?([^""(]+)/);
        if (correctMatch) {
          speak(correctMatch[1].trim());
        } else {
          speak(m.correction);
        }
      }
    }

    // ==================== è¯æ±‡æœ¬é¡µé¢ ====================
    function renderVocabulary() {
      const vocab = state.vocabulary;
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“š è¯æ±‡æœ¬</h1>
                <p class="text-white/70 text-sm mt-1">å…±æ”¶è— ${vocab.length} ä¸ªå•è¯</p>
              </div>
              <button onclick="showAddVocabForm()" 
                class="text-xs px-3 py-1 rounded-full bg-white/20 hover:bg-white/30 flex items-center gap-1">
                <span>+</span>
                <span>æ·»åŠ å•è¯</span>
              </button>
            </div>
            ${vocab.length >= 3 ? `
              <button onclick="startFlashcardReview(${Math.min(vocab.length, 10)})" 
                class="mt-4 w-full py-3 rounded-xl bg-white text-emerald-600 font-bold shadow-lg hover:bg-gray-100 active:scale-98 transition-all flex items-center justify-center gap-2">
                <span>ğŸ´</span>
                <span>å¼€å§‹é—ªå¡å¤ä¹  (${Math.min(vocab.length, 10)}è¯)</span>
              </button>
            ` : ''}
          </div>
          
          <!-- æ·»åŠ å•è¯è¡¨å• -->
          <div id="addVocabForm" class="hidden bg-white border-b p-4">
            <div class="max-w-md mx-auto space-y-3">
              <input id="vocabWord" type="text" placeholder="è¥¿ç­ç‰™è¯­å•è¯" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabMeaning" type="text" placeholder="ä¸­æ–‡æ„æ€" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <input id="vocabExample" type="text" placeholder="ä¾‹å¥ï¼ˆå¯é€‰ï¼‰" 
                class="w-full p-3 rounded-lg border border-gray-200 focus:border-green-500 outline-none text-sm">
              <div class="flex gap-2">
                <button onclick="hideAddVocabForm()" class="flex-1 py-2 rounded-lg border border-gray-200 text-gray-600 text-sm">å–æ¶ˆ</button>
                <button onclick="addVocabulary()" class="flex-1 py-2 rounded-lg bg-green-500 text-white text-sm">ä¿å­˜</button>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${vocab.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${vocab.map((v, index) => {
                  const date = new Date(v.date);
                  return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div class="p-4">
                        <div class="flex items-start justify-between">
                          <div class="flex-1">
                            <div class="flex items-center gap-2">
                              <span class="text-lg font-bold text-gray-800">${v.word}</span>
                              <button onclick="speakVocab('${v.word.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-primary-500">ğŸ”Š</button>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${v.meaning}</div>
                            ${v.example ? `<div class="text-xs text-gray-400 mt-2 italic">"${v.example}"</div>` : ''}
                          </div>
                          <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                      </div>
                      <div class="border-t border-gray-100 px-4 py-2 bg-gray-50 flex justify-end">
                        <button onclick="deleteVocab(${index})" class="text-xs px-3 py-1.5 rounded-lg text-red-500 hover:bg-red-100 flex items-center gap-1">
                          <span>ğŸ—‘ï¸</span>
                          <span>åˆ é™¤</span>
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“–</div>
                <div class="font-medium">è¯æ±‡æœ¬æ˜¯ç©ºçš„</div>
                <div class="text-sm mt-1">ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å•è¯"å¼€å§‹æ”¶è—</div>
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    // è¯æ±‡æœ¬ç›¸å…³å‡½æ•°
    function showAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.remove('hidden');
    }
    
    function hideAddVocabForm() {
      document.getElementById('addVocabForm')?.classList.add('hidden');
      document.getElementById('vocabWord').value = '';
      document.getElementById('vocabMeaning').value = '';
      document.getElementById('vocabExample').value = '';
    }
    
    function addVocabulary() {
      const word = document.getElementById('vocabWord')?.value.trim();
      const meaning = document.getElementById('vocabMeaning')?.value.trim();
      const example = document.getElementById('vocabExample')?.value.trim();
      
      if (!word || !meaning) {
        alert('è¯·å¡«å†™å•è¯å’Œä¸­æ–‡æ„æ€');
        return;
      }
      
      const vocab = {
        id: Date.now(),
        word,
        meaning,
        example: example || '',
        date: new Date().toISOString(),
        mastered: false
      };
      
      state.vocabulary.unshift(vocab);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      hideAddVocabForm();
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      render();
    }
    
    function deleteVocab(index) {
      state.vocabulary.splice(index, 1);
      if (state.user) {
        Storage.setUserData(state.user.id, 'vocabulary', state.vocabulary);
      }
      render();
    }
    
    function speakVocab(word) {
      speak(word);
    }

    // ==================== é—ªå¡å¤ä¹ åŠŸèƒ½ ====================
    function startFlashcardReview(count = 10) {
      const vocab = state.vocabulary;
      if (vocab.length === 0) {
        alert('è¯æ±‡æœ¬æ˜¯ç©ºçš„ï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›å•è¯ï¼');
        return;
      }
      
      // éšæœºæ‰“ä¹±å¹¶å–æŒ‡å®šæ•°é‡
      const shuffled = [...vocab].sort(() => Math.random() - 0.5);
      const cards = shuffled.slice(0, Math.min(count, vocab.length));
      
      state.flashcard = {
        cards: cards,
        currentIndex: 0,
        showAnswer: false,
        results: [],
        finished: false
      };
      state.view = 'flashcard';
      render();
    }
    
    function flipCard() {
      state.flashcard.showAnswer = !state.flashcard.showAnswer;
      render();
    }
    
    function markCard(isCorrect) {
      const fc = state.flashcard;
      const currentCard = fc.cards[fc.currentIndex];
      
      // è®°å½•ç»“æœ
      fc.results.push({
        word: currentCard.word,
        meaning: currentCard.meaning,
        correct: isCorrect
      });
      
      // ä¸‹ä¸€å¼ å¡ç‰‡
      if (fc.currentIndex < fc.cards.length - 1) {
        fc.currentIndex++;
        fc.showAnswer = false;
      } else {
        fc.finished = true;
        // è®°å½•é—ªå¡å¤ä¹ å®Œæˆ
        recordFlashcardReview();
        checkAchievements();
      }
      render();
    }
    
    function restartFlashcard() {
      const count = state.flashcard.cards.length;
      startFlashcardReview(count);
    }
    
    function exitFlashcard() {
      state.view = 'vocabulary';
      render();
    }
    
    function renderFlashcard() {
      const fc = state.flashcard;
      
      // å®Œæˆé¡µé¢
      if (fc.finished) {
        const correct = fc.results.filter(r => r.correct).length;
        const total = fc.results.length;
        const percentage = Math.round((correct / total) * 100);
        const wrongCards = fc.results.filter(r => !r.correct);
        
        return `
          <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col">
            <div class="p-4">
              <button onclick="exitFlashcard()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›è¯æ±‡æœ¬</button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
              <div class="text-6xl mb-4">${percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
              <h2 class="text-2xl font-bold text-white mb-2">å¤ä¹ å®Œæˆï¼</h2>
              
              <div class="bg-white/20 backdrop-blur rounded-2xl p-6 mb-6 w-full max-w-xs">
                <div class="text-5xl font-bold text-white mb-2">${percentage}%</div>
                <div class="text-white/80">æ­£ç¡®ç‡</div>
                <div class="flex justify-center gap-8 mt-4 text-sm">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-300">${correct}</div>
                    <div class="text-white/60">è®¤è¯†</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-red-300">${total - correct}</div>
                    <div class="text-white/60">ä¸è®¤è¯†</div>
                  </div>
                </div>
              </div>
              
              ${wrongCards.length > 0 ? `
                <div class="bg-white/10 backdrop-blur rounded-xl p-4 w-full max-w-xs mb-6">
                  <div class="text-white/80 text-sm mb-2">éœ€è¦åŠ å¼ºçš„å•è¯ï¼š</div>
                  <div class="space-y-2">
                    ${wrongCards.map(c => `
                      <div class="flex items-center justify-between text-white text-sm">
                        <span class="font-medium">${c.word}</span>
                        <span class="text-white/60">${c.meaning}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div class="flex gap-3 w-full max-w-xs">
                <button onclick="restartFlashcard()" 
                  class="flex-1 py-3 rounded-xl bg-white text-primary-600 font-bold hover:bg-gray-100 transition-colors">
                  å†æ¥ä¸€æ¬¡
                </button>
                <button onclick="exitFlashcard()" 
                  class="flex-1 py-3 rounded-xl bg-white/20 text-white font-bold hover:bg-white/30 transition-colors">
                  è¿”å›
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // å¤ä¹ é¡µé¢
      const currentCard = fc.cards[fc.currentIndex];
      const progress = ((fc.currentIndex) / fc.cards.length) * 100;
      
      return `
        <div class="h-full bg-gradient-to-br from-green-500 via-emerald-500 to-teal-600 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="p-4">
            <div class="flex items-center justify-between text-white mb-3">
              <button onclick="exitFlashcard()" class="text-white/80 text-sm flex items-center gap-1">â† é€€å‡º</button>
              <div class="text-sm">${fc.currentIndex + 1} / ${fc.cards.length}</div>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="h-2 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
          </div>
          
          <!-- å¡ç‰‡åŒºåŸŸ -->
          <div class="flex-1 flex items-center justify-center p-6">
            <div onclick="flipCard()" 
              class="w-full max-w-sm aspect-[3/4] cursor-pointer perspective-1000">
              <div class="relative w-full h-full transition-transform duration-500 transform-style-3d ${fc.showAnswer ? 'rotate-y-180' : ''}">
                <!-- æ­£é¢ï¼šå•è¯ -->
                <div class="absolute inset-0 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center p-6 backface-hidden">
                  <div class="text-gray-400 text-sm mb-4">ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­</div>
                  <div class="text-3xl font-bold text-gray-800 mb-4">${currentCard.word}</div>
                  <button onclick="event.stopPropagation();speak('${currentCard.word.replace(/'/g, "\\'")}')" 
                    class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-xl hover:bg-gray-200 transition-colors">
                    ğŸ”Š
                  </button>
                  <div class="absolute bottom-6 text-gray-400 text-sm">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ç­”æ¡ˆ</div>
                </div>
                
                <!-- èƒŒé¢ï¼šæ„æ€ -->
                <div class="absolute inset-0 bg-white rounded-3xl shadow-2xl flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180">
                  <div class="text-gray-400 text-sm mb-2">ğŸ‡ªğŸ‡¸ ${currentCard.word}</div>
                  <div class="text-2xl font-bold text-gray-800 mb-4">${currentCard.meaning}</div>
                  ${currentCard.example ? `
                    <div class="text-sm text-gray-500 italic text-center px-4">"${currentCard.example}"</div>
                  ` : ''}
                  <div class="absolute bottom-6 text-gray-400 text-sm">ä½ è®¤è¯†è¿™ä¸ªå•è¯å—ï¼Ÿ</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- åº•éƒ¨æŒ‰é’® -->
          <div class="p-6 safe-bottom">
            ${fc.showAnswer ? `
              <div class="flex gap-4 max-w-sm mx-auto">
                <button onclick="markCard(false)" 
                  class="flex-1 py-4 rounded-2xl bg-red-500 text-white font-bold text-lg shadow-lg hover:bg-red-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <span>âŒ</span>
                  <span>ä¸è®¤è¯†</span>
                </button>
                <button onclick="markCard(true)" 
                  class="flex-1 py-4 rounded-2xl bg-green-500 text-white font-bold text-lg shadow-lg hover:bg-green-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <span>âœ…</span>
                  <span>è®¤è¯†</span>
                </button>
              </div>
            ` : `
              <button onclick="flipCard()" 
                class="w-full max-w-sm mx-auto block py-4 rounded-2xl bg-white text-emerald-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all">
                ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ
              </button>
            `}
          </div>
        </div>
      `;
    }

    // ==================== é”™é¢˜å¤ä¹ åŠŸèƒ½ ====================
    function startMistakeReview(count = 10) {
      const mistakes = state.mistakeBook;
      if (mistakes.length === 0) {
        alert('é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼Œç»§ç»­å¯¹è¯ç»ƒä¹ å§ï¼');
        return;
      }
      
      // éšæœºæ‰“ä¹±å¹¶å–æŒ‡å®šæ•°é‡
      const shuffled = [...mistakes].sort(() => Math.random() - 0.5);
      const items = shuffled.slice(0, Math.min(count, mistakes.length));
      
      state.mistakeReview = {
        items: items,
        currentIndex: 0,
        showAnswer: false,
        userAnswer: '',
        results: [],
        finished: false
      };
      state.view = 'mistakeReview';
      render();
    }
    
    function showMistakeAnswer() {
      state.mistakeReview.showAnswer = true;
      render();
    }
    
    function markMistake(mastered) {
      const mr = state.mistakeReview;
      const currentItem = mr.items[mr.currentIndex];
      
      // è®°å½•ç»“æœ
      mr.results.push({
        original: currentItem.original,
        correction: currentItem.correction,
        mastered: mastered
      });
      
      // å¦‚æœæŒæ¡äº†ï¼Œå¯ä»¥æ ‡è®°é”™é¢˜æœ¬ä¸­çš„è¯¥é¡¹
      if (mastered && state.user) {
        const idx = state.mistakeBook.findIndex(m => m.id === currentItem.id);
        if (idx >= 0) {
          state.mistakeBook[idx].reviewed = true;
          Storage.setUserData(state.user.id, 'mistakeBook', state.mistakeBook);
        }
      }
      
      // ä¸‹ä¸€é¢˜
      if (mr.currentIndex < mr.items.length - 1) {
        mr.currentIndex++;
        mr.showAnswer = false;
        mr.userAnswer = '';
      } else {
        mr.finished = true;
      }
      render();
    }
    
    function restartMistakeReview() {
      const count = state.mistakeReview.items.length;
      startMistakeReview(count);
    }
    
    function exitMistakeReview() {
      state.view = 'mistakes';
      render();
    }
    
    function updateMistakeAnswer(value) {
      state.mistakeReview.userAnswer = value;
    }
    
    function renderMistakeReview() {
      const mr = state.mistakeReview;
      
      // å®Œæˆé¡µé¢
      if (mr.finished) {
        const mastered = mr.results.filter(r => r.mastered).length;
        const total = mr.results.length;
        const percentage = Math.round((mastered / total) * 100);
        const needPractice = mr.results.filter(r => !r.mastered);
        
        return `
          <div class="h-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 flex flex-col">
            <div class="p-4">
              <button onclick="exitMistakeReview()" class="text-white/80 text-sm flex items-center gap-1">â† è¿”å›é”™é¢˜æœ¬</button>
            </div>
            
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
              <div class="text-6xl mb-4">${percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
              <h2 class="text-2xl font-bold text-white mb-2">å¤ä¹ å®Œæˆï¼</h2>
              
              <div class="bg-white/20 backdrop-blur rounded-2xl p-6 mb-6 w-full max-w-xs">
                <div class="text-5xl font-bold text-white mb-2">${percentage}%</div>
                <div class="text-white/80">æŒæ¡ç‡</div>
                <div class="flex justify-center gap-8 mt-4 text-sm">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-300">${mastered}</div>
                    <div class="text-white/60">å·²æŒæ¡</div>
                  </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-red-300">${total - mastered}</div>
                    <div class="text-white/60">éœ€åŠ å¼º</div>
                  </div>
                </div>
              </div>
              
              ${needPractice.length > 0 ? `
                <div class="bg-white/10 backdrop-blur rounded-xl p-4 w-full max-w-xs mb-6 text-left">
                  <div class="text-white/80 text-sm mb-2">éœ€è¦ç»§ç»­ç»ƒä¹ ï¼š</div>
                  <div class="space-y-2 max-h-32 overflow-auto">
                    ${needPractice.slice(0, 5).map(c => `
                      <div class="text-white text-xs">
                        <div class="text-red-200 line-through">${c.original.substring(0, 30)}...</div>
                      </div>
                    `).join('')}
                    ${needPractice.length > 5 ? `<div class="text-white/50 text-xs">è¿˜æœ‰ ${needPractice.length - 5} é¡¹...</div>` : ''}
                  </div>
                </div>
              ` : ''}
              
              <div class="flex gap-3 w-full max-w-xs">
                <button onclick="restartMistakeReview()" 
                  class="flex-1 py-3 rounded-xl bg-white text-orange-600 font-bold hover:bg-gray-100 transition-colors">
                  å†æ¥ä¸€æ¬¡
                </button>
                <button onclick="exitMistakeReview()" 
                  class="flex-1 py-3 rounded-xl bg-white/20 text-white font-bold hover:bg-white/30 transition-colors">
                  è¿”å›
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // å¤ä¹ é¡µé¢
      const currentItem = mr.items[mr.currentIndex];
      const progress = ((mr.currentIndex) / mr.items.length) * 100;
      
      // è§£æçº æ­£å†…å®¹ï¼Œæå–æ­£ç¡®ç­”æ¡ˆ
      const correctionText = currentItem.correction;
      // å°è¯•æå– â†’ åé¢çš„æ­£ç¡®å†…å®¹
      const correctMatch = correctionText.match(/â†’\s*[""]?([^""(ï¼ˆ]+)/);
      const correctAnswer = correctMatch ? correctMatch[1].trim() : correctionText;
      
      return `
        <div class="h-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="p-4">
            <div class="flex items-center justify-between text-white mb-3">
              <button onclick="exitMistakeReview()" class="text-white/80 text-sm flex items-center gap-1">â† é€€å‡º</button>
              <div class="text-sm">${mr.currentIndex + 1} / ${mr.items.length}</div>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="h-2 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
          </div>
          
          <!-- é¢˜ç›®åŒºåŸŸ -->
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- é¢˜ç›®å¡ç‰‡ -->
              <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                <div class="text-center mb-4">
                  <span class="text-sm text-gray-500">ğŸ“ è¯·æ‰¾å‡ºå¹¶æ”¹æ­£é”™è¯¯</span>
                </div>
                
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-4">
                  <div class="text-lg text-red-800 font-medium text-center">
                    "${currentItem.original}"
                  </div>
                </div>
                
                <div class="flex items-center justify-center gap-2 text-xs text-gray-400">
                  <span class="px-2 py-1 bg-gray-100 rounded-full">${currentItem.tutorName || 'æœªçŸ¥'}</span>
                  <span class="px-2 py-1 bg-gray-100 rounded-full">${currentItem.scenario || 'è‡ªç”±èŠå¤©'}</span>
                </div>
              </div>
              
              ${!mr.showAnswer ? `
                <!-- è¾“å…¥ç­”æ¡ˆ -->
                <div class="bg-white/90 backdrop-blur rounded-2xl p-4 mb-4">
                  <input type="text" 
                    placeholder="è¾“å…¥ä½ è®¤ä¸ºæ­£ç¡®çš„è¯´æ³•..."
                    value="${mr.userAnswer}"
                    oninput="updateMistakeAnswer(this.value)"
                    class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-orange-400 outline-none text-center">
                </div>
              ` : `
                <!-- æ˜¾ç¤ºç­”æ¡ˆ -->
                <div class="bg-white rounded-2xl shadow-xl p-6 slide-up">
                  <div class="text-center mb-3">
                    <span class="text-sm text-green-600 font-medium">âœ… æ­£ç¡®ç­”æ¡ˆ</span>
                  </div>
                  <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                    <div class="text-lg text-green-800 font-medium text-center">
                      ${correctAnswer}
                    </div>
                    <button onclick="speak('${correctAnswer.replace(/'/g, "\\'")}')" 
                      class="mx-auto mt-2 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-lg hover:bg-green-200">
                      ğŸ”Š
                    </button>
                  </div>
                  
                  <div class="bg-amber-50 rounded-xl p-4">
                    <div class="text-xs text-amber-600 mb-1">ğŸ’¡ çº æ­£è¯´æ˜</div>
                    <div class="text-sm text-amber-900">${correctionText}</div>
                  </div>
                </div>
              `}
            </div>
          </div>
          
          <!-- åº•éƒ¨æŒ‰é’® -->
          <div class="p-4 safe-bottom">
            <div class="max-w-md mx-auto">
              ${mr.showAnswer ? `
                <div class="flex gap-3">
                  <button onclick="markMistake(false)" 
                    class="flex-1 py-4 rounded-2xl bg-white/20 text-white font-bold text-lg hover:bg-white/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>âŒ</span>
                    <span>è¿˜ä¸ä¼š</span>
                  </button>
                  <button onclick="markMistake(true)" 
                    class="flex-1 py-4 rounded-2xl bg-white text-orange-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span>âœ…</span>
                    <span>æŒæ¡äº†</span>
                  </button>
                </div>
              ` : `
                <button onclick="showMistakeAnswer()" 
                  class="w-full py-4 rounded-2xl bg-white text-orange-600 font-bold text-lg shadow-lg hover:bg-gray-100 active:scale-95 transition-all">
                  ğŸ‘€ æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== æ¯æ—¥æ‰“å¡åŠŸèƒ½ ====================
    // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
    function getTodayStr() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
    function hasCheckedInToday() {
      const todayStr = getTodayStr();
      return state.checkinDays.includes(todayStr);
    }
    
    // ä»Šæ—¥æ˜¯å¦æœ‰å­¦ä¹ ï¼ˆå¯¹è¯ï¼‰
    function hasStudiedToday() {
      const todayStr = getTodayStr();
      return state.chatHistory.some(chat => {
        const chatDate = new Date(chat.date).toISOString().split('T')[0];
        return chatDate === todayStr;
      });
    }
    
    // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
    function getStreakDays() {
      if (state.checkinDays.length === 0) return 0;
      
      const sortedDays = [...state.checkinDays].sort().reverse();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let checkDate = new Date(today);
      
      // å¦‚æœä»Šå¤©è¿˜æ²¡æ‰“å¡ï¼Œä»æ˜¨å¤©å¼€å§‹ç®—
      if (!hasCheckedInToday()) {
        checkDate.setDate(checkDate.getDate() - 1);
      }
      
      for (let i = 0; i < sortedDays.length; i++) {
        const dayStr = checkDate.toISOString().split('T')[0];
        if (sortedDays.includes(dayStr)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // æ‰“å¡
    function doCheckin() {
      if (!state.user) return;
      
      const todayStr = getTodayStr();
      if (state.checkinDays.includes(todayStr)) {
        showToast('ä»Šå¤©å·²ç»æ‰“å¡è¿‡äº†ï¼');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ä¹ 
      if (!hasStudiedToday()) {
        if (!confirm('ä»Šå¤©è¿˜æ²¡æœ‰è¿›è¡Œå¯¹è¯ç»ƒä¹ ï¼Œç¡®å®šè¦æ‰“å¡å—ï¼Ÿ')) {
          return;
        }
      }
      
      state.checkinDays.push(todayStr);
      Storage.setUserData(state.user.id, 'checkinDays', state.checkinDays);
      
      const streak = getStreakDays();
      showToast(`ğŸ‰ æ‰“å¡æˆåŠŸï¼è¿ç»­ ${streak} å¤©`);
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      render();
    }
    
    // æ¸²æŸ“æ—¥å†é¡µé¢
    function renderCalendar() {
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const todayStr = getTodayStr();
      
      // è·å–æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startWeekDay = firstDay.getDay(); // 0=å‘¨æ—¥
      
      // æœˆä»½åç§°
      const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                          'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
      
      const streak = getStreakDays();
      const totalCheckins = state.checkinDays.length;
      const checkedToday = hasCheckedInToday();
      const studiedToday = hasStudiedToday();
      
      // ç”Ÿæˆæ—¥å†æ ¼å­
      let calendarDays = [];
      // å¡«å……æœˆåˆç©ºç™½
      for (let i = 0; i < startWeekDay; i++) {
        calendarDays.push({ day: '', status: 'empty' });
      }
      // å¡«å……æ—¥æœŸ
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const isChecked = state.checkinDays.includes(dateStr);
        const isFuture = new Date(dateStr) > today;
        
        calendarDays.push({
          day: d,
          dateStr,
          isToday,
          isChecked,
          isFuture
        });
      }
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between mb-4">
              <div>
                <h1 class="text-2xl font-bold">ğŸ“… å­¦ä¹ æ—¥å†</h1>
                <p class="text-white/70 text-sm mt-1">${currentYear}å¹´ ${monthNames[currentMonth]}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold">ğŸ”¥ ${streak}</div>
                <div class="text-white/70 text-xs">è¿ç»­æ‰“å¡</div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${totalCheckins}</div>
                <div class="text-xs text-white/70">æ€»æ‰“å¡å¤©æ•°</div>
              </div>
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${state.chatHistory.length}</div>
                <div class="text-xs text-white/70">æ€»å¯¹è¯æ•°</div>
              </div>
              <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold">${state.vocabulary.length}</div>
                <div class="text-xs text-white/70">è¯æ±‡ç§¯ç´¯</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- æ—¥å† -->
              <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
                <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `
                    <div class="text-center text-xs text-gray-400 py-2">${d}</div>
                  `).join('')}
                </div>
                
                <!-- æ—¥æœŸæ ¼å­ -->
                <div class="grid grid-cols-7 gap-1">
                  ${calendarDays.map(d => {
                    if (d.status === 'empty') {
                      return '<div class="aspect-square"></div>';
                    }
                    
                    let bgClass = 'bg-gray-50';
                    let textClass = 'text-gray-600';
                    let icon = '';
                    
                    if (d.isFuture) {
                      textClass = 'text-gray-300';
                    } else if (d.isChecked) {
                      bgClass = 'bg-green-100';
                      textClass = 'text-green-700';
                      icon = 'âœ“';
                    }
                    
                    if (d.isToday) {
                      bgClass = d.isChecked ? 'bg-green-500' : 'bg-purple-500';
                      textClass = 'text-white';
                    }
                    
                    return `
                      <div class="aspect-square ${bgClass} rounded-lg flex flex-col items-center justify-center ${d.isToday ? 'ring-2 ring-purple-300' : ''}">
                        <span class="text-sm font-medium ${textClass}">${d.day}</span>
                        ${icon ? `<span class="text-xs ${d.isToday ? 'text-white' : 'text-green-500'}">${icon}</span>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              
              <!-- ä»Šæ—¥çŠ¶æ€ -->
              <div class="bg-white rounded-2xl shadow-sm p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š ä»Šæ—¥å­¦ä¹ </h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">å¯¹è¯ç»ƒä¹ </span>
                    <span class="${studiedToday ? 'text-green-500' : 'text-gray-400'}">${studiedToday ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ'}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-600">æ¯æ—¥æ‰“å¡</span>
                    <span class="${checkedToday ? 'text-green-500' : 'text-gray-400'}">${checkedToday ? 'âœ… å·²æ‰“å¡' : 'â³ æœªæ‰“å¡'}</span>
                  </div>
                </div>
              </div>
              
              <!-- å›¾ä¾‹ -->
              <div class="flex items-center justify-center gap-4 text-xs text-gray-500">
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-green-100 rounded"></div>
                  <span>å·²æ‰“å¡</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-purple-500 rounded"></div>
                  <span>ä»Šå¤©</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-4 h-4 bg-gray-50 rounded border"></div>
                  <span>æœªæ‰“å¡</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ‰“å¡æŒ‰é’® -->
          <div class="p-4 safe-bottom">
            <div class="max-w-md mx-auto">
              ${checkedToday ? `
                <div class="py-4 rounded-2xl bg-green-100 text-green-700 font-bold text-center">
                  âœ… ä»Šæ—¥å·²æ‰“å¡ Â· è¿ç»­ ${streak} å¤©
                </div>
              ` : `
                <button onclick="doCheckin()" 
                  class="w-full py-4 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold text-lg shadow-lg hover:shadow-xl active:scale-98 transition-all flex items-center justify-center gap-2">
                  <span>âœ…</span>
                  <span>æ‰“å¡</span>
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== æˆå°±ç³»ç»Ÿ ====================
    // æ£€æŸ¥å¹¶è§£é”æˆå°±
    function checkAchievements() {
      if (!state.user) return;
      
      let newUnlocked = [];
      
      ACHIEVEMENTS.forEach(achievement => {
        // å¦‚æœå·²è§£é”ï¼Œè·³è¿‡
        if (state.achievements.includes(achievement.id)) return;
        
        // æ£€æŸ¥æ¡ä»¶
        try {
          if (achievement.condition(state)) {
            state.achievements.push(achievement.id);
            newUnlocked.push(achievement);
          }
        } catch (e) {
          // æ¡ä»¶æ£€æŸ¥å‡ºé”™ï¼Œè·³è¿‡
        }
      });
      
      // ä¿å­˜æˆå°±
      if (newUnlocked.length > 0) {
        Storage.setUserData(state.user.id, 'achievements', state.achievements);
        
        // æ˜¾ç¤ºè§£é”æç¤º
        newUnlocked.forEach(a => {
          setTimeout(() => {
            showAchievementToast(a);
          }, 500);
        });
      }
    }
    
    // æ˜¾ç¤ºæˆå°±è§£é”æç¤º
    function showAchievementToast(achievement) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-amber-500 text-white px-6 py-4 rounded-2xl shadow-2xl z-50 flex items-center gap-3 animate-bounce';
      toast.innerHTML = `
        <span class="text-3xl">${achievement.icon}</span>
        <div>
          <div class="text-xs opacity-80">ğŸ‰ æˆå°±è§£é”ï¼</div>
          <div class="font-bold">${achievement.name}</div>
        </div>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }
    
    // è®°å½•ä½¿ç”¨çš„å¯¼å¸ˆ
    function recordTutorUsed(tutorId) {
      if (!state.user || !tutorId) return;
      
      if (!state.stats.tutorsUsed.includes(tutorId)) {
        state.stats.tutorsUsed.push(tutorId);
        Storage.setUserData(state.user.id, 'stats', state.stats);
      }
    }
    
    // è®°å½•é—ªå¡å¤ä¹ æ¬¡æ•°
    function recordFlashcardReview() {
      if (!state.user) return;
      
      state.stats.flashcardReviews = (state.stats.flashcardReviews || 0) + 1;
      Storage.setUserData(state.user.id, 'stats', state.stats);
    }
    
    // æ¸²æŸ“æˆå°±é¡µé¢
    function renderAchievements() {
      const unlockedCount = state.achievements.length;
      const totalCount = ACHIEVEMENTS.length;
      const percentage = Math.round((unlockedCount / totalCount) * 100);
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-yellow-500 to-amber-500 p-6 text-white">
            <button onclick="state.view='home';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-bold">ğŸ† æˆ‘çš„æˆå°±</h1>
                <p class="text-white/80 text-sm mt-1">å·²è§£é” ${unlockedCount}/${totalCount} ä¸ªæˆå°±</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold">${percentage}%</div>
                <div class="text-white/70 text-xs">å®Œæˆåº¦</div>
              </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="mt-4 h-3 bg-white/20 rounded-full overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto">
              <!-- æˆå°±ç½‘æ ¼ -->
              <div class="grid grid-cols-2 gap-3">
                ${ACHIEVEMENTS.map(a => {
                  const unlocked = state.achievements.includes(a.id);
                  return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm ${unlocked ? 'border-2 border-amber-400' : 'opacity-60'}">
                      <div class="text-center">
                        <div class="text-4xl mb-2 ${unlocked ? '' : 'grayscale'}">${a.icon}</div>
                        <div class="font-bold text-gray-800 text-sm">${a.name}</div>
                        <div class="text-xs text-gray-500 mt-1">${a.desc}</div>
                        ${unlocked ? `
                          <div class="mt-2 text-xs text-amber-600 font-medium">âœ… å·²è§£é”</div>
                        ` : `
                          <div class="mt-2 text-xs text-gray-400">ğŸ”’ æœªè§£é”</div>
                        `}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <!-- æç¤º -->
              <div class="mt-6 text-center text-sm text-gray-400">
                ç»§ç»­å­¦ä¹ ï¼Œè§£é”æ›´å¤šæˆå°±ï¼
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      render();
      
      setTimeout(() => {
        if (state.user) {
          // æœ‰å½“å‰ç”¨æˆ·ï¼Œè¿›å…¥ä¸»é¡µ
          state.view = 'home';
        } else if (state.users.length > 0) {
          // æœ‰ç”¨æˆ·ä½†æœªé€‰æ‹©ï¼Œæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©é¡µé¢
          state.view = 'userSelect';
        } else {
          // æ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ¬¢è¿é¡µé¢
          state.view = 'welcome';
        }
        render();
      }, 1000);
    }

    init();
  </script>
</body>
</html>
