<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#6366f1">
  <title>HablaConmigo - AIè¥¿è¯­å£è¯­åŠ©æ‰‹</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‡ªğŸ‡¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            accent: { 500: '#f97316', 600: '#ea580c' }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; }
    
    /* åŠ¨ç”» */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }
    @keyframes bounce { 0%, 100% { transform: translateY(-25%); } 50% { transform: translateY(0); } }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .animate-bounce { animation: bounce 0.6s infinite; }
    
    .mic-recording { position: relative; }
    .mic-recording::before { 
      content: ''; position: absolute; inset: -8px; border-radius: 50%; 
      background: rgba(239,68,68,0.3); animation: pulse-ring 1.5s ease-out infinite; 
    }
    
    /* æ»šåŠ¨æ¡ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* å®‰å…¨åŒºåŸŸ */
    .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    
    /* è¾“å…¥æ¡† */
    input, button, textarea, select { font-size: 16px !important; }
    
    /* ç¿»è¯‘æç¤º */
    .translation-tooltip {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #1e293b; color: white; padding: 8px 12px; border-radius: 8px;
      font-size: 13px; white-space: nowrap; margin-bottom: 8px; z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .translation-tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 6px solid transparent; border-top-color: #1e293b;
    }
    
    /* çº æ­£å¡ç‰‡ */
    .correction-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
      border-radius: 0 12px 12px 0;
    }
    
    /* ç»ç’ƒæ•ˆæœ */
    .glass {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
  </style>
</head>
<body>
  <div id="app" class="h-full"></div>
  
  <script>
    // ==================== æ•°æ®å­˜å‚¨ ====================
    const Storage = {
      get(key, defaultVal = null) {
        try {
          const v = localStorage.getItem('habla_' + key);
          return v ? JSON.parse(v) : defaultVal;
        } catch { return defaultVal; }
      },
      set(key, val) {
        try { localStorage.setItem('habla_' + key, JSON.stringify(val)); } catch {}
      },
      remove(key) {
        try { localStorage.removeItem('habla_' + key); } catch {}
      }
    };

    // ==================== é…ç½® ====================
    const TUTORS = {
      maria: {
        id: 'maria', name: 'MarÃ­a', avatar: 'ğŸ‘©ğŸ»', emoji: 'ğŸŒ¸',
        role: 'æ¸©æŸ”è€å¸ˆ', roleEs: 'Profesora amable',
        personality: 'è€å¿ƒã€æ¸©æŸ”ã€é¼“åŠ±',
        description: 'æ¥è‡ªé©¬å¾·é‡Œçš„è¥¿è¯­è€å¸ˆï¼Œæ“…é•¿çº æ­£è¯­æ³•ï¼Œå¯¹å­¦ç”Ÿéå¸¸æœ‰è€å¿ƒ',
        color: 'from-pink-500 to-rose-500', colorLight: 'bg-pink-50',
        greeting: 'Â¡Hola, {name}! Soy MarÃ­a, tu profesora de espaÃ±ol. Â¡QuÃ© alegrÃ­a conocerte! Â¿QuÃ© te gustarÃ­a practicar hoy?',
        prompt: `Eres MarÃ­a, una profesora de espaÃ±ol de Madrid, amable y muy paciente.
- Hablas de forma cÃ¡lida y siempre animas al estudiante
- Corriges los errores gramaticales de forma natural y educativa
- Cuando encuentres un error, usa el formato: ã€çº æ­£ã€‘"frase incorrecta" â†’ "frase correcta" (explicaciÃ³n en chino)
- Responde en espaÃ±ol, aÃ±ade (traducciÃ³n china) para palabras difÃ­ciles segÃºn el nivel del estudiante
- MantÃ©n respuestas naturales de 2-4 frases`
      },
      carlos: {
        id: 'carlos', name: 'Carlos', avatar: 'ğŸ‘¨ğŸ»', emoji: 'âš½',
        role: 'å¥è°ˆæœ‹å‹', roleEs: 'Amigo hablador',
        personality: 'çƒ­æƒ…ã€å¹½é»˜ã€éšæ€§',
        description: 'å·´å¡ç½—é‚£çš„å¹´è½»äººï¼Œçƒ­çˆ±è¶³çƒå’Œç¾é£Ÿï¼Œè¯´è¯åƒæœ‹å‹ä¸€æ ·è½»æ¾',
        color: 'from-blue-500 to-indigo-500', colorLight: 'bg-blue-50',
        greeting: 'Â¡Ey, quÃ© tal, {name}! Soy Carlos, de Barcelona. Â¿QuÃ© pasa, tÃ­o? Â¡Vamos a charlar!',
        prompt: `Eres Carlos, un chico de 25 aÃ±os de Barcelona, amigable y divertido.
- Hablas de forma informal y relajada, como un amigo
- Te encanta el fÃºtbol (fan del BarÃ§a), la comida y viajar
- Usas expresiones coloquiales y jerga juvenil espaÃ±ola
- Cuando notes un error: ã€çº æ­£ã€‘"error" â†’ "correcciÃ³n" (explicaciÃ³n en chino)
- Respuestas cortas y divertidas, como un chat entre amigos`
      },
      sofia: {
        id: 'sofia', name: 'SofÃ­a', avatar: 'ğŸ‘©ğŸ½', emoji: 'ğŸŒº',
        role: 'æ¸©æŸ”ä¼´ä¾£', roleEs: 'CompaÃ±era cariÃ±osa',
        personality: 'ç”œèœœã€æµªæ¼«ã€å…³å¿ƒ',
        description: 'æ¥è‡ªå¢¨è¥¿å“¥çš„å¥³å­©ï¼Œæ¸©æŸ”æµªæ¼«ï¼Œå–œæ¬¢åˆ†äº«æ‹‰ç¾æ–‡åŒ–',
        color: 'from-purple-500 to-fuchsia-500', colorLight: 'bg-purple-50',
        greeting: 'Â¡Hola, cariÃ±o! Soy SofÃ­a, de MÃ©xico. Â¡QuÃ© lindo conocerte, {name}! Â¿CÃ³mo estÃ¡s hoy?',
        prompt: `Eres SofÃ­a, una chica dulce y cariÃ±osa de MÃ©xico.
- Hablas de forma cÃ¡lida y afectuosa, usando "cariÃ±o", "mi amor" ocasionalmente
- Compartes sobre la cultura, comida y mÃºsica mexicana y latinoamericana
- Usas espaÃ±ol latinoamericano con modismos mexicanos
- Cuando notes un error: ã€çº æ­£ã€‘"error" â†’ "correcciÃ³n" (explicaciÃ³n en chino)
- Respuestas cÃ¡lidas y naturales, mostrando interÃ©s genuino`
      },
      profesor: {
        id: 'profesor', name: 'Prof. GarcÃ­a', avatar: 'ğŸ‘¨ğŸ»â€ğŸ«', emoji: 'ğŸ“š',
        role: 'ä¸¥æ ¼æ•™æˆ', roleEs: 'Profesor estricto',
        personality: 'ä¸¥è°¨ã€å­¦æœ¯ã€æƒå¨',
        description: 'å¤§å­¦è¥¿è¯­æ•™æˆï¼Œéå¸¸æ³¨é‡è¯­æ³•ï¼Œé€‚åˆæƒ³è¦ä¸¥æ ¼å­¦ä¹ çš„ç”¨æˆ·',
        color: 'from-slate-600 to-slate-800', colorLight: 'bg-slate-50',
        greeting: 'Buenos dÃ­as, {name}. Soy el Profesor GarcÃ­a. Estoy aquÃ­ para ayudarle a mejorar su espaÃ±ol. Â¿Comenzamos?',
        prompt: `Eres el Profesor GarcÃ­a, un profesor universitario de espaÃ±ol muy riguroso.
- Hablas de forma formal y acadÃ©mica, usando "usted"
- Prestas mucha atenciÃ³n a la gramÃ¡tica y explicas las reglas detalladamente
- Usa ã€è¯­æ³•ã€‘para explicar puntos gramaticales importantes
- Usa ã€çº æ­£ã€‘para TODOS los errores con explicaciÃ³n detallada en chino
- Exiges respuestas completas y bien estructuradas`
      }
    };

    const SCENARIOS = [
      { id: 'free', icon: 'ğŸ’¬', name: 'è‡ªç”±èŠå¤©', nameEs: 'Charla libre', desc: 'éšä¾¿èŠèŠï¼Œç»ƒä¹ æ—¥å¸¸å¯¹è¯' },
      { id: 'cafe', icon: 'â˜•', name: 'å’–å•¡é¦†', nameEs: 'En la cafeterÃ­a', desc: 'ç‚¹å’–å•¡ã€ç”œç‚¹ï¼Œå’ŒæœåŠ¡å‘˜äº¤æµ' },
      { id: 'restaurant', icon: 'ğŸ½ï¸', name: 'é¤å…ç‚¹é¤', nameEs: 'En el restaurante', desc: 'çœ‹èœå•ã€ç‚¹èœã€ç»“è´¦' },
      { id: 'shopping', icon: 'ğŸ›ï¸', name: 'è´­ç‰©', nameEs: 'De compras', desc: 'è¯¢é—®ä»·æ ¼ã€å°ºç ã€é¢œè‰²' },
      { id: 'travel', icon: 'âœˆï¸', name: 'æ—…è¡Œ', nameEs: 'De viaje', desc: 'é—®è·¯ã€è®¢ç¥¨ã€é…’åº—å…¥ä½' },
      { id: 'work', icon: 'ğŸ’¼', name: 'å·¥ä½œ', nameEs: 'En el trabajo', desc: 'ä¼šè®®ã€é‚®ä»¶ã€èŒåœºäº¤æµ' },
      { id: 'doctor', icon: 'ğŸ¥', name: 'çœ‹åŒ»ç”Ÿ', nameEs: 'En el mÃ©dico', desc: 'æè¿°ç—‡çŠ¶ã€ç†è§£åŒ»å˜±' },
      { id: 'friends', icon: 'ğŸ‰', name: 'ç¤¾äº¤èšä¼š', nameEs: 'Fiesta', desc: 'è®¤è¯†æ–°æœ‹å‹ã€é—²èŠ' },
    ];

    const LEVELS = [
      { id: 'A1', name: 'å…¥é—¨', desc: 'åˆšå¼€å§‹å­¦ä¹ ï¼Œä¼šç®€å•è¯æ±‡' },
      { id: 'A2', name: 'åŸºç¡€', desc: 'èƒ½è¿›è¡Œç®€å•æ—¥å¸¸å¯¹è¯' },
      { id: 'B1', name: 'ä¸­çº§', desc: 'èƒ½å¤„ç†å¤§å¤šæ•°æ—…è¡Œæƒ…å†µ' },
      { id: 'B2', name: 'ä¸­é«˜çº§', desc: 'èƒ½æµåˆ©è®¨è®ºå„ç§è¯é¢˜' },
    ];

    // ==================== åº”ç”¨çŠ¶æ€ ====================
    let state = {
      view: 'loading', // loading, welcome, setup, home, tutor, scenario, chat, settings, history
      user: Storage.get('user', null), // { name, level, showTranslation, correctionLevel, createdAt }
      tutor: null,
      scenario: null,
      messages: [],
      chatHistory: Storage.get('chatHistory', []), // å†å²å¯¹è¯è®°å½•
      inputText: '',
      isLoading: false,
      isListening: false,
      corrections: 0,
      showTranslation: {}, // messageId -> boolean
      translationCache: {}, // messageId -> translation text
    };

    let recognition = null;

    // ==================== å·¥å…·å‡½æ•° ====================
    function $(sel) { return document.querySelector(sel); }
    
    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const clean = text.replace(/ã€.+?ã€‘/g, '').replace(/\(.*?\)/g, '');
        const u = new SpeechSynthesisUtterance(clean);
        u.lang = 'es-ES';
        u.rate = state.user?.speechRate || 0.85;
        speechSynthesis.speak(u);
      }
    }

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      
      const r = new SR();
      r.continuous = true;
      r.interimResults = true;
      r.lang = 'es-ES';
      
      r.onresult = (e) => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if (final) {
          state.inputText += final;
          render();
        }
      };
      
      r.onerror = (e) => {
        if (e.error === 'not-allowed') alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥');
        state.isListening = false;
        render();
      };
      
      r.onend = () => {
        if (state.isListening) {
          try { r.start(); } catch(e) {}
        }
      };
      
      return r;
    }

    function toggleListening() {
      if (!recognition) recognition = initSpeechRecognition();
      if (!recognition) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chrome');
        return;
      }
      
      state.isListening = !state.isListening;
      if (state.isListening) {
        try { recognition.start(); } catch(e) {}
      } else {
        try { recognition.stop(); } catch(e) {}
      }
      render();
    }

    // ==================== API è°ƒç”¨ ====================
    async function callAPI(userMessage, forTranslation = false) {
      const user = state.user;
      
      let systemPrompt;
      if (forTranslation) {
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹è¥¿ç­ç‰™è¯­ç¿»è¯‘æˆç®€æ´çš„ä¸­æ–‡ï¼Œåªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;
      } else {
        systemPrompt = `${state.tutor.prompt}

å­¦ç”Ÿä¿¡æ¯ï¼š
- åå­—ï¼š${user.name}
- è¥¿è¯­æ°´å¹³ï¼š${user.level}
- å¯¹è¯åœºæ™¯ï¼š${state.scenario?.nameEs || 'è‡ªç”±å¯¹è¯'}

é‡è¦è§„åˆ™ï¼š
1. æ ¹æ®å­¦ç”Ÿçš„${user.level}æ°´å¹³è°ƒæ•´è¯æ±‡å’Œå¥å­éš¾åº¦
2. çœŸæ­£ç†è§£å¹¶å›åº”å­¦ç”Ÿè¯´çš„å†…å®¹
3. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´
4. è¯­æ³•é”™è¯¯åŠ¡å¿…ç”¨ã€çº æ­£ã€‘æ ¼å¼æŒ‡å‡º
5. ${user.level === 'A1' || user.level === 'A2' ? 'å¤šç»™é‡è¦è¯æ±‡åŠ ä¸Š(ä¸­æ–‡ç¿»è¯‘)' : 'åªç»™ç”Ÿåƒ»è¯åŠ ç¿»è¯‘'}`;
      }

      const messages = forTranslation 
        ? [{ role: 'user', content: userMessage }]
        : [...state.messages.map(m => ({
            role: m.type === 'user' ? 'user' : 'assistant',
            content: m.text
          })), { role: 'user', content: userMessage }];

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ system: systemPrompt, messages })
        });

        const data = await res.json();
        return data.content?.[0]?.text || 'æŠ±æ­‰ï¼Œè¯·é‡è¯•ã€‚';
      } catch (err) {
        return 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
      }
    }

    async function sendMessage() {
      const text = state.inputText.trim();
      if (!text || state.isLoading) return;
      
      state.isListening = false;
      if (recognition) try { recognition.stop(); } catch(e) {}
      
      state.inputText = '';
      const userMsg = { id: Date.now(), type: 'user', text, time: new Date().toISOString() };
      state.messages.push(userMsg);
      state.isLoading = true;
      render();
      scrollToBottom();
      
      const response = await callAPI(text);
      
      // è§£æçº æ­£å†…å®¹
      const correctionMatch = response.match(/ã€çº æ­£ã€‘(.+?)(?=\n|$)/s);
      const grammarMatch = response.match(/ã€è¯­æ³•ã€‘(.+?)(?=\n|$)/s);
      const cleanResponse = response
        .replace(/ã€çº æ­£ã€‘.+?(?=\n|$)/gs, '')
        .replace(/ã€è¯­æ³•ã€‘.+?(?=\n|$)/gs, '')
        .trim();
      
      const aiMsg = { 
        id: Date.now() + 1, 
        type: 'ai', 
        text: cleanResponse,
        correction: correctionMatch ? correctionMatch[1].trim() : null,
        grammar: grammarMatch ? grammarMatch[1].trim() : null,
        time: new Date().toISOString()
      };
      
      state.messages.push(aiMsg);
      if (correctionMatch) state.corrections++;
      state.isLoading = false;
      
      // ä¿å­˜å¯¹è¯å†å²
      saveChatHistory();
      
      render();
      scrollToBottom();
      speak(cleanResponse);
    }

    async function getTranslation(msgId, text) {
      if (state.translationCache[msgId]) {
        state.showTranslation[msgId] = !state.showTranslation[msgId];
        render();
        return;
      }
      
      state.showTranslation[msgId] = true;
      state.translationCache[msgId] = 'ç¿»è¯‘ä¸­...';
      render();
      
      const translation = await callAPI(text, true);
      state.translationCache[msgId] = translation;
      render();
    }

    function saveChatHistory() {
      if (state.messages.length < 2) return;
      
      const chat = {
        id: Date.now(),
        tutor: state.tutor.id,
        scenario: state.scenario?.id || 'free',
        messages: state.messages.slice(-20), // åªä¿å­˜æœ€è¿‘20æ¡
        corrections: state.corrections,
        date: new Date().toISOString()
      };
      
      state.chatHistory.unshift(chat);
      if (state.chatHistory.length > 50) state.chatHistory = state.chatHistory.slice(0, 50);
      Storage.set('chatHistory', state.chatHistory);
    }

    function startChat(tutor, scenario) {
      state.tutor = tutor;
      state.scenario = scenario;
      state.messages = [];
      state.corrections = 0;
      state.showTranslation = {};
      state.translationCache = {};
      state.view = 'chat';
      
      const greeting = tutor.greeting.replace('{name}', state.user.name);
      setTimeout(() => {
        state.messages = [{ id: 1, type: 'ai', text: greeting, time: new Date().toISOString() }];
        render();
        speak(greeting);
      }, 300);
      
      render();
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages');
        if (container) container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function saveUser(userData) {
      state.user = { ...userData, createdAt: new Date().toISOString() };
      Storage.set('user', state.user);
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function render() {
      const app = document.getElementById('app');
      
      switch(state.view) {
        case 'loading': app.innerHTML = renderLoading(); break;
        case 'welcome': app.innerHTML = renderWelcome(); break;
        case 'setup': app.innerHTML = renderSetup(); break;
        case 'home': app.innerHTML = renderHome(); break;
        case 'tutor': app.innerHTML = renderTutor(); break;
        case 'scenario': app.innerHTML = renderScenario(); break;
        case 'chat': app.innerHTML = renderChat(); break;
        case 'settings': app.innerHTML = renderSettings(); break;
        case 'history': app.innerHTML = renderHistory(); break;
      }
    }

    function renderLoading() {
      return `
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-primary-500 to-primary-700">
          <div class="text-center text-white">
            <div class="text-6xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <div class="text-xl font-semibold">HablaConmigo</div>
            <div class="mt-4 flex justify-center gap-1">
              <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.1s"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderWelcome() {
      return `
        <div class="h-full bg-gradient-to-br from-primary-500 via-primary-600 to-purple-700 flex flex-col items-center justify-center p-6 text-center">
          <div class="fade-in">
            <div class="text-7xl mb-4">ğŸ‡ªğŸ‡¸</div>
            <h1 class="text-4xl font-bold text-white mb-2">Â¡Hola!</h1>
            <h2 class="text-xl text-white/90 mb-1">HablaConmigo</h2>
            <p class="text-white/70 mb-8 max-w-xs text-sm">
              ä¸AIä¼™ä¼´çœŸå®å¯¹è¯<br>
              è¯­éŸ³è¾“å…¥ Â· æ™ºèƒ½çº é”™ Â· å³æ—¶ç¿»è¯‘
            </p>
            
            <button onclick="state.view='setup';render()" 
              class="bg-white text-primary-600 font-bold py-4 px-10 rounded-2xl text-lg shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all">
              å¼€å§‹ä½¿ç”¨ â†’
            </button>
            
            <div class="mt-10 grid grid-cols-4 gap-4 text-white/80 text-xs">
              <div class="text-center"><div class="text-2xl mb-1">ğŸ¤</div>è¯­éŸ³</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸ­</div>è§’è‰²</div>
              <div class="text-center"><div class="text-2xl mb-1">âœï¸</div>çº é”™</div>
              <div class="text-center"><div class="text-2xl mb-1">ğŸŒ</div>ç¿»è¯‘</div>
            </div>
            
            <div class="mt-8 text-white/50 text-xs">å®Œå…¨å…è´¹ Â· æ— éœ€æ³¨å†Œ Â· æ•°æ®å­˜æœ¬åœ°</div>
          </div>
        </div>
      `;
    }

    function renderSetup() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ğŸ‘‹ æ¬¢è¿ï¼</h1>
            <p class="text-white/80 text-sm mt-1">è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä½ </p>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <div class="max-w-md mx-auto space-y-6 fade-in">
              <!-- å§“å -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„åå­—</label>
                <input id="userName" type="text" placeholder="è¾“å…¥ä½ çš„åå­—æˆ–æ˜µç§°" 
                  class="w-full p-4 rounded-xl border border-gray-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                  value="${state.user?.name || ''}">
              </div>
              
              <!-- æ°´å¹³ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„è¥¿è¯­æ°´å¹³</label>
                <div class="grid grid-cols-2 gap-3">
                  ${LEVELS.map(l => `
                    <button onclick="document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('ring-2','ring-primary-500','bg-primary-50'));this.classList.add('ring-2','ring-primary-500','bg-primary-50');document.getElementById('selectedLevel').value='${l.id}'"
                      class="level-btn p-4 rounded-xl border border-gray-200 text-left hover:border-primary-300 transition-all ${state.user?.level === l.id ? 'ring-2 ring-primary-500 bg-primary-50' : ''}">
                      <div class="font-bold text-gray-800">${l.id}</div>
                      <div class="text-sm text-gray-500">${l.name}</div>
                      <div class="text-xs text-gray-400 mt-1">${l.desc}</div>
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedLevel" value="${state.user?.level || 'A2'}">
              </div>
              
              <!-- åå¥½ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ åå¥½</label>
                <div class="space-y-3">
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘</div>
                      <div class="text-xs text-gray-500">AIå›å¤æ—¶è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</div>
                    </div>
                    <input id="autoTranslate" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.autoTranslate ? 'checked' : ''}>
                  </label>
                  
                  <label class="flex items-center justify-between p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-primary-300">
                    <div>
                      <div class="font-medium text-gray-800">ä¸¥æ ¼çº é”™æ¨¡å¼</div>
                      <div class="text-xs text-gray-500">çº æ­£æ‰€æœ‰è¯­æ³•é”™è¯¯ï¼Œé€‚åˆè®¤çœŸå­¦ä¹ </div>
                    </div>
                    <input id="strictMode" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${state.user?.strictMode ? 'checked' : ''}>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 safe-bottom">
            <button onclick="submitSetup()" 
              class="w-full py-4 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-bold shadow-lg hover:shadow-xl active:scale-98 transition-all">
              å¼€å§‹å­¦ä¹  ğŸš€
            </button>
          </div>
        </div>
      `;
    }

    function submitSetup() {
      const name = document.getElementById('userName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('selectedLevel').value;
      const autoTranslate = document.getElementById('autoTranslate').checked;
      const strictMode = document.getElementById('strictMode').checked;
      
      saveUser({ name, level, autoTranslate, strictMode, speechRate: 0.85 });
      state.view = 'home';
      render();
    }

    function renderHome() {
      const user = state.user;
      const recentChats = state.chatHistory.slice(0, 3);
      
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- é¡¶éƒ¨ -->
          <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-6 text-white">
            <div class="flex items-center justify-between mb-4">
              <div>
                <div class="text-sm text-white/70">Â¡Hola!</div>
                <div class="text-2xl font-bold">${user.name}</div>
              </div>
              <button onclick="state.view='settings';render()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                âš™ï¸
              </button>
            </div>
            <div class="flex gap-4 text-sm">
              <div class="bg-white/20 rounded-lg px-3 py-2">
                <div class="text-white/70 text-xs">æ°´å¹³</div>
                <div class="font-bold">${user.level}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-3 py-2">
                <div class="text-white/70 text-xs">å¯¹è¯</div>
                <div class="font-bold">${state.chatHistory.length}</div>
              </div>
              <div class="bg-white/20 rounded-lg px-3 py-2">
                <div class="text-white/70 text-xs">çº æ­£</div>
                <div class="font-bold">${state.chatHistory.reduce((sum, c) => sum + (c.corrections || 0), 0)}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-6">
            <!-- å¼€å§‹æ–°å¯¹è¯ -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-gray-500 mb-3">å¼€å§‹æ–°å¯¹è¯</h3>
              <button onclick="state.view='tutor';render()" 
                class="w-full bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md active:scale-98 transition-all">
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center text-3xl">ğŸ’¬</div>
                <div class="flex-1 text-left">
                  <div class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</div>
                  <div class="text-sm text-gray-500">4ç§æ€§æ ¼çš„AIè§’è‰²ç­‰ä½ æ¥èŠ</div>
                </div>
                <div class="text-gray-300 text-xl">â†’</div>
              </button>
            </div>
            
            <!-- æœ€è¿‘å¯¹è¯ -->
            ${recentChats.length > 0 ? `
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-500">æœ€è¿‘å¯¹è¯</h3>
                  <button onclick="state.view='history';render()" class="text-sm text-primary-600">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div class="space-y-3">
                  ${recentChats.map(chat => {
                    const tutor = TUTORS[chat.tutor];
                    const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                    const date = new Date(chat.date);
                    return `
                      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-xl">${tutor?.avatar || 'ğŸ‘¤'}</div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'} Â· ${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleDateString()} Â· ${chat.messages?.length || 0}æ¡æ¶ˆæ¯</div>
                          </div>
                          ${chat.corrections > 0 ? `<div class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full">çº æ­£${chat.corrections}</div>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="text-center py-10 text-gray-400">
                <div class="text-4xl mb-2">ğŸ“š</div>
                <div>è¿˜æ²¡æœ‰å¯¹è¯è®°å½•</div>
                <div class="text-sm">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡ç»ƒä¹ å§ï¼</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderTutor() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <div>
              <h1 class="font-bold text-gray-800">é€‰æ‹©å¯¹è¯ä¼™ä¼´</h1>
              <p class="text-xs text-gray-500">ä¸åŒè§’è‰²æœ‰ä¸åŒçš„å¯¹è¯é£æ ¼</p>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-4">
              ${Object.values(TUTORS).map(t => `
                <button onclick="state.tutor=TUTORS['${t.id}'];state.view='scenario';render()" 
                  class="w-full bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-98 transition-all fade-in">
                  <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-3xl flex-shrink-0">${t.avatar}</div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800">${t.name}</span>
                        <span class="text-sm">${t.emoji}</span>
                      </div>
                      <div class="text-sm text-primary-600">${t.role} Â· ${t.roleEs}</div>
                      <div class="text-xs text-gray-500 mt-1">${t.description}</div>
                      <div class="flex gap-1 mt-2">
                        ${t.personality.split('ã€').map(p => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">${p}</span>`).join('')}
                      </div>
                    </div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderScenario() {
      const t = state.tutor;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <!-- è§’è‰²ä¿¡æ¯ -->
          <div class="bg-gradient-to-r ${t.color} p-6 text-white">
            <button onclick="state.view='tutor';render()" class="text-white/80 text-sm mb-3 flex items-center gap-1">â† è¿”å›</button>
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-4xl">${t.avatar}</div>
              <div>
                <div class="text-xl font-bold">${t.name} ${t.emoji}</div>
                <div class="text-white/80">${t.role}</div>
                <div class="text-white/60 text-sm">${t.personality}</div>
              </div>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <h3 class="text-sm font-medium text-gray-500 mb-3">é€‰æ‹©å¯¹è¯åœºæ™¯</h3>
            <div class="grid grid-cols-2 gap-3">
              ${SCENARIOS.map(s => `
                <button onclick='startChat(state.tutor, ${JSON.stringify(s).replace(/'/g, "\\'")})'
                  class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-left hover:shadow-md hover:border-primary-200 active:scale-95 transition-all">
                  <div class="text-2xl mb-2">${s.icon}</div>
                  <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                  <div class="text-xs text-gray-400">${s.nameEs}</div>
                  <div class="text-xs text-gray-500 mt-1">${s.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="startChat(state.tutor, SCENARIOS[0])" 
              class="w-full py-4 rounded-xl bg-gradient-to-r ${t.color} text-white font-bold shadow-lg active:scale-98 transition-all">
              ğŸ¤ ç›´æ¥å¼€å§‹è‡ªç”±å¯¹è¯
            </button>
          </div>
        </div>
      `;
    }

    function renderChat() {
      const t = state.tutor;
      const user = state.user;
      
      return `
        <div class="h-full bg-gray-100 flex flex-col">
          <!-- é¡¶æ  -->
          <div class="glass border-b p-3">
            <div class="flex items-center justify-between max-w-lg mx-auto">
              <button onclick="endChat()" class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                <span>â†</span>
                <span class="text-sm">ç»“æŸ</span>
              </button>
              <div class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-xl">${t.avatar}</span>
                  <span class="font-bold text-gray-800">${t.name}</span>
                </div>
                <div class="text-xs text-gray-500">${state.scenario?.name || 'è‡ªç”±èŠå¤©'} Â· ${user.level}</div>
              </div>
              <div class="w-16"></div>
            </div>
          </div>
          
          <!-- æ¶ˆæ¯åˆ—è¡¨ -->
          <div id="messages" class="flex-1 overflow-auto p-4 no-scrollbar">
            <div class="max-w-lg mx-auto space-y-4">
              ${state.messages.map(msg => renderMessage(msg, t)).join('')}
              
              ${state.isLoading ? `
                <div class="flex justify-start fade-in">
                  <div class="bg-white p-4 rounded-2xl shadow-sm">
                    <div class="flex gap-1.5">
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                      <div class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- çº æ­£ç»Ÿè®¡ -->
          ${state.corrections > 0 ? `
            <div class="bg-amber-50 border-t border-amber-100 py-2 text-center">
              <span class="text-sm text-amber-700">ğŸ“ æœ¬æ¬¡å¯¹è¯å·²çº æ­£ <strong>${state.corrections}</strong> å¤„</span>
            </div>
          ` : ''}
          
          <!-- è¾“å…¥åŒº -->
          <div class="glass border-t p-3 safe-bottom">
            <div class="max-w-lg mx-auto">
              <div class="flex gap-2 items-center">
                <button onclick="toggleListening()" 
                  class="relative w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.isListening ? 'bg-red-500 text-white mic-recording' : 'bg-gray-200 hover:bg-gray-300'}">
                  ${state.isListening ? 'â¹' : 'ğŸ¤'}
                </button>
                
                <input id="chatInput" type="text" value="${state.inputText.replace(/"/g, '&quot;')}" 
                  placeholder="${state.isListening ? 'ğŸ™ï¸ æ­£åœ¨å¬...' : 'ç”¨è¥¿ç­ç‰™è¯­è¾“å…¥...'}"
                  oninput="state.inputText=this.value"
                  onkeydown="if(event.key==='Enter')sendMessage()"
                  class="flex-1 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${state.isListening ? 'bg-red-50 border-2 border-red-200' : 'bg-white border border-gray-200'}">
                
                <button onclick="sendMessage()" 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${state.inputText.trim() && !state.isLoading ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-200 text-gray-400'}">
                  â¤
                </button>
              </div>
              
              <div class="flex gap-2 mt-2 overflow-x-auto no-scrollbar">
                ${['Â¡Hola!', 'No entiendo', 'Â¿Puedes repetir?', 'MÃ¡s despacio', 'Â¿QuÃ© significa?'].map(p => `
                  <button onclick="state.inputText='${p}';render()" 
                    class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded-full text-xs whitespace-nowrap hover:border-primary-300 hover:text-primary-600">${p}</button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMessage(msg, tutor) {
      const isUser = msg.type === 'user';
      const showTrans = state.showTranslation[msg.id];
      const translation = state.translationCache[msg.id];
      
      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'} fade-in">
          <div class="max-w-[85%]">
            ${!isUser ? `
              <div class="flex items-center gap-2 mb-1">
                <div class="w-7 h-7 rounded-full bg-gradient-to-br ${tutor.color} flex items-center justify-center text-sm">${tutor.avatar}</div>
                <span class="text-xs text-gray-500">${tutor.name}</span>
              </div>
            ` : ''}
            
            <div class="relative">
              <div onclick="${!isUser ? `handleTranslateClick(${msg.id})` : ''}"
                class="p-4 rounded-2xl text-sm ${isUser 
                  ? 'bg-primary-500 text-white rounded-br-sm' 
                  : 'bg-white shadow-sm rounded-bl-sm cursor-pointer hover:bg-gray-50'} transition-colors">
                ${msg.text}
                ${!isUser ? `<div class="text-xs ${showTrans ? 'text-primary-600' : 'text-gray-400'} mt-2 flex items-center gap-1">
                  <span>ğŸŒ</span> <span>${showTrans ? 'éšè—ç¿»è¯‘' : 'ç‚¹å‡»ç¿»è¯‘'}</span>
                </div>` : ''}
              </div>
              
              ${!isUser && showTrans && translation ? `
                <div class="mt-2 p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm text-blue-800">
                  <div class="text-xs text-blue-500 mb-1">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</div>
                  ${translation}
                </div>
              ` : ''}
              
              ${!isUser ? `
                <button onclick="handleSpeakClick(${msg.id})" 
                  class="absolute -right-10 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-sm hover:bg-gray-50">
                  ğŸ”Š
                </button>
              ` : ''}
            </div>
            
            ${msg.correction ? `
              <div class="correction-card mt-3 p-4 slide-up">
                <div class="flex items-center gap-2 text-amber-800 font-medium mb-2">
                  <span class="text-lg">âœï¸</span>
                  <span>è¯­æ³•çº æ­£</span>
                </div>
                <div class="text-sm text-amber-900">${msg.correction}</div>
              </div>
            ` : ''}
            
            ${msg.grammar ? `
              <div class="mt-3 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-xl slide-up">
                <div class="flex items-center gap-2 text-blue-800 font-medium mb-2">
                  <span class="text-lg">ğŸ“š</span>
                  <span>è¯­æ³•çŸ¥è¯†</span>
                </div>
                <div class="text-sm text-blue-900">${msg.grammar}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // å¤„ç†ç¿»è¯‘ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
    function handleTranslateClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        getTranslation(msgId, msg.text);
      }
    }
    
    // å¤„ç†æœ—è¯»ç‚¹å‡» - é€šè¿‡IDè·å–æ¶ˆæ¯æ–‡æœ¬
    function handleSpeakClick(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (msg) {
        speak(msg.text);
      }
    }

    function endChat() {
      saveChatHistory();
      state.isListening = false;
      speechSynthesis.cancel();
      if (recognition) try { recognition.stop(); } catch(e) {}
      state.view = 'home';
      render();
    }

    function renderSettings() {
      const user = state.user;
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800">è®¾ç½®</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            <div class="max-w-md mx-auto space-y-6">
              <!-- ä¸ªäººä¿¡æ¯ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-gray-500">åå­—</label>
                    <input id="settingName" type="text" value="${user.name}" 
                      class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                  </div>
                  <div>
                    <label class="text-sm text-gray-500">è¥¿è¯­æ°´å¹³</label>
                    <select id="settingLevel" class="w-full mt-1 p-3 rounded-xl border border-gray-200 focus:border-primary-500 outline-none">
                      ${LEVELS.map(l => `<option value="${l.id}" ${user.level === l.id ? 'selected' : ''}>${l.id} - ${l.name}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- å­¦ä¹ åå¥½ -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ“š å­¦ä¹ åå¥½</h3>
                <div class="space-y-4">
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">è‡ªåŠ¨æ˜¾ç¤ºç¿»è¯‘</span>
                    <input id="settingAutoTrans" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.autoTranslate ? 'checked' : ''}>
                  </label>
                  <label class="flex items-center justify-between">
                    <span class="text-gray-700">ä¸¥æ ¼çº é”™æ¨¡å¼</span>
                    <input id="settingStrict" type="checkbox" class="w-5 h-5 text-primary-600 rounded" ${user.strictMode ? 'checked' : ''}>
                  </label>
                  <div>
                    <label class="text-gray-700">è¯­éŸ³é€Ÿåº¦</label>
                    <input id="settingSpeechRate" type="range" min="0.5" max="1.2" step="0.05" value="${user.speechRate || 0.85}"
                      class="w-full mt-2" oninput="document.getElementById('rateValue').textContent=this.value">
                    <div class="flex justify-between text-xs text-gray-400">
                      <span>æ…¢</span>
                      <span id="rateValue">${user.speechRate || 0.85}</span>
                      <span>å¿«</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- æ•°æ®ç®¡ç† -->
              <div class="bg-white rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">å¯¹è¯è®°å½•</span>
                    <span class="text-gray-800 font-medium">${state.chatHistory.length} æ¡</span>
                  </div>
                  <button onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ'))clearHistory()" 
                    class="w-full py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50">
                    æ¸…é™¤å¯¹è¯è®°å½•
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-4 safe-bottom">
            <button onclick="saveSettings()" 
              class="w-full py-4 rounded-xl bg-primary-500 text-white font-bold shadow-lg">
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      `;
    }

    function saveSettings() {
      const name = document.getElementById('settingName').value.trim() || 'å­¦å‘˜';
      const level = document.getElementById('settingLevel').value;
      const autoTranslate = document.getElementById('settingAutoTrans').checked;
      const strictMode = document.getElementById('settingStrict').checked;
      const speechRate = parseFloat(document.getElementById('settingSpeechRate').value);
      
      saveUser({ ...state.user, name, level, autoTranslate, strictMode, speechRate });
      state.view = 'home';
      render();
    }

    function clearHistory() {
      state.chatHistory = [];
      Storage.remove('chatHistory');
      render();
    }

    function renderHistory() {
      return `
        <div class="h-full bg-gray-50 flex flex-col">
          <div class="bg-white border-b p-4 flex items-center gap-3">
            <button onclick="state.view='home';render()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">â†</button>
            <h1 class="font-bold text-gray-800">å¯¹è¯å†å²</h1>
          </div>
          
          <div class="flex-1 overflow-auto p-4">
            ${state.chatHistory.length > 0 ? `
              <div class="max-w-md mx-auto space-y-3">
                ${state.chatHistory.map(chat => {
                  const tutor = TUTORS[chat.tutor];
                  const scenario = SCENARIOS.find(s => s.id === chat.scenario);
                  const date = new Date(chat.date);
                  return `
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                      <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${tutor?.color || 'from-gray-400 to-gray-500'} flex items-center justify-center text-2xl">${tutor?.avatar || 'ğŸ‘¤'}</div>
                        <div class="flex-1">
                          <div class="font-medium text-gray-800">${tutor?.name || 'æœªçŸ¥'}</div>
                          <div class="text-sm text-gray-500">${scenario?.name || 'è‡ªç”±èŠå¤©'}</div>
                          <div class="text-xs text-gray-400">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                        </div>
                        <div class="text-right">
                          <div class="text-sm text-gray-600">${chat.messages?.length || 0} æ¡</div>
                          ${chat.corrections > 0 ? `<div class="text-xs text-amber-600">çº æ­£ ${chat.corrections}</div>` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="text-center py-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“­</div>
                <div>æš‚æ— å¯¹è¯è®°å½•</div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      render();
      
      setTimeout(() => {
        if (state.user) {
          state.view = 'home';
        } else {
          state.view = 'welcome';
        }
        render();
      }, 1000);
    }

    init();
  </script>
</body>
</html>
